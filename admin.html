<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Administraci√≥n - PorkCasare</title>
  <link rel="stylesheet" href="/oficina-virtual/css/style.css">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #fafafa; margin: 0; }
    h1 { margin-bottom: 20px; color: #333; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
    th { background: #f8f9fa; font-weight: 600; color: #495057; }
    tbody tr:hover { background: #f8f9fa; }
    button { padding: 8px 14px; margin: 2px; cursor: pointer; border: none; border-radius: 4px; font-size: 14px; }
    button:hover { opacity: 0.9; }
    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    
    /* Tabs */
    .tabs { display: flex; gap: 8px; border-bottom: 2px solid #dee2e6; margin-bottom: 20px; flex-wrap: wrap; }
    .tab-button { padding: 12px 20px; background: #f8f9fa; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 14px; font-weight: 500; color: #495057; transition: all 0.2s; }
    .tab-button:hover { background: #e9ecef; }
    .tab-button.active { background: white; border-bottom-color: #007bff; color: #007bff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Stats cards */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .stat-card h3 { margin: 0 0 8px 0; font-size: 14px; color: #6c757d; font-weight: 500; }
    .stat-card .value { font-size: 32px; font-weight: 700; color: #333; }
    .stat-card.blue .value { color: #007bff; }
    .stat-card.green .value { color: #28a745; }
    .stat-card.orange .value { color: #fd7e14; }
    .stat-card.purple .value { color: #6f42c1; }
    .stat-card.red .value { color: #dc3545; }
    
    /* Header */
    .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
    .empty-state { text-align: center; padding: 40px; color: #6c757d; }
    
    /* Product Cards */
    .product-card-preview { 
      background: white; 
      border-radius: 12px; 
      padding: 16px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }
    .product-card-preview:hover { 
      transform: translateY(-4px); 
      box-shadow: 0 4px 16px rgba(0,0,0,0.15); 
    }
    .product-card-preview img { 
      width: 100%; 
      height: 180px; 
      object-fit: cover; 
      border-radius: 8px; 
      margin-bottom: 12px; 
    }
    .product-card-preview h4 { 
      margin: 0 0 8px 0; 
      font-size: 16px; 
      font-weight: 600; 
      color: #333; 
    }
    .product-card-preview p { 
      margin: 0 0 8px 0; 
      font-size: 13px; 
      color: #666; 
      line-height: 1.4; 
    }
    .product-card-preview .price { 
      font-size: 18px; 
      font-weight: 700; 
      color: #28a745; 
      margin-bottom: 8px; 
    }
    .product-badge { 
      position: absolute; 
      top: 24px; 
      right: 24px; 
      background: #dc3545; 
      color: white; 
      padding: 4px 8px; 
      border-radius: 4px; 
      font-size: 11px; 
      font-weight: 600; 
      text-transform: uppercase; 
    }
    .product-badge.hidden { background: #6c757d; }
    .product-badge.outofstock { background: #fd7e14; }
  </style>
</head>
<body>
  <h1>Panel de Administraci√≥n</h1>

  <!-- Formulario de login -->
  <div id="loginSection">
    <h2>Iniciar sesi√≥n</h2>
    <form id="loginForm">
      <label>Email:</label><br>
      <input type="email" id="email" required><br><br>
      <label>Contrase√±a:</label><br>
      <input type="password" id="password" required><br><br>
      <button type="submit">Ingresar</button>
    </form>
  </div>

  <!-- Panel solo visible si es admin -->
  <div id="adminPanel" class="hidden">
    <div class="admin-header">
      <h1>Panel de Administraci√≥n</h1>
      <button id="logoutBtn" class="btn-secondary">Cerrar sesi√≥n</button>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-button active" data-tab="overview">Resumen</button>
      <button class="tab-button" data-tab="pending">√ìrdenes Pendientes</button>
      <button class="tab-button" data-tab="confirmed">√ìrdenes Confirmadas</button>
      <button class="tab-button" data-tab="rejected">√ìrdenes Rechazadas</button>
      <button class="tab-button" data-tab="distributors">Distribuidores</button>
      <button class="tab-button" data-tab="clients">Clientes</button>
      <button class="tab-button" data-tab="payouts">Cobros de Distribuidores</button>
      <button class="tab-button" data-tab="users">Usuarios</button>
      <button class="tab-button" data-tab="inventory">Inventario</button>
      <button class="tab-button" data-tab="products">Productos</button>
      <button class="tab-button" data-tab="categories">Categor√≠as</button>
      <button class="tab-button" data-tab="calculator">Calculadora de Puntos</button>
    </div>

    <!-- Tab: Resumen -->
    <div id="tab-overview" class="tab-content active">
      <div class="stats-grid">
        <div class="stat-card blue">
          <h3>Total de Ventas</h3>
          <div class="value" id="totalSales">$0</div>
        </div>
        <div class="stat-card green">
          <h3>√ìrdenes Confirmadas</h3>
          <div class="value" id="confirmedCount">0</div>
        </div>
        <div class="stat-card orange">
          <h3>√ìrdenes Pendientes</h3>
          <div class="value" id="pendingCount">0</div>
        </div>
        <div class="stat-card purple">
          <h3>Distribuidores</h3>
          <div class="value" id="distributorsCount">0</div>
        </div>
        <div class="stat-card blue">
          <h3>Total Usuarios</h3>
          <div class="value" id="usersCount">0</div>
        </div>
        <div class="stat-card red">
          <h3>√ìrdenes Rechazadas</h3>
          <div class="value" id="rejectedCount">0</div>
        </div>
        <div class="stat-card green">
          <h3>Inventario Total</h3>
          <div class="value" id="inventoryCount">0</div>
        </div>
      </div>
      
      <h2>Actividad Reciente</h2>
      <table>
        <thead>
          <tr>
            <th>Producto</th>
            <th>Usuario</th>
            <th>Precio</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="recentActivity"></tbody>
      </table>
    </div>

    <!-- Tab: √ìrdenes Pendientes -->
    <div id="tab-pending" class="tab-content">
      <h2>√ìrdenes Pendientes</h2>
      <table>
        <thead>
          <tr>
            <th>ID de Orden</th>
            <th>Usuario</th>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Precio</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="pendingOrdersTable"></tbody>
      </table>
    </div>

    <!-- Tab: √ìrdenes Confirmadas -->
    <div id="tab-confirmed" class="tab-content">
      <h2>√ìrdenes Confirmadas</h2>
      <table>
        <thead>
          <tr>
            <th>ID Orden</th>
            <th>ID Usuario</th>
            <th>Usuario</th>
            <th>Producto</th>
            <th>Precio</th>
            <th>Puntos</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="confirmedOrdersTable"></tbody>
      </table>
    </div>

    <!-- Tab: √ìrdenes Rechazadas -->
    <div id="tab-rejected" class="tab-content">
      <h2>√ìrdenes Rechazadas</h2>
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>ID</th>
            <th>Producto</th>
            <th>Usuario</th>
            <th>Precio</th>
            <th>Motivo</th>
          </tr>
        </thead>
        <tbody id="rejectedOrdersTable"></tbody>
      </table>
    </div>

    <!-- Tab: Distribuidores -->
    <div id="tab-distributors" class="tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:12px;flex-wrap:wrap;">
        <h2 style="margin:0;">Distribuidores Registrados</h2>
        <input type="text" id="distributorSearchInput" placeholder="Buscar por nombre, usuario o c√©dula..." style="padding:10px 16px;border:1px solid #ddd;border-radius:6px;font-size:14px;min-width:300px;flex:1;max-width:400px;">
      </div>
      <table>
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Nombre</th>
            <th>Email</th>
            <th>Celular</th>
            <th>Estado</th>
            <th>Puntos Personales</th>
            <th>Puntos Grupales</th>
            <th>Registro</th>
            <th>Detalles</th>
          </tr>
        </thead>
        <tbody id="distributorsTable"></tbody>
      </table>
      
      <!-- Distributor Details Panel -->
      <div id="distributorDetailsPanel" style="display:none;position:fixed;top:0;right:-600px;width:600px;height:100vh;background:white;box-shadow:-4px 0 20px rgba(0,0,0,0.15);z-index:2000;transition:right 0.3s ease;overflow-y:auto;">
        <div style="padding:24px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h2 style="margin:0;font-size:20px;">Detalles del Distribuidor</h2>
            <button id="closeDistributorPanel" style="background:transparent;border:none;font-size:28px;cursor:pointer;color:#666;line-height:1;">&times;</button>
          </div>
          
          <div id="distributorDetailsContent"></div>
        </div>
      </div>
      
      <!-- Overlay for distributor panel -->
      <div id="distributorPanelOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.3);z-index:1999;"></div>
    </div>

    <!-- Tab: Clientes -->
    <div id="tab-clients" class="tab-content">
      <h2>Clientes Registrados</h2>
      <table>
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Nombre</th>
            <th>Email</th>
            <th>Celular</th>
            <th>Puntos</th>
            <th>Registro</th>
          </tr>
        </thead>
        <tbody id="clientsTable"></tbody>
      </table>
    </div>

    <!-- Tab: Cobros de Distribuidores -->
    <div id="tab-payouts" class="tab-content">
      <h2>Cobros de Distribuidores</h2>
      <table>
        <thead>
          <tr>
            <th>Distribuidor</th>
            <th>Monto a cobrar</th>
            <th>Fecha solicitud</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="payoutsTable"></tbody>
      </table>
    </div>

    <!-- Tab: Inventario -->
    <div id="tab-inventory" class="tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h2 style="margin:0;">Gesti√≥n de Inventario</h2>
        <button id="addInventoryBtn" class="btn-success">+ Agregar Unidades</button>
      </div>
      
      <div class="stats-grid" style="margin-bottom:20px;">
        <div class="stat-card blue">
          <h3>Total en Stock</h3>
          <div class="value" id="totalStockUnits">0</div>
        </div>
        <div class="stat-card green">
          <h3>Unidades Vendidas</h3>
          <div class="value" id="totalSoldUnits">0</div>
        </div>
        <div class="stat-card orange">
          <h3>√öltima Actualizaci√≥n</h3>
          <div class="value" id="lastInventoryUpdate" style="font-size:16px;">N/A</div>
        </div>
      </div>

      <h3>Inventario por Producto</h3>
      <table style="margin-bottom:30px;">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Total de Unidades</th>
            <th>Unidades Vendidas</th>
            <th>Unidades en Existencia</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="productInventoryTable"></tbody>
      </table>

      <h3>Historial de Movimientos</h3>
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Producto</th>
            <th>Unidades</th>
            <th>Existencias Restantes</th>
            <th>Notas</th>
          </tr>
        </thead>
        <tbody id="inventoryHistoryTable"></tbody>
      </table>
    </div>

    <!-- Tab: Usuarios -->
    <div id="tab-users" class="tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h2 style="margin:0;">Todos los Usuarios</h2>
        <button id="bulkRoleBtn" class="btn-primary">Cambiar Role a Todos</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Nombre</th>
            <th>Email</th>
            <th>Tipo</th>
            <th>Puntos</th>
            <th>Registro</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="usersTable"></tbody>
      </table>
    </div>

    <!-- Tab: Productos -->
    <div id="tab-products" class="tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px;">
        <h2 style="margin:0;">Gesti√≥n de Productos</h2>
        <button id="addProductBtn" class="btn-success">+ Crear Producto</button>
      </div>

      <!-- Preview Selector -->
      <div style="background:white;padding:16px;border-radius:8px;margin-bottom:20px;">
        <label style="font-weight:600;margin-right:12px;">Vista previa para:</label>
        <select id="previewTypeSelector" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
          <option value="distribuidor">Distribuidores</option>
          <option value="restaurante">Restaurantes</option>
          <option value="cliente">Clientes</option>
        </select>
      </div>

      <!-- Products Grid Preview -->
      <div id="productsPreviewGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;margin-bottom:30px;">
        <!-- Product cards will be rendered here -->
      </div>

      <!-- Products Management Table -->
      <h3>Administraci√≥n de Productos</h3>
      <table>
        <thead>
          <tr>
            <th>Imagen</th>
            <th>Nombre</th>
            <th>Descripci√≥n</th>
            <th>Categor√≠a</th>
            <th>Precio Dist.</th>
            <th>Precio Cliente</th>
            <th>Precio Rest.</th>
            <th>Unidades Vendidas</th>
            <th>Destacado</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="productsManagementTable"></tbody>
      </table>
    </div>

    <!-- Tab: Categories -->
    <div id="tab-categories" class="tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px;">
        <h2 style="margin:0;">Gesti√≥n de Categor√≠as</h2>
        <button id="addCategoryBtn" class="btn-success">+ Crear Categor√≠a</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Slug</th>
            <th>Productos</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="categoriesTable">
          <!-- Categories will be rendered here -->
        </tbody>
      </table>
    </div>

    <!-- Tab: Calculadora de Puntos -->
    <div id="tab-calculator" class="tab-content">
      <div style="max-width:900px;margin:0 auto;">
        <h2 style="margin-bottom:8px;">Calculadora de Puntos y Comisiones</h2>
        <p style="color:#666;margin-bottom:24px;">Simula c√≥mo se distribuir√°n los puntos y comisiones en la red antes de confirmar cualquier orden.</p>

        <div style="background:white;padding:24px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:24px;">
          <h3 style="margin-top:0;border-bottom:2px solid #007bff;padding-bottom:8px;margin-bottom:20px;">Datos de la Compra</h3>

          <div style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:6px;font-weight:500;">Comprador</label>
            <select id="calcBuyer" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;">
              <option value="">Seleccionar usuario...</option>
            </select>
          </div>

          <div style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:6px;font-weight:500;">Producto</label>
            <select id="calcProduct" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;">
              <option value="">Seleccionar producto...</option>
            </select>
          </div>

          <div style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:6px;font-weight:500;">Cantidad</label>
            <input type="number" id="calcQuantity" min="1" value="1" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;">
          </div>

          <div style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:6px;font-weight:500;">
              <input type="checkbox" id="calcIsFirstPurchase" style="margin-right:6px;">
              Marcar como primera compra (para Quick Start Bonus)
            </label>
            <p style="font-size:12px;color:#666;margin:4px 0 0 24px;">Solo aplicable para distribuidores que compran 50+ puntos por primera vez</p>
          </div>

          <button id="calcCalculateBtn" class="btn-primary" style="width:100%;padding:12px;font-size:16px;font-weight:600;">
            Calcular Distribuci√≥n
          </button>
        </div>

        <div id="calcResults" style="display:none;">
          <div style="background:white;padding:24px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:16px;">
            <h3 style="margin-top:0;border-bottom:2px solid #28a745;padding-bottom:8px;margin-bottom:20px;">Resumen de la Compra</h3>
            <div id="calcSummary"></div>
          </div>

          <div style="background:white;padding:24px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
            <h3 style="margin-top:0;border-bottom:2px solid #764ba2;padding-bottom:8px;margin-bottom:20px;">Distribuci√≥n de Comisiones</h3>
            <div id="calcDistribution"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para agregar inventario -->
  <div id="inventoryModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:white;padding:30px;border-radius:8px;max-width:500px;width:90%;">
      <h3 style="margin-top:0;">Agregar Unidades al Inventario</h3>
      <form id="addInventoryForm">
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;">Producto</label>
          <select id="inventoryProductId" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;">
            <option value="">Seleccionar producto...</option>
            <!-- Products will be loaded dynamically from database -->
          </select>
        </div>
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;">Unidades a agregar</label>
          <input type="number" id="inventoryUnits" required min="1" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;" placeholder="Ej: 50">
        </div>
        <div style="margin-bottom:20px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;">Notas (opcional)</label>
          <textarea id="inventoryNotes" rows="3" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;" placeholder="Ej: Llegada de nueva compra, proveedor XYZ"></textarea>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button type="button" id="inventoryModalCancel" class="btn-secondary">Cancelar</button>
          <button type="submit" class="btn-success">Agregar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para seleccionar role -->
  <div id="roleModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:white;padding:30px;border-radius:8px;max-width:400px;width:90%;">
      <h3 id="roleModalTitle" style="margin-top:0;">Seleccionar Role</h3>
      <p id="roleModalDescription" style="color:#666;margin-bottom:20px;"></p>
      <select id="roleSelect" style="width:100%;padding:10px;margin-bottom:20px;font-size:14px;border:1px solid #ddd;border-radius:4px;">
        <option value="admin">Admin</option>
        <option value="distribuidor">Distribuidor</option>
        <option value="cliente">Cliente</option>
        <option value="restaurante">Restaurante</option>
        <option value="proveedor">Proveedor</option>
      </select>
      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button id="roleModalCancel" class="btn-secondary">Cancelar</button>
        <button id="roleModalConfirm" class="btn-primary">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Modal para crear/editar categor√≠a -->
  <div id="categoryModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:white;padding:30px;border-radius:8px;max-width:500px;width:90%;">
      <h3 id="categoryModalTitle" style="margin-top:0;">Crear Categor√≠a</h3>
      <form id="categoryForm">
        <input type="hidden" id="categoryEditId">
        
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;">Nombre de la Categor√≠a</label>
          <input type="text" id="categoryName" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;" placeholder="Ej: Carnes, Bebidas, Alimentos">
        </div>
        
        <div style="margin-bottom:20px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;">Slug (ID √∫nico)</label>
          <input type="text" id="categorySlug" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;" placeholder="Ej: carnes, bebidas, alimentos">
          <small style="color:#666;font-size:12px;display:block;margin-top:4px;">Use solo min√∫sculas, n√∫meros y guiones. Este valor se usar√° internamente.</small>
        </div>
        
        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button type="button" id="categoryModalCancel" class="btn-secondary">Cancelar</button>
          <button type="submit" class="btn-success">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para ver √≥rdenes de un producto -->
  <div id="productOrdersModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;overflow-y:auto;">
    <div style="background:white;padding:30px;border-radius:8px;max-width:800px;width:90%;margin:40px auto;max-height:80vh;overflow-y:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:2px solid #e9ecef;padding-bottom:12px;">
        <h3 id="productOrdersModalTitle" style="margin:0;">√ìrdenes del Producto</h3>
        <button id="productOrdersModalClose" style="background:transparent;border:none;font-size:28px;cursor:pointer;color:#666;line-height:1;">&times;</button>
      </div>

      <div id="productOrdersContent">
        <!-- Content will be loaded dynamically -->
      </div>
    </div>
  </div>

  <!-- Modal para crear/editar producto -->
  <div id="productModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;overflow-y:auto;">
    <div style="background:white;padding:30px;border-radius:8px;max-width:700px;width:90%;margin:40px auto;">
      <h3 id="productModalTitle" style="margin-top:0;">Crear Producto</h3>
      <form id="productForm">
        <input type="hidden" id="productEditId">
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
          <div>
            <label style="display:block;margin-bottom:6px;font-weight:500;">Nombre del Producto *</label>
            <input type="text" id="productName" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;" placeholder="Ej: Chuletas - 3 kg">
          </div>
          
          <div>
            <label style="display:block;margin-bottom:6px;font-weight:500;">ID del Producto *</label>
            <input type="text" id="productId" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;" placeholder="Ej: chuletas-3kg">
          </div>
        </div>

        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;">Descripci√≥n</label>
          <textarea id="productDescription" rows="2" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;" placeholder="Descripci√≥n del producto"></textarea>
        </div>

        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;">URL de la Imagen</label>
          <input type="text" id="productImage" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;" placeholder="/images/productos/producto.jpg">
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:16px;">
          <div>
            <label style="display:block;margin-bottom:6px;font-weight:500;">Precio Distribuidor</label>
            <input type="number" id="productPriceDistributor" min="0" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;" placeholder="60000">
          </div>
          
          <div>
            <label style="display:block;margin-bottom:6px;font-weight:500;">Precio Cliente</label>
            <input type="number" id="productPriceClient" min="0" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;" placeholder="75000">
          </div>
          
          <div>
            <label style="display:block;margin-bottom:6px;font-weight:500;">Precio Restaurante</label>
            <input type="number" id="productPriceRestaurant" min="0" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;" placeholder="20000">
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
          <div>
            <label style="display:block;margin-bottom:6px;font-weight:500;">Puntos para Distribuidores</label>
            <input type="number" id="productPointsDistributor" step="any" min="0" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;" placeholder="2.5">
            <small style="color:#666;font-size:12px;">Puntos que genera este producto para distribuidores</small>
          </div>

          <div>
            <label style="display:block;margin-bottom:6px;font-weight:500;">Puntos para Restaurantes</label>
            <input type="number" id="productPointsRestaurant" step="any" min="0" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;" placeholder="3.333">
            <small style="color:#666;font-size:12px;">Puntos por kilo/unidad para restaurantes</small>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
          <div>
            <label style="display:block;margin-bottom:6px;font-weight:500;">Unidad</label>
            <select id="productUnit" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;">
              <option value="paquete">Paquete</option>
              <option value="kilo">Kilo</option>
              <option value="unidad">Unidad</option>
            </select>
          </div>

          <div>
            <label style="display:block;margin-bottom:6px;font-weight:500;">Categor√≠a</label>
            <select id="productCategory" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;">
              <option value="carnes">Carnes</option>
              <option value="bebidas">Bebidas</option>
              <option value="alimentos">Alimentos</option>
              <option value="aseo">Aseo</option>
              <option value="higiene-personal">Higiene Personal</option>
              <option value="abarrotes">Abarrotes</option>
            </select>
          </div>
        </div>

        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;">Disponible para:</label>
          <div style="display:flex;gap:16px;">
            <label style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="productAvailDistributor" value="distribuidor">
              <span>Distribuidores</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="productAvailClient" value="cliente">
              <span>Clientes</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="productAvailRestaurant" value="restaurante">
              <span>Restaurantes</span>
            </label>
          </div>
        </div>

        <div style="margin-bottom:20px;">
          <label style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="productHidden">
            <span style="font-weight:500;">Ocultar producto (no visible para usuarios)</span>
          </label>
        </div>

        <div style="margin-bottom:20px;">
          <label style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="productOutOfStock">
            <span style="font-weight:500;">Marcar como agotado</span>
          </label>
        </div>

        <div style="margin-bottom:20px;">
          <label style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="productFeatured">
            <span style="font-weight:500;">‚≠ê Destacar (aparece de primero en oficina virtual)</span>
          </label>
        </div>

        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button type="button" id="productModalCancel" class="btn-secondary">Cancelar</button>
          <button type="submit" class="btn-success">Guardar Producto</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { doc, getDoc, collection, getDocs, query, where, orderBy, limit, updateDoc, runTransaction, addDoc, setDoc, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    import { auth, db } from "/src/firebase-config.js";

    const loginSection = document.getElementById("loginSection");
    const adminPanel = document.getElementById("adminPanel");
    const loginForm = document.getElementById("loginForm");
    const logoutBtn = document.getElementById("logoutBtn");

    let currentUser = null;

    // Tab switching
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabId = btn.dataset.tab;
        
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        btn.classList.add('active');
        document.getElementById(`tab-${tabId}`).classList.add('active');
      });
    });

    // Login
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        alert("Error en login: " + err.message);
      }
    });

    // Logout
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    // Chequear estado del usuario
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          console.log("üîê Usuario autenticado:", user.uid, user.email);
          
          const userDoc = await getDoc(doc(db, "usuarios", user.uid));
          if (!userDoc.exists()) {
            console.error("‚ùå Documento de usuario no existe en Firestore para UID:", user.uid);
            alert("Acceso denegado. Usuario no encontrado en la base de datos.\nUID: " + user.uid);
            await signOut(auth);
            return;
          }
          
          const userData = userDoc.data();
          console.log("üë§ Datos del usuario:", JSON.stringify(userData, null, 2));
          
          const userRole = userData.role || userData.rol;
          console.log("üé≠ Rol detectado:", userRole);
          
          if (userRole !== "admin") {
            console.error("‚ùå Usuario no es admin. Rol actual:", userRole);
            alert("Acceso denegado. No eres administrador.\nRol actual: " + (userRole || "sin rol"));
            await signOut(auth);
            return;
          }

          console.log("‚úÖ Acceso admin concedido");
          currentUser = user;
          loginSection.classList.add("hidden");
          adminPanel.classList.remove("hidden");
          
          await loadAllData();
        } catch (error) {
          console.error("‚ùå Error en verificaci√≥n de usuario:", error);
          alert("Error verificando permisos: " + error.message);
          await signOut(auth);
        }
      } else {
        loginSection.classList.remove("hidden");
        adminPanel.classList.add("hidden");
      }
    });

    // Cargar todos los datos
    async function loadAllData() {
      await Promise.all([
        loadOrders(),
        loadDistributors(),
        loadClients(),
        loadUsers(),
        loadPayouts(),
        loadStats(),
        loadInventory(),
        loadProducts(),
        loadCategories()
      ]);
    }

    let allProducts = [];

    // Cargar estad√≠sticas
    async function loadStats() {
      try {
        const ordersSnap = await getDocs(collection(db, "orders"));
        const orders = ordersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        // Fetch missing usernames for orders in recent activity
        const usersCache = new Map();
        for (const order of orders.slice(0, 10)) {
          if (order.buyerUid && !order.buyerUsername && !usersCache.has(order.buyerUid)) {
            try {
              const userDoc = await getDoc(doc(db, "usuarios", order.buyerUid));
              if (userDoc.exists()) {
                const userData = userDoc.data();
                order.buyerUsername = userData.usuario || userData.nombre || 'Usuario desconocido';
                usersCache.set(order.buyerUid, order.buyerUsername);
              }
            } catch (err) {
              console.warn('Error fetching user for recent order:', order.id, err);
            }
          } else if (order.buyerUid && usersCache.has(order.buyerUid)) {
            order.buyerUsername = usersCache.get(order.buyerUid);
          }
        }
        
        const pending = orders.filter(o => o.status === 'pending' || o.status === 'pending_delivery');
        const confirmed = orders.filter(o => o.status === 'confirmed');
        const rejected = orders.filter(o => o.status === 'rejected');
        
        const totalSales = confirmed.reduce((sum, o) => sum + (Number(o.price) || 0), 0);
        
        const usersSnap = await getDocs(collection(db, "usuarios"));
        const users = usersSnap.docs.map(d => d.data());
        const distributors = users.filter(u => u.role === 'distribuidor' || u.tipoRegistro === 'distribuidor' || (!u.role && !u.tipoRegistro));
        
        document.getElementById('totalSales').textContent = `$${totalSales.toLocaleString()}`;
        document.getElementById('confirmedCount').textContent = confirmed.length;
        document.getElementById('pendingCount').textContent = pending.length;
        document.getElementById('rejectedCount').textContent = rejected.length;
        document.getElementById('distributorsCount').textContent = distributors.length;
        document.getElementById('usersCount').textContent = users.length;
        
        // Recent activity
        const recentOrders = orders.slice(0, 10);
        const recentTable = document.getElementById('recentActivity');
        recentTable.innerHTML = '';
        
        if (recentOrders.length === 0) {
          recentTable.innerHTML = '<tr><td colspan="4" class="empty-state">No hay actividad reciente</td></tr>';
        } else {
          recentOrders.forEach(order => {
            const row = document.createElement('tr');
            const statusColor = order.status === 'confirmed' ? '#28a745' : order.status === 'rejected' ? '#dc3545' : '#fd7e14';
            const userId = order.buyerUid ? order.buyerUid.substring(0, 8) + '...' : 'N/A';
            const username = order.buyerUsername || 'N/A';
            row.innerHTML = `
              <td>${order.productName || 'N/A'}</td>
              <td><code style="font-size:0.85em;color:#666">${userId}</code><br><strong>${username}</strong></td>
              <td>$${(order.price || 0).toLocaleString()}</td>
              <td><span style="color:${statusColor};font-weight:600">${order.status}</span></td>
            `;
            recentTable.appendChild(row);
          });
        }
      } catch (err) {
        console.error('Error loading stats:', err);
      }
    }

    // Cargar √≥rdenes
    async function loadOrders() {
      try {
        const ordersSnap = await getDocs(collection(db, "orders"));
        const orders = ordersSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        // Fetch missing usernames for orders that don't have buyerUsername
        const usersCache = new Map();
        for (const order of orders) {
          if (order.buyerUid && !order.buyerUsername && !usersCache.has(order.buyerUid)) {
            try {
              const userDoc = await getDoc(doc(db, "usuarios", order.buyerUid));
              if (userDoc.exists()) {
                const userData = userDoc.data();
                order.buyerUsername = userData.usuario || userData.nombre || 'Usuario desconocido';
                usersCache.set(order.buyerUid, {
                  username: order.buyerUsername,
                  nombre: userData.nombre || '',
                  usuario: userData.usuario || ''
                });
              }
            } catch (err) {
              console.warn('Error fetching user for order:', order.id, err);
            }
          } else if (order.buyerUid && usersCache.has(order.buyerUid)) {
            order.buyerUsername = usersCache.get(order.buyerUid).username;
          }
        }

        // Don't filter out any orders - show all including test users
        const filteredOrders = orders;

        const pending = filteredOrders.filter(o => o.status === 'pending' || o.status === 'pending_delivery').sort((a, b) => a.id.localeCompare(b.id));
        const confirmed = filteredOrders.filter(o => o.status === 'confirmed');
        const rejected = filteredOrders.filter(o => o.status === 'rejected');

        renderOrderTable('pendingOrdersTable', pending, true);
        renderOrderTable('confirmedOrdersTable', confirmed, false);
        renderOrderTable('rejectedOrdersTable', rejected, false);
      } catch (err) {
        console.error('Error loading orders:', err);
      }
    }

    function renderOrderTable(tableId, orders, showActions) {
      const table = document.getElementById(tableId);
      table.innerHTML = '';
      
      if (orders.length === 0) {
        table.innerHTML = `<tr><td colspan="${showActions ? 7 : 6}" class="empty-state">No hay √≥rdenes</td></tr>`;
        return;
      }
      
      orders.forEach(order => {
        const row = document.createElement('tr');
        const date = order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
        const quantity = Number(order.quantity) || 1;
        
        if (showActions) {
          const totalPrice = Number(order.totalPrice) || Number(order.priceTotal) || (Number(order.price) * quantity) || 0;
          row.innerHTML = `
            <td><code>${order.id.substring(0, 12)}...</code></td>
            <td><strong>${order.buyerUsername || order.buyerUid || 'N/A'}</strong></td>
            <td>${order.productName || 'N/A'}</td>
            <td><strong>x${quantity}</strong></td>
            <td>$${totalPrice.toLocaleString()}</td>
            <td>${order.status}</td>
            <td>
              <button class="btn-success" onclick="confirmOrder('${order.id}')">Confirmar</button>
              <button class="btn-danger" onclick="rejectOrder('${order.id}')">Rechazar</button>
            </td>
          `;
        } else if (tableId === 'confirmedOrdersTable') {
          const userId = order.buyerUid ? order.buyerUid.substring(0, 8) + '...' : 'N/A';
          const username = order.buyerUsername || 'N/A';
          const totalPrice = Number(order.totalPrice) || Number(order.priceTotal) || (Number(order.price) * quantity) || 0;
          const totalPoints = Number(order.totalPoints) || Number(order.pointsTotal) || (Number(order.points) * quantity) || 0;
          row.innerHTML = `
            <td><code>${order.id.substring(0, 12)}...</code></td>
            <td><code style="font-size:0.85em;color:#666">${userId}</code></td>
            <td><strong>${username}</strong></td>
            <td>${order.productName || 'N/A'}</td>
            <td>$${totalPrice.toLocaleString()}</td>
            <td>${totalPoints} pts</td>
            <td>
              <button class="btn-danger" onclick="deleteOrder('${order.id}')">Eliminar</button>
            </td>
          `;
        } else {
          const totalPrice = Number(order.totalPrice) || Number(order.priceTotal) || (Number(order.price) * quantity) || 0;
          row.innerHTML = `
            <td>${date}</td>
            <td>${order.id.substring(0, 8)}...</td>
            <td>${order.productName || 'N/A'}</td>
            <td>${order.buyerUsername || order.buyerUid || 'N/A'}</td>
            <td>$${totalPrice.toLocaleString()}</td>
            <td>${order.rejectionReason || 'N/A'}</td>
          `;
        }
        
        table.appendChild(row);
      });
    }

    let allDistributors = [];
    
    // Cargar distribuidores
    async function loadDistributors() {
      try {
        const usersSnap = await getDocs(collection(db, "usuarios"));
        allDistributors = usersSnap.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(u => (u.role === 'distribuidor' || u.tipoRegistro === 'distribuidor' || (!u.role && !u.tipoRegistro)));
        
        renderDistributorsTable(allDistributors);
        
        // Attach search event listener after loading distributors
        const searchInput = document.getElementById('distributorSearchInput');
        if (searchInput && !searchInput.dataset.listenerAttached) {
          searchInput.dataset.listenerAttached = 'true';
          searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (!searchTerm) {
              renderDistributorsTable(allDistributors);
              return;
            }
            
            const filtered = allDistributors.filter(dist => {
              const nombre = (dist.nombre || '').toLowerCase();
              const usuario = (dist.usuario || '').toLowerCase();
              const cedula = (dist.cedula || '').toLowerCase();
              const email = (dist.email || '').toLowerCase();
              
              return nombre.includes(searchTerm) || 
                     usuario.includes(searchTerm) || 
                     cedula.includes(searchTerm) ||
                     email.includes(searchTerm);
            });
            
            renderDistributorsTable(filtered);
          });
        }
      } catch (err) {
        console.error('Error loading distributors:', err);
      }
    }
    
    function renderDistributorsTable(distributors) {
      const table = document.getElementById('distributorsTable');
      table.innerHTML = '';
      
      if (distributors.length === 0) {
        table.innerHTML = '<tr><td colspan="9" class="empty-state">No hay distribuidores</td></tr>';
        return;
      }
      
      const referralCounts = {};
      allDistributors.forEach(dist => {
        const sponsor = dist.patrocinador;
        if (sponsor) {
          referralCounts[sponsor] = (referralCounts[sponsor] || 0) + 1;
        }
      });
      
      distributors.forEach(dist => {
        const row = document.createElement('tr');
        const date = dist.createdAt ? new Date(dist.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
        const personalPoints = dist.personalPoints || dist.puntos || 0;
        const groupPoints = dist.groupPoints || 0;
        const referralCount = referralCounts[dist.usuario] || 0;
        
        const isActive = checkIfUserActiveThisMonth(dist);
        const statusBadge = isActive 
          ? '<span style="background:#10b981;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;">‚úì Activo</span>'
          : '<span style="background:#ef4444;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;">‚ö† Inactivo</span>';
        
        row.innerHTML = `
          <td>${dist.usuario || 'N/A'}</td>
          <td>${dist.nombre || 'N/A'}</td>
          <td>${dist.email || 'N/A'}</td>
          <td>${dist.celular || 'N/A'}</td>
          <td>${statusBadge}</td>
          <td><strong>${personalPoints}</strong></td>
          <td><strong>${groupPoints}</strong></td>
          <td>${date}</td>
          <td><button class="btn-primary" onclick="showDistributorDetails('${dist.id}')">Ver <span style="font-size:16px;">‚Üí</span></button></td>
        `;
        table.appendChild(row);
      });
    }

    // Cargar clientes
    async function loadClients() {
      try {
        const usersSnap = await getDocs(collection(db, "usuarios"));
        const clients = usersSnap.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(u => u.role === 'cliente' || u.tipoRegistro === 'cliente');
        
        const table = document.getElementById('clientsTable');
        table.innerHTML = '';
        
        if (clients.length === 0) {
          table.innerHTML = '<tr><td colspan="6" class="empty-state">No hay clientes</td></tr>';
          return;
        }
        
        clients.forEach(client => {
          const row = document.createElement('tr');
          const date = client.createdAt ? new Date(client.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
          row.innerHTML = `
            <td>${client.usuario || 'N/A'}</td>
            <td>${client.nombre || 'N/A'}</td>
            <td>${client.email || 'N/A'}</td>
            <td>${client.celular || 'N/A'}</td>
            <td>${client.puntos || client.personalPoints || 0}</td>
            <td>${date}</td>
          `;
          table.appendChild(row);
        });
      } catch (err) {
        console.error('Error loading clients:', err);
      }
    }

    // Cargar todos los usuarios
    async function loadUsers() {
      try {
        const usersSnap = await getDocs(collection(db, "usuarios"));
        const users = usersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        const table = document.getElementById('usersTable');
        table.innerHTML = '';
        
        if (users.length === 0) {
          table.innerHTML = '<tr><td colspan="7" class="empty-state">No hay usuarios</td></tr>';
          return;
        }
        
        users.forEach(user => {
          const row = document.createElement('tr');
          const date = user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
          const userRole = user.role || user.rol || user.tipoRegistro || 'distribuidor';
          const tipo = userRole === 'admin' ? 'Admin' : (userRole === 'distribuidor' ? 'Distribuidor' : (userRole === 'cliente' ? 'Cliente' : (userRole === 'restaurante' ? 'Restaurante' : 'Usuario')));
          row.innerHTML = `
            <td>${user.usuario || 'N/A'}</td>
            <td>${user.nombre || 'N/A'}</td>
            <td>${user.email || 'N/A'}</td>
            <td>${tipo}</td>
            <td>${user.puntos || user.personalPoints || 0}</td>
            <td>${date}</td>
            <td>
              <button class="btn-primary" onclick="editUserRole('${user.id}', '${userRole}', '${user.usuario || user.nombre || 'Usuario'}')">Editar Role</button>
            </td>
          `;
          table.appendChild(row);
        });
      } catch (err) {
        console.error('Error loading users:', err);
      }
    }

    // Confirmar / Rechazar
    window.confirmOrder = async function(orderId) {
      if (!currentUser) return;
      try {
        const token = await currentUser.getIdToken();
        const res = await fetch("/.netlify/functions/confirm-order", {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ orderId, action: 'confirm' })
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          console.error("Error confirmando orden:", data);
          alert("Error confirmando orden:\n\n" + (data.error || "Error desconocido") + 
                (data.details ? "\n\nDetalles: " + data.details : ""));
          return;
        }
        alert("Orden confirmada ‚úÖ");
        await loadAllData();
      } catch (err) {
        console.error("Error en confirmOrder:", err);
        alert("Error confirmando orden: " + err.message);
      }
    };

    window.rejectOrder = async function(orderId) {
      if (!currentUser) return;
      const reason = prompt("Motivo del rechazo (opcional):");
      const token = await currentUser.getIdToken();
      const res = await fetch("/.netlify/functions/confirm-order", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ orderId, action: 'reject', rejectionReason: reason })
      });
      if (!res.ok) {
        alert("Error rechazando: " + res.status);
        return;
      }
      alert("Orden rechazada ‚ùå");
      await loadAllData();
    };

    // Eliminar orden confirmada
    window.deleteOrder = async function(orderId) {
      if (!currentUser) return;
      const confirmDelete = confirm("¬øEst√°s seguro de que deseas eliminar esta orden? Esta acci√≥n no se puede deshacer.");
      if (!confirmDelete) return;
      
      try {
        const token = await currentUser.getIdToken();
        // Usar updateDoc para marcar como eliminada en lugar de borrar f√≠sicamente
        const orderRef = doc(db, "orders", orderId);
        await updateDoc(orderRef, {
          status: 'deleted',
          deletedAt: new Date().toISOString(),
          deletedBy: currentUser.uid
        });
        alert("Orden eliminada ‚úÖ");
        await loadAllData();
      } catch (err) {
        console.error('Error deleting order:', err);
        alert("Error eliminando la orden: " + err.message);
      }
    };

    // Cargar cobros pendientes de distribuidores
    async function loadPayouts() {
      try {
        const payoutsSnap = await getDocs(collection(db, "payouts"));
        // Filtrar solo los payouts que NO est√°n pagados
        const payouts = payoutsSnap.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(p => p.status !== 'paid');
        
        console.log('Payouts loaded:', payouts.length, payouts);
        
        const table = document.getElementById('payoutsTable');
        table.innerHTML = '';
        
        if (payouts.length === 0) {
          table.innerHTML = '<tr><td colspan="5" class="empty-state">No hay cobros pendientes</td></tr>';
          return;
        }
        
        // Obtener informaci√≥n de usuarios para mostrar nombres
        const usersMap = new Map();
        for (const payout of payouts) {
          if (payout.userId && !usersMap.has(payout.userId)) {
            try {
              const userDoc = await getDoc(doc(db, "usuarios", payout.userId));
              if (userDoc.exists()) {
                usersMap.set(payout.userId, userDoc.data());
              }
            } catch (err) {
              console.error('Error loading user:', err);
            }
          }
        }
        
        payouts.forEach(payout => {
          const row = document.createElement('tr');
          const userData = usersMap.get(payout.userId) || {};
          const userName = userData.nombre || userData.usuario || 'Desconocido';
          const date = payout.createdAt ? (payout.createdAt.seconds ? new Date(payout.createdAt.seconds * 1000).toLocaleDateString() : new Date(payout.createdAt).toLocaleDateString()) : 'N/A';
          const status = payout.status || 'scheduled';
          const statusText = 'Pendiente';
          const statusColor = '#fd7e14';
          
          row.innerHTML = `
            <td>${userName} (${userData.usuario || payout.userId})</td>
            <td>$${(payout.amount || 0).toLocaleString()}</td>
            <td>${date}</td>
            <td><span style="color:${statusColor};font-weight:600">${statusText}</span></td>
            <td>
              <button class="btn-success" onclick="acceptPayout('${payout.id}', '${payout.userId}', ${payout.amount})">Aceptar y Pagar</button>
            </td>
          `;
          table.appendChild(row);
        });
      } catch (err) {
        console.error('Error loading payouts:', err);
      }
    }

    // Aceptar y pagar cobro (marca como pagado para evitar doble pago)
    window.acceptPayout = async function(payoutId, userId, amount) {
      if (!currentUser) return;
      const confirmPay = confirm(`¬øConfirmar pago de $${amount.toLocaleString()} al distribuidor?`);
      if (!confirmPay) return;
      
      try {
        // Actualizar el estado del payout a 'paid'
        const payoutRef = doc(db, "payouts", payoutId);
        await updateDoc(payoutRef, {
          status: 'paid',
          paidAt: new Date().toISOString(),
          paidBy: currentUser.uid
        });
        
        // El monto ya fue descontado de balance cuando el distribuidor solicit√≥ el cobro
        // Ahora que el admin aprueba el pago, actualizamos:
        // 1. Descontamos de walletBalance (ya que se est√° pagando f√≠sicamente)
        // 2. Incrementamos totalComisionesCobradas (para llevar registro del total pagado)
        const userRef = doc(db, "usuarios", userId);
        await runTransaction(db, async (tx) => {
          const userSnap = await tx.get(userRef);
          if (!userSnap.exists()) {
            throw new Error("Usuario no encontrado");
          }
          const userData = userSnap.data();
          const currentWallet = Number(userData.walletBalance ?? 0);
          const currentCobradas = Number(userData.totalComisionesCobradas ?? 0);
          
          // Descontar de wallet y sumar a comisiones cobradas
          const newWallet = currentWallet - amount;
          const newCobradas = currentCobradas + amount;
          
          tx.update(userRef, {
            walletBalance: newWallet,
            totalComisionesCobradas: newCobradas
          });
        });
        
        alert("Pago confirmado exitosamente ‚úÖ");
        await loadAllData();
      } catch (err) {
        console.error('Error processing payout:', err);
        alert("Error procesando el pago: " + err.message);
      }
    };

    // Role management variables
    let roleModalTarget = null;
    let roleModalMode = 'single';
    
    const roleModal = document.getElementById('roleModal');
    const roleModalTitle = document.getElementById('roleModalTitle');
    const roleModalDescription = document.getElementById('roleModalDescription');
    const roleSelect = document.getElementById('roleSelect');
    const roleModalCancel = document.getElementById('roleModalCancel');
    const roleModalConfirm = document.getElementById('roleModalConfirm');
    const bulkRoleBtn = document.getElementById('bulkRoleBtn');

    // Edit individual user role
    window.editUserRole = async function(userId, currentRole, userName) {
      roleModalTarget = userId;
      roleModalMode = 'single';
      roleModalTitle.textContent = 'Editar Role de Usuario';
      roleModalDescription.textContent = `Cambiando role para: ${userName}`;
      roleSelect.value = currentRole || 'distribuidor';
      roleModal.style.display = 'flex';
    };

    // Bulk role change
    bulkRoleBtn.addEventListener('click', () => {
      roleModalTarget = null;
      roleModalMode = 'bulk';
      roleModalTitle.textContent = 'Cambiar Role a Todos los Usuarios';
      roleModalDescription.textContent = 'Esta acci√≥n cambiar√° el role de TODOS los usuarios en el sistema.';
      roleSelect.value = 'distribuidor';
      roleModal.style.display = 'flex';
    });

    // Cancel modal
    roleModalCancel.addEventListener('click', () => {
      roleModal.style.display = 'none';
      roleModalTarget = null;
    });

    // Close modal on background click
    roleModal.addEventListener('click', (e) => {
      if (e.target === roleModal) {
        roleModal.style.display = 'none';
        roleModalTarget = null;
      }
    });

    // Confirm role change
    roleModalConfirm.addEventListener('click', async () => {
      const selectedRole = roleSelect.value;

      try {
        if (roleModalMode === 'single' && roleModalTarget) {
          const userRef = doc(db, "usuarios", roleModalTarget);
          await updateDoc(userRef, {
            role: selectedRole,
            rol: selectedRole
          });
          alert('Role actualizado exitosamente ‚úÖ');
        } else if (roleModalMode === 'bulk') {
          const usersSnap = await getDocs(collection(db, "usuarios"));
          const updatePromises = usersSnap.docs.map(userDoc => {
            const userRef = doc(db, "usuarios", userDoc.id);
            return updateDoc(userRef, {
              role: selectedRole,
              rol: selectedRole
            });
          });

          await Promise.all(updatePromises);
          alert(`Role actualizado para ${usersSnap.docs.length} usuarios ‚úÖ`);
        }

        roleModal.style.display = 'none';
        roleModalTarget = null;
        await loadAllData();
      } catch (err) {
        console.error('Error updating role:', err);
        alert('Error actualizando role: ' + err.message);
      }
    });

    // Distributor details panel management
    window.showDistributorDetails = async function(distributorId) {
      try {
        const distDoc = await getDoc(doc(db, 'usuarios', distributorId));
        if (!distDoc.exists()) {
          alert('Distribuidor no encontrado');
          return;
        }
        
        const dist = distDoc.data();
        const personalPoints = dist.personalPoints || dist.puntos || 0;
        const groupPoints = dist.groupPoints || 0;
        const balance = dist.balance || 0;
        const walletBalance = dist.walletBalance || 0;
        const totalComisionesCobradas = dist.totalComisionesCobradas || 0;
        
        // Count referrals
        const usersSnap = await getDocs(collection(db, 'usuarios'));
        const referrals = usersSnap.docs.filter(d => {
          const userData = d.data();
          return userData.patrocinador === dist.usuario;
        });
        
        // Get orders history
        const ordersSnap = await getDocs(query(
          collection(db, 'orders'),
          where('buyerUid', '==', distributorId)
        ));
        const orders = ordersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        // Get history from user document
        const history = dist.history || [];
        
        // Calculate current month commissions
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();
        const monthStart = new Date(currentYear, currentMonth, 1);
        const monthEnd = new Date(currentYear, currentMonth + 1, 0, 23, 59, 59, 999);
        
        // Total earned this month from transaction history
        const commissionHistory = history.filter(h => 
          h.type !== 'purchase' && 
          !(h.action || '').includes('Compra confirmada') &&
          h.date
        );
        
        let totalEarnedThisMonth = 0;
        let earnedPointsThisMonth = 0;
        const thisMonthTransactions = [];
        
        commissionHistory.forEach(h => {
          const transactionDate = new Date(h.date);
          if (transactionDate >= monthStart && transactionDate <= monthEnd) {
            totalEarnedThisMonth += (h.amount || 0);
            earnedPointsThisMonth += (h.points || 0);
            thisMonthTransactions.push(h);
          }
        });
        
        // Already collected this month from payouts
        const payoutsSnap = await getDocs(query(
          collection(db, 'payouts'),
          where('userId', '==', distributorId),
          where('status', '==', 'paid')
        ));
        
        let alreadyCollectedThisMonth = 0;
        let collectedPayoutsCount = 0;
        
        payoutsSnap.docs.forEach(doc => {
          const payout = doc.data();
          let paidDate = null;
          
          if (payout.paidAt) {
            if (typeof payout.paidAt === 'string') {
              paidDate = new Date(payout.paidAt);
            } else if (payout.paidAt.seconds) {
              paidDate = new Date(payout.paidAt.seconds * 1000);
            }
          }
          
          if (paidDate && paidDate >= monthStart && paidDate <= monthEnd) {
            alreadyCollectedThisMonth += (payout.amount || 0);
            collectedPayoutsCount++;
          }
        });
        
        // Pending amount from balance field
        const pendingAmount = balance;
        
        // Check if user is active this month
        const isActiveThisMonth = checkIfUserActiveThisMonth(dist);
        const activeStatusBadge = isActiveThisMonth 
          ? '<span style="background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:white;padding:4px 12px;border-radius:16px;font-size:12px;font-weight:600;">‚úì Activo este mes</span>'
          : '<span style="background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:white;padding:4px 12px;border-radius:16px;font-size:12px;font-weight:600;">‚ö† Inactivo este mes</span>';
        
        const contentDiv = document.getElementById('distributorDetailsContent');
        contentDiv.innerHTML = `
          <div style="background:#f8f9fa;padding:16px;border-radius:8px;margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
              <h3 style="margin:0;font-size:18px;color:#333;">${dist.nombre || dist.usuario || 'Sin nombre'}</h3>
              ${activeStatusBadge}
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px;">
              <div><strong>C√≥digo:</strong> ${dist.usuario || 'N/A'}</div>
              <div><strong>Email:</strong> ${dist.email || 'N/A'}</div>
              <div><strong>Celular:</strong> ${dist.celular || 'N/A'}</div>
              <div><strong>Patrocinador:</strong> ${dist.patrocinador || 'Ninguno'}</div>
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:12px;margin-bottom:24px;">
            <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:16px;border-radius:8px;">
              <div style="font-size:12px;opacity:0.9;margin-bottom:4px;">Puntos Personales</div>
              <div style="font-size:28px;font-weight:700;">${personalPoints}</div>
            </div>
            <div style="background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:white;padding:16px;border-radius:8px;">
              <div style="font-size:12px;opacity:0.9;margin-bottom:4px;">Puntos Grupales</div>
              <div style="font-size:28px;font-weight:700;">${groupPoints}</div>
            </div>
            <div style="background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:white;padding:16px;border-radius:8px;">
              <div style="font-size:12px;opacity:0.9;margin-bottom:4px;">Balance Disponible</div>
              <div style="font-size:24px;font-weight:700;">$${balance.toLocaleString()}</div>
            </div>
            <div style="background:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);color:white;padding:16px;border-radius:8px;">
              <div style="font-size:12px;opacity:0.9;margin-bottom:4px;">Total Referidos</div>
              <div style="font-size:28px;font-weight:700;">${referrals.length}</div>
            </div>
          </div>
          
          <div style="background:linear-gradient(135deg,#ffecd2 0%,#fcb69f 100%);padding:20px;border-radius:12px;margin-bottom:24px;box-shadow:0 4px 12px rgba(0,0,0,0.1);">
            <h4 style="margin:0 0 16px 0;font-size:18px;color:#c44536;font-weight:700;">Comisiones del Mes en Curso</h4>
            
            <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:12px;margin-bottom:16px;">
              <div style="background:white;padding:16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                <div style="font-size:12px;color:#666;margin-bottom:6px;font-weight:600;">Total Ganado</div>
                <div style="font-size:24px;font-weight:700;color:#2c3e50;margin-bottom:4px;">$${totalEarnedThisMonth.toLocaleString()}</div>
                <div style="font-size:11px;color:#999;">${earnedPointsThisMonth.toFixed(2)} puntos</div>
              </div>
              
              <div style="background:white;padding:16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                <div style="font-size:12px;color:#666;margin-bottom:6px;font-weight:600;">Ya Cobrado</div>
                <div style="font-size:24px;font-weight:700;color:#27ae60;margin-bottom:4px;">$${alreadyCollectedThisMonth.toLocaleString()}</div>
                <div style="font-size:11px;color:#999;">${collectedPayoutsCount} cobro${collectedPayoutsCount !== 1 ? 's' : ''}</div>
              </div>
              
              <div style="background:white;padding:16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);border:2px solid #e74c3c;">
                <div style="font-size:12px;color:#666;margin-bottom:6px;font-weight:600;">Pendiente</div>
                <div style="font-size:24px;font-weight:700;color:#e74c3c;margin-bottom:4px;">$${pendingAmount.toLocaleString()}</div>
                <div style="font-size:11px;color:#999;">Disponible para retiro</div>
              </div>
            </div>
            
            ${thisMonthTransactions.length > 0 ? `
              <div style="background:white;padding:12px;border-radius:8px;max-height:200px;overflow-y:auto;">
                <div style="font-size:13px;font-weight:600;color:#333;margin-bottom:8px;">Transacciones del mes (${thisMonthTransactions.length})</div>
                <table style="width:100%;font-size:12px;border-collapse:collapse;">
                  <thead style="position:sticky;top:0;background:white;">
                    <tr style="border-bottom:1px solid #e0e0e0;">
                      <th style="padding:6px;text-align:left;color:#666;font-weight:600;">Fecha</th>
                      <th style="padding:6px;text-align:left;color:#666;font-weight:600;">Descripci√≥n</th>
                      <th style="padding:6px;text-align:right;color:#666;font-weight:600;">Monto</th>
                      <th style="padding:6px;text-align:right;color:#666;font-weight:600;">Puntos</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${thisMonthTransactions.slice().reverse().map(t => {
                      const date = new Date(t.date);
                      const formattedDate = date.toLocaleDateString('es-CO', { day: '2-digit', month: 'short' });
                      return `
                        <tr style="border-bottom:1px solid #f5f5f5;">
                          <td style="padding:6px;color:#555;">${formattedDate}</td>
                          <td style="padding:6px;color:#333;font-size:11px;">${t.action || 'N/A'}</td>
                          <td style="padding:6px;text-align:right;color:#27ae60;font-weight:600;">$${(t.amount || 0).toLocaleString()}</td>
                          <td style="padding:6px;text-align:right;color:#3498db;font-weight:600;">${(t.points || 0).toFixed(2)}</td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            ` : '<div style="background:white;padding:12px;border-radius:8px;text-align:center;color:#999;font-size:13px;">No hay transacciones este mes</div>'}
          </div>
          
          <div style="margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;border-bottom:2px solid #e9ecef;padding-bottom:8px;">
              <h4 style="margin:0;font-size:16px;color:#333;">Referidos Directos (${referrals.length})</h4>
              <button 
                onclick="recalculateDistributor('${distributorId}')" 
                class="btn-primary" 
                style="padding:8px 16px;font-size:13px;display:flex;align-items:center;gap:6px;"
              >
                <span style="font-size:16px;">üîÑ</span>
                Recalcular Puntos y Comisiones
              </button>
            </div>
            ${referrals.length === 0 ? '<p style="color:#6c757d;font-size:14px;">No tiene referidos directos</p>' : `
              <div style="max-height:200px;overflow-y:auto;">
                <table style="width:100%;font-size:13px;">
                  <thead style="background:#f8f9fa;">
                    <tr>
                      <th style="padding:8px;">C√≥digo</th>
                      <th style="padding:8px;">Nombre</th>
                      <th style="padding:8px;">Email</th>
                      <th style="padding:8px;">Puntos</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${referrals.map(ref => {
                      const refData = ref.data();
                      return `
                        <tr style="border-bottom:1px solid #e9ecef;">
                          <td style="padding:8px;">${refData.usuario || 'N/A'}</td>
                          <td style="padding:8px;">${refData.nombre || 'N/A'}</td>
                          <td style="padding:8px;">${refData.email || 'N/A'}</td>
                          <td style="padding:8px;"><strong>${refData.personalPoints || refData.puntos || 0}</strong></td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            `}
          </div>
          
          <div style="margin-bottom:20px;">
            <h4 style="margin:0 0 12px 0;font-size:16px;color:#333;border-bottom:2px solid #e9ecef;padding-bottom:8px;">√ìrdenes de Compra (${orders.length})</h4>
            ${orders.length === 0 ? '<p style="color:#6c757d;font-size:14px;">No tiene √≥rdenes registradas</p>' : `
              <div style="max-height:250px;overflow-y:auto;">
                <table style="width:100%;font-size:13px;">
                  <thead style="background:#f8f9fa;">
                    <tr>
                      <th style="padding:8px;">Fecha</th>
                      <th style="padding:8px;">Producto</th>
                      <th style="padding:8px;">Total</th>
                      <th style="padding:8px;">Puntos</th>
                      <th style="padding:8px;">Estado</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${orders.map(order => {
                      const date = order.createdAt ? new Date(order.createdAt).toLocaleDateString() : 'N/A';
                      const statusColors = {
                        confirmed: '#28a745',
                        pending: '#fd7e14',
                        pending_delivery: '#fd7e14',
                        rejected: '#dc3545'
                      };
                      return `
                        <tr style="border-bottom:1px solid #e9ecef;">
                          <td style="padding:8px;">${date}</td>
                          <td style="padding:8px;">${order.productName || 'N/A'}</td>
                          <td style="padding:8px;">$${(order.totalPrice || order.price || 0).toLocaleString()}</td>
                          <td style="padding:8px;"><strong>${order.totalPoints || order.points || 0}</strong></td>
                          <td style="padding:8px;"><span style="color:${statusColors[order.status] || '#6c757d'};font-weight:600;">${order.status}</span></td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            `}
          </div>
          
          <div>
            <h4 style="margin:0 0 12px 0;font-size:16px;color:#333;border-bottom:2px solid #e9ecef;padding-bottom:8px;">Historial de Comisiones (${history.filter(h => h.type !== 'purchase' && !(h.action || '').includes('Compra confirmada')).length})</h4>
            ${history.filter(h => h.type !== 'purchase' && !(h.action || '').includes('Compra confirmada')).length === 0 ? '<p style="color:#6c757d;font-size:14px;">No hay historial de comisiones</p>' : `
              <div style="max-height:300px;overflow-y:auto;">
                <table style="width:100%;font-size:13px;">
                  <thead style="background:#f8f9fa;position:sticky;top:0;">
                    <tr>
                      <th style="padding:8px;">Fecha</th>
                      <th style="padding:8px;">Acci√≥n</th>
                      <th style="padding:8px;">Monto</th>
                      <th style="padding:8px;">Puntos</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${history.filter(h => h.type !== 'purchase' && !(h.action || '').includes('Compra confirmada')).slice().reverse().slice(0, 50).map(h => {
                      const date = h.date ? new Date(h.date).toLocaleDateString() : 'N/A';
                      return `
                        <tr style="border-bottom:1px solid #e9ecef;">
                          <td style="padding:8px;">${date}</td>
                          <td style="padding:8px;">${h.action || 'N/A'}</td>
                          <td style="padding:8px;">$${(h.amount || 0).toLocaleString()}</td>
                          <td style="padding:8px;"><strong>${h.points || 0}</strong></td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            `}
          </div>
        `;
        
        // Show panel
        const panel = document.getElementById('distributorDetailsPanel');
        const overlay = document.getElementById('distributorPanelOverlay');
        overlay.style.display = 'block';
        panel.style.display = 'block';
        setTimeout(() => {
          panel.style.right = '0';
        }, 10);
      } catch (err) {
        console.error('Error loading distributor details:', err);
        alert('Error cargando detalles del distribuidor: ' + err.message);
      }
    };
    
    // Close distributor panel
    document.getElementById('closeDistributorPanel').addEventListener('click', () => {
      const panel = document.getElementById('distributorDetailsPanel');
      const overlay = document.getElementById('distributorPanelOverlay');
      panel.style.right = '-600px';
      setTimeout(() => {
        panel.style.display = 'none';
        overlay.style.display = 'none';
      }, 300);
    });
    
    document.getElementById('distributorPanelOverlay').addEventListener('click', () => {
      document.getElementById('closeDistributorPanel').click();
    });

    // Inventory management
    const inventoryModal = document.getElementById('inventoryModal');
    const addInventoryBtn = document.getElementById('addInventoryBtn');
    const inventoryModalCancel = document.getElementById('inventoryModalCancel');
    const addInventoryForm = document.getElementById('addInventoryForm');

    addInventoryBtn.addEventListener('click', async () => {
      // Populate product dropdown with active products from database
      const productSelect = document.getElementById('inventoryProductId');
      productSelect.innerHTML = '<option value="">Seleccionar producto...</option>';

      try {
        const productsSnap = await getDocs(collection(db, "productos"));
        const activeProducts = productsSnap.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(p => !p.hidden && !p.deleted); // Only show active products

        activeProducts.forEach(product => {
          const option = document.createElement('option');
          option.value = product.id;
          option.textContent = product.nombre;
          productSelect.appendChild(option);
        });
      } catch (err) {
        console.error('Error loading products for inventory:', err);
        alert('Error cargando productos: ' + err.message);
      }

      inventoryModal.style.display = 'flex';
    });

    inventoryModalCancel.addEventListener('click', () => {
      inventoryModal.style.display = 'none';
      addInventoryForm.reset();
    });

    inventoryModal.addEventListener('click', (e) => {
      if (e.target === inventoryModal) {
        inventoryModal.style.display = 'none';
        addInventoryForm.reset();
      }
    });

    addInventoryForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      const productId = document.getElementById('inventoryProductId').value;
      const units = parseInt(document.getElementById('inventoryUnits').value);
      const notes = document.getElementById('inventoryNotes').value.trim();

      try {
        const inventoryRef = doc(db, 'inventory', productId);
        const inventorySnap = await getDoc(inventoryRef);
        
        let currentStock = 0;
        if (inventorySnap.exists()) {
          currentStock = inventorySnap.data().stock || 0;
        }

        const newStock = currentStock + units;

        await setDoc(inventoryRef, {
          productId,
          stock: newStock,
          lastUpdated: new Date().toISOString(),
          updatedBy: currentUser.uid
        }, { merge: true });

        await addDoc(collection(db, 'inventoryHistory'), {
          productId,
          type: 'addition',
          units,
          stockBefore: currentStock,
          stockAfter: newStock,
          notes: notes || 'Adici√≥n manual de inventario',
          createdAt: new Date().toISOString(),
          createdBy: currentUser.uid
        });

        alert(`‚úÖ Se agregaron ${units} unidades al inventario`);
        inventoryModal.style.display = 'none';
        addInventoryForm.reset();
        await loadInventory();
      } catch (err) {
        console.error('Error adding inventory:', err);
        alert('Error agregando inventario: ' + err.message);
      }
    });

    async function loadInventory() {
      try {
        console.log("üì¶ Cargando inventario...");
        console.log("üîç Usuario autenticado:", currentUser?.uid);
        console.log("üîç Token de autenticaci√≥n presente:", !!currentUser);

        // Dynamically load product names from database
        const productNames = {};
        const productsSnap = await getDocs(collection(db, "productos"));
        productsSnap.docs.forEach(doc => {
          const data = doc.data();
          productNames[data.id] = data.nombre;
        });
        console.log("‚úÖ Productos cargados:", Object.keys(productNames).length);

        try {
          console.log("üì¶ Test 1: Intentando leer documento de usuario...");
          const testUserDoc = await getDoc(doc(db, 'usuarios', currentUser.uid));
          console.log("‚úÖ Test 1 exitoso - Usuario doc existe:", testUserDoc.exists());
          if (testUserDoc.exists()) {
            console.log("üìÑ Datos del usuario:", testUserDoc.data());
          }
        } catch (testErr) {
          console.error("‚ùå Test 1 fall√≥:", testErr.code, testErr.message);
        }

        console.log("üì¶ Test 2: Leyendo colecci√≥n 'inventory'...");
        const inventorySnap = await getDocs(collection(db, 'inventory'));
        console.log("‚úÖ Test 2 exitoso - Inventario le√≠do:", inventorySnap.docs.length, "productos");
        
        let totalStock = 0;
        inventorySnap.docs.forEach(doc => {
          totalStock += doc.data().stock || 0;
        });

        console.log("üì¶ Leyendo √≥rdenes confirmadas...");
        const ordersSnap = await getDocs(collection(db, 'orders'));
        const allOrders = ordersSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        // Filter only confirmed orders and exclude test users
        const confirmedOrders = allOrders.filter(order => order.status === 'confirmed');

        // Fetch buyer information to filter out test users
        const usersCache = new Map();
        const filteredOrders = [];

        for (const order of confirmedOrders) {
          if (order.buyerUid) {
            // Get user data from cache or fetch it
            if (!usersCache.has(order.buyerUid)) {
              try {
                const userDoc = await getDoc(doc(db, "usuarios", order.buyerUid));
                if (userDoc.exists()) {
                  const userData = userDoc.data();
                  usersCache.set(order.buyerUid, {
                    nombre: userData.nombre || '',
                    usuario: userData.usuario || ''
                  });
                }
              } catch (err) {
                console.warn('Error fetching user for order:', order.id, err);
              }
            }

            // Check if user is a test user (starts with "prueba")
            const userData = usersCache.get(order.buyerUid);
            if (userData) {
              const isTestUser = userData.nombre.toLowerCase().startsWith('prueba') ||
                                userData.usuario.toLowerCase().startsWith('prueba');

              if (!isTestUser) {
                filteredOrders.push(order);
              } else {
                console.log(`üß™ Orden excluida de usuario de prueba: ${userData.usuario || userData.nombre}`);
              }
            } else {
              // If we couldn't fetch user data, include the order to avoid data loss
              filteredOrders.push(order);
            }
          } else {
            // If no buyerUid, include the order
            filteredOrders.push(order);
          }
        }

        // Calculate total units sold and units sold per product
        let totalSoldUnits = 0;
        const unitsSoldByProduct = {};

        filteredOrders.forEach(order => {
          const quantity = Number(order.quantity) || 1;
          const productId = order.productId || '';

          // Initialize product counter if needed
          if (!unitsSoldByProduct[productId]) {
            unitsSoldByProduct[productId] = 0;
          }

          // Add quantity to product counter
          unitsSoldByProduct[productId] += quantity;

          // Calculate units based on product for total
          if (productId === 'paquete-inicio') {
            // Paquete de 300,000 = 10 unidades
            totalSoldUnits += quantity * 10;
          } else if (['chuletas-3kg', 'costillas-3kg', 'paticas-3kg', 'panceta-3kg', 'pulpa-3kg', 'goulast-3kg'].includes(productId)) {
            // Paquetes de 60,000 = 2 unidades
            totalSoldUnits += quantity * 2;
          } else {
            // Default: count as sold quantity
            totalSoldUnits += quantity;
          }
        });

        console.log("‚úÖ √ìrdenes le√≠das:", ordersSnap.docs.length, "| √ìrdenes confirmadas (sin prueba):", filteredOrders.length, "| Unidades vendidas:", totalSoldUnits);

        console.log("üì¶ Leyendo historial de inventario...");
        const historySnap = await getDocs(query(
          collection(db, 'inventoryHistory'),
          orderBy('createdAt', 'desc'),
          limit(50)
        ));
        console.log("‚úÖ Historial le√≠do:", historySnap.docs.length, "registros");

        let lastUpdate = 'N/A';
        if (!historySnap.empty) {
          const lastDoc = historySnap.docs[0].data();
          const date = new Date(lastDoc.createdAt);
          lastUpdate = date.toLocaleDateString('es-CO', { day: '2-digit', month: 'short' });
        }

        document.getElementById('inventoryCount').textContent = totalStock;
        document.getElementById('totalStockUnits').textContent = totalStock;
        document.getElementById('totalSoldUnits').textContent = totalSoldUnits;
        document.getElementById('lastInventoryUpdate').textContent = lastUpdate;

        // Populate product inventory table
        const productInventoryTable = document.getElementById('productInventoryTable');
        productInventoryTable.innerHTML = '';

        // Create a map of inventory by product ID
        const inventoryByProduct = {};
        inventorySnap.docs.forEach(doc => {
          const data = doc.data();
          inventoryByProduct[data.productId] = data.stock || 0;
        });

        // Get all unique product IDs from both inventory and orders
        const allProductIds = new Set([
          ...Object.keys(inventoryByProduct),
          ...Object.keys(unitsSoldByProduct)
        ]);

        if (allProductIds.size === 0) {
          productInventoryTable.innerHTML = '<tr><td colspan="5" class="empty-state">No hay productos en el inventario</td></tr>';
        } else {
          // Create rows for each product
          const productRows = [];
          allProductIds.forEach(productId => {
            const totalUnits = inventoryByProduct[productId] || 0;
            const soldUnits = unitsSoldByProduct[productId] || 0;
            const remainingUnits = totalUnits - soldUnits;
            const productName = productNames[productId] || productId;

            // Determine status
            let statusHtml = '';
            if (remainingUnits <= 0) {
              statusHtml = '<span style="background:#dc3545;color:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600;">AGOTADO</span>';
            } else if (remainingUnits < 10) {
              statusHtml = '<span style="background:#fd7e14;color:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600;">STOCK BAJO</span>';
            } else {
              statusHtml = '<span style="background:#28a745;color:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600;">DISPONIBLE</span>';
            }

            productRows.push({
              productId,
              productName,
              totalUnits,
              soldUnits,
              remainingUnits,
              statusHtml
            });
          });

          // Sort by product name
          productRows.sort((a, b) => a.productName.localeCompare(b.productName));

          // Render rows
          productRows.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><strong>${row.productName}</strong><br><small style="color:#999;">${row.productId}</small></td>
              <td style="text-align:center;"><strong style="color:#007bff;font-size:16px;">${row.totalUnits}</strong></td>
              <td style="text-align:center;"><strong style="color:#28a745;font-size:16px;">${row.soldUnits}</strong></td>
              <td style="text-align:center;"><strong style="color:${row.remainingUnits < 0 ? '#dc3545' : '#6f42c1'};font-size:16px;">${row.remainingUnits}</strong></td>
              <td style="text-align:center;">${row.statusHtml}</td>
            `;
            productInventoryTable.appendChild(tr);
          });
        }

        const historyTable = document.getElementById('inventoryHistoryTable');
        historyTable.innerHTML = '';

        if (historySnap.empty) {
          historyTable.innerHTML = '<tr><td colspan="6" class="empty-state">No hay movimientos de inventario registrados</td></tr>';
          return;
        }

        historySnap.docs.forEach(doc => {
          const data = doc.data();
          const row = document.createElement('tr');
          const date = new Date(data.createdAt).toLocaleDateString('es-CO');
          const typeText = data.type === 'addition' ? 'Entrada' : 'Venta';
          const typeColor = data.type === 'addition' ? '#28a745' : '#dc3545';
          
          row.innerHTML = `
            <td>${date}</td>
            <td><span style="color:${typeColor};font-weight:600">${typeText}</span></td>
            <td>${productNames[data.productId] || data.productId}</td>
            <td>${data.units > 0 ? '+' : ''}${data.units}</td>
            <td>${data.stockAfter || 0}</td>
            <td>${data.notes || 'N/A'}</td>
          `;
          historyTable.appendChild(row);
        });
        
        console.log("‚úÖ Inventario cargado exitosamente");
      } catch (err) {
        console.error('‚ùå Error loading inventory:', err);
        console.error('Error code:', err.code);
        console.error('Error message:', err.message);
        
        if (err.code === 'permission-denied') {
          console.error("‚ö†Ô∏è PROBLEMA DE PERMISOS DETECTADO:");
          console.error("Usuario actual UID:", currentUser?.uid);
          console.error("Email:", currentUser?.email);
          
          console.error("\nüîß SOLUCI√ìN:");
          console.error("Las reglas de Firestore NO est√°n desplegadas o son diferentes de las locales.");
          console.error("Ejecuta: firebase deploy --only firestore:rules");
          console.error("\nSi el problema persiste, verifica en Firebase Console:");
          console.error("1. Ve a Firestore Database > Rules");
          console.error("2. Verifica que la regla para 'inventory' sea: allow read: if isAuthenticated();");
          console.error("3. Verifica que isAdmin() incluya exists() check y get() del documento usuarios");
          
          alert("‚ùå ERROR DE PERMISOS\n\n" +
                "El usuario tiene rol 'admin' localmente pero Firestore rechaza el acceso.\n\n" +
                "CAUSA M√ÅS PROBABLE:\n" +
                "Las reglas de Firestore NO est√°n desplegadas en Firebase.\n\n" +
                "SOLUCI√ìN:\n" +
                "1. Abre una terminal en la ra√≠z del proyecto\n" +
                "2. Ejecuta: firebase deploy --only firestore:rules\n" +
                "3. Espera confirmaci√≥n de despliegue\n" +
                "4. Recarga esta p√°gina\n\n" +
                "Si ya desplegaste las reglas y el error persiste:\n" +
                "- Verifica en Firebase Console > Firestore > Rules\n" +
                "- Confirma que las reglas publicadas coincidan con firestore.rules\n\n" +
                "Usuario UID: " + currentUser?.uid);
        } else {
          alert('Error cargando inventario: ' + err.message);
        }
      }
    }

    async function loadProducts() {
      try {
        const productsSnap = await getDocs(collection(db, "productos"));
        allProducts = productsSnap.docs.map(d => ({ docId: d.id, ...d.data() }));

        // Calculate units sold for each product
        await calculateUnitsSold();

        renderProductsPreview();
        renderProductsManagementTable();
      } catch (err) {
        console.error('Error loading products:', err);
        allProducts = [];
      }
    }

    async function calculateUnitsSold() {
      try {
        // Get all confirmed orders
        const ordersSnap = await getDocs(collection(db, "orders"));
        const allOrders = ordersSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        console.log(`üìä Total de √≥rdenes en la base de datos: ${allOrders.length}`);

        // Filter only confirmed orders
        const confirmedOrders = allOrders.filter(order => order.status === 'confirmed');

        console.log(`‚úÖ √ìrdenes confirmadas: ${confirmedOrders.length}`);

        // Fetch buyer information to filter out test users
        const usersCache = new Map();
        const filteredOrders = [];

        for (const order of confirmedOrders) {
          if (order.buyerUid) {
            // Get user data from cache or fetch it
            if (!usersCache.has(order.buyerUid)) {
              try {
                const userDoc = await getDoc(doc(db, "usuarios", order.buyerUid));
                if (userDoc.exists()) {
                  const userData = userDoc.data();
                  usersCache.set(order.buyerUid, {
                    nombre: userData.nombre || '',
                    usuario: userData.usuario || ''
                  });
                }
              } catch (err) {
                console.warn('Error fetching user for order:', order.id, err);
              }
            }

            // Check if user is a test user (starts with "prueba")
            const userData = usersCache.get(order.buyerUid);
            if (userData) {
              const isTestUser = userData.nombre.toLowerCase().startsWith('prueba') ||
                                userData.usuario.toLowerCase().startsWith('prueba');

              if (!isTestUser) {
                filteredOrders.push(order);
              } else {
                console.log(`üß™ Orden excluida de usuario de prueba: ${userData.usuario || userData.nombre}`);
              }
            } else {
              // If we couldn't fetch user data, include the order to avoid data loss
              filteredOrders.push(order);
            }
          } else {
            // If no buyerUid, include the order
            filteredOrders.push(order);
          }
        }

        console.log(`‚úÖ √ìrdenes confirmadas (sin usuarios de prueba): ${filteredOrders.length}`);

        // Calculate total units sold per product
        const unitsSoldMap = {};
        filteredOrders.forEach(order => {
          const productId = order.productId;
          const quantity = order.quantity || 0;

          if (!unitsSoldMap[productId]) {
            unitsSoldMap[productId] = 0;
          }
          unitsSoldMap[productId] += quantity;
        });

        // Log units sold per product for debugging
        console.log('üì¶ Unidades vendidas por producto:', unitsSoldMap);

        // Update allProducts with unitsSold
        allProducts.forEach(product => {
          product.unitsSold = unitsSoldMap[product.id] || 0;
        });
      } catch (err) {
        console.error('Error calculating units sold:', err);
      }
    }

    function formatCOP(num) {
      return new Intl.NumberFormat("es-CO", {
        style: "currency",
        currency: "COP",
        minimumFractionDigits: 0
      }).format(num);
    }

    function renderProductsPreview() {
      const previewGrid = document.getElementById('productsPreviewGrid');
      const previewType = document.getElementById('previewTypeSelector').value;
      
      const filteredProducts = allProducts.filter(prod => {
        if (prod.hidden) return false;
        if (!prod.availableFor || prod.availableFor.length === 0) return true;
        return prod.availableFor.includes(previewType);
      });

      if (filteredProducts.length === 0) {
        previewGrid.innerHTML = '<div class="empty-state">No hay productos disponibles para este tipo de usuario</div>';
        return;
      }

      previewGrid.innerHTML = filteredProducts.map(prod => {
        let price = prod.precio || 0;
        if (previewType === 'distribuidor' && prod.precioDistribuidor) {
          price = prod.precioDistribuidor;
        } else if (previewType === 'cliente' && prod.precioCliente) {
          price = prod.precioCliente;
        } else if (previewType === 'restaurante' && prod.precioRestaurante) {
          price = prod.precioRestaurante;
        }

        const badge = prod.outOfStock ? '<span class="product-badge outofstock">Agotado</span>' : '';

        return `
          <div class="product-card-preview">
            ${badge}
            <img src="${prod.imagen || '/images/productos/inicio.jpg'}" alt="${prod.nombre}">
            <h4>${prod.nombre}</h4>
            <p>${prod.descripcion || ''}</p>
            <div class="price">${formatCOP(price)}</div>
            <p style="font-size:12px;color:#999;">por ${prod.unit || 'paquete'}</p>
          </div>
        `;
      }).join('');
    }

    function renderProductsManagementTable() {
      const table = document.getElementById('productsManagementTable');

      if (allProducts.length === 0) {
        table.innerHTML = '<tr><td colspan="11" class="empty-state">No hay productos registrados</td></tr>';
        return;
      }

      const categoryNames = {
        'carnes': 'Carnes',
        'bebidas': 'Bebidas',
        'alimentos': 'Alimentos',
        'aseo': 'Aseo',
        'higiene-personal': 'Higiene Personal',
        'abarrotes': 'Abarrotes'
      };

      table.innerHTML = allProducts.map(prod => {
        const statusBadges = [];
        if (prod.hidden) statusBadges.push('<span style="background:#6c757d;color:white;padding:2px 6px;border-radius:3px;font-size:11px;margin-right:4px;">OCULTO</span>');
        if (prod.outOfStock) statusBadges.push('<span style="background:#fd7e14;color:white;padding:2px 6px;border-radius:3px;font-size:11px;">AGOTADO</span>');
        const statusHtml = statusBadges.length > 0 ? statusBadges.join('') : '<span style="color:#28a745;">‚úì Activo</span>';

        const featuredHtml = prod.featured ? '<span style="font-size:20px;" title="Producto destacado">‚≠ê</span>' : '<span style="color:#ccc;">‚Äî</span>';

        // Calculate units sold
        const unitsSold = prod.unitsSold || 0;
        const unitsSoldHtml = unitsSold > 0
          ? `<button onclick="showProductOrders('${prod.id}', '${prod.nombre.replace(/'/g, "\\'")}', ${unitsSold})" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"><strong>${unitsSold}</strong> ${prod.unit || 'unidades'} üìã</button>`
          : `<span style="color:#999;">${unitsSold} ${prod.unit || 'unidades'}</span>`;

        return `
          <tr>
            <td><img src="${prod.imagen || '/images/productos/inicio.jpg'}" style="width:60px;height:60px;object-fit:cover;border-radius:4px;"></td>
            <td><strong>${prod.nombre}</strong><br><small style="color:#666;">${prod.id}</small></td>
            <td style="max-width:200px;"><small>${prod.descripcion || 'N/A'}</small></td>
            <td><span style="background:#e9ecef;padding:4px 8px;border-radius:4px;font-size:12px;">${categoryNames[prod.categoria] || prod.categoria || 'N/A'}</span></td>
            <td>${prod.precioDistribuidor ? formatCOP(prod.precioDistribuidor) : 'N/A'}</td>
            <td>${prod.precioCliente ? formatCOP(prod.precioCliente) : 'N/A'}</td>
            <td>${prod.precioRestaurante ? formatCOP(prod.precioRestaurante) : 'N/A'}</td>
            <td style="text-align:center;">${unitsSoldHtml}</td>
            <td style="text-align:center;">${featuredHtml}</td>
            <td>${statusHtml}</td>
            <td>
              <button class="btn-primary" onclick="editProduct('${prod.docId}')">Editar</button>
              <button class="btn-danger" onclick="deleteProduct('${prod.docId}', '${prod.nombre}')">Eliminar</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    document.getElementById('previewTypeSelector').addEventListener('change', renderProductsPreview);

    document.getElementById('addProductBtn').addEventListener('click', () => {
      document.getElementById('productModalTitle').textContent = 'Crear Producto';
      document.getElementById('productForm').reset();
      document.getElementById('productEditId').value = '';
      document.getElementById('productModal').style.display = 'flex';
    });

    document.getElementById('productModalCancel').addEventListener('click', () => {
      document.getElementById('productModal').style.display = 'none';
    });

    document.getElementById('productForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const editId = document.getElementById('productEditId').value;
      const productData = {
        id: document.getElementById('productId').value.trim(),
        nombre: document.getElementById('productName').value.trim(),
        descripcion: document.getElementById('productDescription').value.trim(),
        imagen: document.getElementById('productImage').value.trim(),
        precioDistribuidor: parseFloat(document.getElementById('productPriceDistributor').value) || 0,
        precioCliente: parseFloat(document.getElementById('productPriceClient').value) || 0,
        precioRestaurante: parseFloat(document.getElementById('productPriceRestaurant').value) || 0,
        precio: parseFloat(document.getElementById('productPriceDistributor').value) || 0,
        puntosDistribuidor: parseFloat(document.getElementById('productPointsDistributor').value) || 0,
        puntosRestaurante: parseFloat(document.getElementById('productPointsRestaurant').value) || 0,
        puntos: parseFloat(document.getElementById('productPointsDistributor').value) || 0, // backward compatibility
        unit: document.getElementById('productUnit').value,
        categoria: document.getElementById('productCategory').value,
        availableFor: [],
        hidden: document.getElementById('productHidden').checked,
        outOfStock: document.getElementById('productOutOfStock').checked,
        featured: document.getElementById('productFeatured').checked || false
      };

      if (document.getElementById('productAvailDistributor').checked) {
        productData.availableFor.push('distribuidor');
      }
      if (document.getElementById('productAvailClient').checked) {
        productData.availableFor.push('cliente');
      }
      if (document.getElementById('productAvailRestaurant').checked) {
        productData.availableFor.push('restaurante');
      }

      try {
        if (editId) {
          await updateDoc(doc(db, "productos", editId), productData);
          alert('Producto actualizado correctamente');
        } else {
          await addDoc(collection(db, "productos"), productData);
          alert('Producto creado correctamente');
        }
        
        document.getElementById('productModal').style.display = 'none';
        await loadProducts();
      } catch (err) {
        console.error('Error saving product:', err);
        alert('Error al guardar el producto: ' + err.message);
      }
    });

    window.editProduct = async function(docId) {
      const product = allProducts.find(p => p.docId === docId);
      if (!product) return;

      document.getElementById('productModalTitle').textContent = 'Editar Producto';
      document.getElementById('productEditId').value = docId;
      document.getElementById('productId').value = product.id || '';
      document.getElementById('productName').value = product.nombre || '';
      document.getElementById('productDescription').value = product.descripcion || '';
      document.getElementById('productImage').value = product.imagen || '';
      document.getElementById('productPriceDistributor').value = product.precioDistribuidor || '';
      document.getElementById('productPriceClient').value = product.precioCliente || '';
      document.getElementById('productPriceRestaurant').value = product.precioRestaurante || '';
      document.getElementById('productPointsDistributor').value = product.puntosDistribuidor || product.puntos || '';
      document.getElementById('productPointsRestaurant').value = product.puntosRestaurante || product.puntos || '';
      document.getElementById('productUnit').value = product.unit || 'paquete';
      document.getElementById('productCategory').value = product.categoria || 'carnes';

      document.getElementById('productAvailDistributor').checked = (product.availableFor || []).includes('distribuidor');
      document.getElementById('productAvailClient').checked = (product.availableFor || []).includes('cliente');
      document.getElementById('productAvailRestaurant').checked = (product.availableFor || []).includes('restaurante');

      document.getElementById('productHidden').checked = product.hidden || false;
      document.getElementById('productOutOfStock').checked = product.outOfStock || false;
      document.getElementById('productFeatured').checked = product.featured || false;

      document.getElementById('productModal').style.display = 'flex';
    };

    window.deleteProduct = async function(docId, productName) {
      if (!confirm(`¬øEst√°s seguro de eliminar el producto "${productName}"?`)) return;

      try {
        await updateDoc(doc(db, "productos", docId), { deleted: true });
        alert('Producto eliminado correctamente');
        await loadProducts();
      } catch (err) {
        console.error('Error deleting product:', err);
        alert('Error al eliminar el producto: ' + err.message);
      }
    };

    // Categories Management
    let allCategories = [];
    
    async function loadCategories() {
      try {
        const categoriesSnap = await getDocs(collection(db, "categorias"));
        if (categoriesSnap.empty) {
          allCategories = [
            { id: 'carnes', nombre: 'Carnes', slug: 'carnes' },
            { id: 'bebidas', nombre: 'Bebidas', slug: 'bebidas' },
            { id: 'alimentos', nombre: 'Alimentos', slug: 'alimentos' },
            { id: 'aseo', nombre: 'Aseo', slug: 'aseo' },
            { id: 'higiene-personal', nombre: 'Higiene Personal', slug: 'higiene-personal' },
            { id: 'abarrotes', nombre: 'Abarrotes', slug: 'abarrotes' }
          ];
          for (const cat of allCategories) {
            await addDoc(collection(db, "categorias"), cat);
          }
        } else {
          allCategories = categoriesSnap.docs.map(d => ({ docId: d.id, ...d.data() }));
        }
        renderCategoriesTable();
        updateProductCategoryOptions();
      } catch (err) {
        console.error('Error loading categories:', err);
        allCategories = [
          { id: 'carnes', nombre: 'Carnes', slug: 'carnes' },
          { id: 'bebidas', nombre: 'Bebidas', slug: 'bebidas' },
          { id: 'alimentos', nombre: 'Alimentos', slug: 'alimentos' },
          { id: 'aseo', nombre: 'Aseo', slug: 'aseo' },
          { id: 'higiene-personal', nombre: 'Higiene Personal', slug: 'higiene-personal' },
          { id: 'abarrotes', nombre: 'Abarrotes', slug: 'abarrotes' }
        ];
      }
    }

    function renderCategoriesTable() {
      const tbody = document.getElementById('categoriesTable');
      if (!tbody) return;

      tbody.innerHTML = allCategories.map(cat => {
        const productCount = allProducts.filter(p => p.categoria === cat.slug).length;
        return `
          <tr>
            <td>${cat.id}</td>
            <td><strong>${cat.nombre}</strong></td>
            <td><span style="font-family:monospace;font-size:12px;color:#666;">${cat.slug}</span></td>
            <td>${productCount} producto${productCount !== 1 ? 's' : ''}</td>
            <td>
              <button class="btn-primary" onclick="editCategory('${cat.docId || cat.id}')">Editar</button>
              <button class="btn-danger" onclick="deleteCategory('${cat.docId || cat.id}', '${cat.nombre}')">Eliminar</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    document.getElementById('addCategoryBtn')?.addEventListener('click', () => {
      document.getElementById('categoryModalTitle').textContent = 'Crear Categor√≠a';
      document.getElementById('categoryEditId').value = '';
      document.getElementById('categoryName').value = '';
      document.getElementById('categorySlug').value = '';
      document.getElementById('categoryModal').style.display = 'flex';
    });

    document.getElementById('categoryModalCancel')?.addEventListener('click', () => {
      document.getElementById('categoryModal').style.display = 'none';
    });

    document.getElementById('categoryForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const editDocId = document.getElementById('categoryEditId').value;
      const nombre = document.getElementById('categoryName').value.trim();
      const slug = document.getElementById('categorySlug').value.trim().toLowerCase();

      if (!nombre || !slug) {
        alert('Todos los campos son obligatorios');
        return;
      }

      if (!/^[a-z0-9-]+$/.test(slug)) {
        alert('El slug solo puede contener letras min√∫sculas, n√∫meros y guiones');
        return;
      }

      const existingCategory = allCategories.find(c => c.slug === slug && c.docId !== editDocId);
      if (existingCategory) {
        alert('Ya existe una categor√≠a con ese slug');
        return;
      }

      try {
        const categoryData = { id: slug, nombre, slug };

        if (editDocId) {
          await updateDoc(doc(db, "categorias", editDocId), categoryData);
          alert('Categor√≠a actualizada correctamente');
        } else {
          await addDoc(collection(db, "categorias"), categoryData);
          alert('Categor√≠a creada correctamente');
        }

        await loadCategories();
        document.getElementById('categoryModal').style.display = 'none';
      } catch (err) {
        console.error('Error saving category:', err);
        alert('Error al guardar la categor√≠a: ' + err.message);
      }
    });

    window.editCategory = function(docId) {
      const category = allCategories.find(c => c.docId === docId || c.id === docId);
      if (!category) return;

      document.getElementById('categoryModalTitle').textContent = 'Editar Categor√≠a';
      document.getElementById('categoryEditId').value = category.docId || '';
      document.getElementById('categoryName').value = category.nombre;
      document.getElementById('categorySlug').value = category.slug;
      document.getElementById('categoryModal').style.display = 'flex';
    };

    window.deleteCategory = async function(docId, categoryName) {
      const category = allCategories.find(c => c.docId === docId || c.id === docId);
      if (!category) return;

      const productCount = allProducts.filter(p => p.categoria === category.slug).length;
      
      if (productCount > 0) {
        alert(`No puedes eliminar la categor√≠a "${categoryName}" porque tiene ${productCount} producto(s) asociado(s).`);
        return;
      }

      if (!confirm(`¬øEst√°s seguro de eliminar la categor√≠a "${categoryName}"?`)) return;

      try {
        if (category.docId) {
          await deleteDoc(doc(db, "categorias", category.docId));
        }
        alert('Categor√≠a eliminada correctamente');
        await loadCategories();
      } catch (err) {
        console.error('Error deleting category:', err);
        alert('Error al eliminar la categor√≠a: ' + err.message);
      }
    };

    function updateProductCategoryOptions() {
      const selector = document.getElementById('productCategory');
      if (!selector) return;

      selector.innerHTML = allCategories.map(cat => 
        `<option value="${cat.slug}">${cat.nombre}</option>`
      ).join('');
    }

    // Helper function to check if user is active this month
    function checkIfUserActiveThisMonth(userData) {
      const hist = userData?.history;
      if (!Array.isArray(hist)) return false;
      
      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth();
      
      for (const e of hist) {
        if (!e) continue;
        const dateRaw = e.date || e.fechaCompra || e.fecha_recompra || e.createdAt || e.fecha;
        const d = dateRaw ? (typeof dateRaw.toDate === "function" ? dateRaw.toDate() : new Date(dateRaw)) : null;
        const action = (e.action || "").toLowerCase();
        const type = (e.type || "").toLowerCase();
        
        if (!d || d.getFullYear() !== currentYear || d.getMonth() !== currentMonth) {
          continue;
        }
        
        if (type === "purchase" && /compra confirmada/i.test(action)) {
          return true;
        }
        
        if (!type && /compra confirmada/i.test(action) && !action.includes("comisi√≥n") && !action.includes("bono")) {
          return true;
        }
      }
      return false;
    }

    // Show product orders modal
    window.showProductOrders = async function(productId, productName, totalUnits) {
      try {
        // Get the modal elements
        const modal = document.getElementById('productOrdersModal');
        const modalTitle = document.getElementById('productOrdersModalTitle');
        const modalContent = document.getElementById('productOrdersContent');

        // Set loading state
        modalTitle.textContent = `√ìrdenes: ${productName}`;
        modalContent.innerHTML = '<div style="text-align:center;padding:40px;"><span style="font-size:24px;">‚è≥</span><br>Cargando √≥rdenes...</div>';
        modal.style.display = 'flex';

        // Fetch all confirmed orders for this product
        const ordersSnap = await getDocs(query(
          collection(db, 'orders'),
          where('productId', '==', productId),
          where('status', '==', 'confirmed')
        ));

        const orders = ordersSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        console.log(`üì¶ √ìrdenes encontradas para ${productName}:`, orders.length);

        if (orders.length === 0) {
          modalContent.innerHTML = `
            <div style="text-align:center;padding:40px;color:#666;">
              <span style="font-size:48px;">üì≠</span>
              <h3 style="margin:16px 0 8px 0;">No hay √≥rdenes confirmadas</h3>
              <p>No se encontraron √≥rdenes confirmadas para este producto.</p>
            </div>
          `;
          return;
        }

        // Fetch user information for each order
        const usersCache = new Map();
        for (const order of orders) {
          if (order.buyerUid && !usersCache.has(order.buyerUid)) {
            try {
              const userDoc = await getDoc(doc(db, 'usuarios', order.buyerUid));
              if (userDoc.exists()) {
                const userData = userDoc.data();
                usersCache.set(order.buyerUid, {
                  nombre: userData.nombre || 'Sin nombre',
                  usuario: userData.usuario || 'Sin usuario',
                  email: userData.email || 'Sin email',
                  role: userData.role || userData.tipoRegistro || 'distribuidor'
                });
              } else {
                usersCache.set(order.buyerUid, {
                  nombre: 'Usuario no encontrado',
                  usuario: 'N/A',
                  email: 'N/A',
                  role: 'N/A'
                });
              }
            } catch (err) {
              console.error('Error fetching user:', order.buyerUid, err);
              usersCache.set(order.buyerUid, {
                nombre: 'Error al cargar',
                usuario: 'N/A',
                email: 'N/A',
                role: 'N/A'
              });
            }
          }
        }

        // Filter out test users (names starting with "prueba")
        const filteredOrders = orders.filter(order => {
          const userData = usersCache.get(order.buyerUid);
          if (userData) {
            const isTestUser = userData.nombre.toLowerCase().startsWith('prueba') ||
                              userData.usuario.toLowerCase().startsWith('prueba');
            if (isTestUser) {
              console.log(`üß™ Orden excluida de usuario de prueba en modal: ${userData.usuario || userData.nombre}`);
            }
            return !isTestUser;
          }
          return true; // Include if no user data found
        });

        // Calculate total units
        const calculatedTotal = filteredOrders.reduce((sum, order) => sum + (order.quantity || 1), 0);

        // Build the content
        modalContent.innerHTML = `
          <div style="background:#f8f9fa;padding:16px;border-radius:8px;margin-bottom:20px;">
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
              <div>
                <div style="font-size:12px;color:#666;margin-bottom:4px;">Producto</div>
                <div style="font-size:16px;font-weight:600;">${productName}</div>
              </div>
              <div>
                <div style="font-size:12px;color:#666;margin-bottom:4px;">Total √ìrdenes</div>
                <div style="font-size:20px;font-weight:700;color:#667eea;">${filteredOrders.length}</div>
              </div>
              <div>
                <div style="font-size:12px;color:#666;margin-bottom:4px;">Total Unidades</div>
                <div style="font-size:20px;font-weight:700;color:#764ba2;">${calculatedTotal}</div>
              </div>
            </div>
            ${calculatedTotal !== totalUnits ? `
              <div style="margin-top:12px;padding:12px;background:#fff3cd;border:1px solid #ffc107;border-radius:6px;font-size:13px;">
                ‚ö†Ô∏è <strong>Nota:</strong> El total calculado (${calculatedTotal}) no coincide con el total mostrado (${totalUnits}).
                Esto podr√≠a indicar una discrepancia en los datos.
              </div>
            ` : ''}
          </div>

          <div style="overflow-x:auto;">
            <table style="width:100%;border-collapse:collapse;font-size:13px;">
              <thead style="background:#f8f9fa;position:sticky;top:0;">
                <tr>
                  <th style="padding:12px 8px;text-align:left;border-bottom:2px solid #dee2e6;">Fecha</th>
                  <th style="padding:12px 8px;text-align:left;border-bottom:2px solid #dee2e6;">ID Orden</th>
                  <th style="padding:12px 8px;text-align:left;border-bottom:2px solid #dee2e6;">Distribuidor/Cliente</th>
                  <th style="padding:12px 8px;text-align:left;border-bottom:2px solid #dee2e6;">Contacto</th>
                  <th style="padding:12px 8px;text-align:center;border-bottom:2px solid #dee2e6;">Cantidad</th>
                  <th style="padding:12px 8px;text-align:right;border-bottom:2px solid #dee2e6;">Precio Total</th>
                  <th style="padding:12px 8px;text-align:center;border-bottom:2px solid #dee2e6;">Puntos</th>
                </tr>
              </thead>
              <tbody>
                ${filteredOrders.map((order, index) => {
                  const userData = usersCache.get(order.buyerUid) || {
                    nombre: order.buyerUsername || 'Desconocido',
                    usuario: 'N/A',
                    email: 'N/A',
                    role: 'N/A'
                  };

                  const date = order.createdAt
                    ? (order.createdAt.seconds
                      ? new Date(order.createdAt.seconds * 1000).toLocaleDateString('es-CO', { day: '2-digit', month: 'short', year: 'numeric' })
                      : new Date(order.createdAt).toLocaleDateString('es-CO', { day: '2-digit', month: 'short', year: 'numeric' }))
                    : 'N/A';

                  const quantity = order.quantity || 1;
                  const totalPrice = order.totalPrice || order.priceTotal || (order.price * quantity) || 0;
                  const totalPoints = order.totalPoints || order.pointsTotal || (order.points * quantity) || 0;

                  const roleColors = {
                    'distribuidor': '#667eea',
                    'cliente': '#28a745',
                    'restaurante': '#fd7e14',
                    'admin': '#dc3545'
                  };
                  const roleColor = roleColors[userData.role] || '#6c757d';

                  const rowBg = index % 2 === 0 ? 'white' : '#f8f9fa';

                  return `
                    <tr style="background:${rowBg};border-bottom:1px solid #e9ecef;">
                      <td style="padding:12px 8px;">${date}</td>
                      <td style="padding:12px 8px;"><code style="font-size:11px;background:#e9ecef;padding:2px 6px;border-radius:3px;">${order.id.substring(0, 12)}...</code></td>
                      <td style="padding:12px 8px;">
                        <div style="font-weight:600;margin-bottom:2px;">${userData.nombre}</div>
                        <div style="font-size:11px;color:#666;">@${userData.usuario}</div>
                        <div style="font-size:10px;margin-top:2px;">
                          <span style="background:${roleColor};color:white;padding:2px 6px;border-radius:10px;text-transform:uppercase;font-weight:600;">${userData.role}</span>
                        </div>
                      </td>
                      <td style="padding:12px 8px;font-size:12px;color:#666;">${userData.email}</td>
                      <td style="padding:12px 8px;text-align:center;"><strong style="font-size:16px;color:#764ba2;">${quantity}</strong></td>
                      <td style="padding:12px 8px;text-align:right;font-weight:600;">$${totalPrice.toLocaleString()}</td>
                      <td style="padding:12px 8px;text-align:center;"><strong style="color:#28a745;">${totalPoints}</strong></td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
              <tfoot style="background:#e9ecef;font-weight:700;">
                <tr>
                  <td colspan="4" style="padding:12px 8px;text-align:right;border-top:2px solid #dee2e6;">TOTALES:</td>
                  <td style="padding:12px 8px;text-align:center;border-top:2px solid #dee2e6;color:#764ba2;font-size:18px;">${calculatedTotal}</td>
                  <td style="padding:12px 8px;text-align:right;border-top:2px solid #dee2e6;">$${filteredOrders.reduce((sum, o) => sum + (o.totalPrice || o.priceTotal || (o.price * (o.quantity || 1)) || 0), 0).toLocaleString()}</td>
                  <td style="padding:12px 8px;text-align:center;border-top:2px solid #dee2e6;color:#28a745;">${filteredOrders.reduce((sum, o) => sum + (o.totalPoints || o.pointsTotal || (o.points * (o.quantity || 1)) || 0), 0)}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        `;

      } catch (err) {
        console.error('Error loading product orders:', err);
        const modalContent = document.getElementById('productOrdersContent');
        modalContent.innerHTML = `
          <div style="text-align:center;padding:40px;color:#dc3545;">
            <span style="font-size:48px;">‚ùå</span>
            <h3 style="margin:16px 0 8px 0;">Error al cargar √≥rdenes</h3>
            <p>${err.message}</p>
          </div>
        `;
      }
    };

    // Close product orders modal
    document.getElementById('productOrdersModalClose').addEventListener('click', () => {
      document.getElementById('productOrdersModal').style.display = 'none';
    });

    document.getElementById('productOrdersModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('productOrdersModal')) {
        document.getElementById('productOrdersModal').style.display = 'none';
      }
    });

    // Recalculate distributor points and commissions
    window.recalculateDistributor = async function(distributorId) {
      if (!currentUser) {
        alert('Error: Usuario no autenticado');
        return;
      }

      const confirmRecalc = confirm(
        '¬øRecalcular los puntos y comisiones de este distribuidor?\n\n' +
        'Esta acci√≥n:\n' +
        '‚Ä¢ Analizar√° todo el historial del distribuidor\n' +
        '‚Ä¢ Recalcular√° los puntos grupales correctos\n' +
        '‚Ä¢ Actualizar√° el balance bas√°ndose en comisiones reales\n' +
        '‚Ä¢ Excluir√° compras personales de los puntos grupales\n\n' +
        '¬øDeseas continuar?'
      );

      if (!confirmRecalc) return;

      try {
        const token = await currentUser.getIdToken();
        
        // Mostrar indicador de carga
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span style="font-size:16px;">‚è≥</span> Recalculando...';

        const res = await fetch('/.netlify/functions/recalculate-distributor', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ distributorId })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Error desconocido');
        }

        // Restaurar bot√≥n
        btn.disabled = false;
        btn.innerHTML = originalText;

        // Mostrar resultados
        const changes = data.changes;
        const changesSummary = [
          `Puntos Grupales: ${data.before.groupPoints} ‚Üí ${data.after.groupPoints} (${changes.groupPoints >= 0 ? '+' : ''}${changes.groupPoints})`,
          `Balance: $${data.before.balance.toLocaleString()} ‚Üí $${data.after.balance.toLocaleString()} (${changes.balance >= 0 ? '+' : ''}$${changes.balance.toLocaleString()})`
        ].join('\n');

        alert(
          '‚úÖ Recalculaci√≥n completada exitosamente\n\n' +
          'Cambios realizados:\n' +
          changesSummary
        );

        // Recargar datos del panel
        await loadAllData();
        
        // Recargar detalles del distribuidor si el panel est√° abierto
        const panel = document.getElementById('distributorDetailsPanel');
        if (panel && panel.style.display === 'block') {
          await showDistributorDetails(distributorId);
        }

      } catch (err) {
        console.error('Error recalculando distribuidor:', err);
        alert('Error recalculando distribuidor:\n' + err.message);
        
        // Restaurar bot√≥n en caso de error
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }
    };

    // ============================================
    // CALCULADORA DE PUNTOS Y COMISIONES
    // ============================================

    const POINT_VALUE = 2800;
    const COMMISSION_RATE = 0.10;
    const RESTAURANT_COMMISSION_RATE = 0.05;
    const MAX_LEVELS = 5;
    const QUICK_START_THRESHOLD = 50;
    const QUICK_START_DIRECT_POINTS = 21;
    const QUICK_START_UPPER_LEVELS_POINTS = 1;
    const MAX_LEVELS_QUICK_START = 4;

    let calcUsers = [];
    let calcProducts = [];

    async function loadCalculatorData() {
      try {
        const [usersSnap, productsSnap] = await Promise.all([
          getDocs(collection(db, 'usuarios')),
          getDocs(collection(db, 'productos'))
        ]);

        calcUsers = usersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        calcProducts = productsSnap.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(p => !p.deleted && !p.hidden);

        const buyerSelect = document.getElementById('calcBuyer');
        const productSelect = document.getElementById('calcProduct');

        buyerSelect.innerHTML = '<option value="">Seleccionar usuario...</option>';
        calcUsers.forEach(user => {
          const option = document.createElement('option');
          option.value = user.id;
          option.textContent = `${user.nombre} (@${user.usuario}) - ${user.tipoRegistro || 'usuario'}`;
          buyerSelect.appendChild(option);
        });

        productSelect.innerHTML = '<option value="">Seleccionar producto...</option>';
        calcProducts.forEach(prod => {
          const option = document.createElement('option');
          option.value = prod.id;
          option.textContent = `${prod.nombre} - $${(prod.precioDistribuidor || prod.precio || 0).toLocaleString()}`;
          productSelect.appendChild(option);
        });

      } catch (err) {
        console.error('Error loading calculator data:', err);
        alert('Error cargando datos para la calculadora');
      }
    }

    async function findUserByUsername(username) {
      if (!username) return null;
      const user = calcUsers.find(u => u.usuario === username);
      return user ? { id: user.id, data: user } : null;
    }

    function getProductPrice(product, userType) {
      if (userType === 'distribuidor') {
        return product.precioDistribuidor || product.precio || 0;
      } else if (userType === 'cliente') {
        return product.precioCliente || product.precio || 0;
      } else if (userType === 'restaurante') {
        return product.precioRestaurante || product.precio || 0;
      }
      return product.precio || 0;
    }

    function getProductPoints(product, userType) {
      if (userType === 'distribuidor') {
        return product.puntosDistribuidor || product.puntos || 0;
      } else if (userType === 'restaurante') {
        return product.puntosRestaurante || product.puntos || 0;
      }
      return product.puntosDistribuidor || product.puntos || 0;
    }

    document.getElementById('calcCalculateBtn').addEventListener('click', async () => {
      const buyerId = document.getElementById('calcBuyer').value;
      const productId = document.getElementById('calcProduct').value;
      const quantity = parseInt(document.getElementById('calcQuantity').value) || 1;
      const isFirstPurchase = document.getElementById('calcIsFirstPurchase').checked;

      if (!buyerId || !productId) {
        alert('Por favor selecciona un comprador y un producto');
        return;
      }

      const buyer = calcUsers.find(u => u.id === buyerId);
      const product = calcProducts.find(p => p.id === productId);

      if (!buyer || !product) {
        alert('Error: comprador o producto no encontrado');
        return;
      }

      const buyerType = buyer.tipoRegistro || 'distribuidor';
      const unitPrice = getProductPrice(product, buyerType);
      const unitPoints = getProductPoints(product, buyerType);
      const totalPrice = unitPrice * quantity;
      const totalPoints = unitPoints * quantity;

      // Build upline chain
      const uplineChain = [];
      let currentSponsor = buyer.patrocinador;

      while (currentSponsor && uplineChain.length < MAX_LEVELS) {
        const sponsorObj = await findUserByUsername(currentSponsor);
        if (!sponsorObj) break;

        uplineChain.push({
          username: sponsorObj.data.usuario,
          name: sponsorObj.data.nombre,
          level: uplineChain.length + 1,
          type: sponsorObj.data.tipoRegistro || 'distribuidor'
        });

        currentSponsor = sponsorObj.data.patrocinador;
      }

      // Calculate commissions based on buyer type
      let commissions = [];
      let quickStartBonus = null;

      if (buyerType === 'cliente') {
        // Cliente: solo al patrocinador directo
        if (uplineChain.length > 0) {
          const distPrice = product.precioDistribuidor || product.precio || 0;
          const priceDiff = (unitPrice - distPrice) * quantity;
          const diffPoints = priceDiff / POINT_VALUE;

          commissions.push({
            recipient: uplineChain[0],
            amountCOP: priceDiff,
            points: diffPoints,
            type: 'Comisi√≥n por diferencia de precio'
          });
        }
      } else if (buyerType === 'distribuidor') {
        // Check Quick Start Bonus
        if (isFirstPurchase && totalPoints >= QUICK_START_THRESHOLD) {
          const numPackages = Math.floor(totalPoints / QUICK_START_THRESHOLD);

          if (uplineChain.length > 0) {
            const directPoints = numPackages * QUICK_START_DIRECT_POINTS;
            quickStartBonus = {
              recipient: uplineChain[0],
              points: directPoints,
              amountCOP: directPoints * POINT_VALUE,
              type: 'Quick Start Bonus (Patrocinador Directo)'
            };
          }

          for (let i = 1; i < Math.min(uplineChain.length, MAX_LEVELS_QUICK_START + 1); i++) {
            const upperPoints = numPackages * QUICK_START_UPPER_LEVELS_POINTS;
            commissions.push({
              recipient: uplineChain[i],
              amountCOP: upperPoints * POINT_VALUE,
              points: upperPoints,
              type: `Quick Start Bonus (Nivel ${i + 1})`
            });
          }
        } else {
          // Normal commission: 10% to each upline
          const totalValue = totalPoints * POINT_VALUE;
          const commissionPerUpline = totalValue * COMMISSION_RATE;
          const pointsPerUpline = commissionPerUpline / POINT_VALUE;

          uplineChain.forEach(upline => {
            commissions.push({
              recipient: upline,
              amountCOP: commissionPerUpline,
              points: pointsPerUpline,
              type: `Comisi√≥n 10% (Nivel ${upline.level})`
            });
          });
        }
      } else if (buyerType === 'restaurante') {
        // Restaurant: 5% of total points to each upline
        const pointsPerUpline = totalPoints * RESTAURANT_COMMISSION_RATE;
        const amountPerUpline = pointsPerUpline * POINT_VALUE;

        uplineChain.forEach(upline => {
          commissions.push({
            recipient: upline,
            amountCOP: amountPerUpline,
            points: pointsPerUpline,
            type: `Comisi√≥n 5% Restaurante (Nivel ${upline.level})`
          });
        });
      }

      // Display results
      const summaryDiv = document.getElementById('calcSummary');
      summaryDiv.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:16px;">
          <div style="background:#f8f9fa;padding:16px;border-radius:6px;">
            <div style="font-size:12px;color:#666;margin-bottom:4px;">Comprador</div>
            <div style="font-weight:600;font-size:16px;">${buyer.nombre}</div>
            <div style="font-size:13px;color:#666;">@${buyer.usuario}</div>
            <div style="margin-top:4px;">
              <span style="background:#007bff;color:white;padding:2px 8px;border-radius:10px;font-size:11px;text-transform:uppercase;">${buyerType}</span>
            </div>
          </div>
          <div style="background:#f8f9fa;padding:16px;border-radius:6px;">
            <div style="font-size:12px;color:#666;margin-bottom:4px;">Producto</div>
            <div style="font-weight:600;font-size:16px;">${product.nombre}</div>
            <div style="font-size:13px;color:#666;">Cantidad: ${quantity}</div>
          </div>
          <div style="background:#e7f5ff;padding:16px;border-radius:6px;">
            <div style="font-size:12px;color:#666;margin-bottom:4px;">Precio Total</div>
            <div style="font-weight:700;font-size:20px;color:#007bff;">$${totalPrice.toLocaleString()}</div>
            <div style="font-size:13px;color:#666;">$${unitPrice.toLocaleString()} √ó ${quantity}</div>
          </div>
          <div style="background:#e6f9f0;padding:16px;border-radius:6px;">
            <div style="font-size:12px;color:#666;margin-bottom:4px;">Puntos Totales</div>
            <div style="font-weight:700;font-size:20px;color:#28a745;">${totalPoints} pts</div>
            <div style="font-size:13px;color:#666;">${unitPoints} pts √ó ${quantity}</div>
          </div>
        </div>
      `;

      const distributionDiv = document.getElementById('calcDistribution');

      if (commissions.length === 0 && !quickStartBonus) {
        distributionDiv.innerHTML = `
          <div style="text-align:center;padding:40px;color:#6c757d;">
            <span style="font-size:48px;">‚ÑπÔ∏è</span>
            <h3 style="margin:16px 0 8px 0;">Sin comisiones</h3>
            <p>Este comprador no tiene patrocinador o no genera comisiones.</p>
          </div>
        `;
      } else {
        let totalCommissionCOP = commissions.reduce((sum, c) => sum + c.amountCOP, 0);
        let totalCommissionPoints = commissions.reduce((sum, c) => sum + c.points, 0);

        if (quickStartBonus) {
          totalCommissionCOP += quickStartBonus.amountCOP;
          totalCommissionPoints += quickStartBonus.points;
        }

        let distributionHTML = '';

        if (quickStartBonus) {
          distributionHTML += `
            <div style="background:#fff3cd;border-left:4px solid #ffc107;padding:16px;margin-bottom:16px;border-radius:4px;">
              <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
                <div>
                  <div style="font-weight:600;color:#856404;margin-bottom:4px;">‚≠ê ${quickStartBonus.type}</div>
                  <div style="font-size:14px;color:#856404;">${quickStartBonus.recipient.name} (@${quickStartBonus.recipient.username})</div>
                </div>
                <div style="text-align:right;">
                  <div style="font-size:18px;font-weight:700;color:#856404;">$${quickStartBonus.amountCOP.toLocaleString()}</div>
                  <div style="font-size:14px;color:#856404;">${quickStartBonus.points.toFixed(2)} puntos</div>
                </div>
              </div>
            </div>
          `;
        }

        commissions.forEach((comm, idx) => {
          const bgColor = idx % 2 === 0 ? '#f8f9fa' : '#ffffff';
          distributionHTML += `
            <div style="background:${bgColor};padding:16px;margin-bottom:8px;border-radius:4px;border-left:4px solid #764ba2;">
              <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
                <div style="flex:1;">
                  <div style="font-weight:600;margin-bottom:4px;">${comm.recipient.name}</div>
                  <div style="font-size:13px;color:#666;">@${comm.recipient.username}</div>
                  <div style="font-size:12px;color:#764ba2;margin-top:4px;">${comm.type}</div>
                </div>
                <div style="text-align:right;">
                  <div style="font-size:18px;font-weight:700;color:#333;">$${comm.amountCOP.toLocaleString()}</div>
                  <div style="font-size:14px;color:#28a745;">${comm.points.toFixed(2)} puntos</div>
                </div>
              </div>
            </div>
          `;
        });

        distributionHTML += `
          <div style="background:#e9ecef;padding:20px;margin-top:16px;border-radius:6px;">
            <div style="display:flex;justify-content:space-between;align-items:center;font-weight:700;font-size:18px;">
              <div>TOTAL A DISTRIBUIR:</div>
              <div>
                <div style="color:#333;">$${totalCommissionCOP.toLocaleString()}</div>
                <div style="color:#28a745;font-size:16px;">${totalCommissionPoints.toFixed(2)} puntos</div>
              </div>
            </div>
          </div>
        `;

        distributionDiv.innerHTML = distributionHTML;
      }

      document.getElementById('calcResults').style.display = 'block';
    });

    // Load calculator data when the calculator tab is activated
    const originalTabListener = document.querySelectorAll('.tab-button');
    originalTabListener.forEach(btn => {
      if (btn.dataset.tab === 'calculator') {
        btn.addEventListener('click', () => {
          if (calcUsers.length === 0 || calcProducts.length === 0) {
            loadCalculatorData();
          }
        });
      }
    });
  </script>
</body>
</html>
