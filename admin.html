<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Administraci√≥n - PorkCasare</title>
  <link rel="stylesheet" href="/oficina-virtual/css/style.css">
  <style>
    /* === FINANCIAL PLATFORM THEME === */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    :root {
      --primary-dark: #1a1f36;
      --primary-blue: #0052cc;
      --accent-blue: #2684ff;
      --success-green: #00875a;
      --danger-red: #de350b;
      --warning-orange: #ff8b00;
      --text-primary: #172b4d;
      --text-secondary: #5e6c84;
      --border-color: #dfe1e6;
      --bg-light: #f4f5f7;
      --bg-white: #ffffff;
      --shadow-sm: 0 1px 2px rgba(9,30,66,0.08);
      --shadow-md: 0 4px 8px rgba(9,30,66,0.1);
      --shadow-lg: 0 8px 16px rgba(9,30,66,0.12);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 0;
      background: var(--bg-light);
      margin: 0;
      color: var(--text-primary);
      line-height: 1.5;
    }

    h1 { margin-bottom: 20px; color: var(--primary-dark); font-weight: 700; letter-spacing: -0.5px; }
    h2 { color: var(--text-primary); font-weight: 600; letter-spacing: -0.3px; }
    h3 { color: var(--text-primary); font-weight: 600; }

    .hidden { display: none !important; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: var(--bg-white);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }
    th, td { padding: 14px 16px; border-bottom: 1px solid var(--border-color); text-align: left; }
    th {
      background: linear-gradient(180deg, #fafbfc 0%, #f4f5f7 100%);
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    tbody tr:hover { background: #f8f9fa; }
    tbody tr:last-child td { border-bottom: none; }

    button {
      padding: 8px 16px;
      margin: 2px;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    button:hover { transform: translateY(-1px); box-shadow: var(--shadow-sm); }
    button:active { transform: translateY(0); }

    .btn-primary { background: var(--primary-blue); color: white; }
    .btn-primary:hover { background: #0047b3; }
    .btn-success { background: var(--success-green); color: white; }
    .btn-success:hover { background: #006644; }
    .btn-danger { background: var(--danger-red); color: white; }
    .btn-danger:hover { background: #bf2600; }
    .btn-secondary { background: var(--bg-light); color: var(--text-primary); border: 1px solid var(--border-color); }
    .btn-secondary:hover { background: #e4e7eb; }

    /* === WALL STREET TICKER BANNER === */
    .ticker-wrapper {
      background: linear-gradient(90deg, #0d1117 0%, #161b22 50%, #0d1117 100%);
      border-bottom: 1px solid #30363d;
      overflow: hidden;
      position: relative;
    }
    .ticker-wrapper::before,
    .ticker-wrapper::after {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      width: 60px;
      z-index: 2;
      pointer-events: none;
    }
    .ticker-wrapper::before {
      left: 0;
      background: linear-gradient(90deg, #0d1117, transparent);
    }
    .ticker-wrapper::after {
      right: 0;
      background: linear-gradient(90deg, transparent, #0d1117);
    }
    .ticker-content {
      display: flex;
      animation: ticker-scroll 40s linear infinite;
      padding: 12px 0;
    }
    .ticker-content:hover {
      animation-play-state: paused;
    }
    @keyframes ticker-scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    .ticker-item {
      display: flex;
      align-items: center;
      padding: 0 28px;
      white-space: nowrap;
      border-right: 1px solid #30363d;
    }
    .ticker-item:last-child { border-right: none; }
    .ticker-label {
      font-size: 11px;
      font-weight: 600;
      color: #8b949e;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-right: 10px;
    }
    .ticker-value {
      font-size: 15px;
      font-weight: 700;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', monospace;
    }
    .ticker-value.positive { color: #3fb950; }
    .ticker-value.negative { color: #f85149; }
    .ticker-value.neutral { color: #58a6ff; }
    .ticker-change {
      font-size: 12px;
      margin-left: 8px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }
    .ticker-change.up { background: rgba(63,185,80,0.15); color: #3fb950; }
    .ticker-change.down { background: rgba(248,81,73,0.15); color: #f85149; }

    /* === TABS === */
    .tabs {
      display: flex;
      gap: 4px;
      background: var(--bg-white);
      padding: 8px 12px;
      border-radius: 12px;
      margin: 0 20px 20px 20px;
      flex-wrap: wrap;
      box-shadow: var(--shadow-sm);
    }
    .tab-button {
      padding: 10px 18px;
      background: transparent;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.2s ease;
    }
    .tab-button:hover { background: var(--bg-light); color: var(--text-primary); }
    .tab-button.active {
      background: var(--primary-blue);
      color: white;
      box-shadow: var(--shadow-sm);
    }
    .tab-content { display: none; padding: 0 20px 20px 20px; }
    .tab-content.active { display: block; }

    /* Accordion for Product Costs */
    #productCostsAccordionHeader:hover {
      filter: brightness(1.05);
    }

    /* === STATS CARDS === */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: var(--bg-white);
      padding: 24px;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
      transition: all 0.2s ease;
    }
    .stat-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    .stat-card h3 {
      margin: 0 0 12px 0;
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .stat-card .value {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
      font-family: 'SF Mono', 'Monaco', monospace;
    }
    .stat-card.blue .value { color: var(--primary-blue); }
    .stat-card.green .value { color: var(--success-green); }
    .stat-card.orange .value { color: var(--warning-orange); }
    .stat-card.purple .value { color: #6554c0; }
    .stat-card.red .value { color: var(--danger-red); }

    /* === ADMIN HEADER === */
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      background: var(--bg-white);
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 0;
      flex-wrap: wrap;
      gap: 12px;
    }
    .admin-header h1 {
      font-size: 24px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .admin-header h1::before {
      content: 'üìä';
      font-size: 28px;
    }

    .empty-state { text-align: center; padding: 60px 40px; color: var(--text-secondary); }
    
    /* Product Cards */
    .product-card-preview { 
      background: white; 
      border-radius: 12px; 
      padding: 16px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }
    .product-card-preview:hover { 
      transform: translateY(-4px); 
      box-shadow: 0 4px 16px rgba(0,0,0,0.15); 
    }
    .product-card-preview img { 
      width: 100%; 
      height: 180px; 
      object-fit: cover; 
      border-radius: 8px; 
      margin-bottom: 12px; 
    }
    .product-card-preview h4 { 
      margin: 0 0 8px 0; 
      font-size: 16px; 
      font-weight: 600; 
      color: #333; 
    }
    .product-card-preview p { 
      margin: 0 0 8px 0; 
      font-size: 13px; 
      color: #666; 
      line-height: 1.4; 
    }
    .product-card-preview .price { 
      font-size: 18px; 
      font-weight: 700; 
      color: #28a745; 
      margin-bottom: 8px; 
    }
    .product-badge { 
      position: absolute; 
      top: 24px; 
      right: 24px; 
      background: #dc3545; 
      color: white; 
      padding: 4px 8px; 
      border-radius: 4px; 
      font-size: 11px; 
      font-weight: 600; 
      text-transform: uppercase; 
    }
    .product-badge.hidden { background: #6c757d; }
    .product-badge.outofstock { background: #fd7e14; }

    /* Grouped Orders Styles */
    .user-orders-group {
      background: white;
      border-radius: 12px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden;
      border: 1px solid #e9ecef;
    }
    .user-orders-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid transparent;
    }
    .user-orders-header:hover {
      background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    }
    .user-orders-header.expanded {
      border-bottom-color: #dee2e6;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .user-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 18px;
    }
    .user-details h4 {
      margin: 0;
      font-size: 16px;
      color: #333;
    }
    .user-details p {
      margin: 4px 0 0 0;
      font-size: 13px;
      color: #6c757d;
    }
    .orders-summary {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .orders-count {
      background: #007bff;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }
    .orders-total {
      font-size: 15px;
      font-weight: 600;
      color: #28a745;
    }
    .expand-icon {
      font-size: 20px;
      color: #6c757d;
      transition: transform 0.3s;
    }
    .user-orders-header.expanded .expand-icon {
      transform: rotate(180deg);
    }
    .user-orders-content {
      display: none;
      padding: 0;
    }
    .user-orders-content.expanded {
      display: block;
    }
    .order-card {
      border-bottom: 1px solid #f1f3f4;
      padding: 20px;
      background: #fff;
    }
    .order-card:last-child {
      border-bottom: none;
    }
    .order-card:hover {
      background: #fafbfc;
    }
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px dashed #e9ecef;
    }
    .order-id {
      font-family: monospace;
      font-size: 13px;
      background: #f8f9fa;
      padding: 4px 10px;
      border-radius: 4px;
      color: #495057;
    }
    .order-status {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .order-status.pending { background: #fff3cd; color: #856404; }
    .order-status.pending_delivery { background: #cce5ff; color: #004085; }
    .order-status.pending_mp { background: #d4edda; color: #155724; }
    .order-status.pending_cash { background: #e2d6f5; color: #563d7c; }
    .order-products {
      margin-bottom: 16px;
    }
    .product-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .product-item:last-child {
      margin-bottom: 0;
    }
    .product-info {
      flex: 1;
    }
    .product-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }
    .product-variants {
      font-size: 13px;
      color: #6c757d;
    }
    .product-variants span {
      display: inline-block;
      margin-right: 12px;
    }
    .product-pricing {
      text-align: right;
    }
    .product-qty {
      font-size: 13px;
      color: #6c757d;
      margin-bottom: 2px;
    }
    .product-price {
      font-weight: 700;
      color: #28a745;
    }
    .order-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 12px;
      border-top: 1px solid #e9ecef;
    }
    .order-total {
      font-size: 18px;
      font-weight: 700;
      color: #333;
    }
    .order-actions {
      display: flex;
      gap: 8px;
    }
    .order-actions button {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 6px;
    }
    .empty-orders-state {
      text-align: center;
      padding: 60px 20px;
      color: #6c757d;
    }
    .empty-orders-state h3 {
      margin: 0 0 8px 0;
      font-size: 18px;
      color: #495057;
    }
    .pending-orders-container {
      max-width: 100%;
    }

    /* === LOGIN SECTION === */
    #loginSection {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #0d1117 0%, #161b22 50%, #1a1f36 100%);
      padding: 20px;
    }
    #loginSection h2 {
      color: #f0f6fc;
      font-size: 28px;
      margin-bottom: 32px;
      letter-spacing: -0.5px;
    }
    #loginSection h2::before {
      content: 'üîê ';
    }
    #loginForm {
      background: #21262d;
      padding: 40px;
      border-radius: 16px;
      border: 1px solid #30363d;
      box-shadow: 0 16px 48px rgba(0,0,0,0.4);
      width: 100%;
      max-width: 400px;
    }
    #loginForm label {
      color: #8b949e;
      font-size: 14px;
      font-weight: 500;
      display: block;
      margin-bottom: 8px;
    }
    #loginForm input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid #30363d;
      border-radius: 8px;
      background: #0d1117;
      color: #f0f6fc;
      font-size: 15px;
      margin-bottom: 20px;
      box-sizing: border-box;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    #loginForm input:focus {
      outline: none;
      border-color: #58a6ff;
      box-shadow: 0 0 0 3px rgba(88,166,255,0.15);
    }
    #loginForm button {
      width: 100%;
      padding: 14px 24px;
      background: linear-gradient(135deg, #238636 0%, #2ea043 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    #loginForm button:hover {
      background: linear-gradient(135deg, #2ea043 0%, #3fb950 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(46,160,67,0.3);
    }

    /* Unsaved changes indicator for branding section */
    .btn-pulse {
      animation: pulse-save 1.5s infinite;
      box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.5);
    }

    @keyframes pulse-save {
      0% {
        box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.5);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
      }
    }

    .unsaved-indicator {
      display: none;
      color: var(--warning-orange);
      font-size: 0.85rem;
      font-weight: 500;
      margin-left: 8px;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      50% { opacity: 0.5; }
    }

    /* === ENHANCED ACTIVITY LOG STYLES === */
    .activity-container {
      background: var(--bg-white);
      border-radius: 12px;
      box-shadow: var(--shadow-md);
      overflow: hidden;
      margin-top: 20px;
    }

    .activity-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: linear-gradient(180deg, #fafbfc 0%, #f4f5f7 100%);
      border-bottom: 1px solid var(--border-color);
    }

    .activity-header h2 {
      margin: 0;
      font-size: 16px;
      color: var(--text-primary);
    }

    .activity-refresh-btn {
      padding: 6px 12px;
      font-size: 12px;
      background: var(--primary-blue);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .activity-list {
      max-height: 600px;
      overflow-y: auto;
    }

    .activity-item {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background 0.2s;
    }

    .activity-item:hover {
      background: #f8f9fa;
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .activity-type-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .activity-type-badge.sale {
      background: rgba(0, 135, 90, 0.1);
      color: var(--success-green);
    }

    .activity-type-badge.order_approved {
      background: rgba(38, 132, 255, 0.1);
      color: var(--accent-blue);
    }

    .activity-type-badge.order_rejected {
      background: rgba(222, 53, 11, 0.1);
      color: var(--danger-red);
    }

    .activity-type-badge.user_registration {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
    }

    .activity-timestamp {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .activity-title {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .activity-user {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .activity-financial {
      display: flex;
      gap: 16px;
      margin-bottom: 8px;
    }

    .activity-stat {
      display: flex;
      flex-direction: column;
    }

    .activity-stat-label {
      font-size: 10px;
      text-transform: uppercase;
      color: var(--text-secondary);
      letter-spacing: 0.5px;
    }

    .activity-stat-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .activity-stat-value.positive {
      color: var(--success-green);
    }

    .activity-beneficiaries-summary {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
      padding-top: 8px;
      border-top: 1px dashed var(--border-color);
    }

    .activity-beneficiaries-count {
      background: var(--bg-light);
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 500;
    }

    .activity-expand-icon {
      margin-left: auto;
      color: var(--text-secondary);
      transition: transform 0.2s;
    }

    .activity-item.expanded .activity-expand-icon {
      transform: rotate(180deg);
    }

    .activity-details {
      display: none;
      padding: 16px 20px 20px;
      background: linear-gradient(180deg, #f8f9fa 0%, #ffffff 100%);
      border-bottom: 1px solid var(--border-color);
    }

    .activity-item.expanded + .activity-details {
      display: block;
    }

    /* Expanded detail section styles */
    .activity-detail-section {
      margin-bottom: 16px;
    }

    .activity-detail-section:last-child {
      margin-bottom: 0;
    }

    .activity-detail-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 600;
    }

    .activity-detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      background: white;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .activity-detail-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .activity-detail-label {
      font-size: 10px;
      text-transform: uppercase;
      color: var(--text-secondary);
      letter-spacing: 0.3px;
    }

    .activity-detail-value {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .activity-detail-value.highlight-blue {
      color: var(--primary-blue);
    }

    .activity-detail-value.highlight-green {
      color: var(--success-green);
    }

    .no-beneficiaries-message {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .no-beneficiaries-message-icon {
      font-size: 16px;
    }

    .click-to-expand-hint {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
      padding-top: 8px;
      border-top: 1px dashed var(--border-color);
      cursor: pointer;
    }

    .click-to-expand-hint:hover {
      color: var(--primary-blue);
    }

    .beneficiary-list {
      margin: 0;
      padding: 0;
      list-style: none;
    }

    .beneficiary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: white;
      border-radius: 6px;
      margin-bottom: 8px;
      border: 1px solid var(--border-color);
    }

    .beneficiary-item:last-child {
      margin-bottom: 0;
    }

    .beneficiary-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .beneficiary-level {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--primary-blue);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
    }

    .beneficiary-name {
      font-weight: 500;
      font-size: 13px;
      color: var(--text-primary);
    }

    .beneficiary-earnings {
      text-align: right;
    }

    .beneficiary-points {
      font-size: 13px;
      font-weight: 600;
      color: var(--primary-blue);
    }

    .beneficiary-amount {
      font-size: 12px;
      color: var(--success-green);
      font-weight: 500;
    }

    .activity-empty {
      padding: 40px 20px;
      text-align: center;
      color: var(--text-secondary);
    }

    .activity-empty-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <!-- Formulario de login -->
  <div id="loginSection">
    <h2>Iniciar sesi√≥n</h2>
    <form id="loginForm">
      <label for="email">Email</label>
      <input type="email" id="email" placeholder="correo@ejemplo.com" required>
      <label for="password">Contrase√±a</label>
      <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
      <button type="submit">Ingresar</button>
    </form>
  </div>

  <!-- Panel solo visible si es admin -->
  <div id="adminPanel" class="hidden">
    <!-- Wall Street Ticker Banner -->
    <div class="ticker-wrapper" id="salesTicker">
      <div class="ticker-content" id="tickerContent">
        <!-- Ticker items will be populated by JavaScript -->
        <div class="ticker-item">
          <span class="ticker-label">Cargando datos...</span>
          <span class="ticker-value neutral">--</span>
        </div>
      </div>
    </div>

    <div class="admin-header">
      <h1>Panel de Administraci√≥n</h1>
      <button id="logoutBtn" class="btn-secondary">Cerrar sesi√≥n</button>
    </div>

    <div style="padding-top: 20px;"></div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-button active" data-tab="overview">Resumen</button>
      <button class="tab-button" data-tab="pending">√ìrdenes Pendientes</button>
      <button class="tab-button" data-tab="confirmed">√ìrdenes Confirmadas</button>
      <button class="tab-button" data-tab="rejected">√ìrdenes Rechazadas</button>
      <button class="tab-button" data-tab="distributors">Distribuidores</button>
      <button class="tab-button" data-tab="clients">Clientes</button>
      <button class="tab-button" data-tab="payouts">Cobros de Distribuidores</button>
      <button class="tab-button" data-tab="users">Usuarios</button>
      <button class="tab-button" data-tab="inventory">Inventario</button>
      <button class="tab-button" data-tab="products">Productos</button>
      <button class="tab-button" data-tab="categories">Categor√≠as</button>
      <button class="tab-button" data-tab="shipping">Tarifas de Env√≠o</button>
      <button class="tab-button" data-tab="calculator">Calculadora de Puntos</button>
      <button class="tab-button" data-tab="profits">Ganancias</button>
      <button class="tab-button" data-tab="education">Educaci√≥n</button>
      <button class="tab-button" data-tab="branding">Identidad Visual</button>
    </div>

    <!-- Tab: Resumen -->
    <div id="tab-overview" class="tab-content active">
      <div class="stats-grid">
        <div class="stat-card blue">
          <h3>Total de Ventas</h3>
          <div class="value" id="totalSales">$0</div>
        </div>
        <div class="stat-card green">
          <h3>√ìrdenes Confirmadas</h3>
          <div class="value" id="confirmedCount">0</div>
        </div>
        <div class="stat-card orange">
          <h3>√ìrdenes Pendientes</h3>
          <div class="value" id="pendingCount">0</div>
        </div>
        <div class="stat-card purple">
          <h3>Distribuidores</h3>
          <div class="value" id="distributorsCount">0</div>
        </div>
        <div class="stat-card blue">
          <h3>Total Usuarios</h3>
          <div class="value" id="usersCount">0</div>
        </div>
        <div class="stat-card red">
          <h3>√ìrdenes Rechazadas</h3>
          <div class="value" id="rejectedCount">0</div>
        </div>
        <div class="stat-card green">
          <h3>Inventario Total</h3>
          <div class="value" id="inventoryCount">0</div>
        </div>
      </div>
      
      <h2>Actividad Reciente</h2>
      <div class="activity-container">
        <div class="activity-header">
          <span style="font-size:13px;color:var(--text-secondary);">√öltimas acciones del sistema</span>
          <button class="activity-refresh-btn" onclick="loadRecentActivity()">Actualizar</button>
        </div>
        <div class="activity-list" id="recentActivityList">
          <!-- Activity items will be populated by JavaScript -->
          <div class="activity-empty">
            <div class="activity-empty-icon">üìä</div>
            <div>Cargando actividad reciente...</div>
          </div>
        </div>
      </div>

      <!-- Legacy table for backward compatibility (hidden) -->
      <table style="display:none;">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Usuario</th>
            <th>Precio</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="recentActivity"></tbody>
      </table>
    </div>

    <!-- Tab: √ìrdenes Pendientes -->
    <div id="tab-pending" class="tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h2 style="margin:0;">√ìrdenes Pendientes</h2>
        <div style="display:flex;gap:12px;align-items:center;">
          <span id="pendingOrdersSummary" style="font-size:14px;color:#6c757d;"></span>
          <button id="expandAllOrders" class="btn-secondary" style="font-size:13px;padding:6px 12px;">Expandir Todo</button>
          <button id="collapseAllOrders" class="btn-secondary" style="font-size:13px;padding:6px 12px;">Colapsar Todo</button>
        </div>
      </div>
      <div id="pendingOrdersGrouped" class="pending-orders-container">
        <!-- Grouped orders will be rendered here -->
      </div>
    </div>

    <!-- Tab: √ìrdenes Confirmadas -->
    <div id="tab-confirmed" class="tab-content">
      <h2>√ìrdenes Confirmadas</h2>
      <table>
        <thead>
          <tr>
            <th>ID Orden</th>
            <th>ID Usuario</th>
            <th>Usuario</th>
            <th>Producto</th>
            <th>Precio</th>
            <th>Puntos</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="confirmedOrdersTable"></tbody>
      </table>
    </div>

    <!-- Tab: √ìrdenes Rechazadas -->
    <div id="tab-rejected" class="tab-content">
      <h2>√ìrdenes Rechazadas</h2>
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>ID</th>
            <th>Producto</th>
            <th>Usuario</th>
            <th>Precio</th>
            <th>Motivo</th>
          </tr>
        </thead>
        <tbody id="rejectedOrdersTable"></tbody>
      </table>
    </div>

    <!-- Tab: Distribuidores -->
    <div id="tab-distributors" class="tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:12px;flex-wrap:wrap;">
        <h2 style="margin:0;">Distribuidores Registrados</h2>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <input type="text" id="distributorSearchInput" placeholder="Buscar por nombre, usuario o c√©dula..." style="padding:10px 16px;border:1px solid #ddd;border-radius:6px;font-size:14px;min-width:200px;">
          <select id="distributorSortFilter" style="padding:10px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px;background:white;">
            <option value="name_asc">Nombre A-Z</option>
            <option value="name_desc">Nombre Z-A</option>
            <option value="date_newest">M√°s Recientes</option>
            <option value="date_oldest">M√°s Antiguos</option>
            <option value="balance_high">Mayor Balance</option>
            <option value="balance_low">Menor Balance</option>
            <option value="points_high">M√°s Puntos Personales</option>
            <option value="points_low">Menos Puntos Personales</option>
            <option value="group_high">M√°s Puntos Grupales</option>
            <option value="group_low">Menos Puntos Grupales</option>
            <option value="referrals_high">M√°s Referidos</option>
            <option value="active_first">Activos Primero</option>
            <option value="inactive_first">Inactivos Primero</option>
          </select>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Nombre</th>
            <th>Email</th>
            <th>Celular</th>
            <th>Estado</th>
            <th>Puntos Personales</th>
            <th>Puntos Grupales</th>
            <th>Registro</th>
            <th>Detalles</th>
          </tr>
        </thead>
        <tbody id="distributorsTable"></tbody>
      </table>
      
      <!-- Distributor Details Panel -->
      <div id="distributorDetailsPanel" style="display:none;position:fixed;top:0;right:-600px;width:600px;height:100vh;background:white;box-shadow:-4px 0 20px rgba(0,0,0,0.15);z-index:2000;transition:right 0.3s ease;overflow-y:auto;">
        <div style="padding:24px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h2 style="margin:0;font-size:20px;">Detalles del Distribuidor</h2>
            <button id="closeDistributorPanel" style="background:transparent;border:none;font-size:28px;cursor:pointer;color:#666;line-height:1;">&times;</button>
          </div>
          
          <div id="distributorDetailsContent"></div>
        </div>
      </div>
      
      <!-- Overlay for distributor panel -->
      <div id="distributorPanelOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.3);z-index:1999;"></div>
    </div>

    <!-- Tab: Clientes -->
    <div id="tab-clients" class="tab-content">
      <h2>Clientes Registrados</h2>
      <table>
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Nombre</th>
            <th>Email</th>
            <th>Celular</th>
            <th>Puntos</th>
            <th>Registro</th>
          </tr>
        </thead>
        <tbody id="clientsTable"></tbody>
      </table>
    </div>

    <!-- Tab: Cobros de Distribuidores -->
    <div id="tab-payouts" class="tab-content">
      <h2>Cobros de Distribuidores</h2>
      <table>
        <thead>
          <tr>
            <th>Distribuidor</th>
            <th>Monto a cobrar</th>
            <th>Fecha solicitud</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="payoutsTable"></tbody>
      </table>
    </div>

    <!-- Tab: Inventario -->
    <div id="tab-inventory" class="tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h2 style="margin:0;">Gesti√≥n de Inventario</h2>
        <button id="addInventoryBtn" class="btn-success">+ Agregar Unidades</button>
      </div>
      
      <div class="stats-grid" style="margin-bottom:20px;">
        <div class="stat-card blue">
          <h3>Total en Stock</h3>
          <div class="value" id="totalStockUnits">0</div>
        </div>
        <div class="stat-card green">
          <h3>Unidades Vendidas</h3>
          <div class="value" id="totalSoldUnits">0</div>
        </div>
        <div class="stat-card orange">
          <h3>√öltima Actualizaci√≥n</h3>
          <div class="value" id="lastInventoryUpdate" style="font-size:16px;">N/A</div>
        </div>
      </div>

      <h3>Inventario por Producto</h3>
      <table style="margin-bottom:30px;">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Total de Unidades</th>
            <th>Unidades Vendidas</th>
            <th>Unidades en Existencia</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="productInventoryTable"></tbody>
      </table>

      <h3>Historial de Movimientos</h3>
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Producto</th>
            <th>Unidades</th>
            <th>Existencias Restantes</th>
            <th>Notas</th>
          </tr>
        </thead>
        <tbody id="inventoryHistoryTable"></tbody>
      </table>
    </div>

    <!-- Tab: Usuarios -->
    <div id="tab-users" class="tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h2 style="margin:0;">Todos los Usuarios</h2>
        <button id="bulkRoleBtn" class="btn-primary">Cambiar Role a Todos</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Nombre</th>
            <th>Email</th>
            <th>Tipo</th>
            <th>Puntos</th>
            <th>Registro</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="usersTable"></tbody>
      </table>
    </div>

    <!-- Tab: Productos -->
    <div id="tab-products" class="tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px;">
        <h2 style="margin:0;">Gesti√≥n de Productos</h2>
        <button id="addProductBtn" class="btn-success">+ Crear Producto</button>
      </div>

      <!-- Preview Selector -->
      <div style="background:white;padding:16px;border-radius:8px;margin-bottom:20px;">
        <label style="font-weight:600;margin-right:12px;">Vista previa para:</label>
        <select id="previewTypeSelector" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
          <option value="distribuidor">Distribuidores</option>
          <option value="restaurante">Restaurantes</option>
          <option value="cliente">Clientes</option>
        </select>
      </div>

      <!-- Products Grid Preview -->
      <div id="productsPreviewGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;margin-bottom:30px;">
        <!-- Product cards will be rendered here -->
      </div>

      <!-- Products Management Table -->
      <h3>Administraci√≥n de Productos</h3>
      <table>
        <thead>
          <tr>
            <th>Imagen</th>
            <th>Nombre</th>
            <th>Descripci√≥n</th>
            <th>Categor√≠a</th>
            <th>Unidades</th>
            <th>Precio Dist.</th>
            <th>Precio Cliente</th>
            <th>Precio Rest.</th>
            <th>Puntos</th>
            <th>Variantes</th>
            <th>Vendidas</th>
            <th>Destacado</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="productsManagementTable"></tbody>
      </table>
    </div>

    <!-- Tab: Categories -->
    <div id="tab-categories" class="tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px;">
        <h2 style="margin:0;">Gesti√≥n de Categor√≠as</h2>
        <button id="addCategoryBtn" class="btn-success">+ Crear Categor√≠a</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Slug</th>
            <th>Productos</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="categoriesTable">
          <!-- Categories will be rendered here -->
        </tbody>
      </table>
    </div>

    <!-- Tab: Tarifas de Env√≠o (UE) -->
    <div id="tab-shipping" class="tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px;">
        <h2 style="margin:0;">Configuraci√≥n de Tarifas de Env√≠o (UE)</h2>
        <button id="saveShippingRatesBtn" class="btn-primary" style="padding:10px 20px;">üíæ Guardar Cambios</button>
      </div>

      <div style="background:#fff3cd;padding:16px;border-radius:8px;margin-bottom:24px;border-left:4px solid #ffc107;">
        <h4 style="margin:0 0 8px 0;color:#856404;">üì¶ Sistema de Unidades de Env√≠o (UE)</h4>
        <p style="margin:0;color:#856404;font-size:13px;">
          El costo de env√≠o se calcula autom√°ticamente seg√∫n el <strong>total de UE</strong> del pedido y la <strong>ciudad de destino</strong>.<br>
          <strong>F√≥rmula:</strong> UE_total = Œ£ (UE_producto √ó cantidad)<br>
          <strong>Ejemplo:</strong> 2 vinos (UE=2) + 3 jabones (UE=1) = UE_total de 7
        </p>
      </div>

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(450px,1fr));gap:24px;">
        <!-- Tarifas para Yopal -->
        <div style="background:#f0fdf4;padding:20px;border-radius:12px;border:2px solid #86efac;">
          <h3 style="margin:0 0 16px 0;color:#166534;font-size:16px;">üè† Env√≠o Local - Yopal</h3>
          <p style="color:#166534;font-size:12px;margin:0 0 16px 0;">Mensaje mostrado: "Env√≠o local Yopal ‚Äì tarifa seg√∫n pedido"</p>

          <table style="width:100%;border-collapse:collapse;">
            <thead>
              <tr style="background:#dcfce7;">
                <th style="padding:10px;text-align:left;border-bottom:2px solid #86efac;font-size:13px;">Rango UE</th>
                <th style="padding:10px;text-align:right;border-bottom:2px solid #86efac;font-size:13px;">Tarifa (COP)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="padding:10px;border-bottom:1px solid #dcfce7;font-size:13px;">1 ‚Äì 5 UE</td>
                <td style="padding:10px;border-bottom:1px solid #dcfce7;text-align:right;">
                  <input type="number" id="yopal_1_5" value="5000" min="0" style="width:100px;padding:6px;border:1px solid #86efac;border-radius:4px;text-align:right;">
                </td>
              </tr>
              <tr>
                <td style="padding:10px;border-bottom:1px solid #dcfce7;font-size:13px;">6 ‚Äì 10 UE</td>
                <td style="padding:10px;border-bottom:1px solid #dcfce7;text-align:right;">
                  <input type="number" id="yopal_6_10" value="8000" min="0" style="width:100px;padding:6px;border:1px solid #86efac;border-radius:4px;text-align:right;">
                </td>
              </tr>
              <tr>
                <td style="padding:10px;font-size:13px;">+10 UE</td>
                <td style="padding:10px;text-align:right;">
                  <input type="number" id="yopal_11_plus" value="12000" min="0" style="width:100px;padding:6px;border:1px solid #86efac;border-radius:4px;text-align:right;">
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Tarifas para Otras Ciudades -->
        <div style="background:#eff6ff;padding:20px;border-radius:12px;border:2px solid #93c5fd;">
          <h3 style="margin:0 0 16px 0;color:#1e40af;font-size:16px;">üöö Env√≠o Nacional - Otras Ciudades</h3>
          <p style="color:#1e40af;font-size:12px;margin:0 0 16px 0;">Mensaje mostrado: "Env√≠o nacional calculado seg√∫n ciudad de destino"</p>

          <table style="width:100%;border-collapse:collapse;">
            <thead>
              <tr style="background:#dbeafe;">
                <th style="padding:10px;text-align:left;border-bottom:2px solid #93c5fd;font-size:13px;">Rango UE</th>
                <th style="padding:10px;text-align:right;border-bottom:2px solid #93c5fd;font-size:13px;">Tarifa (COP)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="padding:10px;border-bottom:1px solid #dbeafe;font-size:13px;">1 ‚Äì 3 UE</td>
                <td style="padding:10px;border-bottom:1px solid #dbeafe;text-align:right;">
                  <input type="number" id="other_1_3" value="16000" min="0" style="width:100px;padding:6px;border:1px solid #93c5fd;border-radius:4px;text-align:right;">
                </td>
              </tr>
              <tr>
                <td style="padding:10px;border-bottom:1px solid #dbeafe;font-size:13px;">4 ‚Äì 6 UE</td>
                <td style="padding:10px;border-bottom:1px solid #dbeafe;text-align:right;">
                  <input type="number" id="other_4_6" value="22000" min="0" style="width:100px;padding:6px;border:1px solid #93c5fd;border-radius:4px;text-align:right;">
                </td>
              </tr>
              <tr>
                <td style="padding:10px;border-bottom:1px solid #dbeafe;font-size:13px;">7 ‚Äì 10 UE</td>
                <td style="padding:10px;border-bottom:1px solid #dbeafe;text-align:right;">
                  <input type="number" id="other_7_10" value="30000" min="0" style="width:100px;padding:6px;border:1px solid #93c5fd;border-radius:4px;text-align:right;">
                </td>
              </tr>
              <tr>
                <td style="padding:10px;border-bottom:1px solid #dbeafe;font-size:13px;">11 ‚Äì 15 UE</td>
                <td style="padding:10px;border-bottom:1px solid #dbeafe;text-align:right;">
                  <input type="number" id="other_11_15" value="40000" min="0" style="width:100px;padding:6px;border:1px solid #93c5fd;border-radius:4px;text-align:right;">
                </td>
              </tr>
              <tr>
                <td style="padding:10px;font-size:13px;">+15 UE (especial)</td>
                <td style="padding:10px;text-align:right;">
                  <input type="number" id="other_16_plus" value="50000" min="0" style="width:100px;padding:6px;border:1px solid #93c5fd;border-radius:4px;text-align:right;">
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Simulador de Env√≠o -->
      <div style="background:#f8f9fa;padding:20px;border-radius:12px;margin-top:24px;border:1px solid #dee2e6;">
        <h3 style="margin:0 0 16px 0;color:#495057;font-size:16px;">üßÆ Simulador de Costo de Env√≠o</h3>
        <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:end;">
          <div>
            <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:500;">Total UE del pedido:</label>
            <input type="number" id="simTotalUE" value="7" min="1" style="width:100px;padding:8px;border:1px solid #ddd;border-radius:4px;">
          </div>
          <div>
            <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:500;">Ciudad:</label>
            <select id="simCity" style="padding:8px;border:1px solid #ddd;border-radius:4px;">
              <option value="yopal">Yopal</option>
              <option value="other">Otra ciudad</option>
            </select>
          </div>
          <button id="simCalculateBtn" class="btn-primary" style="padding:8px 16px;">Calcular</button>
          <div id="simResult" style="padding:12px 20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border-radius:8px;font-weight:600;display:none;">
            Costo: $0
          </div>
        </div>
      </div>

      <!-- Referencia de UE por tipo de producto -->
      <div style="background:#fff;padding:20px;border-radius:12px;margin-top:24px;border:1px solid #dee2e6;">
        <h3 style="margin:0 0 16px 0;color:#495057;font-size:16px;">üìã Gu√≠a de Clasificaci√≥n UE</h3>
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:#f8f9fa;">
              <th style="padding:10px;text-align:left;border-bottom:2px solid #dee2e6;font-size:13px;">UE</th>
              <th style="padding:10px;text-align:left;border-bottom:2px solid #dee2e6;font-size:13px;">Descripci√≥n</th>
              <th style="padding:10px;text-align:left;border-bottom:2px solid #dee2e6;font-size:13px;">Ejemplos</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="padding:10px;border-bottom:1px solid #eee;font-weight:600;color:#16a34a;">1</td>
              <td style="padding:10px;border-bottom:1px solid #eee;">Peque√±o / Liviano</td>
              <td style="padding:10px;border-bottom:1px solid #eee;color:#666;font-size:13px;">Jabones, accesorios peque√±os, especias</td>
            </tr>
            <tr>
              <td style="padding:10px;border-bottom:1px solid #eee;font-weight:600;color:#ca8a04;">2</td>
              <td style="padding:10px;border-bottom:1px solid #eee;">Mediano / Fr√°gil</td>
              <td style="padding:10px;border-bottom:1px solid #eee;color:#666;font-size:13px;">Vinos, botellas, productos fr√°giles</td>
            </tr>
            <tr>
              <td style="padding:10px;border-bottom:1px solid #eee;font-weight:600;color:#ea580c;">3</td>
              <td style="padding:10px;border-bottom:1px solid #eee;">Grande / Fr√°gil</td>
              <td style="padding:10px;border-bottom:1px solid #eee;color:#666;font-size:13px;">Canastas, kits de regalo, cajas grandes</td>
            </tr>
            <tr>
              <td style="padding:10px;font-weight:600;color:#dc2626;">4</td>
              <td style="padding:10px;">Caja Pesada</td>
              <td style="padding:10px;color:#666;font-size:13px;">Paquetes de carne 15kg, productos a granel</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Promotional Codes Management Section -->
      <div style="margin-top:32px;border-top:2px solid #dee2e6;padding-top:32px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px;">
          <h2 style="margin:0;">üéÅ Gesti√≥n de C√≥digos Promocionales</h2>
          <button id="addPromoCodeBtn" class="btn-primary" style="padding:10px 20px;">‚ûï Crear Nuevo C√≥digo</button>
        </div>

        <div style="background:#e3f2fd;padding:16px;border-radius:8px;margin-bottom:24px;border-left:4px solid #2196f3;">
          <h4 style="margin:0 0 8px 0;color:#1565c0;">üìù Sistema de C√≥digos Promocionales</h4>
          <p style="margin:0;color:#1565c0;font-size:13px;">
            Los c√≥digos promocionales permiten ofrecer <strong>env√≠o gratuito</strong> a los clientes.<br>
            Configura fechas de expiraci√≥n, l√≠mites de uso, y restricciones por ciudad o producto.
          </p>
        </div>

        <!-- Promo Codes List -->
        <div id="promoCodesContainer" style="background:#fff;border-radius:12px;border:1px solid #dee2e6;overflow:hidden;">
          <table style="width:100%;border-collapse:collapse;" id="promoCodesTable">
            <thead>
              <tr style="background:#f8f9fa;">
                <th style="padding:12px;text-align:left;border-bottom:2px solid #dee2e6;font-size:13px;">C√≥digo</th>
                <th style="padding:12px;text-align:left;border-bottom:2px solid #dee2e6;font-size:13px;">Estado</th>
                <th style="padding:12px;text-align:left;border-bottom:2px solid #dee2e6;font-size:13px;">Expiraci√≥n</th>
                <th style="padding:12px;text-align:center;border-bottom:2px solid #dee2e6;font-size:13px;">Usos</th>
                <th style="padding:12px;text-align:left;border-bottom:2px solid #dee2e6;font-size:13px;">Restricciones</th>
                <th style="padding:12px;text-align:center;border-bottom:2px solid #dee2e6;font-size:13px;">Acciones</th>
              </tr>
            </thead>
            <tbody id="promoCodesTableBody">
              <tr>
                <td colspan="6" style="padding:40px;text-align:center;color:#6c757d;">
                  <div style="font-size:48px;margin-bottom:16px;">üéÅ</div>
                  Cargando c√≥digos promocionales...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Promo Code Modal -->
      <div id="promoCodeModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:10000;align-items:center;justify-content:center;">
        <div style="background:white;border-radius:16px;max-width:600px;width:95%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
          <div style="padding:24px;border-bottom:1px solid #eee;position:sticky;top:0;background:white;z-index:1;">
            <h3 id="promoModalTitle" style="margin:0;font-size:20px;">Crear C√≥digo Promocional</h3>
          </div>
          <div style="padding:24px;">
            <form id="promoCodeForm">
              <div style="margin-bottom:16px;">
                <label style="display:block;margin-bottom:6px;font-weight:500;color:#333;">C√≥digo *</label>
                <input type="text" id="promoCodeInput" required placeholder="Ej: ENVIOFREE2024"
                  style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;text-transform:uppercase;box-sizing:border-box;">
                <p style="font-size:12px;color:#666;margin:4px 0 0 0;">El c√≥digo que los clientes usar√°n (sin espacios)</p>
              </div>

              <div style="margin-bottom:16px;">
                <label style="display:block;margin-bottom:6px;font-weight:500;color:#333;">Descripci√≥n</label>
                <input type="text" id="promoCodeDescription" placeholder="Ej: Promoci√≥n de verano"
                  style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;box-sizing:border-box;">
              </div>

              <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
                <div>
                  <label style="display:block;margin-bottom:6px;font-weight:500;color:#333;">Fecha de Expiraci√≥n</label>
                  <input type="date" id="promoCodeExpiration"
                    style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;box-sizing:border-box;">
                  <p style="font-size:12px;color:#666;margin:4px 0 0 0;">Dejar vac√≠o para sin expiraci√≥n</p>
                </div>
                <div>
                  <label style="display:block;margin-bottom:6px;font-weight:500;color:#333;">L√≠mite de Usos</label>
                  <input type="number" id="promoCodeUsageLimit" min="0" placeholder="Sin l√≠mite"
                    style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;box-sizing:border-box;">
                  <p style="font-size:12px;color:#666;margin:4px 0 0 0;">0 o vac√≠o = ilimitado</p>
                </div>
              </div>

              <div style="margin-bottom:16px;">
                <label style="display:block;margin-bottom:6px;font-weight:500;color:#333;">Ciudades Permitidas</label>
                <input type="text" id="promoCodeCities" placeholder="Ej: Yopal, Bogot√°, Medell√≠n"
                  style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;box-sizing:border-box;">
                <p style="font-size:12px;color:#666;margin:4px 0 0 0;">Separadas por comas. Dejar vac√≠o para todas las ciudades.</p>
              </div>

              <div style="margin-bottom:16px;">
                <label style="display:block;margin-bottom:6px;font-weight:500;color:#333;">Productos Aplicables (IDs)</label>
                <input type="text" id="promoCodeProducts" placeholder="Ej: prod-001, prod-002"
                  style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;box-sizing:border-box;">
                <p style="font-size:12px;color:#666;margin:4px 0 0 0;">IDs de productos separados por comas. Dejar vac√≠o para todos los productos.</p>
              </div>

              <div style="margin-bottom:24px;">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                  <input type="checkbox" id="promoCodeActive" checked style="width:18px;height:18px;">
                  <span style="font-weight:500;color:#333;">C√≥digo Activo</span>
                </label>
              </div>

              <input type="hidden" id="promoCodeEditId" value="">

              <div style="display:flex;gap:12px;">
                <button type="button" id="cancelPromoCodeBtn"
                  style="flex:1;padding:12px;background:#6c757d;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">
                  Cancelar
                </button>
                <button type="submit"
                  style="flex:2;padding:12px;background:#28a745;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">
                  Guardar C√≥digo
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Calculadora de Puntos -->
    <div id="tab-calculator" class="tab-content">
      <div style="max-width:900px;margin:0 auto;">
        <h2 style="margin-bottom:8px;">Calculadora de Puntos y Comisiones</h2>
        <p style="color:#666;margin-bottom:24px;">Calcula autom√°ticamente los puntos y comisiones basados en el beneficio de un producto.</p>

        <!-- CALCULADORA R√ÅPIDA DE CONVERSI√ìN -->
        <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:28px;border-radius:12px;box-shadow:0 4px 15px rgba(102,126,234,0.4);margin-bottom:32px;">
          <h3 style="margin:0 0 20px 0;color:white;font-size:20px;font-weight:700;">
            <span style="margin-right:8px;">üí∞</span>Conversi√≥n R√°pida: Pesos ‚Üí Puntos
          </h3>

          <div style="background:rgba(255,255,255,0.15);padding:16px;border-radius:8px;margin-bottom:20px;border-left:4px solid rgba(255,255,255,0.6);">
            <p style="color:rgba(255,255,255,0.95);margin:0;font-size:14px;">
              <strong>F√≥rmula:</strong> 1 Punto = $2.800 pesos | Distribuidores reciben 10% de los puntos | Restaurantes reciben 5% de los puntos
            </p>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:end;">
            <div>
              <label style="display:block;margin-bottom:8px;font-weight:600;color:white;font-size:14px;">
                Beneficio del Producto (en pesos)
              </label>
              <div style="position:relative;">
                <span style="position:absolute;left:16px;top:50%;transform:translateY(-50%);color:#667eea;font-weight:700;font-size:18px;">$</span>
                <input type="number"
                  id="quickCalcBenefit"
                  min="0"
                  step="100"
                  placeholder="Ej: 7000"
                  style="width:100%;padding:16px 16px 16px 36px;border:none;border-radius:8px;font-size:18px;font-weight:600;box-sizing:border-box;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
              </div>
              <p style="color:rgba(255,255,255,0.7);font-size:12px;margin:8px 0 0 0;">Ingresa el valor del beneficio que genera el producto</p>
            </div>

            <div>
              <button id="quickCalcBtn"
                style="width:100%;padding:16px 24px;background:white;color:#667eea;border:none;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:all 0.2s;"
                onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(0,0,0,0.2)';"
                onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';">
                <span style="margin-right:8px;">üìä</span>Calcular Puntos y Comisiones
              </button>
            </div>
          </div>
        </div>

        <!-- RESULTADOS DE LA CALCULADORA R√ÅPIDA -->
        <div id="quickCalcResults" style="display:none;margin-bottom:32px;">
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;">

            <!-- Resultado 1: Conversi√≥n a Puntos -->
            <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 4px 12px rgba(0,0,0,0.08);border-top:4px solid #28a745;">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                <div style="width:48px;height:48px;background:linear-gradient(135deg,#28a745 0%,#20c997 100%);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;">
                  üéØ
                </div>
                <div>
                  <div style="font-size:12px;color:#6c757d;font-weight:500;text-transform:uppercase;">Conversi√≥n a Puntos</div>
                  <div style="font-size:12px;color:#28a745;">$2.800 = 1 punto</div>
                </div>
              </div>
              <div style="font-size:36px;font-weight:800;color:#28a745;margin-bottom:4px;" id="quickResultPoints">0.00</div>
              <div style="font-size:14px;color:#666;">puntos generados</div>
              <div style="margin-top:12px;padding:12px;background:#e6f9f0;border-radius:6px;font-size:13px;color:#0d6d45;">
                <strong id="quickResultBenefitDisplay">$0</strong> √∑ $2.800 = <strong id="quickResultPointsSmall">0.00</strong> puntos
              </div>
            </div>

            <!-- Resultado 2: Comisi√≥n Distribuidores (10%) -->
            <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 4px 12px rgba(0,0,0,0.08);border-top:4px solid #007bff;">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                <div style="width:48px;height:48px;background:linear-gradient(135deg,#007bff 0%,#00d4ff 100%);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;">
                  üë•
                </div>
                <div>
                  <div style="font-size:12px;color:#6c757d;font-weight:500;text-transform:uppercase;">Distribuidores</div>
                  <div style="font-size:12px;color:#007bff;">10% de los puntos</div>
                </div>
              </div>
              <div style="font-size:36px;font-weight:800;color:#007bff;margin-bottom:4px;" id="quickResultDistributor">0.00</div>
              <div style="font-size:14px;color:#666;">puntos de comisi√≥n</div>
              <div style="margin-top:12px;padding:12px;background:#e7f5ff;border-radius:6px;font-size:13px;color:#0a5eb5;">
                <strong id="quickResultPointsForDist">0.00</strong> √ó 10% = <strong id="quickResultDistributorSmall">0.00</strong> puntos
                <div style="margin-top:6px;padding-top:6px;border-top:1px dashed #b8daff;">
                  Equivalente: <strong id="quickResultDistributorPesos">$0</strong> pesos
                </div>
              </div>
            </div>

            <!-- Resultado 3: Comisi√≥n Restaurantes (5%) -->
            <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 4px 12px rgba(0,0,0,0.08);border-top:4px solid #fd7e14;">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                <div style="width:48px;height:48px;background:linear-gradient(135deg,#fd7e14 0%,#ffc107 100%);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;">
                  üçΩÔ∏è
                </div>
                <div>
                  <div style="font-size:12px;color:#6c757d;font-weight:500;text-transform:uppercase;">Restaurantes</div>
                  <div style="font-size:12px;color:#fd7e14;">5% de los puntos</div>
                </div>
              </div>
              <div style="font-size:36px;font-weight:800;color:#fd7e14;margin-bottom:4px;" id="quickResultRestaurant">0.00</div>
              <div style="font-size:14px;color:#666;">puntos de comisi√≥n</div>
              <div style="margin-top:12px;padding:12px;background:#fff8e6;border-radius:6px;font-size:13px;color:#b36b00;">
                <strong id="quickResultPointsForRest">0.00</strong> √ó 5% = <strong id="quickResultRestaurantSmall">0.00</strong> puntos
                <div style="margin-top:6px;padding-top:6px;border-top:1px dashed #ffc107;">
                  Equivalente: <strong id="quickResultRestaurantPesos">$0</strong> pesos
                </div>
              </div>
            </div>
          </div>

          <!-- Resumen Total -->
          <div style="margin-top:20px;background:#f8f9fa;border-radius:12px;padding:20px;border:2px solid #e9ecef;">
            <h4 style="margin:0 0 16px 0;font-size:16px;color:#495057;">üìã Resumen del C√°lculo</h4>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;text-align:center;">
              <div style="padding:12px;background:white;border-radius:8px;">
                <div style="font-size:12px;color:#6c757d;">Beneficio Ingresado</div>
                <div style="font-size:20px;font-weight:700;color:#333;" id="summaryBenefit">$0</div>
              </div>
              <div style="padding:12px;background:white;border-radius:8px;">
                <div style="font-size:12px;color:#6c757d;">Puntos Totales</div>
                <div style="font-size:20px;font-weight:700;color:#28a745;" id="summaryPoints">0.00</div>
              </div>
              <div style="padding:12px;background:white;border-radius:8px;">
                <div style="font-size:12px;color:#6c757d;">Comisi√≥n Dist. (10%)</div>
                <div style="font-size:20px;font-weight:700;color:#007bff;" id="summaryDist">0.00 pts</div>
              </div>
              <div style="padding:12px;background:white;border-radius:8px;">
                <div style="font-size:12px;color:#6c757d;">Comisi√≥n Rest. (5%)</div>
                <div style="font-size:20px;font-weight:700;color:#fd7e14;" id="summaryRest">0.00 pts</div>
              </div>
            </div>
          </div>
        </div>

        <hr style="border:none;border-top:2px dashed #e9ecef;margin:32px 0;">

        <h3 style="margin-bottom:8px;color:#495057;">üßÆ Simulador Avanzado de Distribuci√≥n</h3>
        <p style="color:#666;margin-bottom:24px;">Simula c√≥mo se distribuir√°n los puntos y comisiones en la red para una orden espec√≠fica.</p>

        <div style="background:white;padding:24px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:24px;">
          <h3 style="margin-top:0;border-bottom:2px solid #007bff;padding-bottom:8px;margin-bottom:20px;">Datos de la Compra</h3>

          <div style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:6px;font-weight:500;">Comprador</label>
            <select id="calcBuyer" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;">
              <option value="">Seleccionar usuario...</option>
            </select>
          </div>

          <div style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:6px;font-weight:500;">Producto</label>
            <select id="calcProduct" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;">
              <option value="">Seleccionar producto...</option>
            </select>
          </div>

          <div style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:6px;font-weight:500;">Cantidad</label>
            <input type="number" id="calcQuantity" min="1" value="1" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;">
          </div>

          <div style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:6px;font-weight:500;">
              <input type="checkbox" id="calcIsFirstPurchase" style="margin-right:6px;">
              Marcar como primera compra (para Quick Start Bonus)
            </label>
            <p style="font-size:12px;color:#666;margin:4px 0 0 24px;">Solo aplicable para distribuidores que compran 50+ puntos por primera vez</p>
          </div>

          <button id="calcCalculateBtn" class="btn-primary" style="width:100%;padding:12px;font-size:16px;font-weight:600;">
            Calcular Distribuci√≥n
          </button>
        </div>

        <div id="calcResults" style="display:none;">
          <div style="background:white;padding:24px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:16px;">
            <h3 style="margin-top:0;border-bottom:2px solid #28a745;padding-bottom:8px;margin-bottom:20px;">Resumen de la Compra</h3>
            <div id="calcSummary"></div>
          </div>

          <div style="background:white;padding:24px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
            <h3 style="margin-top:0;border-bottom:2px solid #764ba2;padding-bottom:8px;margin-bottom:20px;">Distribuci√≥n de Comisiones</h3>
            <div id="calcDistribution"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Ganancias (Profits) -->
    <div id="tab-profits" class="tab-content">
      <div style="max-width:1200px;margin:0 auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px;">
          <h2 style="margin:0;">An√°lisis de Ganancias por Producto</h2>
          <div style="display:flex;gap:8px;align-items:center;">
            <label style="font-weight:500;">Per√≠odo:</label>
            <select id="profitsPeriodFilter" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
              <option value="current">Mes en Curso</option>
              <option value="last">Mes Anterior</option>
              <option value="last3">√öltimos 3 Meses</option>
              <option value="last6">√öltimos 6 Meses</option>
              <option value="year">Este A√±o</option>
              <option value="all">Todo el Tiempo</option>
            </select>
          </div>
        </div>

        <!-- Stats Summary -->
        <div class="stats-grid" style="margin-bottom:24px;">
          <div class="stat-card green">
            <h3>Ganancia Total del Per√≠odo</h3>
            <div class="value" id="profitsTotalProfit">$0</div>
          </div>
          <div class="stat-card blue">
            <h3>Total Ventas (Bruto)</h3>
            <div class="value" id="profitsTotalSales">$0</div>
          </div>
          <div class="stat-card orange">
            <h3>Pagado a la Red</h3>
            <div class="value" id="profitsTotalNetwork">$0</div>
          </div>
          <div class="stat-card purple">
            <h3>Margen Promedio</h3>
            <div class="value" id="profitsAvgMargin">0%</div>
          </div>
        </div>

        <!-- Add/Edit Costs Section - Accordion -->
        <div style="background:white;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:24px;overflow:hidden;">
          <!-- Accordion Header - Always visible -->
          <div id="productCostsAccordionHeader" onclick="toggleProductCostsAccordion()" style="padding:16px 20px;background:linear-gradient(135deg,#28a745,#20c997);cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:background 0.3s ease;">
            <div style="display:flex;align-items:center;gap:12px;">
              <span style="font-size:20px;">‚öôÔ∏è</span>
              <h3 style="margin:0;color:white;font-size:16px;font-weight:600;">Configurar Costos y Beneficios por Producto</h3>
            </div>
            <div style="display:flex;align-items:center;gap:10px;">
              <span style="color:rgba(255,255,255,0.85);font-size:13px;font-weight:500;">Ver / Ocultar configuraci√≥n por producto</span>
              <span id="productCostsAccordionIcon" style="color:white;font-size:18px;transition:transform 0.3s ease;">‚ñº</span>
            </div>
          </div>
          <!-- Accordion Content - Collapsible -->
          <div id="productCostsAccordionContent" style="max-height:0;overflow:hidden;transition:max-height 0.4s ease-out;">
            <div style="padding:20px;">
              <p style="color:#666;font-size:14px;margin-bottom:16px;">Ingresa el costo de compra de cada producto y el porcentaje que corresponde a la plataforma. Por ejemplo: si el beneficio es 600 pesos y la plataforma se queda con 50%, la plataforma gana 300 pesos y la red 300 pesos.</p>

              <div style="background:#e7f5ff;padding:12px 16px;border-radius:8px;margin-bottom:20px;border-left:4px solid #007bff;">
                <strong style="color:#007bff;">Ejemplo:</strong>
                <span style="color:#495057;">Arroz - Costo: $2,980 / Precio Venta: $3,580 / Beneficio: $600 / Plataforma 50%: $300 / Red 50%: $300</span>
              </div>

              <div id="profitsCostsList" style="margin-bottom:20px;">
                <!-- Product cost rows will be rendered here -->
                <div style="text-align:center;color:#666;padding:20px;">Cargando productos...</div>
              </div>

              <button id="saveProfitsCostsBtn" class="btn-success" style="width:100%;padding:12px;">Guardar Configuracion</button>
            </div>
          </div>
        </div>

        <!-- Profits Table -->
        <div style="background:white;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:24px;">
          <h3 style="margin-top:0;border-bottom:2px solid #007bff;padding-bottom:8px;margin-bottom:16px;">Reporte de Ganancias por Producto</h3>

          <table>
            <thead>
              <tr>
                <th>Producto</th>
                <th style="text-align:center;">Unidades</th>
                <th>Precio Venta</th>
                <th>Costo</th>
                <th>Beneficio Unitario</th>
                <th>Ganancia Plataforma</th>
                <th>Pago a Red</th>
                <th>Ingreso Bruto</th>
                <th>Ganancia Neta Total</th>
              </tr>
            </thead>
            <tbody id="profitsTable">
              <tr><td colspan="9" class="empty-state">Cargando...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Monthly Chart Section -->
        <div style="background:white;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
          <h3 style="margin-top:0;border-bottom:2px solid #764ba2;padding-bottom:8px;margin-bottom:16px;">Hist√≥rico Mensual de Ganancias</h3>

          <div id="profitsMonthlyReport" style="min-height:200px;">
            <!-- Monthly bars will be rendered here -->
            <div style="text-align:center;color:#666;padding:20px;">Cargando hist√≥rico...</div>
          </div>
        </div>

        <!-- Purged Commissions Report Section -->
        <div style="background:white;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-top:24px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
            <h3 style="margin:0;border-bottom:2px solid #dc3545;padding-bottom:8px;">Informe de Comisiones Eliminadas por Inactividad</h3>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
              <!-- Month/Year Selector for Purge Report -->
              <div style="display:flex;gap:8px;align-items:center;background:#f8f9fa;padding:8px 12px;border-radius:6px;border:1px solid #ddd;">
                <label style="font-size:13px;color:#555;font-weight:500;">Consultar:</label>
                <select id="purgeMonthSelect" style="padding:6px 10px;border:1px solid #ccc;border-radius:4px;font-size:13px;min-width:110px;">
                  <option value="0">Enero</option>
                  <option value="1">Febrero</option>
                  <option value="2">Marzo</option>
                  <option value="3">Abril</option>
                  <option value="4">Mayo</option>
                  <option value="5">Junio</option>
                  <option value="6">Julio</option>
                  <option value="7">Agosto</option>
                  <option value="8">Septiembre</option>
                  <option value="9">Octubre</option>
                  <option value="10">Noviembre</option>
                  <option value="11">Diciembre</option>
                </select>
                <select id="purgeYearSelect" style="padding:6px 10px;border:1px solid #ccc;border-radius:4px;font-size:13px;min-width:80px;">
                  <!-- Years will be populated dynamically -->
                </select>
              </div>
              <button id="manualPurgeBtn" onclick="executeManualPurge()" style="background:linear-gradient(135deg,#c62828,#b71c1c);color:white;border:none;padding:10px 20px;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;" title="Ver vista previa y generar reporte del mes seleccionado">
                <span style="font-size:16px;">üìã</span> Ver Vista Previa / Purgar
              </button>
              <select id="purgeReportFilter" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
              <option value="all">Todos los meses</option>
              <option value="current_year">Este a√±o</option>
              <option value="last_3">√öltimos 3 meses</option>
            </select>
            </div>
          </div>

          <div class="stats-grid" style="margin-bottom:20px;">
            <div class="stat-card" style="background:linear-gradient(135deg,#f5f5f5,#e0e0e0);">
              <h3>Total Reportes</h3>
              <div class="value" id="purgeReportCount">0</div>
            </div>
            <div class="stat-card" style="background:linear-gradient(135deg,#ffebee,#ffcdd2);">
              <h3>Total COP Eliminados</h3>
              <div class="value" id="purgeTotalAmount" style="color:#c62828;">$0</div>
            </div>
            <div class="stat-card" style="background:linear-gradient(135deg,#fff3e0,#ffe0b2);">
              <h3>Total Puntos Eliminados</h3>
              <div class="value" id="purgeTotalPoints" style="color:#ef6c00;">0</div>
            </div>
            <div class="stat-card" style="background:linear-gradient(135deg,#fce4ec,#f8bbd9);">
              <h3>Usuarios Afectados</h3>
              <div class="value" id="purgeTotalUsers" style="color:#ad1457;">0</div>
            </div>
          </div>

          <div id="purgeReportsList" style="max-height:500px;overflow-y:auto;">
            <div style="text-align:center;color:#666;padding:20px;">Cargando informes de purga...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Educaci√≥n -->
    <div id="tab-education" class="tab-content">
      <div style="max-width:1200px;margin:0 auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px;">
          <h2 style="margin:0;">Gesti√≥n de Contenido Educativo</h2>
          <button id="btnAddEducation" class="btn-success" style="display:flex;align-items:center;gap:6px;padding:10px 20px;">
            <span>‚ûï</span> Agregar Enlace
          </button>
        </div>

        <p style="color:#666;margin-bottom:20px;">
          Administra los enlaces educativos que aparecen en la oficina virtual. Los usuarios podr√°n acceder a videos, documentos y recursos √∫tiles.
        </p>

        <!-- Filtros de categor√≠a -->
        <div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;">
          <button class="edu-filter-btn active" data-filter="all" style="padding:8px 16px;border:1px solid #ddd;border-radius:20px;background:#667eea;color:white;cursor:pointer;">Todos</button>
          <button class="edu-filter-btn" data-filter="video" style="padding:8px 16px;border:1px solid #ddd;border-radius:20px;background:#f8f9fa;cursor:pointer;">üé¨ Videos</button>
          <button class="edu-filter-btn" data-filter="libro" style="padding:8px 16px;border:1px solid #ddd;border-radius:20px;background:#f8f9fa;cursor:pointer;">üìö Libros</button>
          <button class="edu-filter-btn" data-filter="documento" style="padding:8px 16px;border:1px solid #ddd;border-radius:20px;background:#f8f9fa;cursor:pointer;">üìÑ Documentos</button>
          <button class="edu-filter-btn" data-filter="pec" style="padding:8px 16px;border:1px solid #ddd;border-radius:20px;background:#f8f9fa;cursor:pointer;">üìã PEC</button>
          <button class="edu-filter-btn" data-filter="link" style="padding:8px 16px;border:1px solid #ddd;border-radius:20px;background:#f8f9fa;cursor:pointer;">üîó Enlaces</button>
        </div>

        <!-- Lista de contenido educativo -->
        <div id="educationList" style="display:grid;gap:16px;">
          <div style="text-align:center;color:#666;padding:40px;">Cargando contenido educativo...</div>
        </div>
      </div>
    </div>

    <!-- Tab: Identidad Visual -->
    <div id="tab-branding" class="tab-content">
      <div style="max-width:1200px;margin:0 auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px;">
          <div>
            <h2 style="margin:0;">Identidad Visual</h2>
            <p style="margin:8px 0 0 0;color:#666;font-size:14px;">Personaliza la apariencia de tu plataforma sin tocar c√≥digo</p>
          </div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <div style="display:flex;gap:8px;">
              <button id="exportBrandingBtn" class="btn-secondary" style="display:flex;align-items:center;gap:6px;padding:8px 12px;font-size:13px;" title="Exportar configuraci√≥n como archivo JSON">
                <span>üì•</span> Exportar
              </button>
              <button id="importBrandingBtn" class="btn-secondary" style="display:flex;align-items:center;gap:6px;padding:8px 12px;font-size:13px;" title="Importar configuraci√≥n desde archivo JSON">
                <span>üì§</span> Importar
              </button>
              <button id="restoreBackupBtn" class="btn-secondary" style="display:flex;align-items:center;gap:6px;padding:8px 12px;font-size:13px;" title="Restaurar desde backup local">
                <span>üîÑ</span> Backup Local
              </button>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
              <button id="resetBrandingBtn" class="btn-secondary" style="display:flex;align-items:center;gap:6px;">
                <span>‚Ü∫</span> Restaurar Valores
              </button>
              <button id="saveBrandingBtn" class="btn-success" style="display:flex;align-items:center;gap:8px;padding:12px 24px;font-size:15px;">
                <span>üíæ</span> Guardar cambios
              </button>
            </div>
            <span id="brandingUnsavedIndicator" class="unsaved-indicator">‚ö†Ô∏è Cambios sin guardar</span>
          </div>
        </div>

        <!-- √öltima actualizaci√≥n -->
        <div id="brandingLastUpdated" style="display:none;background:#e8f4fd;padding:12px 16px;border-radius:8px;margin-bottom:24px;font-size:13px;color:#0052cc;">
          <strong>√öltima actualizaci√≥n:</strong> <span id="brandingLastUpdatedDate">--</span> por <span id="brandingLastUpdatedBy">--</span>
        </div>

        <!-- Grid de secciones -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(500px, 1fr));gap:24px;">

          <!-- Secci√≥n: Informaci√≥n de la Empresa -->
          <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);border:1px solid #e9ecef;">
            <h3 style="margin:0 0 20px 0;font-size:18px;color:#333;display:flex;align-items:center;gap:10px;">
              <span style="font-size:24px;">üè¢</span> Informaci√≥n de la Empresa
            </h3>

            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:6px;font-weight:600;font-size:14px;color:#333;">Nombre de la Plataforma</label>
              <input type="text" id="brandPlatformName" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;box-sizing:border-box;" placeholder="Ej: PorKCasare" value="PorKCasare">
            </div>

            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:6px;font-weight:600;font-size:14px;color:#333;">Eslogan / Tagline</label>
              <input type="text" id="brandTagline" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;box-sizing:border-box;" placeholder="Ej: Carne empacada al vac√≠o" value="Carne empacada al vac√≠o">
            </div>

            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:6px;font-weight:600;font-size:14px;color:#333;">Logo Principal</label>
              <div style="display:flex;align-items:center;gap:16px;">
                <div style="width:80px;height:80px;border-radius:50%;background:#f8f9fa;display:flex;align-items:center;justify-content:center;border:2px solid #e9ecef;overflow:hidden;">
                  <img id="brandLogoPreview" src="/images/logo.webp" alt="Logo" style="width:100%;height:100%;object-fit:cover;">
                </div>
                <div style="flex:1;">
                  <input type="text" id="brandLogoUrl" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;box-sizing:border-box;" placeholder="/images/logo.webp" value="/images/logo.webp">
                  <small style="color:#666;font-size:12px;display:block;margin-top:4px;">URL relativa o absoluta del logo (ej: /images/logo.webp)</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Secci√≥n: Colores Principales -->
          <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);border:1px solid #e9ecef;">
            <h3 style="margin:0 0 20px 0;font-size:18px;color:#333;display:flex;align-items:center;gap:10px;">
              <span style="font-size:24px;">üé®</span> Colores Principales
            </h3>

            <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:16px;">
              <div>
                <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Color Primario</label>
                <div style="display:flex;align-items:center;gap:8px;">
                  <input type="color" id="brandColorPrimary" value="#667eea" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                  <input type="text" id="brandColorPrimaryHex" value="#667eea" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                </div>
              </div>

              <div>
                <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Color Secundario</label>
                <div style="display:flex;align-items:center;gap:8px;">
                  <input type="color" id="brandColorSecondary" value="#764ba2" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                  <input type="text" id="brandColorSecondaryHex" value="#764ba2" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                </div>
              </div>

              <div>
                <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Color Acento</label>
                <div style="display:flex;align-items:center;gap:8px;">
                  <input type="color" id="brandColorAccent" value="#0052cc" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                  <input type="text" id="brandColorAccentHex" value="#0052cc" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                </div>
              </div>

              <div>
                <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Color de √âxito</label>
                <div style="display:flex;align-items:center;gap:8px;">
                  <input type="color" id="brandColorSuccess" value="#00875a" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                  <input type="text" id="brandColorSuccessHex" value="#00875a" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                </div>
              </div>

              <div>
                <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Color de Peligro</label>
                <div style="display:flex;align-items:center;gap:8px;">
                  <input type="color" id="brandColorDanger" value="#de350b" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                  <input type="text" id="brandColorDangerHex" value="#de350b" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                </div>
              </div>

              <div>
                <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Color de Alerta</label>
                <div style="display:flex;align-items:center;gap:8px;">
                  <input type="color" id="brandColorWarning" value="#ff8b00" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                  <input type="text" id="brandColorWarningHex" value="#ff8b00" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                </div>
              </div>
            </div>

            <!-- Vista previa de gradiente -->
            <div style="margin-top:20px;padding-top:16px;border-top:1px solid #e9ecef;">
              <label style="display:block;margin-bottom:10px;font-weight:600;font-size:13px;color:#333;">Vista Previa del Gradiente</label>
              <div id="brandGradientPreview" style="height:60px;border-radius:8px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
            </div>
          </div>

          <!-- Secci√≥n: Tipograf√≠as -->
          <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);border:1px solid #e9ecef;">
            <h3 style="margin:0 0 20px 0;font-size:18px;color:#333;display:flex;align-items:center;gap:10px;">
              <span style="font-size:24px;">üìù</span> Tipograf√≠as
            </h3>

            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:6px;font-weight:600;font-size:14px;color:#333;">Fuente para T√≠tulos</label>
              <select id="brandFontHeadings" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;">
                <option value="'Inter', sans-serif">Inter (Actual)</option>
                <option value="'Poppins', sans-serif">Poppins</option>
                <option value="'Roboto', sans-serif">Roboto</option>
                <option value="'Open Sans', sans-serif">Open Sans</option>
                <option value="'Montserrat', sans-serif">Montserrat</option>
                <option value="'Lato', sans-serif">Lato</option>
                <option value="'Nunito', sans-serif">Nunito</option>
                <option value="Arial, sans-serif">Arial</option>
              </select>
            </div>

            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:6px;font-weight:600;font-size:14px;color:#333;">Fuente para Textos</label>
              <select id="brandFontBody" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;">
                <option value="'Inter', sans-serif">Inter (Actual)</option>
                <option value="'Poppins', sans-serif">Poppins</option>
                <option value="'Roboto', sans-serif">Roboto</option>
                <option value="'Open Sans', sans-serif">Open Sans</option>
                <option value="'Montserrat', sans-serif">Montserrat</option>
                <option value="'Lato', sans-serif">Lato</option>
                <option value="'Nunito', sans-serif">Nunito</option>
                <option value="Arial, sans-serif">Arial</option>
              </select>
            </div>

            <!-- Vista previa de tipograf√≠a -->
            <div style="margin-top:16px;padding:16px;background:#f8f9fa;border-radius:8px;">
              <p id="brandFontPreviewHeading" style="margin:0 0 8px 0;font-size:20px;font-weight:700;font-family:'Inter', sans-serif;">Vista Previa de T√≠tulo</p>
              <p id="brandFontPreviewBody" style="margin:0;font-size:14px;color:#666;font-family:'Inter', sans-serif;">Este es un ejemplo de c√≥mo se ver√° el texto normal en tu plataforma.</p>
            </div>
          </div>

          <!-- Secci√≥n: Colores de Texto y Fondo -->
          <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);border:1px solid #e9ecef;">
            <h3 style="margin:0 0 20px 0;font-size:18px;color:#333;display:flex;align-items:center;gap:10px;">
              <span style="font-size:24px;">üñºÔ∏è</span> Colores de Texto y Fondo
            </h3>

            <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:16px;">
              <div>
                <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Texto Principal</label>
                <div style="display:flex;align-items:center;gap:8px;">
                  <input type="color" id="brandColorTextPrimary" value="#172b4d" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                  <input type="text" id="brandColorTextPrimaryHex" value="#172b4d" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                </div>
              </div>

              <div>
                <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Texto Secundario</label>
                <div style="display:flex;align-items:center;gap:8px;">
                  <input type="color" id="brandColorTextSecondary" value="#5e6c84" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                  <input type="text" id="brandColorTextSecondaryHex" value="#5e6c84" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                </div>
              </div>

              <div>
                <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Fondo General</label>
                <div style="display:flex;align-items:center;gap:8px;">
                  <input type="color" id="brandColorBackground" value="#f4f5f7" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                  <input type="text" id="brandColorBackgroundHex" value="#f4f5f7" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                </div>
              </div>

              <div>
                <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Fondo de Tarjetas</label>
                <div style="display:flex;align-items:center;gap:8px;">
                  <input type="color" id="brandColorCardBackground" value="#ffffff" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                  <input type="text" id="brandColorCardBackgroundHex" value="#ffffff" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Secci√≥n de Textos Editables -->
        <div style="margin-top:24px;">
          <h3 style="margin:0 0 20px 0;font-size:20px;color:#333;display:flex;align-items:center;gap:10px;">
            <span style="font-size:24px;">üìÑ</span> Textos Editables
          </h3>

          <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(500px, 1fr));gap:24px;">

            <!-- Textos del Home -->
            <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);border:1px solid #e9ecef;">
              <h4 style="margin:0 0 16px 0;font-size:16px;color:#333;display:flex;align-items:center;gap:8px;">
                <span>üè†</span> P√°gina Principal (Home)
              </h4>

              <div style="margin-bottom:14px;">
                <label style="display:block;margin-bottom:4px;font-weight:600;font-size:13px;color:#333;">T√≠tulo del Hero</label>
                <input type="text" id="brandHomeHeroTitle" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;box-sizing:border-box;" placeholder="Carne empacada al vac√≠o ‚Äî PorKCasare">
              </div>

              <div style="margin-bottom:14px;">
                <label style="display:block;margin-bottom:4px;font-weight:600;font-size:13px;color:#333;">Subt√≠tulo del Hero</label>
                <textarea id="brandHomeHeroSubtitle" rows="2" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;box-sizing:border-box;resize:vertical;" placeholder="Seleccionamos, empacamos y distribuimos..."></textarea>
              </div>

              <div style="margin-bottom:14px;">
                <label style="display:block;margin-bottom:4px;font-weight:600;font-size:13px;color:#333;">T√≠tulo de Misi√≥n</label>
                <input type="text" id="brandHomeMissionTitle" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;box-sizing:border-box;" placeholder="Misi√≥n">
              </div>

              <div style="margin-bottom:14px;">
                <label style="display:block;margin-bottom:4px;font-weight:600;font-size:13px;color:#333;">Texto de Misi√≥n</label>
                <textarea id="brandHomeMissionText" rows="3" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;box-sizing:border-box;resize:vertical;" placeholder="En PorkCasare trabajamos d√≠a a d√≠a..."></textarea>
              </div>

              <div style="margin-bottom:14px;">
                <label style="display:block;margin-bottom:4px;font-weight:600;font-size:13px;color:#333;">T√≠tulo de Visi√≥n</label>
                <input type="text" id="brandHomeVisionTitle" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;box-sizing:border-box;" placeholder="Visi√≥n">
              </div>

              <div style="margin-bottom:14px;">
                <label style="display:block;margin-bottom:4px;font-weight:600;font-size:13px;color:#333;">Texto de Visi√≥n</label>
                <textarea id="brandHomeVisionText" rows="3" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;box-sizing:border-box;resize:vertical;" placeholder="Convertirnos en una granja porc√≠cola l√≠der..."></textarea>
              </div>

              <div>
                <label style="display:block;margin-bottom:4px;font-weight:600;font-size:13px;color:#333;">Texto del Footer</label>
                <input type="text" id="brandHomeFooterText" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;box-sizing:border-box;" placeholder="¬© PorKCasare by F&F Asociados">
              </div>
            </div>

            <!-- Textos de Selecci√≥n de Acceso -->
            <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);border:1px solid #e9ecef;">
              <h4 style="margin:0 0 16px 0;font-size:16px;color:#333;display:flex;align-items:center;gap:8px;">
                <span>üö™</span> Pantalla de Selecci√≥n de Acceso
              </h4>

              <div style="margin-bottom:14px;">
                <label style="display:block;margin-bottom:4px;font-weight:600;font-size:13px;color:#333;">T√≠tulo de Bienvenida</label>
                <input type="text" id="brandAccessTitle" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;box-sizing:border-box;" placeholder="Bienvenido a PorkCasare">
              </div>

              <div style="margin-bottom:14px;">
                <label style="display:block;margin-bottom:4px;font-weight:600;font-size:13px;color:#333;">Bot√≥n Registro Cliente</label>
                <input type="text" id="brandAccessClientBtn" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;box-sizing:border-box;" placeholder="Registro de Cliente">
              </div>

              <div style="margin-bottom:14px;">
                <label style="display:block;margin-bottom:4px;font-weight:600;font-size:13px;color:#333;">Bot√≥n Registro Distribuidor</label>
                <input type="text" id="brandAccessDistributorBtn" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;box-sizing:border-box;" placeholder="Registro nuevo Distribuidor">
              </div>

              <div>
                <label style="display:block;margin-bottom:4px;font-weight:600;font-size:13px;color:#333;">Bot√≥n Acceso Distribuidor</label>
                <input type="text" id="brandAccessDistributorAccessBtn" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;box-sizing:border-box;" placeholder="Acceso del Distribuidor">
              </div>
            </div>

            <!-- Textos de Login -->
            <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);border:1px solid #e9ecef;">
              <h4 style="margin:0 0 16px 0;font-size:16px;color:#333;display:flex;align-items:center;gap:8px;">
                <span>üîê</span> Pantallas de Login
              </h4>

              <div style="margin-bottom:14px;">
                <label style="display:block;margin-bottom:4px;font-weight:600;font-size:13px;color:#333;">T√≠tulo Portal Proveedores</label>
                <input type="text" id="brandLoginProveedorTitle" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;box-sizing:border-box;" placeholder="Portal de Proveedores">
              </div>

              <div style="margin-bottom:14px;">
                <label style="display:block;margin-bottom:4px;font-weight:600;font-size:13px;color:#333;">Subt√≠tulo Portal Proveedores</label>
                <input type="text" id="brandLoginProveedorSubtitle" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;box-sizing:border-box;" placeholder="Ingresa tus credenciales para acceder">
              </div>

              <div style="margin-bottom:14px;">
                <label style="display:block;margin-bottom:4px;font-weight:600;font-size:13px;color:#333;">Texto Bot√≥n de Login</label>
                <input type="text" id="brandLoginButton" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;box-sizing:border-box;" placeholder="Iniciar Sesi√≥n">
              </div>

              <div>
                <label style="display:block;margin-bottom:4px;font-weight:600;font-size:13px;color:#333;">Texto Recuperar Contrase√±a</label>
                <input type="text" id="brandLoginForgotPassword" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;box-sizing:border-box;" placeholder="Recuperar contrase√±a">
              </div>
            </div>

            <!-- Textos de Oficina Virtual -->
            <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);border:1px solid #e9ecef;">
              <h4 style="margin:0 0 16px 0;font-size:16px;color:#333;display:flex;align-items:center;gap:8px;">
                <span>üè™</span> Oficina Virtual
              </h4>

              <div style="margin-bottom:14px;">
                <label style="display:block;margin-bottom:4px;font-weight:600;font-size:13px;color:#333;">T√≠tulo en Navegaci√≥n</label>
                <input type="text" id="brandVirtualOfficeNavTitle" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;box-sizing:border-box;" placeholder="PorkCasare">
              </div>

              <div style="margin-bottom:14px;">
                <label style="display:block;margin-bottom:4px;font-weight:600;font-size:13px;color:#333;">Texto Bot√≥n Cerrar Sesi√≥n</label>
                <input type="text" id="brandVirtualOfficeLogoutBtn" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;box-sizing:border-box;" placeholder="Cerrar sesi√≥n">
              </div>

              <div style="margin-bottom:14px;">
                <label style="display:block;margin-bottom:4px;font-weight:600;font-size:13px;color:#333;">Mensaje de Alerta de Activaci√≥n</label>
                <textarea id="brandVirtualOfficeActivationAlert" rows="2" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;box-sizing:border-box;resize:vertical;" placeholder="Debes realizar una compra m√≠nima de 50 puntos..."></textarea>
              </div>

              <div style="margin-bottom:14px;">
                <label style="display:block;margin-bottom:4px;font-weight:600;font-size:13px;color:#333;">T√≠tulo de Progreso</label>
                <input type="text" id="brandVirtualOfficeProgressTitle" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;box-sizing:border-box;" placeholder="¬°Tu camino a Corona!">
              </div>

              <div>
                <label style="display:block;margin-bottom:4px;font-weight:600;font-size:13px;color:#333;">Subt√≠tulo de Progreso</label>
                <input type="text" id="brandVirtualOfficeProgressSubtitle" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;box-sizing:border-box;" placeholder="Contin√∫a acumulando puntos para alcanzar mayores beneficios">
              </div>
            </div>
          </div>
        </div>

        <!-- Secci√≥n: Configuraci√≥n Visual Avanzada -->
        <div style="margin-top:24px;">
          <h3 style="margin:0 0 20px 0;font-size:20px;color:#333;display:flex;align-items:center;gap:10px;">
            <span style="font-size:24px;">üéØ</span> Configuraci√≥n Visual Avanzada
          </h3>
          <p style="margin:0 0 16px 0;color:#666;font-size:14px;">Personaliza la apariencia de la oficina virtual, productos y home de clientes</p>

          <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(500px, 1fr));gap:24px;">

            <!-- Colores de la Oficina Virtual -->
            <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);border:1px solid #e9ecef;">
              <h4 style="margin:0 0 16px 0;font-size:16px;color:#333;display:flex;align-items:center;gap:8px;">
                <span>üè¢</span> Colores Oficina Virtual
              </h4>
              <p style="margin:0 0 16px 0;color:#666;font-size:13px;">Paleta de colores para el panel de distribuidores</p>

              <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:16px;">
                <div>
                  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Color Principal</label>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <input type="color" id="brandVOColorPrimary" value="#4a90e2" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                    <input type="text" id="brandVOColorPrimaryHex" value="#4a90e2" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                  </div>
                </div>

                <div>
                  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Color Secundario</label>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <input type="color" id="brandVOColorSecondary" value="#667eea" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                    <input type="text" id="brandVOColorSecondaryHex" value="#667eea" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                  </div>
                </div>

                <div>
                  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Color Acento</label>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <input type="color" id="brandVOColorAccent" value="#007bff" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                    <input type="text" id="brandVOColorAccentHex" value="#007bff" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                  </div>
                </div>

                <div>
                  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Fondo de Navegaci√≥n</label>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <input type="color" id="brandVONavBackground" value="#4a90e2" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                    <input type="text" id="brandVONavBackgroundHex" value="#4a90e2" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                  </div>
                </div>
              </div>

              <!-- Vista previa navegaci√≥n -->
              <div style="margin-top:16px;padding-top:16px;border-top:1px solid #e9ecef;">
                <label style="display:block;margin-bottom:10px;font-weight:600;font-size:13px;color:#333;">Vista Previa Navegaci√≥n</label>
                <div id="brandVONavPreview" style="height:50px;border-radius:8px;background:#4a90e2;display:flex;align-items:center;justify-content:space-between;padding:0 16px;color:#fff;">
                  <span style="font-weight:600;">PorkCasare</span>
                  <span style="font-size:13px;">Cerrar sesi√≥n</span>
                </div>
              </div>
            </div>

            <!-- Botones de la Oficina Virtual -->
            <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);border:1px solid #e9ecef;">
              <h4 style="margin:0 0 16px 0;font-size:16px;color:#333;display:flex;align-items:center;gap:8px;">
                <span>üîò</span> Botones Oficina Virtual
              </h4>
              <p style="margin:0 0 16px 0;color:#666;font-size:13px;">Colores de botones generales del panel</p>

              <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:16px;">
                <div>
                  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Bot√≥n Normal</label>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <input type="color" id="brandVOBtnNormal" value="#007bff" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                    <input type="text" id="brandVOBtnNormalHex" value="#007bff" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                  </div>
                </div>

                <div>
                  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Bot√≥n Hover</label>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <input type="color" id="brandVOBtnHover" value="#0056b3" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                    <input type="text" id="brandVOBtnHoverHex" value="#0056b3" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                  </div>
                </div>

                <div>
                  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Texto de Botones</label>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <input type="color" id="brandVOBtnText" value="#ffffff" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                    <input type="text" id="brandVOBtnTextHex" value="#ffffff" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                  </div>
                </div>

                <div>
                  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Bot√≥n Cerrar Sesi√≥n</label>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <input type="color" id="brandVOBtnLogout" value="#667eea" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                    <input type="text" id="brandVOBtnLogoutHex" value="#667eea" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                  </div>
                </div>
              </div>

              <!-- Vista previa de botones -->
              <div style="margin-top:16px;padding-top:16px;border-top:1px solid #e9ecef;">
                <label style="display:block;margin-bottom:10px;font-weight:600;font-size:13px;color:#333;">Vista Previa de Botones</label>
                <div style="display:flex;gap:12px;flex-wrap:wrap;">
                  <button id="brandVOBtnPreviewNormal" type="button" style="padding:10px 20px;border:none;border-radius:6px;background:#007bff;color:#fff;font-weight:600;cursor:pointer;">Bot√≥n Normal</button>
                  <button id="brandVOBtnPreviewLogout" type="button" style="padding:10px 20px;border:none;border-radius:8px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;font-weight:600;cursor:pointer;">Cerrar Sesi√≥n</button>
                </div>
              </div>
            </div>

            <!-- Botones de Productos -->
            <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);border:1px solid #e9ecef;">
              <h4 style="margin:0 0 16px 0;font-size:16px;color:#333;display:flex;align-items:center;gap:8px;">
                <span>üõí</span> Botones de Productos
              </h4>
              <p style="margin:0 0 16px 0;color:#666;font-size:13px;">Colores para botones de comprar, ver m√°s y agregar al carrito</p>

              <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:16px;">
                <div>
                  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Bot√≥n Comprar (Normal)</label>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <input type="color" id="brandProductBtnBuy" value="#2563a0" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                    <input type="text" id="brandProductBtnBuyHex" value="#2563a0" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                  </div>
                </div>

                <div>
                  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Bot√≥n Comprar (Hover)</label>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <input type="color" id="brandProductBtnBuyHover" value="#3573b0" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                    <input type="text" id="brandProductBtnBuyHoverHex" value="#3573b0" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                  </div>
                </div>

                <div>
                  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Bot√≥n Agregar</label>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <input type="color" id="brandProductBtnAdd" value="#007bff" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                    <input type="text" id="brandProductBtnAddHex" value="#007bff" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                  </div>
                </div>

                <div>
                  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Bot√≥n Ver M√°s</label>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <input type="color" id="brandProductBtnViewMore" value="#6c757d" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                    <input type="text" id="brandProductBtnViewMoreHex" value="#6c757d" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                  </div>
                </div>

                <div>
                  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Texto de Botones</label>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <input type="color" id="brandProductBtnText" value="#ffffff" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                    <input type="text" id="brandProductBtnTextHex" value="#ffffff" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                  </div>
                </div>

                <div>
                  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Borde de Cantidad (+/-)</label>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <input type="color" id="brandProductQtyBorder" value="#1e88e5" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                    <input type="text" id="brandProductQtyBorderHex" value="#1e88e5" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                  </div>
                </div>
              </div>

              <!-- Vista previa de botones de producto -->
              <div style="margin-top:16px;padding-top:16px;border-top:1px solid #e9ecef;">
                <label style="display:block;margin-bottom:10px;font-weight:600;font-size:13px;color:#333;">Vista Previa</label>
                <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
                  <button id="brandProductBtnPreviewBuy" type="button" style="padding:8px 16px;border:none;border-radius:6px;background:#2563a0;color:#fff;font-weight:600;font-size:12px;cursor:pointer;text-transform:uppercase;">Comprar Ahora</button>
                  <button id="brandProductBtnPreviewAdd" type="button" style="padding:8px 16px;border:none;border-radius:6px;background:#007bff;color:#fff;font-weight:600;font-size:12px;cursor:pointer;">Agregar</button>
                  <button id="brandProductBtnPreviewViewMore" type="button" style="padding:8px 16px;border:none;border-radius:6px;background:#6c757d;color:#fff;font-weight:600;font-size:12px;cursor:pointer;">Ver M√°s</button>
                  <div style="display:flex;align-items:center;gap:4px;">
                    <button id="brandProductQtyPreviewMinus" type="button" style="width:30px;height:30px;border:2px solid #1e88e5;background:#fff;color:#1e88e5;border-radius:50%;font-size:16px;font-weight:700;cursor:pointer;">‚àí</button>
                    <span style="padding:0 8px;font-weight:600;">1</span>
                    <button id="brandProductQtyPreviewPlus" type="button" style="width:30px;height:30px;border:2px solid #1e88e5;background:#fff;color:#1e88e5;border-radius:50%;font-size:16px;font-weight:700;cursor:pointer;">+</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tarjetas de Productos -->
            <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);border:1px solid #e9ecef;">
              <h4 style="margin:0 0 16px 0;font-size:16px;color:#333;display:flex;align-items:center;gap:8px;">
                <span>üÉè</span> Tarjetas de Productos
              </h4>
              <p style="margin:0 0 16px 0;color:#666;font-size:13px;">Colores para las tarjetas de productos en oficina virtual y home de clientes</p>

              <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:16px;">
                <div>
                  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Fondo de Tarjeta</label>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <input type="color" id="brandProductCardBg" value="#ffffff" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                    <input type="text" id="brandProductCardBgHex" value="#ffffff" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                  </div>
                </div>

                <div>
                  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Borde de Tarjeta</label>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <input type="color" id="brandProductCardBorder" value="#e8e8e8" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                    <input type="text" id="brandProductCardBorderHex" value="#e8e8e8" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                  </div>
                </div>

                <div>
                  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">T√≠tulo del Producto</label>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <input type="color" id="brandProductCardTitle" value="#1e293b" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                    <input type="text" id="brandProductCardTitleHex" value="#1e293b" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                  </div>
                </div>

                <div>
                  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Color del Precio</label>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <input type="color" id="brandProductCardPrice" value="#007bff" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                    <input type="text" id="brandProductCardPriceHex" value="#007bff" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                  </div>
                </div>

                <div>
                  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Descripci√≥n</label>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <input type="color" id="brandProductCardDesc" value="#64748b" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                    <input type="text" id="brandProductCardDescHex" value="#64748b" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                  </div>
                </div>

                <div>
                  <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#333;">Sombra (hover)</label>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <input type="color" id="brandProductCardShadow" value="#000000" style="width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;">
                    <input type="text" id="brandProductCardShadowHex" value="#000000" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:monospace;">
                  </div>
                  <small style="color:#666;font-size:11px;">Transparencia aplicada autom√°ticamente</small>
                </div>
              </div>

              <!-- Vista previa de tarjeta -->
              <div style="margin-top:16px;padding-top:16px;border-top:1px solid #e9ecef;">
                <label style="display:block;margin-bottom:10px;font-weight:600;font-size:13px;color:#333;">Vista Previa de Tarjeta</label>
                <div id="brandProductCardPreview" style="width:200px;background:#fff;border:1px solid #e8e8e8;border-radius:12px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,0.05);">
                  <div style="height:80px;background:#f0f0f0;border-radius:8px;margin-bottom:10px;display:flex;align-items:center;justify-content:center;color:#999;">Imagen</div>
                  <div id="brandProductCardPreviewTitle" style="font-size:14px;font-weight:600;color:#1e293b;margin-bottom:4px;">Nombre Producto</div>
                  <div id="brandProductCardPreviewDesc" style="font-size:12px;color:#64748b;margin-bottom:8px;">Descripci√≥n breve</div>
                  <div id="brandProductCardPreviewPrice" style="font-size:15px;font-weight:600;color:#007bff;">$45.000</div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- Paletas Predefinidas -->
        <div style="margin-top:24px;background:white;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);border:1px solid #e9ecef;">
          <h3 style="margin:0 0 20px 0;font-size:18px;color:#333;display:flex;align-items:center;gap:10px;">
            <span style="font-size:24px;">üåà</span> Paletas Predefinidas
          </h3>
          <p style="margin:0 0 16px 0;color:#666;font-size:14px;">Selecciona una paleta para aplicar autom√°ticamente los colores</p>

          <div style="display:flex;gap:16px;flex-wrap:wrap;">
            <button class="brand-palette-btn" data-palette="profesional" style="padding:16px 24px;border:2px solid #667eea;border-radius:10px;cursor:pointer;background:white;transition:all 0.2s;">
              <div style="display:flex;gap:6px;margin-bottom:8px;">
                <span style="width:20px;height:20px;border-radius:50%;background:#667eea;"></span>
                <span style="width:20px;height:20px;border-radius:50%;background:#764ba2;"></span>
                <span style="width:20px;height:20px;border-radius:50%;background:#0052cc;"></span>
              </div>
              <span style="font-size:13px;font-weight:600;color:#333;">Profesional</span>
            </button>

            <button class="brand-palette-btn" data-palette="natural" style="padding:16px 24px;border:2px solid #e9ecef;border-radius:10px;cursor:pointer;background:white;transition:all 0.2s;">
              <div style="display:flex;gap:6px;margin-bottom:8px;">
                <span style="width:20px;height:20px;border-radius:50%;background:#2d6a4f;"></span>
                <span style="width:20px;height:20px;border-radius:50%;background:#40916c;"></span>
                <span style="width:20px;height:20px;border-radius:50%;background:#52b788;"></span>
              </div>
              <span style="font-size:13px;font-weight:600;color:#333;">Natural</span>
            </button>

            <button class="brand-palette-btn" data-palette="moderno" style="padding:16px 24px;border:2px solid #e9ecef;border-radius:10px;cursor:pointer;background:white;transition:all 0.2s;">
              <div style="display:flex;gap:6px;margin-bottom:8px;">
                <span style="width:20px;height:20px;border-radius:50%;background:#7c3aed;"></span>
                <span style="width:20px;height:20px;border-radius:50%;background:#a78bfa;"></span>
                <span style="width:20px;height:20px;border-radius:50%;background:#c4b5fd;"></span>
              </div>
              <span style="font-size:13px;font-weight:600;color:#333;">Moderno</span>
            </button>

            <button class="brand-palette-btn" data-palette="calido" style="padding:16px 24px;border:2px solid #e9ecef;border-radius:10px;cursor:pointer;background:white;transition:all 0.2s;">
              <div style="display:flex;gap:6px;margin-bottom:8px;">
                <span style="width:20px;height:20px;border-radius:50%;background:#ea580c;"></span>
                <span style="width:20px;height:20px;border-radius:50%;background:#fb923c;"></span>
                <span style="width:20px;height:20px;border-radius:50%;background:#fdba74;"></span>
              </div>
              <span style="font-size:13px;font-weight:600;color:#333;">C√°lido</span>
            </button>

            <button class="brand-palette-btn" data-palette="corporativo" style="padding:16px 24px;border:2px solid #e9ecef;border-radius:10px;cursor:pointer;background:white;transition:all 0.2s;">
              <div style="display:flex;gap:6px;margin-bottom:8px;">
                <span style="width:20px;height:20px;border-radius:50%;background:#1e293b;"></span>
                <span style="width:20px;height:20px;border-radius:50%;background:#475569;"></span>
                <span style="width:20px;height:20px;border-radius:50%;background:#64748b;"></span>
              </div>
              <span style="font-size:13px;font-weight:600;color:#333;">Corporativo</span>
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal para agregar/editar contenido educativo -->
  <div id="educationModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:white;padding:30px;border-radius:12px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto;">
      <h3 style="margin-top:0;margin-bottom:20px;display:flex;align-items:center;gap:10px;">
        <span style="font-size:24px;">üìö</span>
        <span id="educationModalTitle">Agregar Enlace Educativo</span>
      </h3>
      <form id="educationForm">
        <input type="hidden" id="educationId">

        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:6px;font-weight:600;">Tipo de contenido *</label>
          <select id="educationType" required style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;">
            <option value="">Seleccionar tipo...</option>
            <option value="video">üé¨ Video (YouTube, TikTok, etc.)</option>
            <option value="libro">üìö Libro</option>
            <option value="documento">üìÑ Documento</option>
            <option value="pec">üìã PEC del Mes</option>
            <option value="link">üîó Enlace √ötil</option>
          </select>
        </div>

        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:6px;font-weight:600;">T√≠tulo *</label>
          <input type="text" id="educationTitle" required style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;" placeholder="Ej: C√≥mo hacer tu primera venta">
        </div>

        <!-- Campo de URL para contenido NO-PEC -->
        <div id="educationUrlField" style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:6px;font-weight:600;">URL del recurso *</label>
          <input type="url" id="educationUrl" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;" placeholder="https://...">
          <small style="color:#666;display:block;margin-top:4px;">Para videos de YouTube, usa el link normal (no el embed)</small>
        </div>

        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:6px;font-weight:600;">Descripci√≥n (opcional)</label>
          <textarea id="educationDescription" rows="3" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;resize:vertical;" placeholder="Breve descripci√≥n del contenido..."></textarea>
        </div>

        <!-- Campos exclusivos para PEC -->
        <div id="pecFieldsContainer" style="display:none;">
          <!-- Selector de producto para PEC -->
          <div id="pecProductField" style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:6px;font-weight:600;">Producto asociado *</label>
            <select id="educationProductId" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;">
              <option value="">Seleccionar producto...</option>
              <!-- Products will be loaded dynamically -->
            </select>
            <small style="color:#666;display:block;margin-top:4px;">Selecciona el producto del cat√°logo que se mostrar√° cuando el usuario haga clic en este recurso PEC</small>
          </div>

          <!-- Campo de imagen para PEC -->
          <div id="pecImageField" style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:6px;font-weight:600;">Imagen de portada del libro *</label>
            <input type="text" id="educationImage" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;" placeholder="Ej: libro-liderazgo.jpg">
            <small style="color:#666;display:block;margin-top:4px;">La imagen debe estar en /images/pec/. Solo ingrese el nombre del archivo (ej: portada-pec-enero.jpg)</small>
            <div id="pecImagePreview" style="margin-top:12px;display:none;text-align:center;">
              <img id="pecImagePreviewImg" style="max-width:200px;max-height:280px;border-radius:8px;border:1px solid #ddd;box-shadow:0 4px 12px rgba(0,0,0,0.15);" src="" alt="Vista previa">
            </div>
          </div>
        </div>

        <div style="margin-bottom:20px;">
          <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
            <input type="checkbox" id="educationActive" checked style="width:18px;height:18px;">
            <span style="font-weight:500;">Activo (visible para usuarios)</span>
          </label>
        </div>

        <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;padding-top:10px;border-top:1px solid #eee;">
          <button type="button" id="educationModalCancel" class="btn-secondary">Cancelar</button>
          <button type="submit" class="btn-success">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para agregar inventario -->
  <div id="inventoryModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:white;padding:30px;border-radius:8px;max-width:500px;width:90%;">
      <h3 style="margin-top:0;">Agregar Unidades al Inventario</h3>
      <form id="addInventoryForm">
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;">Producto</label>
          <select id="inventoryProductId" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;">
            <option value="">Seleccionar producto...</option>
            <!-- Products will be loaded dynamically from database -->
          </select>
        </div>
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;">Unidades a agregar</label>
          <input type="number" id="inventoryUnits" required min="1" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;" placeholder="Ej: 50">
        </div>
        <div style="margin-bottom:20px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;">Notas (opcional)</label>
          <textarea id="inventoryNotes" rows="3" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;" placeholder="Ej: Llegada de nueva compra, proveedor XYZ"></textarea>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button type="button" id="inventoryModalCancel" class="btn-secondary">Cancelar</button>
          <button type="submit" class="btn-success">Agregar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para seleccionar role -->
  <div id="roleModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:white;padding:30px;border-radius:8px;max-width:400px;width:90%;">
      <h3 id="roleModalTitle" style="margin-top:0;">Seleccionar Role</h3>
      <p id="roleModalDescription" style="color:#666;margin-bottom:20px;"></p>
      <select id="roleSelect" style="width:100%;padding:10px;margin-bottom:20px;font-size:14px;border:1px solid #ddd;border-radius:4px;">
        <option value="admin">Admin</option>
        <option value="distribuidor">Distribuidor</option>
        <option value="cliente">Cliente</option>
        <option value="restaurante">Restaurante</option>
        <option value="proveedor">Proveedor</option>
      </select>
      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button id="roleModalCancel" class="btn-secondary">Cancelar</button>
        <button id="roleModalConfirm" class="btn-primary">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Modal para crear/editar categor√≠a -->
  <div id="categoryModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:white;padding:30px;border-radius:8px;max-width:500px;width:90%;">
      <h3 id="categoryModalTitle" style="margin-top:0;">Crear Categor√≠a</h3>
      <form id="categoryForm">
        <input type="hidden" id="categoryEditId">
        
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;">Nombre de la Categor√≠a</label>
          <input type="text" id="categoryName" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;" placeholder="Ej: Carnes, Bebidas, Alimentos">
        </div>
        
        <div style="margin-bottom:20px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;">Slug (ID √∫nico)</label>
          <input type="text" id="categorySlug" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;" placeholder="Ej: carnes, bebidas, alimentos">
          <small style="color:#666;font-size:12px;display:block;margin-top:4px;">Use solo min√∫sculas, n√∫meros y guiones. Este valor se usar√° internamente.</small>
        </div>
        
        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button type="button" id="categoryModalCancel" class="btn-secondary">Cancelar</button>
          <button type="submit" class="btn-success">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para ver √≥rdenes de un producto -->
  <div id="productOrdersModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;overflow-y:auto;">
    <div style="background:white;padding:30px;border-radius:8px;max-width:800px;width:90%;margin:40px auto;max-height:80vh;overflow-y:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:2px solid #e9ecef;padding-bottom:12px;">
        <h3 id="productOrdersModalTitle" style="margin:0;">√ìrdenes del Producto</h3>
        <button id="productOrdersModalClose" style="background:transparent;border:none;font-size:28px;cursor:pointer;color:#666;line-height:1;">&times;</button>
      </div>

      <div id="productOrdersContent">
        <!-- Content will be loaded dynamically -->
      </div>
    </div>
  </div>

  <!-- Modal para crear/editar producto -->
  <div id="productModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;overflow-y:auto;">
    <div style="background:white;padding:20px;border-radius:8px;max-width:600px;width:95%;margin:20px auto;max-height:90vh;overflow-y:auto;box-sizing:border-box;">
      <h3 id="productModalTitle" style="margin-top:0;font-size:18px;">Crear Producto</h3>
      <form id="productForm">
        <input type="hidden" id="productEditId">

        <div style="margin-bottom:14px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;font-size:13px;">Nombre del Producto *</label>
          <input type="text" id="productName" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;box-sizing:border-box;" placeholder="Ej: Chuletas - 3 kg">
        </div>

        <div style="margin-bottom:14px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;font-size:13px;">ID del Producto *</label>
          <input type="text" id="productId" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;box-sizing:border-box;" placeholder="Ej: chuletas-3kg">
        </div>

        <div style="margin-bottom:14px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;font-size:13px;">Descripci√≥n</label>
          <textarea id="productDescription" rows="2" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;box-sizing:border-box;" placeholder="Descripci√≥n del producto"></textarea>
        </div>

        <div style="margin-bottom:14px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;font-size:13px;">URL de la Imagen</label>
          <input type="text" id="productImage" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;box-sizing:border-box;" placeholder="/images/productos/producto.jpg">
        </div>

        <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:14px;">
          <div style="flex:1;min-width:120px;">
            <label style="display:block;margin-bottom:6px;font-weight:500;font-size:13px;">Precio Distribuidor</label>
            <input type="number" id="productPriceDistributor" min="0" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;box-sizing:border-box;" placeholder="60000">
          </div>

          <div style="flex:1;min-width:120px;">
            <label style="display:block;margin-bottom:6px;font-weight:500;font-size:13px;">Precio Cliente</label>
            <input type="number" id="productPriceClient" min="0" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;box-sizing:border-box;" placeholder="75000">
          </div>

          <div style="flex:1;min-width:120px;">
            <label style="display:block;margin-bottom:6px;font-weight:500;font-size:13px;">Precio Restaurante</label>
            <input type="number" id="productPriceRestaurant" min="0" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;box-sizing:border-box;" placeholder="20000">
          </div>
        </div>

        <!-- Cost and Profit Configuration Section -->
        <div style="background:#e8f5e9;padding:14px;border-radius:8px;margin-bottom:14px;border-left:4px solid #28a745;">
          <h4 style="margin:0 0 10px 0;font-size:13px;color:#1b5e20;">Configuracion de Costo y Margen de Ganancia</h4>
          <p style="font-size:11px;color:#2e7d32;margin:0 0 10px 0;">Estos valores se usan para calcular las ganancias de la plataforma en el reporte de Ganancias.</p>
          <div style="display:flex;flex-wrap:wrap;gap:10px;">
            <div style="flex:1;min-width:140px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;font-size:12px;">Costo de Compra (COP)</label>
              <input type="number" id="productCosto" min="0" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px;box-sizing:border-box;" placeholder="Ej: 50000">
              <small style="color:#666;font-size:10px;">Costo de adquisicion del producto</small>
            </div>

            <div style="flex:1;min-width:140px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;font-size:12px;">% Plataforma del Beneficio</label>
              <select id="productPlatformPercent" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px;box-sizing:border-box;">
                <option value="40">40% Plataforma / 60% Red</option>
                <option value="45">45% Plataforma / 55% Red</option>
                <option value="50" selected>50% Plataforma / 50% Red</option>
                <option value="55">55% Plataforma / 45% Red</option>
                <option value="60">60% Plataforma / 40% Red</option>
              </select>
              <small style="color:#666;font-size:10px;">Como se divide el beneficio</small>
            </div>

            <div style="flex:1;min-width:140px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;font-size:12px;">Beneficio Estimado</label>
              <div id="productBenefitPreview" style="padding:8px;background:#fff;border:1px solid #ddd;border-radius:4px;font-size:13px;color:#28a745;font-weight:600;">
                $0
              </div>
              <small style="color:#666;font-size:10px;">Precio Dist. - Costo</small>
            </div>
          </div>
        </div>

        <!-- Puntos separados para Distribuidores vs Restaurantes -->
        <div style="background:#e7f5ff;padding:14px;border-radius:8px;margin-bottom:14px;border-left:4px solid #007bff;">
          <h4 style="margin:0 0 10px 0;font-size:13px;color:#0a5eb5;">Configuraci√≥n de Puntos</h4>
          <div style="display:flex;flex-wrap:wrap;gap:10px;">
            <div style="flex:1;min-width:140px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;font-size:12px;">Puntos para Distribuidores</label>
              <input type="number" id="productPointsDistributor" step="0.01" min="0" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px;box-sizing:border-box;" placeholder="Ej: 2.5">
              <small style="color:#666;font-size:10px;">Puntos por unidad (permite decimales)</small>
            </div>

            <div style="flex:1;min-width:140px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;font-size:12px;">Puntos para Restaurantes</label>
              <input type="number" id="productPointsRestaurant" step="0.001" min="0" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px;box-sizing:border-box;" placeholder="Ej: 3.333">
              <small style="color:#666;font-size:10px;">Puntos por kilo/unidad (hasta 3 decimales)</small>
            </div>
          </div>
        </div>

        <!-- Unidades separadas para Distribuidores/Clientes vs Restaurantes -->
        <div style="background:#f8f9fa;padding:14px;border-radius:8px;margin-bottom:14px;">
          <h4 style="margin:0 0 10px 0;font-size:13px;color:#495057;">Configuraci√≥n de Unidades y Cantidades</h4>
          <div style="display:flex;flex-wrap:wrap;gap:10px;">
            <div style="flex:1;min-width:140px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;font-size:12px;">Unidad (Distribuidores/Clientes)</label>
              <select id="productUnit" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px;box-sizing:border-box;">
                <option value="paquete">Paquete</option>
                <option value="kilo">Kilo</option>
                <option value="unidad">Unidad</option>
              </select>
              <small style="color:#666;font-size:10px;">Unidad para dist. y clientes</small>
            </div>

            <div style="flex:1;min-width:140px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;font-size:12px;">Unidad (Restaurantes)</label>
              <select id="productUnitRestaurant" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px;box-sizing:border-box;">
                <option value="kilo">Kilo</option>
                <option value="paquete">Paquete</option>
                <option value="unidad">Unidad</option>
              </select>
              <small style="color:#666;font-size:10px;">Unidad para restaurantes</small>
            </div>
          </div>

          <!-- Nuevos campos de cantidad/peso -->
          <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;padding-top:12px;border-top:1px dashed #ddd;">
            <div style="flex:1;min-width:140px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;font-size:12px;">Cantidad/Peso (Dist./Clientes)</label>
              <input type="number" id="productQuantityDistributor" step="0.1" min="0" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px;box-sizing:border-box;" placeholder="Ej: 3">
              <small style="color:#666;font-size:10px;">Ej: 3 si el paquete pesa 3 kilos</small>
            </div>

            <div style="flex:1;min-width:140px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;font-size:12px;">Cantidad/Peso (Restaurantes)</label>
              <input type="number" id="productQuantityRestaurant" step="0.1" min="0" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px;box-sizing:border-box;" placeholder="Ej: 1">
              <small style="color:#666;font-size:10px;">Ej: 1 para venta por kilo</small>
            </div>
          </div>
        </div>

        <!-- Unidades de Env√≠o (UE) Configuration -->
        <div style="background:#fff3cd;padding:14px;border-radius:8px;margin-bottom:14px;border-left:4px solid #ffc107;">
          <h4 style="margin:0 0 10px 0;font-size:13px;color:#856404;">üì¶ Unidades de Env√≠o (UE)</h4>
          <p style="font-size:11px;color:#856404;margin:0 0 10px 0;">El valor de UE determina el costo de env√≠o. No se muestra al usuario.</p>
          <div style="display:flex;flex-wrap:wrap;gap:10px;">
            <div style="flex:1;min-width:200px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;font-size:12px;">Unidades de Env√≠o (UE)</label>
              <select id="productShippingUnits" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px;box-sizing:border-box;background:white;">
                <option value="1">1 - Peque√±o/Liviano (ej: jabones, accesorios)</option>
                <option value="2" selected>2 - Mediano/Fr√°gil (ej: vinos, botellas)</option>
                <option value="3">3 - Grande/Fr√°gil (ej: canastas, kits)</option>
                <option value="4">4 - Caja Pesada (ej: paquetes de carne 15kg)</option>
              </select>
              <small style="color:#856404;font-size:10px;">Afecta el c√°lculo del costo de env√≠o por pedido</small>
            </div>
          </div>
        </div>

        <div style="margin-bottom:14px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;font-size:13px;">Categor√≠a</label>
          <select id="productCategory" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;box-sizing:border-box;">
            <option value="carnes">Carnes</option>
            <option value="bebidas">Bebidas</option>
            <option value="alimentos">Alimentos</option>
            <option value="aseo">Aseo</option>
            <option value="higiene-personal">Higiene Personal</option>
            <option value="abarrotes">Abarrotes</option>
          </select>
        </div>

        <div style="margin-bottom:14px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;font-size:13px;">Disponible para:</label>
          <div style="display:flex;flex-wrap:wrap;gap:12px;">
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;">
              <input type="checkbox" id="productAvailDistributor" value="distribuidor">
              <span>Distribuidores</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;">
              <input type="checkbox" id="productAvailClient" value="cliente">
              <span>Clientes</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;">
              <input type="checkbox" id="productAvailRestaurant" value="restaurante">
              <span>Restaurantes</span>
            </label>
          </div>
        </div>

        <div style="margin-bottom:12px;">
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;">
            <input type="checkbox" id="productHidden">
            <span style="font-weight:500;">Ocultar producto (no visible para usuarios)</span>
          </label>
        </div>

        <div style="margin-bottom:12px;">
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;">
            <input type="checkbox" id="productOutOfStock">
            <span style="font-weight:500;">Marcar como agotado</span>
          </label>
        </div>

        <div style="margin-bottom:16px;">
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;">
            <input type="checkbox" id="productFeatured">
            <span style="font-weight:500;">‚≠ê Destacar (aparece de primero)</span>
          </label>
        </div>

        <!-- Product Variants Section -->
        <div id="productVariantsSection" style="background:#f8f9fa;padding:16px;border-radius:10px;margin-bottom:16px;border:1px solid #e9ecef;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div>
              <h4 style="margin:0;font-size:14px;color:#495057;">üè∑Ô∏è Variantes del Producto</h4>
              <small style="color:#6c757d;">Ej: Seco, Semi-seco, Dulce para vinos</small>
            </div>
            <button type="button" id="addVariantBtn" class="btn-primary" style="padding:6px 12px;font-size:12px;">+ Agregar Variante</button>
          </div>

          <div id="variantsContainer">
            <!-- Variants will be dynamically added here -->
          </div>

          <div id="noVariantsMessage" style="text-align:center;padding:20px;color:#6c757d;font-size:13px;font-style:italic;">
            Sin variantes. Usa el bot√≥n "Agregar Variante" para a√±adir opciones.
          </div>
        </div>

        <!-- Producto de Lanzamiento Section -->
        <div id="launchProductSection" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);padding:16px;border-radius:10px;margin-bottom:16px;">
          <div style="margin-bottom:12px;">
            <label style="display:flex;align-items:center;gap:8px;font-size:14px;color:white;">
              <input type="checkbox" id="productIsLaunch" style="width:18px;height:18px;">
              <span style="font-weight:600;">üöÄ Producto de Lanzamiento</span>
            </label>
            <small style="color:rgba(255,255,255,0.85);margin-left:26px;display:block;margin-top:4px;">El producto aparecer√° bloqueado con cuenta regresiva hasta la fecha de lanzamiento</small>
          </div>

          <div id="launchConfigFields" style="display:none;margin-top:14px;padding-top:14px;border-top:1px solid rgba(255,255,255,0.3);">
            <h4 style="margin:0 0 12px 0;font-size:13px;color:white;">Configuraci√≥n del Lanzamiento</h4>

            <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px;">
              <div style="flex:1;min-width:180px;">
                <label style="display:block;margin-bottom:6px;font-weight:500;font-size:12px;color:white;">Fecha y hora de lanzamiento *</label>
                <input type="datetime-local" id="productLaunchDate" style="width:100%;padding:10px;border:none;border-radius:6px;font-size:14px;box-sizing:border-box;">
                <small style="color:rgba(255,255,255,0.75);font-size:10px;">Cuando el contador llegue a cero, el producto estar√° disponible</small>
              </div>
            </div>

            <div style="background:rgba(255,255,255,0.15);padding:10px;border-radius:6px;margin-top:10px;">
              <p style="margin:0;font-size:12px;color:white;">
                <strong>üìå Comportamiento:</strong><br>
                ‚Ä¢ El producto aparecer√° visible pero bloqueado<br>
                ‚Ä¢ Imagen desenfocada, sin descripci√≥n completa<br>
                ‚Ä¢ Contador regresivo en tiempo real<br>
                ‚Ä¢ Al finalizar: se activa autom√°ticamente seg√∫n disponibilidad
              </p>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;padding-top:10px;border-top:1px solid #eee;">
          <button type="button" id="productModalCancel" class="btn-secondary">Cancelar</button>
          <button type="submit" class="btn-success">Guardar Producto</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para generar compra desde admin -->
  <div id="adminPurchaseModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;align-items:center;justify-content:center;overflow-y:auto;">
    <div style="background:white;padding:30px;border-radius:12px;width:95%;max-width:700px;max-height:90vh;overflow-y:auto;margin:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #e9ecef;">
        <div>
          <h3 style="margin:0;font-size:20px;color:#333;">Generar Compra</h3>
          <p id="adminPurchaseDistributorInfo" style="margin:4px 0 0 0;font-size:14px;color:#666;"></p>
        </div>
        <button id="adminPurchaseModalClose" style="background:transparent;border:none;font-size:28px;cursor:pointer;color:#666;line-height:1;">&times;</button>
      </div>

      <!-- Product selection -->
      <div style="margin-bottom:20px;">
        <label style="display:block;margin-bottom:8px;font-weight:600;color:#333;">Seleccionar Productos</label>
        <div id="adminPurchaseProductsList" style="max-height:300px;overflow-y:auto;border:1px solid #ddd;border-radius:8px;padding:8px;">
          <div style="text-align:center;padding:20px;color:#666;">Cargando productos...</div>
        </div>
      </div>

      <!-- Selected products summary -->
      <div id="adminPurchaseSelectedContainer" style="display:none;margin-bottom:20px;background:#f8f9fa;padding:16px;border-radius:8px;">
        <h4 style="margin:0 0 12px 0;font-size:16px;color:#333;">Productos Seleccionados</h4>
        <div id="adminPurchaseSelectedList"></div>
        <div style="margin-top:12px;padding-top:12px;border-top:1px solid #dee2e6;">
          <div style="display:flex;justify-content:space-between;font-size:14px;margin-bottom:4px;">
            <span>Subtotal:</span>
            <span id="adminPurchaseSubtotal">$0</span>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:14px;margin-bottom:4px;">
            <span>Total Puntos:</span>
            <span id="adminPurchaseTotalPoints">0 pts</span>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:18px;font-weight:700;color:#28a745;margin-top:8px;padding-top:8px;border-top:1px solid #dee2e6;">
            <span>Total:</span>
            <span id="adminPurchaseTotal">$0</span>
          </div>
        </div>
      </div>

      <!-- Notes field -->
      <div style="margin-bottom:20px;">
        <label style="display:block;margin-bottom:8px;font-weight:600;color:#333;">Notas (opcional)</label>
        <textarea id="adminPurchaseNotes" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:14px;resize:vertical;min-height:60px;" placeholder="Agregar notas o comentarios sobre esta compra..."></textarea>
      </div>

      <!-- Hidden fields -->
      <input type="hidden" id="adminPurchaseDistributorId" value="">
      <input type="hidden" id="adminPurchaseDistributorUsername" value="">

      <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;padding-top:10px;border-top:1px solid #eee;">
        <button type="button" id="adminPurchaseModalCancel" class="btn-secondary">Cancelar</button>
        <button type="button" id="adminPurchaseModalConfirm" class="btn-success" disabled>Crear Orden Pendiente</button>
      </div>
    </div>
  </div>

  <!-- Modal para Informe Previo de Pago a Distribuidor -->
  <div id="payoutReportModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;align-items:center;justify-content:center;overflow-y:auto;">
    <div style="background:white;border-radius:12px;width:95%;max-width:800px;max-height:90vh;overflow-y:auto;margin:20px auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
      <!-- Header del informe -->
      <div style="background:linear-gradient(135deg, #1a1f36 0%, #2c3e50 100%);color:white;padding:24px;border-radius:12px 12px 0 0;">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
          <div>
            <h2 style="margin:0;font-size:22px;font-weight:700;">üìã INFORME DE LIQUIDACI√ìN DE COMISIONES</h2>
            <p style="margin:8px 0 0 0;opacity:0.9;font-size:14px;">PorkCasare - Panel Administrativo</p>
          </div>
          <button id="payoutReportModalClose" style="background:rgba(255,255,255,0.2);border:none;color:white;font-size:24px;width:36px;height:36px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;">&times;</button>
        </div>
        <div style="margin-top:16px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.2);display:flex;gap:24px;flex-wrap:wrap;">
          <div>
            <span style="font-size:12px;opacity:0.7;">Fecha del Reporte</span>
            <p id="payoutReportDate" style="margin:4px 0 0 0;font-size:16px;font-weight:600;">--</p>
          </div>
          <div>
            <span style="font-size:12px;opacity:0.7;">Per√≠odo de Liquidaci√≥n</span>
            <p id="payoutReportPeriod" style="margin:4px 0 0 0;font-size:16px;font-weight:600;">--</p>
          </div>
        </div>
      </div>

      <!-- Informaci√≥n del Distribuidor -->
      <div style="padding:24px;border-bottom:1px solid #e9ecef;">
        <h3 style="margin:0 0 16px 0;font-size:16px;color:#333;display:flex;align-items:center;gap:8px;">
          <span style="font-size:20px;">üë§</span> Informaci√≥n del Distribuidor
        </h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">
          <div style="background:#f8f9fa;padding:12px 16px;border-radius:8px;">
            <span style="font-size:12px;color:#6c757d;">Nombre Completo</span>
            <p id="payoutReportName" style="margin:4px 0 0 0;font-size:15px;font-weight:600;color:#333;">--</p>
          </div>
          <div style="background:#f8f9fa;padding:12px 16px;border-radius:8px;">
            <span style="font-size:12px;color:#6c757d;">Usuario</span>
            <p id="payoutReportUsername" style="margin:4px 0 0 0;font-size:15px;font-weight:600;color:#333;">--</p>
          </div>
          <div style="background:#f8f9fa;padding:12px 16px;border-radius:8px;">
            <span style="font-size:12px;color:#6c757d;">ID de Usuario</span>
            <p id="payoutReportUserId" style="margin:4px 0 0 0;font-size:13px;font-weight:500;color:#666;font-family:monospace;">--</p>
          </div>
          <div style="background:#f8f9fa;padding:12px 16px;border-radius:8px;">
            <span style="font-size:12px;color:#6c757d;">Patrocinador</span>
            <p id="payoutReportSponsor" style="margin:4px 0 0 0;font-size:15px;font-weight:600;color:#333;">--</p>
          </div>
        </div>
        <!-- Estado del Distribuidor en el Mes -->
        <div id="payoutReportStatusContainer" style="margin-top:16px;padding:16px;border-radius:10px;display:flex;align-items:center;gap:12px;">
          <span id="payoutReportStatusIcon" style="font-size:24px;">‚è≥</span>
          <div>
            <span style="font-size:12px;color:#6c757d;">Estado del Distribuidor en el Mes Actual</span>
            <p id="payoutReportStatus" style="margin:4px 0 0 0;font-size:16px;font-weight:700;">Calculando...</p>
          </div>
        </div>
      </div>

      <!-- Resumen de Ventas y Comisiones -->
      <div style="padding:24px;border-bottom:1px solid #e9ecef;">
        <h3 style="margin:0 0 16px 0;font-size:16px;color:#333;display:flex;align-items:center;gap:8px;">
          <span style="font-size:20px;">üìä</span> Resumen de Actividad
        </h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:16px;">
          <div style="background:linear-gradient(135deg, #e8f4fd 0%, #d0e8fa 100%);padding:16px;border-radius:10px;text-align:center;">
            <span style="font-size:12px;color:#0052cc;">Puntos Personales</span>
            <p id="payoutReportPersonalPoints" style="margin:8px 0 0 0;font-size:24px;font-weight:700;color:#0052cc;">0</p>
          </div>
          <div style="background:linear-gradient(135deg, #e6f9f0 0%, #c8f5df 100%);padding:16px;border-radius:10px;text-align:center;">
            <span style="font-size:12px;color:#00875a;">Puntos Grupales</span>
            <p id="payoutReportGroupPoints" style="margin:8px 0 0 0;font-size:24px;font-weight:700;color:#00875a;">0</p>
          </div>
          <div style="background:linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);padding:16px;border-radius:10px;text-align:center;">
            <span style="font-size:12px;color:#ff8b00;">Balance Acumulado</span>
            <p id="payoutReportBalance" style="margin:8px 0 0 0;font-size:24px;font-weight:700;color:#ff8b00;">$0</p>
          </div>
          <div style="background:linear-gradient(135deg, #f5e6ff 0%, #e8d4ff 100%);padding:16px;border-radius:10px;text-align:center;">
            <span style="font-size:12px;color:#7c3aed;">Cobros Previos</span>
            <p id="payoutReportPreviousPaid" style="margin:8px 0 0 0;font-size:24px;font-weight:700;color:#7c3aed;">$0</p>
          </div>
        </div>
      </div>

      <!-- Detalle de Comisiones por Concepto -->
      <div style="padding:24px;border-bottom:1px solid #e9ecef;">
        <h3 style="margin:0 0 16px 0;font-size:16px;color:#333;display:flex;align-items:center;gap:8px;">
          <span style="font-size:20px;">üí∞</span> Detalle de Comisiones por Concepto
        </h3>
        <div style="overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;font-size:14px;">
            <thead>
              <tr style="background:#f8f9fa;">
                <th style="padding:12px;text-align:left;border-bottom:2px solid #dee2e6;color:#495057;">Concepto / Fuente</th>
                <th style="padding:12px;text-align:center;border-bottom:2px solid #dee2e6;color:#495057;">Cantidad</th>
                <th style="padding:12px;text-align:right;border-bottom:2px solid #dee2e6;color:#495057;">Puntos</th>
                <th style="padding:12px;text-align:right;border-bottom:2px solid #dee2e6;color:#495057;">Monto</th>
              </tr>
            </thead>
            <tbody id="payoutReportCommissionsTable">
              <!-- Rows will be dynamically populated -->
            </tbody>
            <tfoot>
              <tr style="background:#f8f9fa;font-weight:700;">
                <td style="padding:12px;border-top:2px solid #dee2e6;">TOTAL COMISIONES</td>
                <td style="padding:12px;text-align:center;border-top:2px solid #dee2e6;" id="payoutReportTotalCount">0</td>
                <td style="padding:12px;text-align:right;border-top:2px solid #dee2e6;" id="payoutReportTotalPoints">0</td>
                <td style="padding:12px;text-align:right;border-top:2px solid #dee2e6;color:#00875a;" id="payoutReportTotalAmount">$0</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- Historial Reciente de Comisiones -->
      <div style="padding:24px;border-bottom:1px solid #e9ecef;">
        <h3 style="margin:0 0 16px 0;font-size:16px;color:#333;display:flex;align-items:center;gap:8px;">
          <span style="font-size:20px;">üìú</span> Historial Reciente de Transacciones
          <span style="font-size:12px;color:#6c757d;font-weight:normal;">(√öltimas 20 transacciones)</span>
        </h3>
        <div id="payoutReportHistoryContainer" style="max-height:300px;overflow-y:auto;border:1px solid #e9ecef;border-radius:8px;">
          <!-- History entries will be dynamically populated -->
        </div>
      </div>

      <!-- Monto a Pagar -->
      <div style="padding:24px;background:linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);border-bottom:1px solid #e9ecef;">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;">
          <div>
            <h3 style="margin:0;font-size:18px;color:#166534;">VALOR A PAGAR AL DISTRIBUIDOR</h3>
            <p style="margin:4px 0 0 0;font-size:13px;color:#15803d;">Monto solicitado para liquidaci√≥n</p>
          </div>
          <div style="text-align:right;">
            <p id="payoutReportFinalAmount" style="margin:0;font-size:36px;font-weight:800;color:#166534;">$0</p>
            <input type="hidden" id="payoutReportPayoutId" value="">
            <input type="hidden" id="payoutReportUserIdHidden" value="">
            <input type="hidden" id="payoutReportAmountHidden" value="">
          </div>
        </div>
      </div>

      <!-- Acciones -->
      <div style="padding:24px;display:flex;gap:12px;justify-content:flex-end;flex-wrap:wrap;background:#f8f9fa;border-radius:0 0 12px 12px;">
        <button id="payoutReportCancelBtn" class="btn-secondary" style="padding:12px 24px;font-size:14px;">
          Cancelar
        </button>
        <button id="payoutReportConfirmBtn" class="btn-success" style="padding:12px 32px;font-size:14px;font-weight:600;display:flex;align-items:center;gap:8px;">
          <span>‚úì</span> Confirmar y Ejecutar Pago
        </button>
      </div>
    </div>
  </div>

  <!-- SweetAlert2 for notifications and dialogs -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script type="module">
    import { signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { doc, getDoc, collection, getDocs, query, where, orderBy, limit, updateDoc, runTransaction, addDoc, setDoc, increment, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    import { auth, db } from "/src/firebase-config.js";

    const loginSection = document.getElementById("loginSection");
    const adminPanel = document.getElementById("adminPanel");
    const loginForm = document.getElementById("loginForm");
    const logoutBtn = document.getElementById("logoutBtn");

    let currentUser = null;
    let currentTab = 'overview';

    // Tab switching with unsaved changes protection
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabId = btn.dataset.tab;

        // Check for unsaved branding changes when leaving branding tab
        if (currentTab === 'branding' && tabId !== 'branding' && typeof hasUnsavedBrandingChanges !== 'undefined' && hasUnsavedBrandingChanges) {
          const confirmLeave = confirm('Tienes cambios sin guardar en Identidad Visual. ¬øEst√°s seguro de que deseas salir sin guardar?');
          if (!confirmLeave) {
            return; // Stay on branding tab
          }
          // User chose to leave without saving - reset the flag
          hasUnsavedBrandingChanges = false;
          if (typeof updateUnsavedChangesIndicator === 'function') {
            updateUnsavedChangesIndicator();
          }
        }

        currentTab = tabId;

        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        btn.classList.add('active');
        document.getElementById(`tab-${tabId}`).classList.add('active');
      });
    });

    // Login
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        alert("Error en login: " + err.message);
      }
    });

    // Logout
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    // Chequear estado del usuario
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          console.log("üîê Usuario autenticado:", user.uid, user.email);
          
          const userDoc = await getDoc(doc(db, "usuarios", user.uid));
          if (!userDoc.exists()) {
            console.error("‚ùå Documento de usuario no existe en Firestore para UID:", user.uid);
            alert("Acceso denegado. Usuario no encontrado en la base de datos.\nUID: " + user.uid);
            await signOut(auth);
            return;
          }
          
          const userData = userDoc.data();
          console.log("üë§ Datos del usuario:", JSON.stringify(userData, null, 2));
          
          const userRole = userData.role || userData.rol;
          console.log("üé≠ Rol detectado:", userRole);
          
          if (userRole !== "admin") {
            console.error("‚ùå Usuario no es admin. Rol actual:", userRole);
            alert("Acceso denegado. No eres administrador.\nRol actual: " + (userRole || "sin rol"));
            await signOut(auth);
            return;
          }

          console.log("‚úÖ Acceso admin concedido");
          currentUser = user;
          loginSection.classList.add("hidden");
          adminPanel.classList.remove("hidden");
          
          await loadAllData();
        } catch (error) {
          console.error("‚ùå Error en verificaci√≥n de usuario:", error);
          alert("Error verificando permisos: " + error.message);
          await signOut(auth);
        }
      } else {
        loginSection.classList.remove("hidden");
        adminPanel.classList.add("hidden");
      }
    });

    // Cargar todos los datos
    async function loadAllData() {
      await Promise.all([
        loadOrders(),
        loadDistributors(),
        loadClients(),
        loadUsers(),
        loadPayouts(),
        loadStats(),
        loadInventory(),
        loadProducts(),
        loadCategories(),
        loadShippingRates(),
        loadEducationContent(),
        loadRecentActivity()
      ]);
    }

    // Enhanced Recent Activity Loader
    async function loadRecentActivity() {
      const activityList = document.getElementById('recentActivityList');
      if (!activityList) return;

      activityList.innerHTML = `
        <div class="activity-empty">
          <div class="activity-empty-icon">‚è≥</div>
          <div>Cargando actividad reciente...</div>
        </div>
      `;

      try {
        // Load from activity_logs collection, ordered by timestamp descending
        const activitySnap = await getDocs(
          query(
            collection(db, "activity_logs"),
            orderBy("timestamp", "desc"),
            limit(20)
          )
        );

        if (activitySnap.empty) {
          // Fallback to orders if no activity logs exist yet
          await loadRecentActivityFromOrders();
          return;
        }

        const activities = activitySnap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderActivityList(activities);

      } catch (err) {
        console.error('Error loading recent activity:', err);
        // Fallback to orders-based activity
        await loadRecentActivityFromOrders();
      }
    }

    // Fallback: Load activity from orders collection
    async function loadRecentActivityFromOrders() {
      const activityList = document.getElementById('recentActivityList');
      if (!activityList) return;

      try {
        const ordersSnap = await getDocs(
          query(
            collection(db, "orders"),
            orderBy("createdAt", "desc"),
            limit(20)
          )
        );

        if (ordersSnap.empty) {
          activityList.innerHTML = `
            <div class="activity-empty">
              <div class="activity-empty-icon">üì≠</div>
              <div>No hay actividad reciente</div>
            </div>
          `;
          return;
        }

        // Convert orders to activity format
        const activities = ordersSnap.docs.map(d => {
          const order = d.data();
          return {
            id: d.id,
            type: order.status === 'confirmed' ? 'sale' : (order.status === 'rejected' ? 'order_rejected' : 'order_pending'),
            title: `${order.status === 'confirmed' ? 'Venta' : (order.status === 'rejected' ? 'Rechazado' : 'Pendiente')}: ${order.productName || 'Producto'}`,
            user: {
              id: order.buyerUid,
              name: order.buyerUsername || 'Usuario',
              type: order.buyerType || 'distribuidor'
            },
            product: {
              name: order.productName || 'Producto',
              id: order.productId
            },
            orderId: d.id,
            financial: {
              totalPoints: order.totalPoints || order.points || 0,
              totalValue: order.totalPrice || order.price || 0,
              pointValue: 2800
            },
            beneficiaries: [],
            beneficiariesCount: 0,
            createdAt: order.createdAt ? (order.createdAt.toDate ? order.createdAt.toDate().toISOString() : order.createdAt) : new Date().toISOString(),
            metadata: {
              quantity: order.quantity || 1,
              status: order.status
            }
          };
        });

        renderActivityList(activities);

      } catch (err) {
        console.error('Error loading activity from orders:', err);
        activityList.innerHTML = `
          <div class="activity-empty">
            <div class="activity-empty-icon">‚ö†Ô∏è</div>
            <div>Error cargando actividad</div>
          </div>
        `;
      }
    }

    // Render the activity list
    function renderActivityList(activities) {
      const activityList = document.getElementById('recentActivityList');
      if (!activityList) return;

      if (activities.length === 0) {
        activityList.innerHTML = `
          <div class="activity-empty">
            <div class="activity-empty-icon">üì≠</div>
            <div>No hay actividad reciente</div>
          </div>
        `;
        return;
      }

      activityList.innerHTML = activities.map((activity, index) => {
        const typeLabels = {
          'sale': 'Venta',
          'order_approved': 'Aprobado',
          'order_rejected': 'Rechazado',
          'order_pending': 'Pendiente',
          'user_registration': 'Registro',
          'payout_request': 'Cobro',
          'payout_approved': 'Cobro Aprobado',
          'monthly_activation': 'Activaci√≥n'
        };

        const typeLabel = typeLabels[activity.type] || activity.type;
        const timestamp = activity.createdAt || activity.timestamp;
        const dateStr = timestamp ? formatActivityDate(timestamp) : 'Fecha no disponible';
        const fullDateStr = timestamp ? formatActivityFullDate(timestamp) : 'Fecha no disponible';
        const userName = activity.user?.name || 'Usuario desconocido';
        const userType = activity.user?.type || '';
        const userId = activity.user?.id || '';
        const totalPoints = activity.financial?.totalPoints || 0;
        const totalValue = activity.financial?.totalValue || 0;
        const productName = activity.product?.name || activity.title?.replace(/^(Venta|Pendiente|Rechazado|Aprobado):\s*/, '') || 'N/A';
        const beneficiariesCount = activity.beneficiariesCount || activity.beneficiaries?.length || 0;

        // Map user type to role display name
        const roleLabels = {
          'distribuidor': 'Distribuidor',
          'distributor': 'Distribuidor',
          'cliente': 'Cliente',
          'client': 'Cliente',
          'restaurante': 'Restaurante',
          'restaurant': 'Restaurante'
        };
        const userRole = roleLabels[userType?.toLowerCase()] || userType || 'No especificado';

        // Build the detailed expanded view HTML
        let detailsHtml = `
          <div class="activity-details" id="activity-details-${index}">
            <!-- Base event information -->
            <div class="activity-detail-section">
              <div class="activity-detail-section-title">Informaci√≥n del Evento</div>
              <div class="activity-detail-grid">
                <div class="activity-detail-item">
                  <span class="activity-detail-label">Tipo de Actividad</span>
                  <span class="activity-detail-value">${typeLabel}</span>
                </div>
                <div class="activity-detail-item">
                  <span class="activity-detail-label">Producto</span>
                  <span class="activity-detail-value">${productName}</span>
                </div>
                <div class="activity-detail-item">
                  <span class="activity-detail-label">Usuario</span>
                  <span class="activity-detail-value">${userName}</span>
                </div>
                <div class="activity-detail-item">
                  <span class="activity-detail-label">Rol del Usuario</span>
                  <span class="activity-detail-value">${userRole}</span>
                </div>
                <div class="activity-detail-item">
                  <span class="activity-detail-label">Fecha y Hora</span>
                  <span class="activity-detail-value">${fullDateStr}</span>
                </div>
                ${userId ? `
                <div class="activity-detail-item">
                  <span class="activity-detail-label">ID Usuario</span>
                  <span class="activity-detail-value" style="font-size:11px;word-break:break-all;">${userId}</span>
                </div>
                ` : ''}
                <div class="activity-detail-item">
                  <span class="activity-detail-label">Valor Total</span>
                  <span class="activity-detail-value highlight-green">$${totalValue.toLocaleString('es-CO')}</span>
                </div>
                <div class="activity-detail-item">
                  <span class="activity-detail-label">Puntos Generados</span>
                  <span class="activity-detail-value highlight-blue">${totalPoints} pts</span>
                </div>
              </div>
            </div>

            <!-- Beneficiaries section -->
            <div class="activity-detail-section">
              <div class="activity-detail-section-title">Beneficios Multinivel (5 Niveles Ascendentes)</div>
              ${beneficiariesCount > 0 ? `
                <ul class="beneficiary-list">
                  ${activity.beneficiaries.map(b => `
                    <li class="beneficiary-item">
                      <div class="beneficiary-info">
                        <div class="beneficiary-level">${b.level}</div>
                        <div class="beneficiary-name">
                          <strong>${b.userName || 'N/A'}</strong>
                          ${b.userId ? `<br><span style="font-size:10px;color:var(--text-secondary);">ID: ${b.userId.substring(0,12)}...</span>` : ''}
                        </div>
                      </div>
                      <div class="beneficiary-earnings">
                        <div class="beneficiary-points">${(b.points || 0).toFixed(2)} pts</div>
                        <div class="beneficiary-amount">$${(b.amount || 0).toLocaleString('es-CO')}</div>
                      </div>
                    </li>
                  `).join('')}
                </ul>
              ` : `
                <div class="no-beneficiaries-message">
                  <span class="no-beneficiaries-message-icon">‚ÑπÔ∏è</span>
                  <span>No aplica beneficios multinivel para esta actividad</span>
                </div>
              `}
            </div>
          </div>
        `;

        return `
          <div class="activity-item has-details" onclick="toggleActivityDetails(${index})" id="activity-item-${index}">
            <div class="activity-item-header">
              <span class="activity-type-badge ${activity.type}">${typeLabel}</span>
              <span class="activity-timestamp">${dateStr}</span>
            </div>
            <div class="activity-title">${activity.title || productName || 'Actividad'}</div>
            <div class="activity-user">
              <strong>${userName}</strong>
              ${userType ? `<span style="color: var(--text-secondary);"> ¬∑ ${userRole}</span>` : ''}
            </div>
            <div class="activity-financial">
              <div class="activity-stat">
                <span class="activity-stat-label">Puntos</span>
                <span class="activity-stat-value">${totalPoints}</span>
              </div>
              <div class="activity-stat">
                <span class="activity-stat-label">Valor</span>
                <span class="activity-stat-value positive">$${totalValue.toLocaleString('es-CO')}</span>
              </div>
            </div>
            <div class="click-to-expand-hint">
              ${beneficiariesCount > 0 ? `
                <span class="activity-beneficiaries-count">${beneficiariesCount} beneficiarios</span>
                <span>Ver detalle completo</span>
              ` : `
                <span>Ver detalle del evento</span>
              `}
              <span class="activity-expand-icon">‚ñº</span>
            </div>
          </div>
          ${detailsHtml}
        `;
      }).join('');
    }

    // Toggle activity details expansion
    function toggleActivityDetails(index) {
      const item = document.getElementById(`activity-item-${index}`);
      const details = document.getElementById(`activity-details-${index}`);

      if (!item || !details) return;

      const isExpanded = item.classList.contains('expanded');

      // Close all other expanded items
      document.querySelectorAll('.activity-item.expanded').forEach(el => {
        el.classList.remove('expanded');
      });
      document.querySelectorAll('.activity-details').forEach(el => {
        el.style.display = 'none';
      });

      // Toggle current item
      if (!isExpanded) {
        item.classList.add('expanded');
        details.style.display = 'block';
        // Smooth scroll to show expanded details
        setTimeout(() => {
          details.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 50);
      }
    }
    // Expose toggleActivityDetails to global scope for onclick handlers
    window.toggleActivityDetails = toggleActivityDetails;

    // Format activity date (relative time)
    function formatActivityDate(timestamp) {
      try {
        let date;
        if (timestamp && timestamp.toDate) {
          date = timestamp.toDate();
        } else if (timestamp && timestamp.seconds) {
          date = new Date(timestamp.seconds * 1000);
        } else if (typeof timestamp === 'string') {
          date = new Date(timestamp);
        } else {
          return 'Fecha no disponible';
        }

        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Hace un momento';
        if (diffMins < 60) return `Hace ${diffMins} min`;
        if (diffHours < 24) return `Hace ${diffHours}h`;
        if (diffDays < 7) return `Hace ${diffDays} d√≠as`;

        return date.toLocaleDateString('es-CO', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return 'Fecha no disponible';
      }
    }

    // Format activity full date (absolute date and time)
    function formatActivityFullDate(timestamp) {
      try {
        let date;
        if (timestamp && timestamp.toDate) {
          date = timestamp.toDate();
        } else if (timestamp && timestamp.seconds) {
          date = new Date(timestamp.seconds * 1000);
        } else if (typeof timestamp === 'string') {
          date = new Date(timestamp);
        } else {
          return 'Fecha no disponible';
        }

        return date.toLocaleDateString('es-CO', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
      } catch (e) {
        return 'Fecha no disponible';
      }
    }

    let allProducts = [];

    // Wall Street Ticker Banner Update Function
    function updateSalesTicker(orders, confirmed, pending, rejected, totalSales, distributorsCount) {
      const tickerContent = document.getElementById('tickerContent');
      if (!tickerContent) return;

      // Calculate sales metrics
      const confirmedTotal = confirmed.reduce((sum, o) => sum + (Number(o.totalPrice) || Number(o.priceTotal) || Number(o.price) || 0), 0);
      const pendingTotal = pending.reduce((sum, o) => sum + (Number(o.totalPrice) || Number(o.priceTotal) || Number(o.price) || 0), 0);
      const rejectedTotal = rejected.reduce((sum, o) => sum + (Number(o.totalPrice) || Number(o.priceTotal) || Number(o.price) || 0), 0);

      // Get recent orders for individual display (last 8)
      const recentConfirmed = confirmed.slice(0, 4);
      const recentRejected = rejected.slice(0, 2);
      const recentPending = pending.slice(0, 3);

      // Format currency
      const formatMoney = (num) => '$' + Math.round(num).toLocaleString('es-CO');

      // Build ticker items
      let tickerItems = [];

      // Summary metrics
      tickerItems.push(`
        <div class="ticker-item">
          <span class="ticker-label">Ventas Confirmadas</span>
          <span class="ticker-value positive">${formatMoney(confirmedTotal)}</span>
          <span class="ticker-change up">+${confirmed.length}</span>
        </div>
      `);

      tickerItems.push(`
        <div class="ticker-item">
          <span class="ticker-label">Pendientes</span>
          <span class="ticker-value neutral">${formatMoney(pendingTotal)}</span>
          <span class="ticker-change" style="background:rgba(88,166,255,0.15);color:#58a6ff;">${pending.length}</span>
        </div>
      `);

      tickerItems.push(`
        <div class="ticker-item">
          <span class="ticker-label">Rechazadas</span>
          <span class="ticker-value negative">${formatMoney(rejectedTotal)}</span>
          <span class="ticker-change down">-${rejected.length}</span>
        </div>
      `);

      tickerItems.push(`
        <div class="ticker-item">
          <span class="ticker-label">Distribuidores</span>
          <span class="ticker-value neutral">${distributorsCount}</span>
        </div>
      `);

      // Add individual recent confirmed orders
      recentConfirmed.forEach(order => {
        const price = Number(order.totalPrice) || Number(order.priceTotal) || Number(order.price) || 0;
        const productName = (order.productName || 'Producto').substring(0, 18);
        tickerItems.push(`
          <div class="ticker-item">
            <span class="ticker-label">${productName}</span>
            <span class="ticker-value positive">+${formatMoney(price)}</span>
            <span class="ticker-change up">CONFIRMADA</span>
          </div>
        `);
      });

      // Add recent pending
      recentPending.forEach(order => {
        const price = Number(order.totalPrice) || Number(order.priceTotal) || Number(order.price) || 0;
        const productName = (order.productName || 'Producto').substring(0, 18);
        tickerItems.push(`
          <div class="ticker-item">
            <span class="ticker-label">${productName}</span>
            <span class="ticker-value neutral">${formatMoney(price)}</span>
            <span class="ticker-change" style="background:rgba(255,139,0,0.15);color:#ff8b00;">PENDIENTE</span>
          </div>
        `);
      });

      // Add recent rejected
      recentRejected.forEach(order => {
        const price = Number(order.totalPrice) || Number(order.priceTotal) || Number(order.price) || 0;
        const productName = (order.productName || 'Producto').substring(0, 18);
        tickerItems.push(`
          <div class="ticker-item">
            <span class="ticker-label">${productName}</span>
            <span class="ticker-value negative">-${formatMoney(price)}</span>
            <span class="ticker-change down">RECHAZADA</span>
          </div>
        `);
      });

      // Duplicate items for seamless infinite scroll
      const allItems = tickerItems.join('');
      tickerContent.innerHTML = allItems + allItems;
    }

    // Cargar estad√≠sticas
    async function loadStats() {
      try {
        const ordersSnap = await getDocs(collection(db, "orders"));
        const orders = ordersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        // Fetch missing usernames for orders in recent activity
        const usersCache = new Map();
        for (const order of orders.slice(0, 10)) {
          if (order.buyerUid && !order.buyerUsername && !usersCache.has(order.buyerUid)) {
            try {
              const userDoc = await getDoc(doc(db, "usuarios", order.buyerUid));
              if (userDoc.exists()) {
                const userData = userDoc.data();
                order.buyerUsername = userData.usuario || userData.nombre || 'Usuario desconocido';
                usersCache.set(order.buyerUid, order.buyerUsername);
              }
            } catch (err) {
              console.warn('Error fetching user for recent order:', order.id, err);
            }
          } else if (order.buyerUid && usersCache.has(order.buyerUid)) {
            order.buyerUsername = usersCache.get(order.buyerUid);
          }
        }
        
        const pending = orders.filter(o => o.status === 'pending' || o.status === 'pending_delivery');
        const confirmed = orders.filter(o => o.status === 'confirmed');
        const rejected = orders.filter(o => o.status === 'rejected');
        
        const totalSales = confirmed.reduce((sum, o) => sum + (Number(o.price) || 0), 0);
        
        const usersSnap = await getDocs(collection(db, "usuarios"));
        const users = usersSnap.docs.map(d => d.data());
        const distributors = users.filter(u => u.role === 'distribuidor' || u.tipoRegistro === 'distribuidor' || (!u.role && !u.tipoRegistro));
        
        document.getElementById('totalSales').textContent = `$${totalSales.toLocaleString()}`;
        document.getElementById('confirmedCount').textContent = confirmed.length;
        document.getElementById('pendingCount').textContent = pending.length;
        document.getElementById('rejectedCount').textContent = rejected.length;
        document.getElementById('distributorsCount').textContent = distributors.length;
        document.getElementById('usersCount').textContent = users.length;
        
        // Recent activity
        const recentOrders = orders.slice(0, 10);
        const recentTable = document.getElementById('recentActivity');
        recentTable.innerHTML = '';
        
        if (recentOrders.length === 0) {
          recentTable.innerHTML = '<tr><td colspan="4" class="empty-state">No hay actividad reciente</td></tr>';
        } else {
          recentOrders.forEach(order => {
            const row = document.createElement('tr');
            const statusColor = order.status === 'confirmed' ? '#28a745' : order.status === 'rejected' ? '#dc3545' : '#fd7e14';
            const userId = order.buyerUid ? order.buyerUid.substring(0, 8) + '...' : 'N/A';
            const username = order.buyerUsername || 'N/A';
            row.innerHTML = `
              <td>${order.productName || 'N/A'}</td>
              <td><code style="font-size:0.85em;color:#666">${userId}</code><br><strong>${username}</strong></td>
              <td>$${(order.price || 0).toLocaleString()}</td>
              <td><span style="color:${statusColor};font-weight:600">${order.status}</span></td>
            `;
            recentTable.appendChild(row);
          });
        }

        // Update Wall Street Ticker Banner
        updateSalesTicker(orders, confirmed, pending, rejected, totalSales, distributors.length);
      } catch (err) {
        console.error('Error loading stats:', err);
      }
    }

    // Cargar √≥rdenes
    async function loadOrders() {
      try {
        const ordersSnap = await getDocs(collection(db, "orders"));
        const orders = ordersSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        // Fetch missing usernames for orders that don't have buyerUsername
        const usersCache = new Map();
        for (const order of orders) {
          if (order.buyerUid && !order.buyerUsername && !usersCache.has(order.buyerUid)) {
            try {
              const userDoc = await getDoc(doc(db, "usuarios", order.buyerUid));
              if (userDoc.exists()) {
                const userData = userDoc.data();
                order.buyerUsername = userData.usuario || userData.nombre || 'Usuario desconocido';
                usersCache.set(order.buyerUid, {
                  username: order.buyerUsername,
                  nombre: userData.nombre || '',
                  usuario: userData.usuario || ''
                });
              }
            } catch (err) {
              console.warn('Error fetching user for order:', order.id, err);
            }
          } else if (order.buyerUid && usersCache.has(order.buyerUid)) {
            order.buyerUsername = usersCache.get(order.buyerUid).username;
          }
        }

        // Don't filter out any orders - show all including test users
        const filteredOrders = orders;

        const pending = filteredOrders.filter(o => o.status === 'pending' || o.status === 'pending_delivery' || o.status === 'pending_mp' || o.status === 'pending_cash').sort((a, b) => a.id.localeCompare(b.id));
        const confirmed = filteredOrders.filter(o => o.status === 'confirmed');
        const rejected = filteredOrders.filter(o => o.status === 'rejected');

        // Use new grouped rendering for pending orders
        renderGroupedPendingOrders(pending);
        renderOrderTable('confirmedOrdersTable', confirmed, false);
        renderOrderTable('rejectedOrdersTable', rejected, false);
      } catch (err) {
        console.error('Error loading orders:', err);
      }
    }

    function renderOrderTable(tableId, orders, showActions) {
      const table = document.getElementById(tableId);
      table.innerHTML = '';
      
      if (orders.length === 0) {
        table.innerHTML = `<tr><td colspan="${showActions ? 7 : 6}" class="empty-state">No hay √≥rdenes</td></tr>`;
        return;
      }
      
      orders.forEach(order => {
        const row = document.createElement('tr');
        const date = order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
        const quantity = Number(order.quantity) || 1;
        
        if (showActions) {
          const totalPrice = Number(order.totalPrice) || Number(order.priceTotal) || (Number(order.price) * quantity) || 0;
          row.innerHTML = `
            <td><code>${order.id.substring(0, 12)}...</code></td>
            <td><strong>${order.buyerUsername || order.buyerUid || 'N/A'}</strong></td>
            <td>${order.productName || 'N/A'}</td>
            <td><strong>x${quantity}</strong></td>
            <td>$${totalPrice.toLocaleString()}</td>
            <td>${order.status}</td>
            <td>
              <button class="btn-success" onclick="confirmOrder('${order.id}')">Confirmar</button>
              <button class="btn-danger" onclick="rejectOrder('${order.id}')">Rechazar</button>
            </td>
          `;
        } else if (tableId === 'confirmedOrdersTable') {
          const userId = order.buyerUid ? order.buyerUid.substring(0, 8) + '...' : 'N/A';
          const username = order.buyerUsername || 'N/A';
          const totalPrice = Number(order.totalPrice) || Number(order.priceTotal) || (Number(order.price) * quantity) || 0;
          const totalPoints = Number(order.totalPoints) || Number(order.pointsTotal) || (Number(order.points) * quantity) || 0;
          row.innerHTML = `
            <td><code>${order.id.substring(0, 12)}...</code></td>
            <td><code style="font-size:0.85em;color:#666">${userId}</code></td>
            <td><strong>${username}</strong></td>
            <td>${order.productName || 'N/A'}</td>
            <td>$${totalPrice.toLocaleString()}</td>
            <td>${totalPoints} pts</td>
            <td>
              <button class="btn-danger" onclick="deleteOrder('${order.id}')">Eliminar</button>
            </td>
          `;
        } else {
          const totalPrice = Number(order.totalPrice) || Number(order.priceTotal) || (Number(order.price) * quantity) || 0;
          row.innerHTML = `
            <td>${date}</td>
            <td>${order.id.substring(0, 8)}...</td>
            <td>${order.productName || 'N/A'}</td>
            <td>${order.buyerUsername || order.buyerUid || 'N/A'}</td>
            <td>$${totalPrice.toLocaleString()}</td>
            <td>${order.rejectionReason || 'N/A'}</td>
          `;
        }

        table.appendChild(row);
      });
    }

    // Store pending orders globally for updates
    let pendingOrdersData = [];

    // Group orders by user
    function groupOrdersByUser(orders) {
      const grouped = {};
      orders.forEach(order => {
        const key = order.buyerUid || 'unknown';
        if (!grouped[key]) {
          grouped[key] = {
            buyerUid: order.buyerUid,
            buyerUsername: order.buyerUsername || 'Usuario desconocido',
            orders: []
          };
        }
        // Update username if we have a better one
        if (order.buyerUsername && order.buyerUsername !== 'Usuario desconocido') {
          grouped[key].buyerUsername = order.buyerUsername;
        }
        grouped[key].orders.push(order);
      });
      return Object.values(grouped);
    }

    // Get user initials for avatar
    function getUserInitials(name) {
      if (!name || name === 'Usuario desconocido') return '?';
      const parts = name.trim().split(' ');
      if (parts.length >= 2) {
        return (parts[0][0] + parts[1][0]).toUpperCase();
      }
      return name.substring(0, 2).toUpperCase();
    }

    // Get status label in Spanish
    function getStatusLabel(status) {
      const labels = {
        'pending': 'Pendiente',
        'pending_delivery': 'Pendiente Entrega',
        'pending_mp': 'Pendiente MP',
        'pending_cash': 'Pendiente Efectivo'
      };
      return labels[status] || status;
    }

    // Calculate order total price
    function calculateOrderTotal(order) {
      const quantity = Number(order.quantity) || 1;
      return Number(order.totalPrice) || Number(order.priceTotal) || (Number(order.price) * quantity) || 0;
    }

    // Get products from order (handles multiple formats)
    function getOrderProducts(order) {
      const products = [];

      // Check for items array (cart orders)
      if (order.items && Array.isArray(order.items)) {
        order.items.forEach(item => {
          products.push({
            name: item.title || item.productName || item.nombre || 'Producto',
            quantity: Number(item.quantity) || 1,
            price: Number(item.unit_price) || Number(item.precio) || 0,
            points: Number(item.points) || Number(item.puntos) || 0,
            variant: item.variant || item.variante || null,
            size: item.size || item.talla || item.tamano || null,
            color: item.color || null
          });
        });
      }
      // Check for productos array (alternative format)
      else if (order.productos && Array.isArray(order.productos)) {
        order.productos.forEach(prod => {
          products.push({
            name: prod.nombre || prod.productName || 'Producto',
            quantity: Number(prod.quantity) || Number(prod.cantidad) || 1,
            price: Number(prod.precio) || Number(prod.price) || 0,
            points: Number(prod.puntos) || Number(prod.points) || 0,
            variant: prod.variant || prod.variante || null,
            size: prod.size || prod.talla || prod.tamano || null,
            color: prod.color || null
          });
        });
      }
      // Single product order
      else {
        const quantity = Number(order.quantity) || 1;
        const unitPrice = Number(order.price) || (calculateOrderTotal(order) / quantity) || 0;
        products.push({
          name: order.productName || order.product || order.nombre || 'Producto',
          quantity: quantity,
          price: unitPrice,
          points: Number(order.totalPoints) || Number(order.points) || Number(order.puntos) || 0,
          variant: order.variant || order.variante || null,
          size: order.size || order.talla || order.tamano || null,
          color: order.color || null
        });
      }

      return products;
    }

    // Render grouped pending orders
    function renderGroupedPendingOrders(orders) {
      pendingOrdersData = orders;
      const container = document.getElementById('pendingOrdersGrouped');
      const summaryEl = document.getElementById('pendingOrdersSummary');

      if (!container) return;

      container.innerHTML = '';

      if (orders.length === 0) {
        container.innerHTML = `
          <div class="empty-orders-state">
            <h3>No hay ordenes pendientes</h3>
            <p>Todas las ordenes han sido procesadas</p>
          </div>
        `;
        if (summaryEl) summaryEl.textContent = '';
        return;
      }

      const groupedOrders = groupOrdersByUser(orders);
      const totalAmount = orders.reduce((sum, o) => sum + calculateOrderTotal(o), 0);

      if (summaryEl) {
        summaryEl.textContent = `${groupedOrders.length} usuario(s) | ${orders.length} orden(es) | Total: $${totalAmount.toLocaleString()}`;
      }

      groupedOrders.forEach(userGroup => {
        const userTotal = userGroup.orders.reduce((sum, o) => sum + calculateOrderTotal(o), 0);
        const initials = getUserInitials(userGroup.buyerUsername);
        const ordersCount = userGroup.orders.length;

        const groupEl = document.createElement('div');
        groupEl.className = 'user-orders-group';
        groupEl.dataset.userId = userGroup.buyerUid;

        groupEl.innerHTML = `
          <div class="user-orders-header" onclick="toggleUserOrders('${userGroup.buyerUid}')">
            <div class="user-info">
              <div class="user-avatar">${initials}</div>
              <div class="user-details">
                <h4>${userGroup.buyerUsername}</h4>
                <p>ID: ${userGroup.buyerUid ? userGroup.buyerUid.substring(0, 12) + '...' : 'N/A'}</p>
              </div>
            </div>
            <div class="orders-summary">
              <span class="orders-count">${ordersCount} ${ordersCount === 1 ? 'orden' : 'ordenes'}</span>
              <span class="orders-total">$${userTotal.toLocaleString()}</span>
              <span class="expand-icon">&#9660;</span>
            </div>
          </div>
          <div class="user-orders-content" id="orders-${userGroup.buyerUid}">
            ${userGroup.orders.map(order => renderOrderCard(order)).join('')}
          </div>
        `;

        container.appendChild(groupEl);
      });

      // Setup expand/collapse all buttons
      setupExpandCollapseButtons();
    }

    // Render individual order card
    function renderOrderCard(order) {
      const products = getOrderProducts(order);
      const orderTotal = calculateOrderTotal(order);
      const statusLabel = getStatusLabel(order.status);

      const productsHtml = products.map(prod => {
        const variantParts = [];
        if (prod.size) variantParts.push(`Talla: ${prod.size}`);
        if (prod.color) variantParts.push(`Color: ${prod.color}`);
        if (prod.variant) variantParts.push(prod.variant);

        const variantsHtml = variantParts.length > 0
          ? `<div class="product-variants">${variantParts.map(v => `<span>${v}</span>`).join('')}</div>`
          : '';

        const productTotal = prod.price * prod.quantity;

        return `
          <div class="product-item">
            <div class="product-info">
              <div class="product-name">${prod.name}</div>
              ${variantsHtml}
              ${prod.points > 0 ? `<div class="product-variants"><span>${prod.points} pts</span></div>` : ''}
            </div>
            <div class="product-pricing">
              <div class="product-qty">x${prod.quantity}</div>
              <div class="product-price">$${productTotal.toLocaleString()}</div>
            </div>
          </div>
        `;
      }).join('');

      return `
        <div class="order-card" data-order-id="${order.id}">
          <div class="order-header">
            <span class="order-id">Orden: ${order.id.substring(0, 16)}...</span>
            <span class="order-status ${order.status}">${statusLabel}</span>
          </div>
          <div class="order-products">
            ${productsHtml}
          </div>
          <div class="order-footer">
            <div class="order-total">Total: $${orderTotal.toLocaleString()}</div>
            <div class="order-actions">
              <button class="btn-success" onclick="confirmOrderInline('${order.id}', this)">Confirmar</button>
              <button class="btn-danger" onclick="rejectOrderInline('${order.id}', this)">Rechazar</button>
            </div>
          </div>
        </div>
      `;
    }

    // Toggle user orders expand/collapse
    window.toggleUserOrders = function(userId) {
      const contentEl = document.getElementById(`orders-${userId}`);
      const headerEl = contentEl?.previousElementSibling;

      if (contentEl && headerEl) {
        contentEl.classList.toggle('expanded');
        headerEl.classList.toggle('expanded');
      }
    };

    // Setup expand/collapse all buttons
    function setupExpandCollapseButtons() {
      const expandBtn = document.getElementById('expandAllOrders');
      const collapseBtn = document.getElementById('collapseAllOrders');

      if (expandBtn) {
        expandBtn.onclick = function() {
          document.querySelectorAll('.user-orders-content').forEach(el => el.classList.add('expanded'));
          document.querySelectorAll('.user-orders-header').forEach(el => el.classList.add('expanded'));
        };
      }

      if (collapseBtn) {
        collapseBtn.onclick = function() {
          document.querySelectorAll('.user-orders-content').forEach(el => el.classList.remove('expanded'));
          document.querySelectorAll('.user-orders-header').forEach(el => el.classList.remove('expanded'));
        };
      }
    }

    // Confirm order inline (without full page reload)
    window.confirmOrderInline = async function(orderId, buttonEl) {
      if (!currentUser) return;

      const orderCard = buttonEl.closest('.order-card');
      const actionsDiv = buttonEl.parentElement;

      // Disable buttons and show loading
      actionsDiv.innerHTML = '<span style="color:#6c757d;font-size:13px;">Procesando...</span>';

      try {
        const token = await currentUser.getIdToken();
        const res = await fetch("/.netlify/functions/confirm-order", {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ orderId, action: 'confirm' })
        });

        const data = await res.json();

        if (!res.ok) {
          console.error("Error confirmando orden:", data);
          alert("Error confirmando orden:\n\n" + (data.error || "Error desconocido") +
                (data.details ? "\n\nDetalles: " + data.details : ""));
          // Restore buttons
          actionsDiv.innerHTML = `
            <button class="btn-success" onclick="confirmOrderInline('${orderId}', this)">Confirmar</button>
            <button class="btn-danger" onclick="rejectOrderInline('${orderId}', this)">Rechazar</button>
          `;
          return;
        }

        // Success - animate removal
        orderCard.style.transition = 'all 0.3s ease';
        orderCard.style.backgroundColor = '#d4edda';
        orderCard.querySelector('.order-status').textContent = 'Confirmada';
        orderCard.querySelector('.order-status').className = 'order-status';
        orderCard.querySelector('.order-status').style.background = '#28a745';
        orderCard.querySelector('.order-status').style.color = 'white';

        setTimeout(() => {
          orderCard.style.opacity = '0';
          orderCard.style.transform = 'translateX(20px)';
          setTimeout(() => {
            removeOrderFromView(orderId);
            // Refresh stats
            loadStats();
          }, 300);
        }, 800);

      } catch (err) {
        console.error("Error en confirmOrderInline:", err);
        alert("Error confirmando orden: " + err.message);
        // Restore buttons
        actionsDiv.innerHTML = `
          <button class="btn-success" onclick="confirmOrderInline('${orderId}', this)">Confirmar</button>
          <button class="btn-danger" onclick="rejectOrderInline('${orderId}', this)">Rechazar</button>
        `;
      }
    };

    // Reject order inline (without full page reload)
    window.rejectOrderInline = async function(orderId, buttonEl) {
      if (!currentUser) return;

      const reason = prompt("Motivo del rechazo (opcional):");

      const orderCard = buttonEl.closest('.order-card');
      const actionsDiv = buttonEl.parentElement;

      // Disable buttons and show loading
      actionsDiv.innerHTML = '<span style="color:#6c757d;font-size:13px;">Procesando...</span>';

      try {
        const token = await currentUser.getIdToken();
        const res = await fetch("/.netlify/functions/confirm-order", {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ orderId, action: 'reject', rejectionReason: reason })
        });

        if (!res.ok) {
          alert("Error rechazando: " + res.status);
          // Restore buttons
          actionsDiv.innerHTML = `
            <button class="btn-success" onclick="confirmOrderInline('${orderId}', this)">Confirmar</button>
            <button class="btn-danger" onclick="rejectOrderInline('${orderId}', this)">Rechazar</button>
          `;
          return;
        }

        // Success - animate removal
        orderCard.style.transition = 'all 0.3s ease';
        orderCard.style.backgroundColor = '#f8d7da';
        orderCard.querySelector('.order-status').textContent = 'Rechazada';
        orderCard.querySelector('.order-status').className = 'order-status';
        orderCard.querySelector('.order-status').style.background = '#dc3545';
        orderCard.querySelector('.order-status').style.color = 'white';

        setTimeout(() => {
          orderCard.style.opacity = '0';
          orderCard.style.transform = 'translateX(-20px)';
          setTimeout(() => {
            removeOrderFromView(orderId);
            // Refresh stats
            loadStats();
          }, 300);
        }, 800);

      } catch (err) {
        console.error('Error en rejectOrderInline:', err);
        alert("Error rechazando orden: " + err.message);
        // Restore buttons
        actionsDiv.innerHTML = `
          <button class="btn-success" onclick="confirmOrderInline('${orderId}', this)">Confirmar</button>
          <button class="btn-danger" onclick="rejectOrderInline('${orderId}', this)">Rechazar</button>
        `;
      }
    };

    // Remove order from view and update user group
    function removeOrderFromView(orderId) {
      const orderCard = document.querySelector(`.order-card[data-order-id="${orderId}"]`);
      if (!orderCard) return;

      const userGroup = orderCard.closest('.user-orders-group');
      const userId = userGroup?.dataset.userId;

      // Remove from data
      pendingOrdersData = pendingOrdersData.filter(o => o.id !== orderId);

      // Remove card from DOM
      orderCard.remove();

      // Check if user group is now empty
      if (userGroup) {
        const remainingCards = userGroup.querySelectorAll('.order-card');
        if (remainingCards.length === 0) {
          userGroup.remove();
        } else {
          // Update user group header
          const countEl = userGroup.querySelector('.orders-count');
          const totalEl = userGroup.querySelector('.orders-total');

          const userOrders = pendingOrdersData.filter(o => o.buyerUid === userId);
          const userTotal = userOrders.reduce((sum, o) => sum + calculateOrderTotal(o), 0);

          if (countEl) {
            countEl.textContent = `${userOrders.length} ${userOrders.length === 1 ? 'orden' : 'ordenes'}`;
          }
          if (totalEl) {
            totalEl.textContent = `$${userTotal.toLocaleString()}`;
          }
        }
      }

      // Update summary
      const summaryEl = document.getElementById('pendingOrdersSummary');
      if (summaryEl) {
        const groupedOrders = groupOrdersByUser(pendingOrdersData);
        const totalAmount = pendingOrdersData.reduce((sum, o) => sum + calculateOrderTotal(o), 0);

        if (pendingOrdersData.length === 0) {
          summaryEl.textContent = '';
          document.getElementById('pendingOrdersGrouped').innerHTML = `
            <div class="empty-orders-state">
              <h3>No hay ordenes pendientes</h3>
              <p>Todas las ordenes han sido procesadas</p>
            </div>
          `;
        } else {
          summaryEl.textContent = `${groupedOrders.length} usuario(s) | ${pendingOrdersData.length} orden(es) | Total: $${totalAmount.toLocaleString()}`;
        }
      }
    }

    let allDistributors = [];
    let distributorReferralCounts = {}; // Global referral counts for sorting

    // Cargar distribuidores
    async function loadDistributors() {
      try {
        const usersSnap = await getDocs(collection(db, "usuarios"));
        allDistributors = usersSnap.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(u => (u.role === 'distribuidor' || u.tipoRegistro === 'distribuidor' || (!u.role && !u.tipoRegistro)));

        // Build referral counts
        distributorReferralCounts = {};
        allDistributors.forEach(dist => {
          const sponsor = dist.patrocinador;
          if (sponsor) {
            distributorReferralCounts[sponsor] = (distributorReferralCounts[sponsor] || 0) + 1;
          }
        });

        // Add referral count to each distributor for sorting
        allDistributors = allDistributors.map(dist => ({
          ...dist,
          referralCount: distributorReferralCounts[dist.usuario] || 0,
          monthlyPoints: getMonthlyPersonalPointsAdmin(dist),
          isActive: checkIfUserActiveThisMonth(dist)
        }));

        applyDistributorFilters();

        // Attach search event listener after loading distributors
        const searchInput = document.getElementById('distributorSearchInput');
        if (searchInput && !searchInput.dataset.listenerAttached) {
          searchInput.dataset.listenerAttached = 'true';
          searchInput.addEventListener('input', () => applyDistributorFilters());
        }

        // Attach sort filter event listener
        const sortFilter = document.getElementById('distributorSortFilter');
        if (sortFilter && !sortFilter.dataset.listenerAttached) {
          sortFilter.dataset.listenerAttached = 'true';
          sortFilter.addEventListener('change', () => applyDistributorFilters());
        }
      } catch (err) {
        console.error('Error loading distributors:', err);
      }
    }

    // Apply both search and sort filters
    function applyDistributorFilters() {
      const searchInput = document.getElementById('distributorSearchInput');
      const sortFilter = document.getElementById('distributorSortFilter');

      const searchTerm = (searchInput?.value || '').toLowerCase().trim();
      const sortBy = sortFilter?.value || 'name_asc';

      // First filter by search term
      let filtered = allDistributors;
      if (searchTerm) {
        filtered = allDistributors.filter(dist => {
          const nombre = (dist.nombre || '').toLowerCase();
          const usuario = (dist.usuario || '').toLowerCase();
          const cedula = (dist.cedula || '').toLowerCase();
          const email = (dist.email || '').toLowerCase();

          return nombre.includes(searchTerm) ||
                 usuario.includes(searchTerm) ||
                 cedula.includes(searchTerm) ||
                 email.includes(searchTerm);
        });
      }

      // Then sort
      filtered = sortDistributors(filtered, sortBy);

      renderDistributorsTable(filtered);
    }

    // Sort distributors by criteria
    function sortDistributors(distributors, sortBy) {
      const sorted = [...distributors];

      switch (sortBy) {
        case 'name_asc':
          return sorted.sort((a, b) => (a.nombre || '').localeCompare(b.nombre || ''));
        case 'name_desc':
          return sorted.sort((a, b) => (b.nombre || '').localeCompare(a.nombre || ''));
        case 'date_newest':
          return sorted.sort((a, b) => {
            const dateA = a.createdAt?.seconds || 0;
            const dateB = b.createdAt?.seconds || 0;
            return dateB - dateA;
          });
        case 'date_oldest':
          return sorted.sort((a, b) => {
            const dateA = a.createdAt?.seconds || 0;
            const dateB = b.createdAt?.seconds || 0;
            return dateA - dateB;
          });
        case 'balance_high':
          return sorted.sort((a, b) => (b.balance || 0) - (a.balance || 0));
        case 'balance_low':
          return sorted.sort((a, b) => (a.balance || 0) - (b.balance || 0));
        case 'points_high':
          return sorted.sort((a, b) => {
            const pointsA = a.personalPoints || a.puntos || 0;
            const pointsB = b.personalPoints || b.puntos || 0;
            return pointsB - pointsA;
          });
        case 'points_low':
          return sorted.sort((a, b) => {
            const pointsA = a.personalPoints || a.puntos || 0;
            const pointsB = b.personalPoints || b.puntos || 0;
            return pointsA - pointsB;
          });
        case 'group_high':
          return sorted.sort((a, b) => (b.groupPoints || 0) - (a.groupPoints || 0));
        case 'group_low':
          return sorted.sort((a, b) => (a.groupPoints || 0) - (b.groupPoints || 0));
        case 'referrals_high':
          return sorted.sort((a, b) => (b.referralCount || 0) - (a.referralCount || 0));
        case 'active_first':
          return sorted.sort((a, b) => {
            if (a.isActive === b.isActive) return (a.nombre || '').localeCompare(b.nombre || '');
            return a.isActive ? -1 : 1;
          });
        case 'inactive_first':
          return sorted.sort((a, b) => {
            if (a.isActive === b.isActive) return (a.nombre || '').localeCompare(b.nombre || '');
            return a.isActive ? 1 : -1;
          });
        default:
          return sorted;
      }
    }

    function renderDistributorsTable(distributors) {
      const table = document.getElementById('distributorsTable');
      table.innerHTML = '';

      if (distributors.length === 0) {
        table.innerHTML = '<tr><td colspan="9" class="empty-state">No hay distribuidores</td></tr>';
        return;
      }

      distributors.forEach(dist => {
        const row = document.createElement('tr');
        const date = dist.createdAt ? new Date(dist.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
        const personalPoints = dist.personalPoints || dist.puntos || 0;
        const groupPoints = dist.groupPoints || 0;
        const referralCount = dist.referralCount || 0;
        const monthlyPoints = dist.monthlyPoints || 0;

        const isActive = dist.isActive;
        const statusBadge = isActive
          ? `<span style="background:#10b981;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;" title="${monthlyPoints} puntos este mes">‚úì Activo (${monthlyPoints} pts)</span>`
          : `<span style="background:#ef4444;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;" title="Necesita ${MONTHLY_ACTIVATION_POINTS_THRESHOLD - monthlyPoints} pts m√°s">‚ö† Inactivo (${monthlyPoints}/${MONTHLY_ACTIVATION_POINTS_THRESHOLD} pts)</span>`;

        row.innerHTML = `
          <td>${dist.usuario || 'N/A'}</td>
          <td>${dist.nombre || 'N/A'}</td>
          <td>${dist.email || 'N/A'}</td>
          <td>${dist.celular || 'N/A'}</td>
          <td>${statusBadge}</td>
          <td><strong>${personalPoints}</strong></td>
          <td><strong>${groupPoints}</strong></td>
          <td>${date}</td>
          <td><button class="btn-primary" onclick="showDistributorDetails('${dist.id}')">Ver <span style="font-size:16px;">‚Üí</span></button></td>
        `;
        table.appendChild(row);
      });
    }

    // Cargar clientes
    async function loadClients() {
      try {
        const usersSnap = await getDocs(collection(db, "usuarios"));
        const clients = usersSnap.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(u => u.role === 'cliente' || u.tipoRegistro === 'cliente');
        
        const table = document.getElementById('clientsTable');
        table.innerHTML = '';
        
        if (clients.length === 0) {
          table.innerHTML = '<tr><td colspan="6" class="empty-state">No hay clientes</td></tr>';
          return;
        }
        
        clients.forEach(client => {
          const row = document.createElement('tr');
          const date = client.createdAt ? new Date(client.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
          row.innerHTML = `
            <td>${client.usuario || 'N/A'}</td>
            <td>${client.nombre || 'N/A'}</td>
            <td>${client.email || 'N/A'}</td>
            <td>${client.celular || 'N/A'}</td>
            <td>${client.puntos || client.personalPoints || 0}</td>
            <td>${date}</td>
          `;
          table.appendChild(row);
        });
      } catch (err) {
        console.error('Error loading clients:', err);
      }
    }

    // Cargar todos los usuarios
    async function loadUsers() {
      try {
        const usersSnap = await getDocs(collection(db, "usuarios"));
        const users = usersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        const table = document.getElementById('usersTable');
        table.innerHTML = '';
        
        if (users.length === 0) {
          table.innerHTML = '<tr><td colspan="7" class="empty-state">No hay usuarios</td></tr>';
          return;
        }
        
        users.forEach(user => {
          const row = document.createElement('tr');
          const date = user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
          const userRole = user.role || user.rol || user.tipoRegistro || 'distribuidor';
          const tipo = userRole === 'admin' ? 'Admin' : (userRole === 'distribuidor' ? 'Distribuidor' : (userRole === 'cliente' ? 'Cliente' : (userRole === 'restaurante' ? 'Restaurante' : 'Usuario')));
          row.innerHTML = `
            <td>${user.usuario || 'N/A'}</td>
            <td>${user.nombre || 'N/A'}</td>
            <td>${user.email || 'N/A'}</td>
            <td>${tipo}</td>
            <td>${user.puntos || user.personalPoints || 0}</td>
            <td>${date}</td>
            <td>
              <button class="btn-primary" onclick="editUserRole('${user.id}', '${userRole}', '${user.usuario || user.nombre || 'Usuario'}')">Editar Role</button>
            </td>
          `;
          table.appendChild(row);
        });
      } catch (err) {
        console.error('Error loading users:', err);
      }
    }

    // Confirmar / Rechazar
    window.confirmOrder = async function(orderId) {
      if (!currentUser) return;
      try {
        const token = await currentUser.getIdToken();
        const res = await fetch("/.netlify/functions/confirm-order", {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ orderId, action: 'confirm' })
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          console.error("Error confirmando orden:", data);
          alert("Error confirmando orden:\n\n" + (data.error || "Error desconocido") + 
                (data.details ? "\n\nDetalles: " + data.details : ""));
          return;
        }
        alert("Orden confirmada ‚úÖ");
        await loadAllData();
      } catch (err) {
        console.error("Error en confirmOrder:", err);
        alert("Error confirmando orden: " + err.message);
      }
    };

    window.rejectOrder = async function(orderId) {
      if (!currentUser) return;
      const reason = prompt("Motivo del rechazo (opcional):");
      const token = await currentUser.getIdToken();
      const res = await fetch("/.netlify/functions/confirm-order", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ orderId, action: 'reject', rejectionReason: reason })
      });
      if (!res.ok) {
        alert("Error rechazando: " + res.status);
        return;
      }
      alert("Orden rechazada ‚ùå");
      await loadAllData();
    };

    // Eliminar orden confirmada
    window.deleteOrder = async function(orderId) {
      if (!currentUser) return;
      const confirmDelete = confirm("¬øEst√°s seguro de que deseas eliminar esta orden? Esta acci√≥n no se puede deshacer.");
      if (!confirmDelete) return;
      
      try {
        const token = await currentUser.getIdToken();
        // Usar updateDoc para marcar como eliminada en lugar de borrar f√≠sicamente
        const orderRef = doc(db, "orders", orderId);
        await updateDoc(orderRef, {
          status: 'deleted',
          deletedAt: new Date().toISOString(),
          deletedBy: currentUser.uid
        });
        alert("Orden eliminada ‚úÖ");
        await loadAllData();
      } catch (err) {
        console.error('Error deleting order:', err);
        alert("Error eliminando la orden: " + err.message);
      }
    };

    // Cargar cobros pendientes de distribuidores
    async function loadPayouts() {
      try {
        const payoutsSnap = await getDocs(collection(db, "payouts"));
        // Filtrar solo los payouts que NO est√°n pagados
        const payouts = payoutsSnap.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(p => p.status !== 'paid');
        
        console.log('Payouts loaded:', payouts.length, payouts);
        
        const table = document.getElementById('payoutsTable');
        table.innerHTML = '';
        
        if (payouts.length === 0) {
          table.innerHTML = '<tr><td colspan="5" class="empty-state">No hay cobros pendientes</td></tr>';
          return;
        }
        
        // Obtener informaci√≥n de usuarios para mostrar nombres
        const usersMap = new Map();
        for (const payout of payouts) {
          if (payout.userId && !usersMap.has(payout.userId)) {
            try {
              const userDoc = await getDoc(doc(db, "usuarios", payout.userId));
              if (userDoc.exists()) {
                usersMap.set(payout.userId, userDoc.data());
              }
            } catch (err) {
              console.error('Error loading user:', err);
            }
          }
        }
        
        payouts.forEach(payout => {
          const row = document.createElement('tr');
          const userData = usersMap.get(payout.userId) || {};
          const userName = userData.nombre || userData.usuario || 'Desconocido';
          const date = payout.createdAt ? (payout.createdAt.seconds ? new Date(payout.createdAt.seconds * 1000).toLocaleDateString() : new Date(payout.createdAt).toLocaleDateString()) : 'N/A';
          const status = payout.status || 'scheduled';
          const statusText = 'Pendiente';
          const statusColor = '#fd7e14';

          row.innerHTML = `
            <td>${userName} (${userData.usuario || payout.userId})</td>
            <td>$${(payout.amount || 0).toLocaleString()}</td>
            <td>${date}</td>
            <td><span style="color:${statusColor};font-weight:600">${statusText}</span></td>
            <td>
              <button class="btn-primary" onclick="showPayoutReport('${payout.id}', '${payout.userId}', ${payout.amount})" style="display:flex;align-items:center;gap:6px;">
                <span>üìã</span> Ver Informe
              </button>
            </td>
          `;
          table.appendChild(row);
        });
      } catch (err) {
        console.error('Error loading payouts:', err);
      }
    }

    // Aceptar y pagar cobro (marca como pagado para evitar doble pago)
    // Esta funci√≥n ahora es llamada desde el modal de informe previo
    window.acceptPayout = async function(payoutId, userId, amount) {
      if (!currentUser) return;

      try {
        // Actualizar el estado del payout a 'paid'
        const payoutRef = doc(db, "payouts", payoutId);
        await updateDoc(payoutRef, {
          status: 'paid',
          paidAt: new Date().toISOString(),
          paidBy: currentUser.uid
        });

        // El monto ya fue descontado de balance cuando el distribuidor solicit√≥ el cobro
        // Ahora que el admin aprueba el pago, actualizamos:
        // 1. Descontamos de walletBalance (ya que se est√° pagando f√≠sicamente)
        // 2. Incrementamos totalComisionesCobradas (para llevar registro del total pagado)
        const userRef = doc(db, "usuarios", userId);
        await runTransaction(db, async (tx) => {
          const userSnap = await tx.get(userRef);
          if (!userSnap.exists()) {
            throw new Error("Usuario no encontrado");
          }
          const userData = userSnap.data();
          const currentWallet = Number(userData.walletBalance ?? 0);
          const currentCobradas = Number(userData.totalComisionesCobradas ?? 0);

          // Descontar de wallet y sumar a comisiones cobradas
          const newWallet = currentWallet - amount;
          const newCobradas = currentCobradas + amount;

          tx.update(userRef, {
            walletBalance: newWallet,
            totalComisionesCobradas: newCobradas
          });
        });

        // Cerrar el modal de informe
        closePayoutReportModal();

        alert("Pago confirmado exitosamente ‚úÖ");
        await loadAllData();
      } catch (err) {
        console.error('Error processing payout:', err);
        alert("Error procesando el pago: " + err.message);
      }
    };

    // ========================================
    // INFORME PREVIO DE PAGO - MODAL
    // ========================================

    // Funci√≥n para mostrar el informe previo de pago del distribuidor
    window.showPayoutReport = async function(payoutId, userId, amount) {
      if (!currentUser) return;

      const modal = document.getElementById('payoutReportModal');

      // Mostrar modal con indicador de carga
      modal.style.display = 'flex';

      try {
        // Obtener datos del payout
        const payoutDoc = await getDoc(doc(db, "payouts", payoutId));
        if (!payoutDoc.exists()) {
          throw new Error("Solicitud de pago no encontrada");
        }
        const payoutData = payoutDoc.data();

        // Obtener datos completos del usuario
        const userDoc = await getDoc(doc(db, "usuarios", userId));
        if (!userDoc.exists()) {
          throw new Error("Usuario no encontrado");
        }
        const userData = userDoc.data();

        // Configurar fecha del reporte
        const now = new Date();
        document.getElementById('payoutReportDate').textContent = now.toLocaleDateString('es-CO', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        // Calcular per√≠odo de liquidaci√≥n
        const payoutCreatedAt = payoutData.createdAt?.seconds
          ? new Date(payoutData.createdAt.seconds * 1000)
          : new Date(payoutData.createdAt || now);
        const scheduledFor = payoutData.scheduled_for || 'N/A';
        document.getElementById('payoutReportPeriod').textContent = `Hasta ${scheduledFor}`;

        // Informaci√≥n del distribuidor
        document.getElementById('payoutReportName').textContent = userData.nombre || 'No especificado';
        document.getElementById('payoutReportUsername').textContent = userData.usuario || 'N/A';
        document.getElementById('payoutReportUserId').textContent = userId;
        document.getElementById('payoutReportSponsor').textContent = userData.patrocinador || 'Sin patrocinador';

        // Calcular estado del distribuidor (activo/inactivo) usando la l√≥gica existente
        const monthlyPersonalPoints = getMonthlyPersonalPointsAdmin(userData);
        const isDistributorActive = monthlyPersonalPoints >= MONTHLY_ACTIVATION_POINTS_THRESHOLD;
        const statusContainer = document.getElementById('payoutReportStatusContainer');
        const statusIcon = document.getElementById('payoutReportStatusIcon');
        const statusText = document.getElementById('payoutReportStatus');

        if (isDistributorActive) {
          statusContainer.style.background = 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)';
          statusIcon.textContent = '‚úÖ';
          statusText.innerHTML = `<span style="color:#047857;">ACTIVO</span> <span style="font-size:13px;font-weight:500;color:#065f46;">(${monthlyPersonalPoints.toFixed(2)} / ${MONTHLY_ACTIVATION_POINTS_THRESHOLD} puntos personales este mes)</span>`;
        } else {
          statusContainer.style.background = 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)';
          statusIcon.textContent = '‚ö†Ô∏è';
          const pointsNeeded = (MONTHLY_ACTIVATION_POINTS_THRESHOLD - monthlyPersonalPoints).toFixed(2);
          statusText.innerHTML = `<span style="color:#dc2626;">INACTIVO</span> <span style="font-size:13px;font-weight:500;color:#991b1b;">(${monthlyPersonalPoints.toFixed(2)} / ${MONTHLY_ACTIVATION_POINTS_THRESHOLD} puntos personales - necesita ${pointsNeeded} pts m√°s)</span>`;
        }

        // Resumen de actividad
        const personalPoints = Number(userData.personalPoints || userData.puntos || 0);
        const groupPoints = Number(userData.groupPoints || 0);
        const balance = Number(userData.balance || 0);
        const walletBalance = Number(userData.walletBalance || 0);
        const totalCobradas = Number(userData.totalComisionesCobradas || 0);

        document.getElementById('payoutReportPersonalPoints').textContent = personalPoints.toFixed(2);
        document.getElementById('payoutReportGroupPoints').textContent = groupPoints.toFixed(2);
        document.getElementById('payoutReportBalance').textContent = `$${balance.toLocaleString()}`;
        document.getElementById('payoutReportPreviousPaid').textContent = `$${totalCobradas.toLocaleString()}`;

        // Analizar historial para detallar comisiones por concepto
        const history = userData.history || [];
        const commissionSummary = analyzeCommissionHistory(history);

        // Renderizar tabla de comisiones por concepto
        renderCommissionsTable(commissionSummary);

        // Renderizar historial reciente
        renderRecentHistory(history);

        // Valor final a pagar
        document.getElementById('payoutReportFinalAmount').textContent = `$${amount.toLocaleString()}`;

        // Guardar datos para la confirmaci√≥n
        document.getElementById('payoutReportPayoutId').value = payoutId;
        document.getElementById('payoutReportUserIdHidden').value = userId;
        document.getElementById('payoutReportAmountHidden').value = amount;

      } catch (err) {
        console.error('Error loading payout report:', err);
        alert('Error cargando el informe: ' + err.message);
        modal.style.display = 'none';
      }
    };

    // Funci√≥n para analizar el historial y agrupar comisiones por tipo
    function analyzeCommissionHistory(history) {
      const summary = {
        'Bono Inicio R√°pido': { count: 0, points: 0, amount: 0 },
        'Comisi√≥n Inicio R√°pido (Niveles Superiores)': { count: 0, points: 0, amount: 0 },
        'Comisi√≥n por Diferencia de Precio': { count: 0, points: 0, amount: 0 },
        'Comisi√≥n Multinivel (10%)': { count: 0, points: 0, amount: 0 },
        'Comisi√≥n por Restaurante (5%)': { count: 0, points: 0, amount: 0 },
        'Otros': { count: 0, points: 0, amount: 0 }
      };

      if (!Array.isArray(history)) return summary;

      for (const entry of history) {
        const type = entry.type || '';
        const amount = Number(entry.amount || 0);
        const points = Number(entry.points || 0);

        // Clasificar por tipo
        if (type === 'quick_start_bonus') {
          summary['Bono Inicio R√°pido'].count++;
          summary['Bono Inicio R√°pido'].points += points;
          summary['Bono Inicio R√°pido'].amount += amount;
        } else if (type === 'quick_start_upper_level') {
          summary['Comisi√≥n Inicio R√°pido (Niveles Superiores)'].count++;
          summary['Comisi√≥n Inicio R√°pido (Niveles Superiores)'].points += points;
          summary['Comisi√≥n Inicio R√°pido (Niveles Superiores)'].amount += amount;
        } else if (type === 'group_points') {
          // Distinguir entre comisi√≥n por diferencia y comisi√≥n multinivel
          const action = entry.action || '';
          if (action.includes('Diferencia de precio') || action.includes('diferencia de precio')) {
            summary['Comisi√≥n por Diferencia de Precio'].count++;
            summary['Comisi√≥n por Diferencia de Precio'].points += points;
            summary['Comisi√≥n por Diferencia de Precio'].amount += amount;
          } else {
            summary['Comisi√≥n Multinivel (10%)'].count++;
            summary['Comisi√≥n Multinivel (10%)'].points += points;
            summary['Comisi√≥n Multinivel (10%)'].amount += amount;
          }
        } else if (type === 'restaurant_commission') {
          summary['Comisi√≥n por Restaurante (5%)'].count++;
          summary['Comisi√≥n por Restaurante (5%)'].points += points;
          summary['Comisi√≥n por Restaurante (5%)'].amount += amount;
        } else if (type === 'earning' && amount > 0) {
          summary['Otros'].count++;
          summary['Otros'].points += points;
          summary['Otros'].amount += amount;
        }
      }

      return summary;
    }

    // Renderizar tabla de comisiones
    function renderCommissionsTable(summary) {
      const table = document.getElementById('payoutReportCommissionsTable');
      let html = '';
      let totalCount = 0;
      let totalPoints = 0;
      let totalAmount = 0;

      const conceptIcons = {
        'Bono Inicio R√°pido': 'üöÄ',
        'Comisi√≥n Inicio R√°pido (Niveles Superiores)': '‚¨ÜÔ∏è',
        'Comisi√≥n por Diferencia de Precio': 'üíµ',
        'Comisi√≥n Multinivel (10%)': 'üåê',
        'Comisi√≥n por Restaurante (5%)': 'üçΩÔ∏è',
        'Otros': 'üì¶'
      };

      for (const [concept, data] of Object.entries(summary)) {
        if (data.count > 0) {
          totalCount += data.count;
          totalPoints += data.points;
          totalAmount += data.amount;

          html += `
            <tr>
              <td style="padding:12px;border-bottom:1px solid #e9ecef;">
                <span style="margin-right:8px;">${conceptIcons[concept] || 'üí∞'}</span>
                ${concept}
              </td>
              <td style="padding:12px;text-align:center;border-bottom:1px solid #e9ecef;">${data.count}</td>
              <td style="padding:12px;text-align:right;border-bottom:1px solid #e9ecef;">${data.points.toFixed(2)}</td>
              <td style="padding:12px;text-align:right;border-bottom:1px solid #e9ecef;">$${data.amount.toLocaleString()}</td>
            </tr>
          `;
        }
      }

      if (html === '') {
        html = '<tr><td colspan="4" style="padding:16px;text-align:center;color:#6c757d;">No hay comisiones registradas en el historial</td></tr>';
      }

      table.innerHTML = html;
      document.getElementById('payoutReportTotalCount').textContent = totalCount;
      document.getElementById('payoutReportTotalPoints').textContent = totalPoints.toFixed(2);
      document.getElementById('payoutReportTotalAmount').textContent = `$${totalAmount.toLocaleString()}`;
    }

    // Renderizar historial reciente
    function renderRecentHistory(history) {
      const container = document.getElementById('payoutReportHistoryContainer');

      if (!Array.isArray(history) || history.length === 0) {
        container.innerHTML = '<div style="padding:24px;text-align:center;color:#6c757d;">No hay transacciones registradas</div>';
        return;
      }

      // Ordenar por fecha m√°s reciente y tomar las √∫ltimas 20
      const sortedHistory = [...history]
        .filter(entry => entry.amount && entry.amount !== 0)
        .sort((a, b) => {
          const dateA = a.timestamp || (a.date ? new Date(a.date).getTime() : 0);
          const dateB = b.timestamp || (b.date ? new Date(b.date).getTime() : 0);
          return dateB - dateA;
        })
        .slice(0, 20);

      if (sortedHistory.length === 0) {
        container.innerHTML = '<div style="padding:24px;text-align:center;color:#6c757d;">No hay transacciones con montos registrados</div>';
        return;
      }

      let html = '';
      for (const entry of sortedHistory) {
        const amount = Number(entry.amount || 0);
        const points = Number(entry.points || 0);
        const action = entry.action || 'Transacci√≥n';
        const date = entry.date ? new Date(entry.date).toLocaleDateString('es-CO', {
          day: '2-digit',
          month: 'short',
          year: 'numeric'
        }) : 'N/A';

        const isPositive = amount >= 0;
        const amountColor = isPositive ? '#00875a' : '#de350b';
        const amountPrefix = isPositive ? '+' : '';

        // Determinar icono seg√∫n tipo
        let icon = 'üí∞';
        const type = entry.type || '';
        if (type === 'quick_start_bonus') icon = 'üöÄ';
        else if (type === 'quick_start_upper_level') icon = '‚¨ÜÔ∏è';
        else if (type === 'restaurant_commission') icon = 'üçΩÔ∏è';
        else if (type === 'group_points') icon = 'üåê';
        else if (type === 'withdraw' || type === 'cobro') icon = 'üí≥';

        html += `
          <div style="padding:12px 16px;border-bottom:1px solid #e9ecef;display:flex;justify-content:space-between;align-items:flex-start;gap:12px;">
            <div style="flex:1;min-width:0;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                <span style="font-size:16px;">${icon}</span>
                <span style="font-size:13px;color:#333;font-weight:500;word-break:break-word;">${action}</span>
              </div>
              <div style="font-size:11px;color:#6c757d;">${date}${entry.fromUser ? ` ‚Ä¢ De: ${entry.fromUser}` : ''}</div>
            </div>
            <div style="text-align:right;flex-shrink:0;">
              <div style="font-size:14px;font-weight:600;color:${amountColor};">${amountPrefix}$${Math.abs(amount).toLocaleString()}</div>
              ${points ? `<div style="font-size:11px;color:#6c757d;">${points.toFixed(2)} pts</div>` : ''}
            </div>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    // Cerrar modal de informe
    function closePayoutReportModal() {
      document.getElementById('payoutReportModal').style.display = 'none';
    }

    // Event listeners para el modal de informe de pago
    document.getElementById('payoutReportModalClose').addEventListener('click', closePayoutReportModal);
    document.getElementById('payoutReportCancelBtn').addEventListener('click', closePayoutReportModal);
    document.getElementById('payoutReportModal').addEventListener('click', (e) => {
      if (e.target.id === 'payoutReportModal') {
        closePayoutReportModal();
      }
    });

    // Confirmar pago desde el modal
    document.getElementById('payoutReportConfirmBtn').addEventListener('click', async () => {
      const payoutId = document.getElementById('payoutReportPayoutId').value;
      const userId = document.getElementById('payoutReportUserIdHidden').value;
      const amount = Number(document.getElementById('payoutReportAmountHidden').value);

      if (!payoutId || !userId || !amount) {
        alert('Error: Datos de pago incompletos');
        return;
      }

      // Confirmar antes de procesar
      const confirmPay = confirm(`¬øEst√° seguro de confirmar el pago de $${amount.toLocaleString()} al distribuidor?\n\nEsta acci√≥n no se puede deshacer.`);
      if (!confirmPay) return;

      const btn = document.getElementById('payoutReportConfirmBtn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span>‚è≥</span> Procesando...';

      try {
        await acceptPayout(payoutId, userId, amount);
      } catch (err) {
        console.error('Error confirming payout:', err);
        alert('Error al procesar el pago: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    });

    // Role management variables
    let roleModalTarget = null;
    let roleModalMode = 'single';
    
    const roleModal = document.getElementById('roleModal');
    const roleModalTitle = document.getElementById('roleModalTitle');
    const roleModalDescription = document.getElementById('roleModalDescription');
    const roleSelect = document.getElementById('roleSelect');
    const roleModalCancel = document.getElementById('roleModalCancel');
    const roleModalConfirm = document.getElementById('roleModalConfirm');
    const bulkRoleBtn = document.getElementById('bulkRoleBtn');

    // Edit individual user role
    window.editUserRole = async function(userId, currentRole, userName) {
      roleModalTarget = userId;
      roleModalMode = 'single';
      roleModalTitle.textContent = 'Editar Role de Usuario';
      roleModalDescription.textContent = `Cambiando role para: ${userName}`;
      roleSelect.value = currentRole || 'distribuidor';
      roleModal.style.display = 'flex';
    };

    // Bulk role change
    bulkRoleBtn.addEventListener('click', () => {
      roleModalTarget = null;
      roleModalMode = 'bulk';
      roleModalTitle.textContent = 'Cambiar Role a Todos los Usuarios';
      roleModalDescription.textContent = 'Esta acci√≥n cambiar√° el role de TODOS los usuarios en el sistema.';
      roleSelect.value = 'distribuidor';
      roleModal.style.display = 'flex';
    });

    // Cancel modal
    roleModalCancel.addEventListener('click', () => {
      roleModal.style.display = 'none';
      roleModalTarget = null;
    });

    // Close modal on background click
    roleModal.addEventListener('click', (e) => {
      if (e.target === roleModal) {
        roleModal.style.display = 'none';
        roleModalTarget = null;
      }
    });

    // Confirm role change
    roleModalConfirm.addEventListener('click', async () => {
      const selectedRole = roleSelect.value;

      try {
        if (roleModalMode === 'single' && roleModalTarget) {
          const userRef = doc(db, "usuarios", roleModalTarget);
          await updateDoc(userRef, {
            role: selectedRole,
            rol: selectedRole
          });
          alert('Role actualizado exitosamente ‚úÖ');
        } else if (roleModalMode === 'bulk') {
          const usersSnap = await getDocs(collection(db, "usuarios"));
          const updatePromises = usersSnap.docs.map(userDoc => {
            const userRef = doc(db, "usuarios", userDoc.id);
            return updateDoc(userRef, {
              role: selectedRole,
              rol: selectedRole
            });
          });

          await Promise.all(updatePromises);
          alert(`Role actualizado para ${usersSnap.docs.length} usuarios ‚úÖ`);
        }

        roleModal.style.display = 'none';
        roleModalTarget = null;
        await loadAllData();
      } catch (err) {
        console.error('Error updating role:', err);
        alert('Error actualizando role: ' + err.message);
      }
    });

    // Distributor details panel management
    window.showDistributorDetails = async function(distributorId) {
      try {
        const distDoc = await getDoc(doc(db, 'usuarios', distributorId));
        if (!distDoc.exists()) {
          alert('Distribuidor no encontrado');
          return;
        }
        
        const dist = distDoc.data();
        const personalPoints = dist.personalPoints || dist.puntos || 0;
        const groupPoints = dist.groupPoints || 0;
        const balance = dist.balance || 0;
        const walletBalance = dist.walletBalance || 0;
        const totalComisionesCobradas = dist.totalComisionesCobradas || 0;
        
        // Count referrals
        const usersSnap = await getDocs(collection(db, 'usuarios'));
        const referrals = usersSnap.docs.filter(d => {
          const userData = d.data();
          return userData.patrocinador === dist.usuario;
        });
        
        // Get orders history
        const ordersSnap = await getDocs(query(
          collection(db, 'orders'),
          where('buyerUid', '==', distributorId)
        ));
        const orders = ordersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        // Get history from user document
        const history = dist.history || [];
        
        // Calculate current month commissions
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();
        const monthStart = new Date(currentYear, currentMonth, 1);
        const monthEnd = new Date(currentYear, currentMonth + 1, 0, 23, 59, 59, 999);
        
        // Total earned this month from transaction history
        const commissionHistory = history.filter(h => 
          h.type !== 'purchase' && 
          !(h.action || '').includes('Compra confirmada') &&
          h.date
        );
        
        let totalEarnedThisMonth = 0;
        let earnedPointsThisMonth = 0;
        const thisMonthTransactions = [];
        
        commissionHistory.forEach(h => {
          const transactionDate = new Date(h.date);
          if (transactionDate >= monthStart && transactionDate <= monthEnd) {
            totalEarnedThisMonth += (h.amount || 0);
            earnedPointsThisMonth += (h.points || 0);
            thisMonthTransactions.push(h);
          }
        });
        
        // Already collected this month from payouts
        const payoutsSnap = await getDocs(query(
          collection(db, 'payouts'),
          where('userId', '==', distributorId),
          where('status', '==', 'paid')
        ));
        
        let alreadyCollectedThisMonth = 0;
        let collectedPayoutsCount = 0;
        
        payoutsSnap.docs.forEach(doc => {
          const payout = doc.data();
          let paidDate = null;
          
          if (payout.paidAt) {
            if (typeof payout.paidAt === 'string') {
              paidDate = new Date(payout.paidAt);
            } else if (payout.paidAt.seconds) {
              paidDate = new Date(payout.paidAt.seconds * 1000);
            }
          }
          
          if (paidDate && paidDate >= monthStart && paidDate <= monthEnd) {
            alreadyCollectedThisMonth += (payout.amount || 0);
            collectedPayoutsCount++;
          }
        });
        
        // Pending amount from balance field
        const pendingAmount = balance;

        // Check if user is active this month
        const isActiveThisMonth = checkIfUserActiveThisMonth(dist);
        const monthlyPts = getMonthlyPersonalPointsAdmin(dist);
        const activeStatusBadge = isActiveThisMonth
          ? `<span style="background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:white;padding:4px 12px;border-radius:16px;font-size:12px;font-weight:600;" title="${monthlyPts} puntos este mes">‚úì Activo este mes (${monthlyPts} pts)</span>`
          : `<span style="background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:white;padding:4px 12px;border-radius:16px;font-size:12px;font-weight:600;" title="Necesita ${MONTHLY_ACTIVATION_POINTS_THRESHOLD - monthlyPts} pts m√°s">‚ö† Inactivo (${monthlyPts}/${MONTHLY_ACTIVATION_POINTS_THRESHOLD} pts)</span>`;
        
        const contentDiv = document.getElementById('distributorDetailsContent');
        contentDiv.innerHTML = `
          <div style="background:#f8f9fa;padding:16px;border-radius:8px;margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
              <h3 style="margin:0;font-size:18px;color:#333;">${dist.nombre || dist.usuario || 'Sin nombre'}</h3>
              ${activeStatusBadge}
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px;">
              <div><strong>C√≥digo:</strong> ${dist.usuario || 'N/A'}</div>
              <div><strong>Email:</strong> ${dist.email || 'N/A'}</div>
              <div><strong>Celular:</strong> ${dist.celular || 'N/A'}</div>
              <div><strong>Patrocinador:</strong> ${dist.patrocinador || 'Ninguno'}</div>
            </div>
            <div style="margin-top:16px;padding-top:16px;border-top:1px solid #dee2e6;">
              <button
                onclick="openAdminPurchaseModal('${distributorId}', '${(dist.nombre || dist.usuario || 'Sin nombre').replace(/'/g, "\\'")}', '${dist.usuario || ''}')"
                class="btn-success"
                style="width:100%;padding:12px 16px;font-size:14px;display:flex;align-items:center;justify-content:center;gap:8px;"
              >
                <span style="font-size:18px;">üõí</span>
                Generar Compra
              </button>
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:12px;margin-bottom:24px;">
            <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:16px;border-radius:8px;">
              <div style="font-size:12px;opacity:0.9;margin-bottom:4px;">Puntos Personales</div>
              <div style="font-size:28px;font-weight:700;">${personalPoints}</div>
            </div>
            <div style="background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:white;padding:16px;border-radius:8px;">
              <div style="font-size:12px;opacity:0.9;margin-bottom:4px;">Puntos Grupales</div>
              <div style="font-size:28px;font-weight:700;">${groupPoints}</div>
            </div>
            <div style="background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:white;padding:16px;border-radius:8px;">
              <div style="font-size:12px;opacity:0.9;margin-bottom:4px;">Balance Disponible</div>
              <div style="font-size:24px;font-weight:700;">$${balance.toLocaleString()}</div>
            </div>
            <div style="background:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);color:white;padding:16px;border-radius:8px;">
              <div style="font-size:12px;opacity:0.9;margin-bottom:4px;">Total Referidos</div>
              <div style="font-size:28px;font-weight:700;">${referrals.length}</div>
            </div>
          </div>
          
          <div style="background:linear-gradient(135deg,#ffecd2 0%,#fcb69f 100%);padding:20px;border-radius:12px;margin-bottom:24px;box-shadow:0 4px 12px rgba(0,0,0,0.1);">
            <h4 style="margin:0 0 16px 0;font-size:18px;color:#c44536;font-weight:700;">Comisiones del Mes en Curso</h4>
            
            <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:12px;margin-bottom:16px;">
              <div style="background:white;padding:16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                <div style="font-size:12px;color:#666;margin-bottom:6px;font-weight:600;">Total Ganado</div>
                <div style="font-size:24px;font-weight:700;color:#2c3e50;margin-bottom:4px;">$${totalEarnedThisMonth.toLocaleString()}</div>
                <div style="font-size:11px;color:#999;">${earnedPointsThisMonth.toFixed(2)} puntos</div>
              </div>
              
              <div style="background:white;padding:16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                <div style="font-size:12px;color:#666;margin-bottom:6px;font-weight:600;">Ya Cobrado</div>
                <div style="font-size:24px;font-weight:700;color:#27ae60;margin-bottom:4px;">$${alreadyCollectedThisMonth.toLocaleString()}</div>
                <div style="font-size:11px;color:#999;">${collectedPayoutsCount} cobro${collectedPayoutsCount !== 1 ? 's' : ''}</div>
              </div>
              
              <div style="background:white;padding:16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);border:2px solid #e74c3c;">
                <div style="font-size:12px;color:#666;margin-bottom:6px;font-weight:600;">Pendiente</div>
                <div style="font-size:24px;font-weight:700;color:#e74c3c;margin-bottom:4px;">$${pendingAmount.toLocaleString()}</div>
                <div style="font-size:11px;color:#999;">Disponible para retiro</div>
              </div>
            </div>
            
            ${thisMonthTransactions.length > 0 ? `
              <div style="background:white;padding:12px;border-radius:8px;max-height:200px;overflow-y:auto;">
                <div style="font-size:13px;font-weight:600;color:#333;margin-bottom:8px;">Transacciones del mes (${thisMonthTransactions.length})</div>
                <table style="width:100%;font-size:12px;border-collapse:collapse;">
                  <thead style="position:sticky;top:0;background:white;">
                    <tr style="border-bottom:1px solid #e0e0e0;">
                      <th style="padding:6px;text-align:left;color:#666;font-weight:600;">Fecha</th>
                      <th style="padding:6px;text-align:left;color:#666;font-weight:600;">Descripci√≥n</th>
                      <th style="padding:6px;text-align:right;color:#666;font-weight:600;">Monto</th>
                      <th style="padding:6px;text-align:right;color:#666;font-weight:600;">Puntos</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${thisMonthTransactions.slice().reverse().map(t => {
                      const date = new Date(t.date);
                      const formattedDate = date.toLocaleDateString('es-CO', { day: '2-digit', month: 'short' });
                      return `
                        <tr style="border-bottom:1px solid #f5f5f5;">
                          <td style="padding:6px;color:#555;">${formattedDate}</td>
                          <td style="padding:6px;color:#333;font-size:11px;">${t.action || 'N/A'}</td>
                          <td style="padding:6px;text-align:right;color:#27ae60;font-weight:600;">$${(t.amount || 0).toLocaleString()}</td>
                          <td style="padding:6px;text-align:right;color:#3498db;font-weight:600;">${(t.points || 0).toFixed(2)}</td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            ` : '<div style="background:white;padding:12px;border-radius:8px;text-align:center;color:#999;font-size:13px;">No hay transacciones este mes</div>'}
          </div>
          
          <div style="margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;border-bottom:2px solid #e9ecef;padding-bottom:8px;">
              <h4 style="margin:0;font-size:16px;color:#333;">Referidos Directos (${referrals.length})</h4>
              <button 
                onclick="recalculateDistributor('${distributorId}')" 
                class="btn-primary" 
                style="padding:8px 16px;font-size:13px;display:flex;align-items:center;gap:6px;"
              >
                <span style="font-size:16px;">üîÑ</span>
                Recalcular Puntos y Comisiones
              </button>
            </div>
            ${referrals.length === 0 ? '<p style="color:#6c757d;font-size:14px;">No tiene referidos directos</p>' : `
              <div style="max-height:200px;overflow-y:auto;">
                <table style="width:100%;font-size:13px;">
                  <thead style="background:#f8f9fa;">
                    <tr>
                      <th style="padding:8px;">C√≥digo</th>
                      <th style="padding:8px;">Nombre</th>
                      <th style="padding:8px;">Email</th>
                      <th style="padding:8px;">Puntos</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${referrals.map(ref => {
                      const refData = ref.data();
                      return `
                        <tr style="border-bottom:1px solid #e9ecef;">
                          <td style="padding:8px;">${refData.usuario || 'N/A'}</td>
                          <td style="padding:8px;">${refData.nombre || 'N/A'}</td>
                          <td style="padding:8px;">${refData.email || 'N/A'}</td>
                          <td style="padding:8px;"><strong>${refData.personalPoints || refData.puntos || 0}</strong></td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            `}
          </div>
          
          <div style="margin-bottom:20px;">
            <h4 style="margin:0 0 12px 0;font-size:16px;color:#333;border-bottom:2px solid #e9ecef;padding-bottom:8px;">√ìrdenes de Compra (${orders.length})</h4>
            ${orders.length === 0 ? '<p style="color:#6c757d;font-size:14px;">No tiene √≥rdenes registradas</p>' : `
              <div style="max-height:250px;overflow-y:auto;">
                <table style="width:100%;font-size:13px;">
                  <thead style="background:#f8f9fa;">
                    <tr>
                      <th style="padding:8px;">Fecha</th>
                      <th style="padding:8px;">Producto</th>
                      <th style="padding:8px;">Total</th>
                      <th style="padding:8px;">Puntos</th>
                      <th style="padding:8px;">Estado</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${orders.map(order => {
                      const date = order.createdAt ? new Date(order.createdAt).toLocaleDateString() : 'N/A';
                      const statusColors = {
                        confirmed: '#28a745',
                        pending: '#fd7e14',
                        pending_delivery: '#fd7e14',
                        rejected: '#dc3545'
                      };
                      return `
                        <tr style="border-bottom:1px solid #e9ecef;">
                          <td style="padding:8px;">${date}</td>
                          <td style="padding:8px;">${order.productName || 'N/A'}</td>
                          <td style="padding:8px;">$${(order.totalPrice || order.price || 0).toLocaleString()}</td>
                          <td style="padding:8px;"><strong>${order.totalPoints || order.points || 0}</strong></td>
                          <td style="padding:8px;"><span style="color:${statusColors[order.status] || '#6c757d'};font-weight:600;">${order.status}</span></td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            `}
          </div>
          
          <div>
            <h4 style="margin:0 0 12px 0;font-size:16px;color:#333;border-bottom:2px solid #e9ecef;padding-bottom:8px;">Historial de Comisiones (${history.filter(h => h.type !== 'purchase' && !(h.action || '').includes('Compra confirmada')).length})</h4>
            ${history.filter(h => h.type !== 'purchase' && !(h.action || '').includes('Compra confirmada')).length === 0 ? '<p style="color:#6c757d;font-size:14px;">No hay historial de comisiones</p>' : `
              <div style="max-height:300px;overflow-y:auto;">
                <table style="width:100%;font-size:13px;">
                  <thead style="background:#f8f9fa;position:sticky;top:0;">
                    <tr>
                      <th style="padding:8px;">Fecha</th>
                      <th style="padding:8px;">Acci√≥n</th>
                      <th style="padding:8px;">Monto</th>
                      <th style="padding:8px;">Puntos</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${history.filter(h => h.type !== 'purchase' && !(h.action || '').includes('Compra confirmada')).slice().reverse().slice(0, 50).map(h => {
                      const date = h.date ? new Date(h.date).toLocaleDateString() : 'N/A';
                      return `
                        <tr style="border-bottom:1px solid #e9ecef;">
                          <td style="padding:8px;">${date}</td>
                          <td style="padding:8px;">${h.action || 'N/A'}</td>
                          <td style="padding:8px;">$${(h.amount || 0).toLocaleString()}</td>
                          <td style="padding:8px;"><strong>${h.points || 0}</strong></td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            `}
          </div>
        `;
        
        // Show panel
        const panel = document.getElementById('distributorDetailsPanel');
        const overlay = document.getElementById('distributorPanelOverlay');
        overlay.style.display = 'block';
        panel.style.display = 'block';
        setTimeout(() => {
          panel.style.right = '0';
        }, 10);
      } catch (err) {
        console.error('Error loading distributor details:', err);
        alert('Error cargando detalles del distribuidor: ' + err.message);
      }
    };
    
    // Close distributor panel
    document.getElementById('closeDistributorPanel').addEventListener('click', () => {
      const panel = document.getElementById('distributorDetailsPanel');
      const overlay = document.getElementById('distributorPanelOverlay');
      panel.style.right = '-600px';
      setTimeout(() => {
        panel.style.display = 'none';
        overlay.style.display = 'none';
      }, 300);
    });

    document.getElementById('distributorPanelOverlay').addEventListener('click', () => {
      document.getElementById('closeDistributorPanel').click();
    });

    // ========================================
    // Admin Purchase Modal - Generate orders for distributors
    // ========================================
    let adminPurchaseSelectedProducts = {};
    let adminPurchaseProductsCache = [];

    window.openAdminPurchaseModal = async function(distributorId, distributorName, distributorUsername) {
      const modal = document.getElementById('adminPurchaseModal');
      const infoEl = document.getElementById('adminPurchaseDistributorInfo');
      const productsList = document.getElementById('adminPurchaseProductsList');

      // Set distributor info
      document.getElementById('adminPurchaseDistributorId').value = distributorId;
      document.getElementById('adminPurchaseDistributorUsername').value = distributorUsername;
      infoEl.textContent = `Para: ${distributorName} (${distributorUsername})`;

      // Reset state
      adminPurchaseSelectedProducts = {};
      document.getElementById('adminPurchaseNotes').value = '';
      document.getElementById('adminPurchaseSelectedContainer').style.display = 'none';
      document.getElementById('adminPurchaseModalConfirm').disabled = true;

      // Show modal
      modal.style.display = 'flex';

      // Load products
      productsList.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">Cargando productos...</div>';

      try {
        const productsSnap = await getDocs(collection(db, "productos"));
        adminPurchaseProductsCache = productsSnap.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(p => !p.hidden && !p.deleted && !p.outOfStock)
          .filter(p => {
            // Only show products available for distributors
            if (!p.availableFor) return true;
            return p.availableFor.includes('distribuidor');
          })
          .sort((a, b) => (a.nombre || '').localeCompare(b.nombre || ''));

        if (adminPurchaseProductsCache.length === 0) {
          productsList.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">No hay productos disponibles</div>';
          return;
        }

        productsList.innerHTML = adminPurchaseProductsCache.map(prod => {
          const price = prod.precioDistribuidor || prod.precio || 0;
          const points = prod.puntos || 0;
          return `
            <div style="display:flex;align-items:center;gap:12px;padding:12px;border-bottom:1px solid #eee;transition:background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
              <img src="${prod.imagen || '/images/placeholder.png'}" alt="${prod.nombre}" style="width:50px;height:50px;object-fit:cover;border-radius:6px;border:1px solid #ddd;">
              <div style="flex:1;min-width:0;">
                <div style="font-weight:600;color:#333;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${prod.nombre}</div>
                <div style="font-size:12px;color:#666;">$${price.toLocaleString()} ¬∑ ${points} pts</div>
              </div>
              <div style="display:flex;align-items:center;gap:8px;">
                <button type="button" onclick="adminPurchaseDecreaseQty('${prod.id}')" style="width:28px;height:28px;border:1px solid #ddd;border-radius:4px;background:white;cursor:pointer;font-size:16px;">-</button>
                <span id="adminPurchaseQty-${prod.id}" style="width:30px;text-align:center;font-weight:600;">0</span>
                <button type="button" onclick="adminPurchaseIncreaseQty('${prod.id}')" style="width:28px;height:28px;border:1px solid #28a745;border-radius:4px;background:#28a745;color:white;cursor:pointer;font-size:16px;">+</button>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Error loading products:', err);
        productsList.innerHTML = '<div style="text-align:center;padding:20px;color:#dc3545;">Error cargando productos</div>';
      }
    };

    window.adminPurchaseIncreaseQty = function(productId) {
      const currentQty = adminPurchaseSelectedProducts[productId] || 0;
      adminPurchaseSelectedProducts[productId] = currentQty + 1;
      document.getElementById(`adminPurchaseQty-${productId}`).textContent = currentQty + 1;
      updateAdminPurchaseSummary();
    };

    window.adminPurchaseDecreaseQty = function(productId) {
      const currentQty = adminPurchaseSelectedProducts[productId] || 0;
      if (currentQty > 0) {
        adminPurchaseSelectedProducts[productId] = currentQty - 1;
        document.getElementById(`adminPurchaseQty-${productId}`).textContent = currentQty - 1;
        if (currentQty - 1 === 0) {
          delete adminPurchaseSelectedProducts[productId];
        }
        updateAdminPurchaseSummary();
      }
    };

    function updateAdminPurchaseSummary() {
      const selectedContainer = document.getElementById('adminPurchaseSelectedContainer');
      const selectedList = document.getElementById('adminPurchaseSelectedList');
      const confirmBtn = document.getElementById('adminPurchaseModalConfirm');

      const selectedIds = Object.keys(adminPurchaseSelectedProducts).filter(id => adminPurchaseSelectedProducts[id] > 0);

      if (selectedIds.length === 0) {
        selectedContainer.style.display = 'none';
        confirmBtn.disabled = true;
        return;
      }

      selectedContainer.style.display = 'block';
      confirmBtn.disabled = false;

      let subtotal = 0;
      let totalPoints = 0;

      const itemsHtml = selectedIds.map(productId => {
        const prod = adminPurchaseProductsCache.find(p => p.id === productId);
        if (!prod) return '';

        const qty = adminPurchaseSelectedProducts[productId];
        const price = prod.precioDistribuidor || prod.precio || 0;
        const points = prod.puntos || 0;
        const itemTotal = price * qty;
        const itemPoints = points * qty;

        subtotal += itemTotal;
        totalPoints += itemPoints;

        return `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #eee;">
            <div>
              <span style="font-weight:500;">${prod.nombre}</span>
              <span style="color:#666;font-size:13px;"> x${qty}</span>
            </div>
            <div style="text-align:right;">
              <div style="font-weight:600;">$${itemTotal.toLocaleString()}</div>
              <div style="font-size:12px;color:#666;">${itemPoints} pts</div>
            </div>
          </div>
        `;
      }).join('');

      selectedList.innerHTML = itemsHtml;
      document.getElementById('adminPurchaseSubtotal').textContent = `$${subtotal.toLocaleString()}`;
      document.getElementById('adminPurchaseTotalPoints').textContent = `${totalPoints} pts`;
      document.getElementById('adminPurchaseTotal').textContent = `$${subtotal.toLocaleString()}`;
    }

    function closeAdminPurchaseModal() {
      const modal = document.getElementById('adminPurchaseModal');
      modal.style.display = 'none';
      adminPurchaseSelectedProducts = {};
    }

    document.getElementById('adminPurchaseModalClose').addEventListener('click', closeAdminPurchaseModal);
    document.getElementById('adminPurchaseModalCancel').addEventListener('click', closeAdminPurchaseModal);
    document.getElementById('adminPurchaseModal').addEventListener('click', (e) => {
      if (e.target.id === 'adminPurchaseModal') {
        closeAdminPurchaseModal();
      }
    });

    document.getElementById('adminPurchaseModalConfirm').addEventListener('click', async () => {
      const distributorId = document.getElementById('adminPurchaseDistributorId').value;
      const distributorUsername = document.getElementById('adminPurchaseDistributorUsername').value;
      const notes = document.getElementById('adminPurchaseNotes').value.trim();
      const confirmBtn = document.getElementById('adminPurchaseModalConfirm');

      const selectedIds = Object.keys(adminPurchaseSelectedProducts).filter(id => adminPurchaseSelectedProducts[id] > 0);

      if (selectedIds.length === 0) {
        alert('Selecciona al menos un producto');
        return;
      }

      // Disable button and show loading
      const originalText = confirmBtn.textContent;
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Creando orden...';

      try {
        // Get distributor data
        const distDoc = await getDoc(doc(db, 'usuarios', distributorId));
        if (!distDoc.exists()) {
          throw new Error('Distribuidor no encontrado');
        }
        const distData = distDoc.data();

        // Create individual orders for each product (following existing pattern)
        const orderIds = [];

        for (const productId of selectedIds) {
          const prod = adminPurchaseProductsCache.find(p => p.id === productId);
          if (!prod) continue;

          const qty = adminPurchaseSelectedProducts[productId];
          const price = prod.precioDistribuidor || prod.precio || 0;
          const points = prod.puntos || 0;
          const totalPrice = price * qty;
          const totalPoints = points * qty;
          const shippingUnits = (prod.shippingUnits || 2) * qty;

          const orderObj = {
            productId: prod.id,
            productName: prod.nombre,
            productImage: prod.imagen || '',
            price: price,
            quantity: qty,
            totalPrice: totalPrice,
            points: points,
            totalPoints: totalPoints,
            shippingUnits: prod.shippingUnits || 2,
            totalShippingUnits: shippingUnits,
            shippingCost: 0, // No shipping cost for admin-created orders
            grandTotal: totalPrice,
            buyerUid: distributorId,
            buyerUsername: distributorUsername,
            buyerType: 'distribuidor',
            buyerInfo: {
              name: distData.nombre || distData.usuario || '',
              email: distData.email || '',
              phone: distData.celular || '',
              address: distData.direccion || 'Generado desde admin',
              city: distData.ciudad || ''
            },
            deliveryMethod: 'admin_generated',
            status: 'pending_delivery',
            createdAt: new Date().toISOString(),
            createdByAdmin: true,
            adminNotes: notes || null,
            adminCreatedBy: currentUser ? currentUser.uid : null,
            isInitial: false,
            fromCart: false
          };

          const orderRef = await addDoc(collection(db, "orders"), orderObj);
          orderIds.push(orderRef.id);
        }

        // Close modal
        closeAdminPurchaseModal();

        // Show success message
        alert(`‚úÖ Orden creada exitosamente!\n\nSe crearon ${orderIds.length} orden(es) en estado pendiente.\n\nLas √≥rdenes aparecer√°n en la pesta√±a "√ìrdenes Pendientes" para su confirmaci√≥n.`);

        // Refresh pending orders if on that tab
        if (document.getElementById('tab-pending')?.classList.contains('active')) {
          await loadPendingOrders();
        }

        // Refresh distributor details panel
        await showDistributorDetails(distributorId);

      } catch (err) {
        console.error('Error creating admin order:', err);
        alert('Error creando la orden: ' + err.message);
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = originalText;
      }
    });
    // ========================================
    // End Admin Purchase Modal
    // ========================================

    // Inventory management
    const inventoryModal = document.getElementById('inventoryModal');
    const addInventoryBtn = document.getElementById('addInventoryBtn');
    const inventoryModalCancel = document.getElementById('inventoryModalCancel');
    const addInventoryForm = document.getElementById('addInventoryForm');

    addInventoryBtn.addEventListener('click', async () => {
      // Populate product dropdown with active products from database
      const productSelect = document.getElementById('inventoryProductId');
      productSelect.innerHTML = '<option value="">Seleccionar producto...</option>';

      try {
        const productsSnap = await getDocs(collection(db, "productos"));
        const activeProducts = productsSnap.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(p => !p.hidden && !p.deleted); // Only show active products

        activeProducts.forEach(product => {
          const option = document.createElement('option');
          option.value = product.id;
          option.textContent = product.nombre;
          productSelect.appendChild(option);
        });
      } catch (err) {
        console.error('Error loading products for inventory:', err);
        alert('Error cargando productos: ' + err.message);
      }

      inventoryModal.style.display = 'flex';
    });

    inventoryModalCancel.addEventListener('click', () => {
      inventoryModal.style.display = 'none';
      addInventoryForm.reset();
    });

    inventoryModal.addEventListener('click', (e) => {
      if (e.target === inventoryModal) {
        inventoryModal.style.display = 'none';
        addInventoryForm.reset();
      }
    });

    addInventoryForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      const productId = document.getElementById('inventoryProductId').value;
      const units = parseInt(document.getElementById('inventoryUnits').value);
      const notes = document.getElementById('inventoryNotes').value.trim();

      try {
        const inventoryRef = doc(db, 'inventory', productId);
        const inventorySnap = await getDoc(inventoryRef);
        
        let currentStock = 0;
        if (inventorySnap.exists()) {
          currentStock = inventorySnap.data().stock || 0;
        }

        const newStock = currentStock + units;

        await setDoc(inventoryRef, {
          productId,
          stock: newStock,
          lastUpdated: new Date().toISOString(),
          updatedBy: currentUser.uid
        }, { merge: true });

        await addDoc(collection(db, 'inventoryHistory'), {
          productId,
          type: 'addition',
          units,
          stockBefore: currentStock,
          stockAfter: newStock,
          notes: notes || 'Adici√≥n manual de inventario',
          createdAt: new Date().toISOString(),
          createdBy: currentUser.uid
        });

        alert(`‚úÖ Se agregaron ${units} unidades al inventario`);
        inventoryModal.style.display = 'none';
        addInventoryForm.reset();
        await loadInventory();
      } catch (err) {
        console.error('Error adding inventory:', err);
        alert('Error agregando inventario: ' + err.message);
      }
    });

    async function loadInventory() {
      try {
        console.log("üì¶ Cargando inventario...");
        console.log("üîç Usuario autenticado:", currentUser?.uid);
        console.log("üîç Token de autenticaci√≥n presente:", !!currentUser);

        // Dynamically load product names from database
        const productNames = {};
        const productsSnap = await getDocs(collection(db, "productos"));
        productsSnap.docs.forEach(doc => {
          const data = doc.data();
          productNames[data.id] = data.nombre;
        });
        console.log("‚úÖ Productos cargados:", Object.keys(productNames).length);

        try {
          console.log("üì¶ Test 1: Intentando leer documento de usuario...");
          const testUserDoc = await getDoc(doc(db, 'usuarios', currentUser.uid));
          console.log("‚úÖ Test 1 exitoso - Usuario doc existe:", testUserDoc.exists());
          if (testUserDoc.exists()) {
            console.log("üìÑ Datos del usuario:", testUserDoc.data());
          }
        } catch (testErr) {
          console.error("‚ùå Test 1 fall√≥:", testErr.code, testErr.message);
        }

        console.log("üì¶ Test 2: Leyendo colecci√≥n 'inventory'...");
        const inventorySnap = await getDocs(collection(db, 'inventory'));
        console.log("‚úÖ Test 2 exitoso - Inventario le√≠do:", inventorySnap.docs.length, "productos");
        
        let totalStock = 0;
        inventorySnap.docs.forEach(doc => {
          totalStock += doc.data().stock || 0;
        });

        console.log("üì¶ Leyendo √≥rdenes confirmadas...");
        const ordersSnap = await getDocs(collection(db, 'orders'));
        const allOrders = ordersSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        // Filter only confirmed orders and exclude test users
        const confirmedOrders = allOrders.filter(order => order.status === 'confirmed');

        // Fetch buyer information to filter out test users
        const usersCache = new Map();
        const filteredOrders = [];

        for (const order of confirmedOrders) {
          if (order.buyerUid) {
            // Get user data from cache or fetch it
            if (!usersCache.has(order.buyerUid)) {
              try {
                const userDoc = await getDoc(doc(db, "usuarios", order.buyerUid));
                if (userDoc.exists()) {
                  const userData = userDoc.data();
                  usersCache.set(order.buyerUid, {
                    nombre: userData.nombre || '',
                    usuario: userData.usuario || ''
                  });
                }
              } catch (err) {
                console.warn('Error fetching user for order:', order.id, err);
              }
            }

            // Check if user is a test user (starts with "prueba")
            const userData = usersCache.get(order.buyerUid);
            if (userData) {
              const isTestUser = userData.nombre.toLowerCase().startsWith('prueba') ||
                                userData.usuario.toLowerCase().startsWith('prueba');

              if (!isTestUser) {
                filteredOrders.push(order);
              } else {
                console.log(`üß™ Orden excluida de usuario de prueba: ${userData.usuario || userData.nombre}`);
              }
            } else {
              // If we couldn't fetch user data, include the order to avoid data loss
              filteredOrders.push(order);
            }
          } else {
            // If no buyerUid, include the order
            filteredOrders.push(order);
          }
        }

        // Calculate total units sold and units sold per product
        let totalSoldUnits = 0;
        const unitsSoldByProduct = {};

        filteredOrders.forEach(order => {
          const quantity = Number(order.quantity) || 1;
          const productId = order.productId || '';

          // Initialize product counter if needed
          if (!unitsSoldByProduct[productId]) {
            unitsSoldByProduct[productId] = 0;
          }

          // Add quantity to product counter
          unitsSoldByProduct[productId] += quantity;

          // Calculate units based on product for total
          if (productId === 'paquete-inicio') {
            // Paquete de 300,000 = 10 unidades
            totalSoldUnits += quantity * 10;
          } else if (['chuletas-3kg', 'costillas-3kg', 'paticas-3kg', 'panceta-3kg', 'pulpa-3kg', 'goulast-3kg'].includes(productId)) {
            // Paquetes de 60,000 = 2 unidades
            totalSoldUnits += quantity * 2;
          } else {
            // Default: count as sold quantity
            totalSoldUnits += quantity;
          }
        });

        console.log("‚úÖ √ìrdenes le√≠das:", ordersSnap.docs.length, "| √ìrdenes confirmadas (sin prueba):", filteredOrders.length, "| Unidades vendidas:", totalSoldUnits);

        console.log("üì¶ Leyendo historial de inventario...");
        const historySnap = await getDocs(query(
          collection(db, 'inventoryHistory'),
          orderBy('createdAt', 'desc'),
          limit(50)
        ));
        console.log("‚úÖ Historial le√≠do:", historySnap.docs.length, "registros");

        let lastUpdate = 'N/A';
        if (!historySnap.empty) {
          const lastDoc = historySnap.docs[0].data();
          const date = new Date(lastDoc.createdAt);
          lastUpdate = date.toLocaleDateString('es-CO', { day: '2-digit', month: 'short' });
        }

        document.getElementById('inventoryCount').textContent = totalStock;
        document.getElementById('totalStockUnits').textContent = totalStock;
        document.getElementById('totalSoldUnits').textContent = totalSoldUnits;
        document.getElementById('lastInventoryUpdate').textContent = lastUpdate;

        // Populate product inventory table
        const productInventoryTable = document.getElementById('productInventoryTable');
        productInventoryTable.innerHTML = '';

        // Create a map of inventory by product ID
        const inventoryByProduct = {};
        inventorySnap.docs.forEach(doc => {
          const data = doc.data();
          inventoryByProduct[data.productId] = data.stock || 0;
        });

        // Get all unique product IDs from both inventory and orders
        const allProductIds = new Set([
          ...Object.keys(inventoryByProduct),
          ...Object.keys(unitsSoldByProduct)
        ]);

        if (allProductIds.size === 0) {
          productInventoryTable.innerHTML = '<tr><td colspan="5" class="empty-state">No hay productos en el inventario</td></tr>';
        } else {
          // Create rows for each product
          const productRows = [];
          allProductIds.forEach(productId => {
            const totalUnits = inventoryByProduct[productId] || 0;
            const soldUnits = unitsSoldByProduct[productId] || 0;
            const remainingUnits = totalUnits - soldUnits;
            const productName = productNames[productId] || productId;

            // Determine status
            let statusHtml = '';
            if (remainingUnits <= 0) {
              statusHtml = '<span style="background:#dc3545;color:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600;">AGOTADO</span>';
            } else if (remainingUnits < 10) {
              statusHtml = '<span style="background:#fd7e14;color:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600;">STOCK BAJO</span>';
            } else {
              statusHtml = '<span style="background:#28a745;color:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600;">DISPONIBLE</span>';
            }

            productRows.push({
              productId,
              productName,
              totalUnits,
              soldUnits,
              remainingUnits,
              statusHtml
            });
          });

          // Sort by product name
          productRows.sort((a, b) => a.productName.localeCompare(b.productName));

          // Render rows
          productRows.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><strong>${row.productName}</strong><br><small style="color:#999;">${row.productId}</small></td>
              <td style="text-align:center;"><strong style="color:#007bff;font-size:16px;">${row.totalUnits}</strong></td>
              <td style="text-align:center;"><strong style="color:#28a745;font-size:16px;">${row.soldUnits}</strong></td>
              <td style="text-align:center;"><strong style="color:${row.remainingUnits < 0 ? '#dc3545' : '#6f42c1'};font-size:16px;">${row.remainingUnits}</strong></td>
              <td style="text-align:center;">${row.statusHtml}</td>
            `;
            productInventoryTable.appendChild(tr);
          });
        }

        const historyTable = document.getElementById('inventoryHistoryTable');
        historyTable.innerHTML = '';

        if (historySnap.empty) {
          historyTable.innerHTML = '<tr><td colspan="6" class="empty-state">No hay movimientos de inventario registrados</td></tr>';
          return;
        }

        historySnap.docs.forEach(doc => {
          const data = doc.data();
          const row = document.createElement('tr');
          const date = new Date(data.createdAt).toLocaleDateString('es-CO');
          const typeText = data.type === 'addition' ? 'Entrada' : 'Venta';
          const typeColor = data.type === 'addition' ? '#28a745' : '#dc3545';
          
          row.innerHTML = `
            <td>${date}</td>
            <td><span style="color:${typeColor};font-weight:600">${typeText}</span></td>
            <td>${productNames[data.productId] || data.productId}</td>
            <td>${data.units > 0 ? '+' : ''}${data.units}</td>
            <td>${data.stockAfter || 0}</td>
            <td>${data.notes || 'N/A'}</td>
          `;
          historyTable.appendChild(row);
        });
        
        console.log("‚úÖ Inventario cargado exitosamente");
      } catch (err) {
        console.error('‚ùå Error loading inventory:', err);
        console.error('Error code:', err.code);
        console.error('Error message:', err.message);
        
        if (err.code === 'permission-denied') {
          console.error("‚ö†Ô∏è PROBLEMA DE PERMISOS DETECTADO:");
          console.error("Usuario actual UID:", currentUser?.uid);
          console.error("Email:", currentUser?.email);
          
          console.error("\nüîß SOLUCI√ìN:");
          console.error("Las reglas de Firestore NO est√°n desplegadas o son diferentes de las locales.");
          console.error("Ejecuta: firebase deploy --only firestore:rules");
          console.error("\nSi el problema persiste, verifica en Firebase Console:");
          console.error("1. Ve a Firestore Database > Rules");
          console.error("2. Verifica que la regla para 'inventory' sea: allow read: if isAuthenticated();");
          console.error("3. Verifica que isAdmin() incluya exists() check y get() del documento usuarios");
          
          alert("‚ùå ERROR DE PERMISOS\n\n" +
                "El usuario tiene rol 'admin' localmente pero Firestore rechaza el acceso.\n\n" +
                "CAUSA M√ÅS PROBABLE:\n" +
                "Las reglas de Firestore NO est√°n desplegadas en Firebase.\n\n" +
                "SOLUCI√ìN:\n" +
                "1. Abre una terminal en la ra√≠z del proyecto\n" +
                "2. Ejecuta: firebase deploy --only firestore:rules\n" +
                "3. Espera confirmaci√≥n de despliegue\n" +
                "4. Recarga esta p√°gina\n\n" +
                "Si ya desplegaste las reglas y el error persiste:\n" +
                "- Verifica en Firebase Console > Firestore > Rules\n" +
                "- Confirma que las reglas publicadas coincidan con firestore.rules\n\n" +
                "Usuario UID: " + currentUser?.uid);
        } else {
          alert('Error cargando inventario: ' + err.message);
        }
      }
    }

    async function loadProducts() {
      try {
        const productsSnap = await getDocs(collection(db, "productos"));
        allProducts = productsSnap.docs.map(d => ({ docId: d.id, ...d.data() }));

        // Calculate units sold for each product
        await calculateUnitsSold();

        renderProductsPreview();
        renderProductsManagementTable();
      } catch (err) {
        console.error('Error loading products:', err);
        allProducts = [];
      }
    }

    async function calculateUnitsSold() {
      try {
        // Get all confirmed orders
        const ordersSnap = await getDocs(collection(db, "orders"));
        const allOrders = ordersSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        console.log(`üìä Total de √≥rdenes en la base de datos: ${allOrders.length}`);

        // Filter only confirmed orders
        const confirmedOrders = allOrders.filter(order => order.status === 'confirmed');

        console.log(`‚úÖ √ìrdenes confirmadas: ${confirmedOrders.length}`);

        // Fetch buyer information to filter out test users
        const usersCache = new Map();
        const filteredOrders = [];

        for (const order of confirmedOrders) {
          if (order.buyerUid) {
            // Get user data from cache or fetch it
            if (!usersCache.has(order.buyerUid)) {
              try {
                const userDoc = await getDoc(doc(db, "usuarios", order.buyerUid));
                if (userDoc.exists()) {
                  const userData = userDoc.data();
                  usersCache.set(order.buyerUid, {
                    nombre: userData.nombre || '',
                    usuario: userData.usuario || ''
                  });
                }
              } catch (err) {
                console.warn('Error fetching user for order:', order.id, err);
              }
            }

            // Check if user is a test user (starts with "prueba")
            const userData = usersCache.get(order.buyerUid);
            if (userData) {
              const isTestUser = userData.nombre.toLowerCase().startsWith('prueba') ||
                                userData.usuario.toLowerCase().startsWith('prueba');

              if (!isTestUser) {
                filteredOrders.push(order);
              } else {
                console.log(`üß™ Orden excluida de usuario de prueba: ${userData.usuario || userData.nombre}`);
              }
            } else {
              // If we couldn't fetch user data, include the order to avoid data loss
              filteredOrders.push(order);
            }
          } else {
            // If no buyerUid, include the order
            filteredOrders.push(order);
          }
        }

        console.log(`‚úÖ √ìrdenes confirmadas (sin usuarios de prueba): ${filteredOrders.length}`);

        // Calculate total units sold per product using intelligent matching
        const unitsSoldMap = {};

        // Helper function to find matching product by ID or name (same logic as findProductMatch)
        const findProductByIdOrName = (productId, productName) => {
          // Try by productId first
          if (productId) {
            let match = allProducts.find(p => p.id === productId);
            if (match) return match.id;

            match = allProducts.find(p => p.docId === productId);
            if (match) return match.id;
          }

          // Try by product name
          if (productName) {
            const lowerName = productName.toLowerCase().trim();

            // Exact match
            let match = allProducts.find(p => p.nombre && p.nombre.toLowerCase().trim() === lowerName);
            if (match) return match.id;

            // Contains match
            match = allProducts.find(p => {
              if (!p.nombre) return false;
              const pName = p.nombre.toLowerCase().trim();
              return pName.includes(lowerName) || lowerName.includes(pName);
            });
            if (match) return match.id;

            // First significant characters match (for partial names)
            if (lowerName.length >= 4) {
              const prefix = lowerName.substring(0, Math.min(6, lowerName.length));
              match = allProducts.find(p => {
                if (!p.nombre) return false;
                const pName = p.nombre.toLowerCase().trim();
                return pName.startsWith(prefix) || prefix.startsWith(pName.substring(0, prefix.length));
              });
              if (match) return match.id;
            }
          }

          return productId || null; // Return original ID if no match found
        };

        filteredOrders.forEach(order => {
          const productId = order.productId;
          const productName = order.productName || order.product || '';
          const quantity = order.quantity || 1;

          // Use intelligent matching to find the product ID
          const matchedProductId = findProductByIdOrName(productId, productName);

          if (matchedProductId) {
            if (!unitsSoldMap[matchedProductId]) {
              unitsSoldMap[matchedProductId] = 0;
            }
            unitsSoldMap[matchedProductId] += quantity;
          }
        });

        // Log units sold per product for debugging
        console.log('üì¶ Unidades vendidas por producto (con vinculaci√≥n inteligente):');
        Object.entries(unitsSoldMap).forEach(([id, qty]) => {
          const prod = allProducts.find(p => p.id === id);
          console.log(`   - ${prod?.nombre || id}: ${qty} unidades`);
        });

        // Update allProducts with unitsSold
        allProducts.forEach(product => {
          product.unitsSold = unitsSoldMap[product.id] || unitsSoldMap[product.docId] || 0;
        });
      } catch (err) {
        console.error('Error calculating units sold:', err);
      }
    }

    function formatCOP(num) {
      return new Intl.NumberFormat("es-CO", {
        style: "currency",
        currency: "COP",
        minimumFractionDigits: 0
      }).format(num);
    }

    function renderProductsPreview() {
      const previewGrid = document.getElementById('productsPreviewGrid');
      const previewType = document.getElementById('previewTypeSelector').value;

      const filteredProducts = allProducts.filter(prod => {
        if (prod.hidden) return false;
        if (!prod.availableFor || prod.availableFor.length === 0) return true;
        return prod.availableFor.includes(previewType);
      });

      if (filteredProducts.length === 0) {
        previewGrid.innerHTML = '<div class="empty-state">No hay productos disponibles para este tipo de usuario</div>';
        return;
      }

      previewGrid.innerHTML = filteredProducts.map(prod => {
        let price = prod.precio || 0;
        let points = 0;
        let unitLabel = prod.unit || 'paquete';

        if (previewType === 'distribuidor') {
          price = prod.precioDistribuidor || prod.precio || 0;
          points = prod.puntosDistribuidor || prod.puntos || 0;
          unitLabel = prod.unit || 'paquete';
        } else if (previewType === 'cliente') {
          price = prod.precioCliente || prod.precio || 0;
          points = prod.puntosDistribuidor || prod.puntos || 0; // Reference points
          unitLabel = prod.unit || 'paquete';
        } else if (previewType === 'restaurante') {
          price = prod.precioRestaurante || prod.precio || 0;
          points = prod.puntosRestaurante || prod.puntos || 0;
          unitLabel = prod.unitRestaurant || prod.unit || 'kilo';
        }

        const badge = prod.outOfStock ? '<span class="product-badge outofstock">Agotado</span>' : '';

        // Format points with appropriate decimals
        const formattedPoints = previewType === 'restaurante'
          ? points.toFixed(3).replace(/\.?0+$/, '')
          : points.toFixed(2).replace(/\.?0+$/, '');

        // Points display based on user type
        let pointsDisplay = '';
        if (points > 0) {
          if (previewType === 'distribuidor') {
            pointsDisplay = `<p style="font-size:11px;color:#007bff;margin:4px 0 0 0;"><span style="background:#e7f5ff;padding:2px 6px;border-radius:4px;">${formattedPoints} pts/${unitLabel}</span></p>`;
          } else if (previewType === 'restaurante') {
            pointsDisplay = `<p style="font-size:11px;color:#fd7e14;margin:4px 0 0 0;"><span style="background:#fff8e6;padding:2px 6px;border-radius:4px;">${formattedPoints} pts/${unitLabel}</span></p>`;
          } else {
            pointsDisplay = `<p style="font-size:10px;color:#999;margin:4px 0 0 0;">Genera ${formattedPoints} pts</p>`;
          }
        }

        return `
          <div class="product-card-preview">
            ${badge}
            <img src="${prod.imagen || '/images/productos/inicio.jpg'}" alt="${prod.nombre}">
            <h4>${prod.nombre}</h4>
            <p>${prod.descripcion || ''}</p>
            <div class="price">${formatCOP(price)}</div>
            <p style="font-size:12px;color:#999;margin:2px 0;">por ${unitLabel}</p>
            ${pointsDisplay}
          </div>
        `;
      }).join('');
    }

    function renderProductsManagementTable() {
      const table = document.getElementById('productsManagementTable');

      if (allProducts.length === 0) {
        table.innerHTML = '<tr><td colspan="13" class="empty-state">No hay productos registrados</td></tr>';
        return;
      }

      const categoryNames = {
        'carnes': 'Carnes',
        'bebidas': 'Bebidas',
        'alimentos': 'Alimentos',
        'aseo': 'Aseo',
        'higiene-personal': 'Higiene Personal',
        'abarrotes': 'Abarrotes'
      };

      table.innerHTML = allProducts.map(prod => {
        const statusBadges = [];
        if (prod.hidden) statusBadges.push('<span style="background:#6c757d;color:white;padding:2px 6px;border-radius:3px;font-size:11px;margin-right:4px;">OCULTO</span>');
        if (prod.outOfStock) statusBadges.push('<span style="background:#fd7e14;color:white;padding:2px 6px;border-radius:3px;font-size:11px;margin-right:4px;">AGOTADO</span>');

        // Launch product status
        if (prod.isLaunchProduct && prod.launchDate) {
          const launchTime = new Date(prod.launchDate).getTime();
          const now = Date.now();
          if (now < launchTime) {
            const launchDateFormatted = new Date(prod.launchDate).toLocaleString('es-CO', {
              day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'
            });
            statusBadges.push(`<span style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:2px 6px;border-radius:3px;font-size:11px;margin-right:4px;" title="Lanza: ${launchDateFormatted}">üöÄ LANZAMIENTO</span>`);
          }
        }

        const statusHtml = statusBadges.length > 0 ? statusBadges.join('') : '<span style="color:#28a745;">‚úì Activo</span>';

        const featuredHtml = prod.featured ? '<span style="font-size:20px;" title="Producto destacado">‚≠ê</span>' : '<span style="color:#ccc;">‚Äî</span>';

        // Calculate units sold
        const unitsSold = prod.unitsSold || 0;
        const unitsSoldHtml = unitsSold > 0
          ? `<button onclick="showProductOrders('${prod.id}', '${prod.nombre.replace(/'/g, "\\'")}', ${unitsSold})" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"><strong>${unitsSold}</strong> ${prod.unit || 'unidades'} üìã</button>`
          : `<span style="color:#999;">${unitsSold} ${prod.unit || 'unidades'}</span>`;

        // Units display with quantity
        const unitDistClient = prod.unit || 'paquete';
        const unitRestaurant = prod.unitRestaurant || 'kilo';
        const qtyDist = prod.quantityDistributor ? `${prod.quantityDistributor} ` : '';
        const qtyRest = prod.quantityRestaurant ? `${prod.quantityRestaurant} ` : '';
        const unitsHtml = `<span style="font-size:11px;"><span style="background:#e7f5ff;padding:2px 4px;border-radius:3px;color:#007bff;">D/C: ${qtyDist}${unitDistClient}${prod.quantityDistributor && prod.quantityDistributor !== 1 ? 's' : ''}</span><br><span style="background:#fff8e6;padding:2px 4px;border-radius:3px;color:#fd7e14;margin-top:2px;display:inline-block;">R: ${qtyRest}${unitRestaurant}${prod.quantityRestaurant && prod.quantityRestaurant !== 1 ? 's' : ''}</span></span>`;

        // Points display
        const ptsDistribuidor = (prod.puntosDistribuidor || prod.puntos || 0).toFixed(2).replace(/\.?0+$/, '');
        const ptsRestaurante = (prod.puntosRestaurante || 0).toFixed(3).replace(/\.?0+$/, '');
        const pointsHtml = `<span style="font-size:11px;"><span style="background:#e7f5ff;padding:2px 4px;border-radius:3px;color:#007bff;">D: ${ptsDistribuidor}</span><br><span style="background:#fff8e6;padding:2px 4px;border-radius:3px;color:#fd7e14;margin-top:2px;display:inline-block;">R: ${ptsRestaurante}</span></span>`;

        // Variants display
        const variants = prod.variants || [];
        const variantsHtml = variants.length > 0
          ? `<span style="font-size:11px;">${variants.map(v => `<span style="background:#e6f9f0;padding:2px 6px;border-radius:3px;color:#0d6d45;margin-right:2px;display:inline-block;margin-bottom:2px;">${v.name}${v.priceDiff ? ` (${v.priceDiff > 0 ? '+' : ''}$${v.priceDiff})` : ''}</span>`).join('')}</span>`
          : '<span style="color:#ccc;">‚Äî</span>';

        return `
          <tr>
            <td><img src="${prod.imagen || '/images/productos/inicio.jpg'}" style="width:60px;height:60px;object-fit:cover;border-radius:4px;"></td>
            <td><strong>${prod.nombre}</strong><br><small style="color:#666;">${prod.id}</small></td>
            <td style="max-width:200px;"><small>${prod.descripcion || 'N/A'}</small></td>
            <td><span style="background:#e9ecef;padding:4px 8px;border-radius:4px;font-size:12px;">${categoryNames[prod.categoria] || prod.categoria || 'N/A'}</span></td>
            <td>${unitsHtml}</td>
            <td>${prod.precioDistribuidor ? formatCOP(prod.precioDistribuidor) : 'N/A'}</td>
            <td>${prod.precioCliente ? formatCOP(prod.precioCliente) : 'N/A'}</td>
            <td>${prod.precioRestaurante ? formatCOP(prod.precioRestaurante) : 'N/A'}</td>
            <td>${pointsHtml}</td>
            <td>${variantsHtml}</td>
            <td style="text-align:center;">${unitsSoldHtml}</td>
            <td style="text-align:center;">${featuredHtml}</td>
            <td>${statusHtml}</td>
            <td>
              <button class="btn-primary" onclick="editProduct('${prod.docId}')">Editar</button>
              <button class="btn-danger" onclick="deleteProduct('${prod.docId}', '${prod.nombre}')">Eliminar</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    document.getElementById('previewTypeSelector').addEventListener('change', renderProductsPreview);

    // Toggle launch product config fields visibility
    document.getElementById('productIsLaunch').addEventListener('change', function() {
      document.getElementById('launchConfigFields').style.display = this.checked ? 'block' : 'none';
      if (!this.checked) {
        document.getElementById('productLaunchDate').value = '';
      }
    });

    // ==========================================
    // PRODUCT COST BENEFIT PREVIEW
    // ==========================================
    function updateProductBenefitPreview() {
      const precioDistribuidor = parseFloat(document.getElementById('productPriceDistributor').value) || 0;
      const costo = parseFloat(document.getElementById('productCosto').value) || 0;
      const beneficio = precioDistribuidor - costo;
      const previewDiv = document.getElementById('productBenefitPreview');

      if (costo > 0 && precioDistribuidor > 0) {
        const color = beneficio >= 0 ? '#28a745' : '#dc3545';
        previewDiv.style.color = color;
        previewDiv.textContent = '$' + beneficio.toLocaleString();
      } else {
        previewDiv.style.color = '#666';
        previewDiv.textContent = '$0';
      }
    }

    // Event listeners for updating benefit preview in product modal
    document.getElementById('productPriceDistributor')?.addEventListener('input', updateProductBenefitPreview);
    document.getElementById('productCosto')?.addEventListener('input', updateProductBenefitPreview);

    // ==========================================
    // PRODUCT VARIANTS MANAGEMENT
    // ==========================================

    let productVariants = []; // Store current product variants

    function renderVariantsContainer() {
      const container = document.getElementById('variantsContainer');
      const noVariantsMsg = document.getElementById('noVariantsMessage');

      if (productVariants.length === 0) {
        container.innerHTML = '';
        noVariantsMsg.style.display = 'block';
        return;
      }

      noVariantsMsg.style.display = 'none';
      container.innerHTML = productVariants.map((variant, index) => `
        <div class="variant-item" data-index="${index}" style="display:flex;align-items:center;gap:10px;padding:10px;background:white;border:1px solid #ddd;border-radius:6px;margin-bottom:8px;">
          <div style="flex:1;">
            <input type="text" class="variant-name" value="${variant.name || ''}" placeholder="Nombre de la variante (ej: Seco)"
              style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px;box-sizing:border-box;">
          </div>
          <div style="width:100px;">
            <input type="number" class="variant-price-diff" value="${variant.priceDiff || 0}" placeholder="Diferencia $"
              style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px;box-sizing:border-box;" title="Diferencia de precio (+/- del precio base)">
          </div>
          <div style="width:80px;">
            <input type="number" class="variant-stock" value="${variant.stock !== undefined ? variant.stock : ''}" placeholder="Stock" min="0"
              style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px;box-sizing:border-box;" title="Stock disponible (vac√≠o = ilimitado)">
          </div>
          <label style="display:flex;align-items:center;gap:4px;font-size:12px;white-space:nowrap;">
            <input type="checkbox" class="variant-default" ${variant.isDefault ? 'checked' : ''}>
            Por defecto
          </label>
          <button type="button" class="btn-danger remove-variant-btn" data-index="${index}" style="padding:6px 10px;font-size:12px;">‚úï</button>
        </div>
      `).join('');

      // Add event listeners to variant inputs
      container.querySelectorAll('.variant-name').forEach((input, idx) => {
        input.addEventListener('input', (e) => {
          productVariants[idx].name = e.target.value;
        });
      });
      container.querySelectorAll('.variant-price-diff').forEach((input, idx) => {
        input.addEventListener('input', (e) => {
          productVariants[idx].priceDiff = parseFloat(e.target.value) || 0;
        });
      });
      container.querySelectorAll('.variant-stock').forEach((input, idx) => {
        input.addEventListener('input', (e) => {
          const val = e.target.value.trim();
          productVariants[idx].stock = val === '' ? null : parseInt(val);
        });
      });
      container.querySelectorAll('.variant-default').forEach((checkbox, idx) => {
        checkbox.addEventListener('change', (e) => {
          // Only one can be default
          if (e.target.checked) {
            productVariants.forEach((v, i) => v.isDefault = (i === idx));
          } else {
            productVariants[idx].isDefault = false;
          }
          renderVariantsContainer();
        });
      });
      container.querySelectorAll('.remove-variant-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const idx = parseInt(e.target.dataset.index);
          productVariants.splice(idx, 1);
          renderVariantsContainer();
        });
      });
    }

    // Add variant button
    document.getElementById('addVariantBtn').addEventListener('click', () => {
      productVariants.push({
        name: '',
        priceDiff: 0,
        stock: null,
        isDefault: productVariants.length === 0 // First variant is default
      });
      renderVariantsContainer();
    });

    // Get variants data for saving
    function getVariantsData() {
      // Filter out empty variants
      return productVariants.filter(v => v.name && v.name.trim() !== '').map(v => ({
        name: v.name.trim(),
        priceDiff: v.priceDiff || 0,
        stock: v.stock,
        isDefault: v.isDefault || false
      }));
    }

    // Reset variants when opening modal
    function resetVariants() {
      productVariants = [];
      renderVariantsContainer();
    }

    // Load variants from product data
    function loadVariants(variants) {
      productVariants = Array.isArray(variants) ? [...variants] : [];
      renderVariantsContainer();
    }

    document.getElementById('addProductBtn').addEventListener('click', () => {
      document.getElementById('productModalTitle').textContent = 'Crear Producto';
      document.getElementById('productForm').reset();
      document.getElementById('productEditId').value = '';
      // Reset launch product fields
      document.getElementById('launchConfigFields').style.display = 'none';
      document.getElementById('productLaunchDate').value = '';
      // Reset product variants
      resetVariants();
      document.getElementById('productModal').style.display = 'flex';
    });

    document.getElementById('productModalCancel').addEventListener('click', () => {
      document.getElementById('productModal').style.display = 'none';
    });

    document.getElementById('productForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const editId = document.getElementById('productEditId').value;
      const productData = {
        id: document.getElementById('productId').value.trim(),
        nombre: document.getElementById('productName').value.trim(),
        descripcion: document.getElementById('productDescription').value.trim(),
        imagen: document.getElementById('productImage').value.trim(),
        precioDistribuidor: parseFloat(document.getElementById('productPriceDistributor').value) || 0,
        precioCliente: parseFloat(document.getElementById('productPriceClient').value) || 0,
        precioRestaurante: parseFloat(document.getElementById('productPriceRestaurant').value) || 0,
        precio: parseFloat(document.getElementById('productPriceDistributor').value) || 0,
        // Cost and profit margin fields for earnings reports
        costo: parseFloat(document.getElementById('productCosto').value) || 0,
        platformPercent: parseInt(document.getElementById('productPlatformPercent').value) || 50,
        puntosDistribuidor: parseFloat(document.getElementById('productPointsDistributor').value) || 0,
        puntosRestaurante: parseFloat(document.getElementById('productPointsRestaurant').value) || 0,
        puntos: parseFloat(document.getElementById('productPointsDistributor').value) || 0, // backward compatibility
        shippingUnits: parseInt(document.getElementById('productShippingUnits').value) || 2, // UE: Unidades de Env√≠o
        unit: document.getElementById('productUnit').value,
        unitRestaurant: document.getElementById('productUnitRestaurant').value,
        quantityDistributor: parseFloat(document.getElementById('productQuantityDistributor').value) || null,
        quantityRestaurant: parseFloat(document.getElementById('productQuantityRestaurant').value) || null,
        categoria: document.getElementById('productCategory').value,
        availableFor: [],
        hidden: document.getElementById('productHidden').checked,
        outOfStock: document.getElementById('productOutOfStock').checked,
        featured: document.getElementById('productFeatured').checked || false,
        // Product variants
        variants: getVariantsData(),
        // Launch Product fields
        isLaunchProduct: document.getElementById('productIsLaunch').checked || false,
        launchDate: document.getElementById('productIsLaunch').checked && document.getElementById('productLaunchDate').value
          ? new Date(document.getElementById('productLaunchDate').value).toISOString()
          : null
      };

      // Validation: if launch product is checked, launch date is required
      if (productData.isLaunchProduct && !productData.launchDate) {
        alert('Por favor ingrese la fecha y hora de lanzamiento');
        return;
      }

      if (document.getElementById('productAvailDistributor').checked) {
        productData.availableFor.push('distribuidor');
      }
      if (document.getElementById('productAvailClient').checked) {
        productData.availableFor.push('cliente');
      }
      if (document.getElementById('productAvailRestaurant').checked) {
        productData.availableFor.push('restaurante');
      }

      try {
        if (editId) {
          await updateDoc(doc(db, "productos", editId), productData);
          alert('Producto actualizado correctamente');
        } else {
          await addDoc(collection(db, "productos"), productData);
          alert('Producto creado correctamente');
        }
        
        document.getElementById('productModal').style.display = 'none';
        await loadProducts();
      } catch (err) {
        console.error('Error saving product:', err);
        alert('Error al guardar el producto: ' + err.message);
      }
    });

    window.editProduct = async function(docId) {
      const product = allProducts.find(p => p.docId === docId);
      if (!product) return;

      document.getElementById('productModalTitle').textContent = 'Editar Producto';
      document.getElementById('productEditId').value = docId;
      document.getElementById('productId').value = product.id || '';
      document.getElementById('productName').value = product.nombre || '';
      document.getElementById('productDescription').value = product.descripcion || '';
      document.getElementById('productImage').value = product.imagen || '';
      document.getElementById('productPriceDistributor').value = product.precioDistribuidor || '';
      document.getElementById('productPriceClient').value = product.precioCliente || '';
      document.getElementById('productPriceRestaurant').value = product.precioRestaurante || '';
      // Cost and profit margin fields
      document.getElementById('productCosto').value = product.costo || '';
      document.getElementById('productPlatformPercent').value = product.platformPercent || 50;
      updateProductBenefitPreview();
      document.getElementById('productPointsDistributor').value = product.puntosDistribuidor || product.puntos || '';
      document.getElementById('productPointsRestaurant').value = product.puntosRestaurante || product.puntos || '';
      document.getElementById('productUnit').value = product.unit || 'paquete';
      document.getElementById('productUnitRestaurant').value = product.unitRestaurant || 'kilo';
      document.getElementById('productQuantityDistributor').value = product.quantityDistributor || '';
      document.getElementById('productQuantityRestaurant').value = product.quantityRestaurant || '';
      document.getElementById('productShippingUnits').value = product.shippingUnits || 2; // UE: Unidades de Env√≠o
      document.getElementById('productCategory').value = product.categoria || 'carnes';

      document.getElementById('productAvailDistributor').checked = (product.availableFor || []).includes('distribuidor');
      document.getElementById('productAvailClient').checked = (product.availableFor || []).includes('cliente');
      document.getElementById('productAvailRestaurant').checked = (product.availableFor || []).includes('restaurante');

      document.getElementById('productHidden').checked = product.hidden || false;
      document.getElementById('productOutOfStock').checked = product.outOfStock || false;
      document.getElementById('productFeatured').checked = product.featured || false;

      // Launch product fields
      document.getElementById('productIsLaunch').checked = product.isLaunchProduct || false;
      if (product.launchDate) {
        // Convert ISO date to datetime-local format
        const launchDate = new Date(product.launchDate);
        const localDateStr = launchDate.toISOString().slice(0, 16);
        document.getElementById('productLaunchDate').value = localDateStr;
      } else {
        document.getElementById('productLaunchDate').value = '';
      }
      // Toggle launch config visibility
      document.getElementById('launchConfigFields').style.display = product.isLaunchProduct ? 'block' : 'none';

      // Load product variants
      loadVariants(product.variants || []);

      document.getElementById('productModal').style.display = 'flex';
    };

    window.deleteProduct = async function(docId, productName) {
      if (!confirm(`¬øEst√°s seguro de eliminar el producto "${productName}"?`)) return;

      try {
        await updateDoc(doc(db, "productos", docId), { deleted: true });
        alert('Producto eliminado correctamente');
        await loadProducts();
      } catch (err) {
        console.error('Error deleting product:', err);
        alert('Error al eliminar el producto: ' + err.message);
      }
    };

    // Categories Management
    let allCategories = [];
    
    async function loadCategories() {
      try {
        const categoriesSnap = await getDocs(collection(db, "categorias"));
        if (categoriesSnap.empty) {
          allCategories = [
            { id: 'carnes', nombre: 'Carnes', slug: 'carnes' },
            { id: 'bebidas', nombre: 'Bebidas', slug: 'bebidas' },
            { id: 'alimentos', nombre: 'Alimentos', slug: 'alimentos' },
            { id: 'aseo', nombre: 'Aseo', slug: 'aseo' },
            { id: 'higiene-personal', nombre: 'Higiene Personal', slug: 'higiene-personal' },
            { id: 'abarrotes', nombre: 'Abarrotes', slug: 'abarrotes' }
          ];
          for (const cat of allCategories) {
            await addDoc(collection(db, "categorias"), cat);
          }
        } else {
          allCategories = categoriesSnap.docs.map(d => ({ docId: d.id, ...d.data() }));
        }
        renderCategoriesTable();
        updateProductCategoryOptions();
      } catch (err) {
        console.error('Error loading categories:', err);
        allCategories = [
          { id: 'carnes', nombre: 'Carnes', slug: 'carnes' },
          { id: 'bebidas', nombre: 'Bebidas', slug: 'bebidas' },
          { id: 'alimentos', nombre: 'Alimentos', slug: 'alimentos' },
          { id: 'aseo', nombre: 'Aseo', slug: 'aseo' },
          { id: 'higiene-personal', nombre: 'Higiene Personal', slug: 'higiene-personal' },
          { id: 'abarrotes', nombre: 'Abarrotes', slug: 'abarrotes' }
        ];
      }
    }

    function renderCategoriesTable() {
      const tbody = document.getElementById('categoriesTable');
      if (!tbody) return;

      tbody.innerHTML = allCategories.map(cat => {
        const productCount = allProducts.filter(p => p.categoria === cat.slug).length;
        return `
          <tr>
            <td>${cat.id}</td>
            <td><strong>${cat.nombre}</strong></td>
            <td><span style="font-family:monospace;font-size:12px;color:#666;">${cat.slug}</span></td>
            <td>${productCount} producto${productCount !== 1 ? 's' : ''}</td>
            <td>
              <button class="btn-primary" onclick="editCategory('${cat.docId || cat.id}')">Editar</button>
              <button class="btn-danger" onclick="deleteCategory('${cat.docId || cat.id}', '${cat.nombre}')">Eliminar</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    document.getElementById('addCategoryBtn')?.addEventListener('click', () => {
      document.getElementById('categoryModalTitle').textContent = 'Crear Categor√≠a';
      document.getElementById('categoryEditId').value = '';
      document.getElementById('categoryName').value = '';
      document.getElementById('categorySlug').value = '';
      document.getElementById('categoryModal').style.display = 'flex';
    });

    document.getElementById('categoryModalCancel')?.addEventListener('click', () => {
      document.getElementById('categoryModal').style.display = 'none';
    });

    document.getElementById('categoryForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const editDocId = document.getElementById('categoryEditId').value;
      const nombre = document.getElementById('categoryName').value.trim();
      const slug = document.getElementById('categorySlug').value.trim().toLowerCase();

      if (!nombre || !slug) {
        alert('Todos los campos son obligatorios');
        return;
      }

      if (!/^[a-z0-9-]+$/.test(slug)) {
        alert('El slug solo puede contener letras min√∫sculas, n√∫meros y guiones');
        return;
      }

      const existingCategory = allCategories.find(c => c.slug === slug && c.docId !== editDocId);
      if (existingCategory) {
        alert('Ya existe una categor√≠a con ese slug');
        return;
      }

      try {
        const categoryData = { id: slug, nombre, slug };

        if (editDocId) {
          await updateDoc(doc(db, "categorias", editDocId), categoryData);
          alert('Categor√≠a actualizada correctamente');
        } else {
          await addDoc(collection(db, "categorias"), categoryData);
          alert('Categor√≠a creada correctamente');
        }

        await loadCategories();
        document.getElementById('categoryModal').style.display = 'none';
      } catch (err) {
        console.error('Error saving category:', err);
        alert('Error al guardar la categor√≠a: ' + err.message);
      }
    });

    window.editCategory = function(docId) {
      const category = allCategories.find(c => c.docId === docId || c.id === docId);
      if (!category) return;

      document.getElementById('categoryModalTitle').textContent = 'Editar Categor√≠a';
      document.getElementById('categoryEditId').value = category.docId || '';
      document.getElementById('categoryName').value = category.nombre;
      document.getElementById('categorySlug').value = category.slug;
      document.getElementById('categoryModal').style.display = 'flex';
    };

    window.deleteCategory = async function(docId, categoryName) {
      const category = allCategories.find(c => c.docId === docId || c.id === docId);
      if (!category) return;

      const productCount = allProducts.filter(p => p.categoria === category.slug).length;
      
      if (productCount > 0) {
        alert(`No puedes eliminar la categor√≠a "${categoryName}" porque tiene ${productCount} producto(s) asociado(s).`);
        return;
      }

      if (!confirm(`¬øEst√°s seguro de eliminar la categor√≠a "${categoryName}"?`)) return;

      try {
        if (category.docId) {
          await deleteDoc(doc(db, "categorias", category.docId));
        }
        alert('Categor√≠a eliminada correctamente');
        await loadCategories();
      } catch (err) {
        console.error('Error deleting category:', err);
        alert('Error al eliminar la categor√≠a: ' + err.message);
      }
    };

    function updateProductCategoryOptions() {
      const selector = document.getElementById('productCategory');
      if (!selector) return;

      selector.innerHTML = allCategories.map(cat =>
        `<option value="${cat.slug}">${cat.nombre}</option>`
      ).join('');
    }

    // =============================================
    // SHIPPING RATES (UE) MANAGEMENT
    // =============================================

    // Default shipping rates
    const DEFAULT_SHIPPING_RATES = {
      yopal: {
        '1_5': 5000,
        '6_10': 8000,
        '11_plus': 12000
      },
      other: {
        '1_3': 16000,
        '4_6': 22000,
        '7_10': 30000,
        '11_15': 40000,
        '16_plus': 50000
      }
    };

    let shippingRates = { ...DEFAULT_SHIPPING_RATES };

    async function loadShippingRates() {
      try {
        const configRef = doc(db, "config", "shippingRates");
        const configSnap = await getDoc(configRef);

        if (configSnap.exists()) {
          const data = configSnap.data();
          shippingRates = {
            yopal: data.yopal || DEFAULT_SHIPPING_RATES.yopal,
            other: data.other || DEFAULT_SHIPPING_RATES.other
          };
        } else {
          // Create default config if it doesn't exist
          await setDoc(configRef, DEFAULT_SHIPPING_RATES);
          shippingRates = { ...DEFAULT_SHIPPING_RATES };
        }

        // Update form inputs with loaded values
        updateShippingFormInputs();
        console.log('‚úÖ Shipping rates loaded:', shippingRates);
      } catch (err) {
        console.error('Error loading shipping rates:', err);
        shippingRates = { ...DEFAULT_SHIPPING_RATES };
        updateShippingFormInputs();
      }
    }

    function updateShippingFormInputs() {
      // Yopal rates
      const yopal_1_5 = document.getElementById('yopal_1_5');
      const yopal_6_10 = document.getElementById('yopal_6_10');
      const yopal_11_plus = document.getElementById('yopal_11_plus');

      if (yopal_1_5) yopal_1_5.value = shippingRates.yopal['1_5'] || 5000;
      if (yopal_6_10) yopal_6_10.value = shippingRates.yopal['6_10'] || 8000;
      if (yopal_11_plus) yopal_11_plus.value = shippingRates.yopal['11_plus'] || 12000;

      // Other cities rates
      const other_1_3 = document.getElementById('other_1_3');
      const other_4_6 = document.getElementById('other_4_6');
      const other_7_10 = document.getElementById('other_7_10');
      const other_11_15 = document.getElementById('other_11_15');
      const other_16_plus = document.getElementById('other_16_plus');

      if (other_1_3) other_1_3.value = shippingRates.other['1_3'] || 16000;
      if (other_4_6) other_4_6.value = shippingRates.other['4_6'] || 22000;
      if (other_7_10) other_7_10.value = shippingRates.other['7_10'] || 30000;
      if (other_11_15) other_11_15.value = shippingRates.other['11_15'] || 40000;
      if (other_16_plus) other_16_plus.value = shippingRates.other['16_plus'] || 50000;
    }

    async function saveShippingRates() {
      const newRates = {
        yopal: {
          '1_5': parseInt(document.getElementById('yopal_1_5').value) || 5000,
          '6_10': parseInt(document.getElementById('yopal_6_10').value) || 8000,
          '11_plus': parseInt(document.getElementById('yopal_11_plus').value) || 12000
        },
        other: {
          '1_3': parseInt(document.getElementById('other_1_3').value) || 16000,
          '4_6': parseInt(document.getElementById('other_4_6').value) || 22000,
          '7_10': parseInt(document.getElementById('other_7_10').value) || 30000,
          '11_15': parseInt(document.getElementById('other_11_15').value) || 40000,
          '16_plus': parseInt(document.getElementById('other_16_plus').value) || 50000
        },
        updatedAt: new Date().toISOString()
      };

      try {
        await setDoc(doc(db, "config", "shippingRates"), newRates);
        shippingRates = newRates;
        alert('‚úÖ Tarifas de env√≠o guardadas correctamente');
      } catch (err) {
        console.error('Error saving shipping rates:', err);
        alert('‚ùå Error al guardar las tarifas: ' + err.message);
      }
    }

    function calculateShippingFromRates(totalUE, isYopal) {
      if (isYopal) {
        if (totalUE <= 5) return shippingRates.yopal['1_5'];
        if (totalUE <= 10) return shippingRates.yopal['6_10'];
        return shippingRates.yopal['11_plus'];
      } else {
        if (totalUE <= 3) return shippingRates.other['1_3'];
        if (totalUE <= 6) return shippingRates.other['4_6'];
        if (totalUE <= 10) return shippingRates.other['7_10'];
        if (totalUE <= 15) return shippingRates.other['11_15'];
        return shippingRates.other['16_plus'];
      }
    }

    // Shipping tab event listeners
    document.getElementById('saveShippingRatesBtn')?.addEventListener('click', saveShippingRates);

    document.getElementById('simCalculateBtn')?.addEventListener('click', () => {
      const totalUE = parseInt(document.getElementById('simTotalUE').value) || 1;
      const city = document.getElementById('simCity').value;
      const isYopal = city === 'yopal';
      const cost = calculateShippingFromRates(totalUE, isYopal);

      const resultEl = document.getElementById('simResult');
      resultEl.textContent = `Costo: $${cost.toLocaleString('es-CO')}`;
      resultEl.style.display = 'block';
    });

    // ==========================================
    // PROMOTIONAL CODES MANAGEMENT
    // ==========================================

    let promoCodes = [];

    async function loadPromoCodes() {
      try {
        const configRef = doc(db, "config", "promoCodes");
        const configSnap = await getDoc(configRef);

        if (configSnap.exists()) {
          const data = configSnap.data();
          promoCodes = data.codes || [];
        } else {
          promoCodes = [];
        }

        renderPromoCodesTable();
      } catch (err) {
        console.error('Error loading promo codes:', err);
        promoCodes = [];
        renderPromoCodesTable();
      }
    }

    function renderPromoCodesTable() {
      const tbody = document.getElementById('promoCodesTableBody');
      if (!tbody) return;

      if (promoCodes.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="padding:40px;text-align:center;color:#6c757d;">
              <div style="font-size:48px;margin-bottom:16px;">üéÅ</div>
              No hay c√≥digos promocionales configurados.<br>
              <button onclick="openPromoCodeModal()" style="margin-top:12px;padding:8px 16px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">
                Crear primer c√≥digo
              </button>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = promoCodes.map((code, index) => {
        const isExpired = code.expirationDate && new Date(code.expirationDate) < new Date();
        const statusBadge = !code.active
          ? '<span style="background:#6c757d;color:white;padding:4px 8px;border-radius:4px;font-size:11px;">Inactivo</span>'
          : isExpired
            ? '<span style="background:#dc3545;color:white;padding:4px 8px;border-radius:4px;font-size:11px;">Expirado</span>'
            : '<span style="background:#28a745;color:white;padding:4px 8px;border-radius:4px;font-size:11px;">Activo</span>';

        const expirationDisplay = code.expirationDate
          ? new Date(code.expirationDate).toLocaleDateString('es-CO')
          : 'Sin expiraci√≥n';

        const usageDisplay = code.usageLimit
          ? `${code.usageCount || 0} / ${code.usageLimit}`
          : `${code.usageCount || 0} / ‚àû`;

        const restrictions = [];
        if (code.cities && code.cities.length > 0) {
          restrictions.push(`üìç ${code.cities.join(', ')}`);
        }
        if (code.products && code.products.length > 0) {
          restrictions.push(`üì¶ ${code.products.length} producto(s)`);
        }
        const restrictionsDisplay = restrictions.length > 0
          ? restrictions.join('<br>')
          : '<span style="color:#999;">Sin restricciones</span>';

        return `
          <tr style="border-bottom:1px solid #eee;">
            <td style="padding:12px;font-weight:600;font-family:monospace;font-size:14px;">${code.code}</td>
            <td style="padding:12px;">${statusBadge}</td>
            <td style="padding:12px;font-size:13px;">${expirationDisplay}</td>
            <td style="padding:12px;text-align:center;font-size:13px;">${usageDisplay}</td>
            <td style="padding:12px;font-size:12px;">${restrictionsDisplay}</td>
            <td style="padding:12px;text-align:center;">
              <button onclick="editPromoCode(${index})" style="background:#667eea;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;margin-right:4px;font-size:12px;">‚úèÔ∏è Editar</button>
              <button onclick="deletePromoCode(${index})" style="background:#dc3545;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;">üóëÔ∏è Eliminar</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function openPromoCodeModal(editIndex = null) {
      const modal = document.getElementById('promoCodeModal');
      const title = document.getElementById('promoModalTitle');
      const form = document.getElementById('promoCodeForm');

      // Reset form
      form.reset();
      document.getElementById('promoCodeEditId').value = '';
      document.getElementById('promoCodeActive').checked = true;

      if (editIndex !== null && promoCodes[editIndex]) {
        const code = promoCodes[editIndex];
        title.textContent = 'Editar C√≥digo Promocional';
        document.getElementById('promoCodeInput').value = code.code || '';
        document.getElementById('promoCodeDescription').value = code.description || '';
        document.getElementById('promoCodeExpiration').value = code.expirationDate || '';
        document.getElementById('promoCodeUsageLimit').value = code.usageLimit || '';
        document.getElementById('promoCodeCities').value = (code.cities || []).join(', ');
        document.getElementById('promoCodeProducts').value = (code.products || []).join(', ');
        document.getElementById('promoCodeActive').checked = code.active !== false;
        document.getElementById('promoCodeEditId').value = editIndex;
      } else {
        title.textContent = 'Crear C√≥digo Promocional';
      }

      modal.style.display = 'flex';
    }

    function closePromoCodeModal() {
      document.getElementById('promoCodeModal').style.display = 'none';
    }

    window.editPromoCode = function(index) {
      openPromoCodeModal(index);
    };

    window.deletePromoCode = async function(index) {
      if (!confirm('¬øEst√°s seguro de eliminar este c√≥digo promocional?')) return;

      promoCodes.splice(index, 1);

      try {
        await setDoc(doc(db, "config", "promoCodes"), {
          codes: promoCodes,
          updatedAt: new Date().toISOString()
        });
        alert('‚úÖ C√≥digo eliminado correctamente');
        renderPromoCodesTable();
      } catch (err) {
        console.error('Error deleting promo code:', err);
        alert('‚ùå Error al eliminar el c√≥digo: ' + err.message);
        await loadPromoCodes(); // Reload to restore state
      }
    };

    async function savePromoCode(e) {
      e.preventDefault();

      const codeValue = document.getElementById('promoCodeInput').value.trim().toUpperCase().replace(/\s+/g, '');
      const description = document.getElementById('promoCodeDescription').value.trim();
      const expirationDate = document.getElementById('promoCodeExpiration').value || null;
      const usageLimit = parseInt(document.getElementById('promoCodeUsageLimit').value) || 0;
      const citiesRaw = document.getElementById('promoCodeCities').value;
      const productsRaw = document.getElementById('promoCodeProducts').value;
      const active = document.getElementById('promoCodeActive').checked;
      const editId = document.getElementById('promoCodeEditId').value;

      if (!codeValue) {
        alert('Por favor ingresa un c√≥digo');
        return;
      }

      const cities = citiesRaw ? citiesRaw.split(',').map(c => c.trim()).filter(c => c) : [];
      const products = productsRaw ? productsRaw.split(',').map(p => p.trim()).filter(p => p) : [];

      const promoCodeData = {
        code: codeValue,
        description,
        expirationDate,
        usageLimit: usageLimit > 0 ? usageLimit : null,
        usageCount: 0,
        cities,
        products,
        active,
        createdAt: new Date().toISOString()
      };

      if (editId !== '') {
        // Editing existing code
        const existingCode = promoCodes[parseInt(editId)];
        promoCodeData.usageCount = existingCode.usageCount || 0;
        promoCodeData.createdAt = existingCode.createdAt || promoCodeData.createdAt;
        promoCodes[parseInt(editId)] = promoCodeData;
      } else {
        // Check for duplicate code
        if (promoCodes.some(p => p.code.toUpperCase() === codeValue)) {
          alert('Ya existe un c√≥digo con este nombre');
          return;
        }
        promoCodes.push(promoCodeData);
      }

      try {
        await setDoc(doc(db, "config", "promoCodes"), {
          codes: promoCodes,
          updatedAt: new Date().toISOString()
        });
        alert('‚úÖ C√≥digo guardado correctamente');
        closePromoCodeModal();
        renderPromoCodesTable();
      } catch (err) {
        console.error('Error saving promo code:', err);
        alert('‚ùå Error al guardar el c√≥digo: ' + err.message);
        await loadPromoCodes(); // Reload to restore state
      }
    }

    // Promo codes event listeners
    document.getElementById('addPromoCodeBtn')?.addEventListener('click', () => openPromoCodeModal());
    document.getElementById('cancelPromoCodeBtn')?.addEventListener('click', closePromoCodeModal);
    document.getElementById('promoCodeForm')?.addEventListener('submit', savePromoCode);

    // Close modal on background click
    document.getElementById('promoCodeModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'promoCodeModal') closePromoCodeModal();
    });

    // Load promo codes on page load
    loadPromoCodes();

    // Umbral de puntos personales para activaci√≥n mensual
    const MONTHLY_ACTIVATION_POINTS_THRESHOLD = 10;

    // Helper function to get monthly personal points from user history
    function getMonthlyPersonalPointsAdmin(userData) {
      const hist = userData?.history;
      if (!Array.isArray(hist)) return 0;

      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth();

      let monthlyPoints = 0;

      for (const e of hist) {
        if (!e) continue;
        const dateRaw = e.date || e.fechaCompra || e.fecha_recompra || e.createdAt || e.fecha || e.timestamp;
        let d = null;

        if (dateRaw) {
          if (typeof dateRaw.toDate === "function") {
            d = dateRaw.toDate();
          } else if (typeof dateRaw === 'number') {
            d = new Date(dateRaw);
          } else if (typeof dateRaw.seconds === 'number') {
            d = new Date(dateRaw.seconds * 1000);
          } else {
            d = new Date(dateRaw);
          }
        }

        if (!d || isNaN(d.getTime()) || d.getFullYear() !== currentYear || d.getMonth() !== currentMonth) {
          continue;
        }

        const action = (e.action || "").toLowerCase();
        const type = (e.type || "").toLowerCase();

        // Solo contar puntos de compras personales confirmadas
        const isPurchase = (type === "purchase" && /compra confirmada/i.test(action)) ||
                           (!type && /compra confirmada/i.test(action) && !action.includes("comisi√≥n") && !action.includes("bono"));

        if (isPurchase) {
          const points = Number(e.points || e.puntos || 0);
          monthlyPoints += points;
        }
      }
      return monthlyPoints;
    }

    // Helper function to check if user is active this month (needs 10+ points)
    function checkIfUserActiveThisMonth(userData) {
      const monthlyPoints = getMonthlyPersonalPointsAdmin(userData);
      return monthlyPoints >= MONTHLY_ACTIVATION_POINTS_THRESHOLD;
    }

    // Show product orders modal
    window.showProductOrders = async function(productId, productName, totalUnits) {
      try {
        // Get the modal elements
        const modal = document.getElementById('productOrdersModal');
        const modalTitle = document.getElementById('productOrdersModalTitle');
        const modalContent = document.getElementById('productOrdersContent');

        // Set loading state
        modalTitle.textContent = `√ìrdenes: ${productName}`;
        modalContent.innerHTML = '<div style="text-align:center;padding:40px;"><span style="font-size:24px;">‚è≥</span><br>Cargando √≥rdenes...</div>';
        modal.style.display = 'flex';

        // Fetch all confirmed orders for this product
        const ordersSnap = await getDocs(query(
          collection(db, 'orders'),
          where('productId', '==', productId),
          where('status', '==', 'confirmed')
        ));

        const orders = ordersSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        console.log(`üì¶ √ìrdenes encontradas para ${productName}:`, orders.length);

        if (orders.length === 0) {
          modalContent.innerHTML = `
            <div style="text-align:center;padding:40px;color:#666;">
              <span style="font-size:48px;">üì≠</span>
              <h3 style="margin:16px 0 8px 0;">No hay √≥rdenes confirmadas</h3>
              <p>No se encontraron √≥rdenes confirmadas para este producto.</p>
            </div>
          `;
          return;
        }

        // Fetch user information for each order
        const usersCache = new Map();
        for (const order of orders) {
          if (order.buyerUid && !usersCache.has(order.buyerUid)) {
            try {
              const userDoc = await getDoc(doc(db, 'usuarios', order.buyerUid));
              if (userDoc.exists()) {
                const userData = userDoc.data();
                usersCache.set(order.buyerUid, {
                  nombre: userData.nombre || 'Sin nombre',
                  usuario: userData.usuario || 'Sin usuario',
                  email: userData.email || 'Sin email',
                  role: userData.role || userData.tipoRegistro || 'distribuidor'
                });
              } else {
                usersCache.set(order.buyerUid, {
                  nombre: 'Usuario no encontrado',
                  usuario: 'N/A',
                  email: 'N/A',
                  role: 'N/A'
                });
              }
            } catch (err) {
              console.error('Error fetching user:', order.buyerUid, err);
              usersCache.set(order.buyerUid, {
                nombre: 'Error al cargar',
                usuario: 'N/A',
                email: 'N/A',
                role: 'N/A'
              });
            }
          }
        }

        // Filter out test users (names starting with "prueba")
        const filteredOrders = orders.filter(order => {
          const userData = usersCache.get(order.buyerUid);
          if (userData) {
            const isTestUser = userData.nombre.toLowerCase().startsWith('prueba') ||
                              userData.usuario.toLowerCase().startsWith('prueba');
            if (isTestUser) {
              console.log(`üß™ Orden excluida de usuario de prueba en modal: ${userData.usuario || userData.nombre}`);
            }
            return !isTestUser;
          }
          return true; // Include if no user data found
        });

        // Calculate total units
        const calculatedTotal = filteredOrders.reduce((sum, order) => sum + (order.quantity || 1), 0);

        // Build the content
        modalContent.innerHTML = `
          <div style="background:#f8f9fa;padding:16px;border-radius:8px;margin-bottom:20px;">
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
              <div>
                <div style="font-size:12px;color:#666;margin-bottom:4px;">Producto</div>
                <div style="font-size:16px;font-weight:600;">${productName}</div>
              </div>
              <div>
                <div style="font-size:12px;color:#666;margin-bottom:4px;">Total √ìrdenes</div>
                <div style="font-size:20px;font-weight:700;color:#667eea;">${filteredOrders.length}</div>
              </div>
              <div>
                <div style="font-size:12px;color:#666;margin-bottom:4px;">Total Unidades</div>
                <div style="font-size:20px;font-weight:700;color:#764ba2;">${calculatedTotal}</div>
              </div>
            </div>
            ${calculatedTotal !== totalUnits ? `
              <div style="margin-top:12px;padding:12px;background:#fff3cd;border:1px solid #ffc107;border-radius:6px;font-size:13px;">
                ‚ö†Ô∏è <strong>Nota:</strong> El total calculado (${calculatedTotal}) no coincide con el total mostrado (${totalUnits}).
                Esto podr√≠a indicar una discrepancia en los datos.
              </div>
            ` : ''}
          </div>

          <div style="overflow-x:auto;">
            <table style="width:100%;border-collapse:collapse;font-size:13px;">
              <thead style="background:#f8f9fa;position:sticky;top:0;">
                <tr>
                  <th style="padding:12px 8px;text-align:left;border-bottom:2px solid #dee2e6;">Fecha</th>
                  <th style="padding:12px 8px;text-align:left;border-bottom:2px solid #dee2e6;">ID Orden</th>
                  <th style="padding:12px 8px;text-align:left;border-bottom:2px solid #dee2e6;">Distribuidor/Cliente</th>
                  <th style="padding:12px 8px;text-align:left;border-bottom:2px solid #dee2e6;">Contacto</th>
                  <th style="padding:12px 8px;text-align:center;border-bottom:2px solid #dee2e6;">Cantidad</th>
                  <th style="padding:12px 8px;text-align:right;border-bottom:2px solid #dee2e6;">Precio Total</th>
                  <th style="padding:12px 8px;text-align:center;border-bottom:2px solid #dee2e6;">Puntos</th>
                </tr>
              </thead>
              <tbody>
                ${filteredOrders.map((order, index) => {
                  const userData = usersCache.get(order.buyerUid) || {
                    nombre: order.buyerUsername || 'Desconocido',
                    usuario: 'N/A',
                    email: 'N/A',
                    role: 'N/A'
                  };

                  const date = order.createdAt
                    ? (order.createdAt.seconds
                      ? new Date(order.createdAt.seconds * 1000).toLocaleDateString('es-CO', { day: '2-digit', month: 'short', year: 'numeric' })
                      : new Date(order.createdAt).toLocaleDateString('es-CO', { day: '2-digit', month: 'short', year: 'numeric' }))
                    : 'N/A';

                  const quantity = order.quantity || 1;
                  const totalPrice = order.totalPrice || order.priceTotal || (order.price * quantity) || 0;
                  const totalPoints = order.totalPoints || order.pointsTotal || (order.points * quantity) || 0;

                  const roleColors = {
                    'distribuidor': '#667eea',
                    'cliente': '#28a745',
                    'restaurante': '#fd7e14',
                    'admin': '#dc3545'
                  };
                  const roleColor = roleColors[userData.role] || '#6c757d';

                  const rowBg = index % 2 === 0 ? 'white' : '#f8f9fa';

                  return `
                    <tr style="background:${rowBg};border-bottom:1px solid #e9ecef;">
                      <td style="padding:12px 8px;">${date}</td>
                      <td style="padding:12px 8px;"><code style="font-size:11px;background:#e9ecef;padding:2px 6px;border-radius:3px;">${order.id.substring(0, 12)}...</code></td>
                      <td style="padding:12px 8px;">
                        <div style="font-weight:600;margin-bottom:2px;">${userData.nombre}</div>
                        <div style="font-size:11px;color:#666;">@${userData.usuario}</div>
                        <div style="font-size:10px;margin-top:2px;">
                          <span style="background:${roleColor};color:white;padding:2px 6px;border-radius:10px;text-transform:uppercase;font-weight:600;">${userData.role}</span>
                        </div>
                      </td>
                      <td style="padding:12px 8px;font-size:12px;color:#666;">${userData.email}</td>
                      <td style="padding:12px 8px;text-align:center;"><strong style="font-size:16px;color:#764ba2;">${quantity}</strong></td>
                      <td style="padding:12px 8px;text-align:right;font-weight:600;">$${totalPrice.toLocaleString()}</td>
                      <td style="padding:12px 8px;text-align:center;"><strong style="color:#28a745;">${totalPoints}</strong></td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
              <tfoot style="background:#e9ecef;font-weight:700;">
                <tr>
                  <td colspan="4" style="padding:12px 8px;text-align:right;border-top:2px solid #dee2e6;">TOTALES:</td>
                  <td style="padding:12px 8px;text-align:center;border-top:2px solid #dee2e6;color:#764ba2;font-size:18px;">${calculatedTotal}</td>
                  <td style="padding:12px 8px;text-align:right;border-top:2px solid #dee2e6;">$${filteredOrders.reduce((sum, o) => sum + (o.totalPrice || o.priceTotal || (o.price * (o.quantity || 1)) || 0), 0).toLocaleString()}</td>
                  <td style="padding:12px 8px;text-align:center;border-top:2px solid #dee2e6;color:#28a745;">${filteredOrders.reduce((sum, o) => sum + (o.totalPoints || o.pointsTotal || (o.points * (o.quantity || 1)) || 0), 0)}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        `;

      } catch (err) {
        console.error('Error loading product orders:', err);
        const modalContent = document.getElementById('productOrdersContent');
        modalContent.innerHTML = `
          <div style="text-align:center;padding:40px;color:#dc3545;">
            <span style="font-size:48px;">‚ùå</span>
            <h3 style="margin:16px 0 8px 0;">Error al cargar √≥rdenes</h3>
            <p>${err.message}</p>
          </div>
        `;
      }
    };

    // Close product orders modal
    document.getElementById('productOrdersModalClose').addEventListener('click', () => {
      document.getElementById('productOrdersModal').style.display = 'none';
    });

    document.getElementById('productOrdersModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('productOrdersModal')) {
        document.getElementById('productOrdersModal').style.display = 'none';
      }
    });

    // Recalculate distributor points and commissions
    window.recalculateDistributor = async function(distributorId) {
      if (!currentUser) {
        alert('Error: Usuario no autenticado');
        return;
      }

      const confirmRecalc = confirm(
        '¬øRecalcular los puntos y comisiones de este distribuidor?\n\n' +
        'Esta acci√≥n:\n' +
        '‚Ä¢ Analizar√° todo el historial del distribuidor\n' +
        '‚Ä¢ Recalcular√° los puntos grupales correctos\n' +
        '‚Ä¢ Actualizar√° el balance bas√°ndose en comisiones reales\n' +
        '‚Ä¢ Excluir√° compras personales de los puntos grupales\n\n' +
        '¬øDeseas continuar?'
      );

      if (!confirmRecalc) return;

      try {
        const token = await currentUser.getIdToken();
        
        // Mostrar indicador de carga
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span style="font-size:16px;">‚è≥</span> Recalculando...';

        const res = await fetch('/.netlify/functions/recalculate-distributor', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ distributorId })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Error desconocido');
        }

        // Restaurar bot√≥n
        btn.disabled = false;
        btn.innerHTML = originalText;

        // Mostrar resultados
        const changes = data.changes;
        const changesSummary = [
          `Puntos Grupales: ${data.before.groupPoints} ‚Üí ${data.after.groupPoints} (${changes.groupPoints >= 0 ? '+' : ''}${changes.groupPoints})`,
          `Balance: $${data.before.balance.toLocaleString()} ‚Üí $${data.after.balance.toLocaleString()} (${changes.balance >= 0 ? '+' : ''}$${changes.balance.toLocaleString()})`
        ].join('\n');

        alert(
          '‚úÖ Recalculaci√≥n completada exitosamente\n\n' +
          'Cambios realizados:\n' +
          changesSummary
        );

        // Recargar datos del panel
        await loadAllData();
        
        // Recargar detalles del distribuidor si el panel est√° abierto
        const panel = document.getElementById('distributorDetailsPanel');
        if (panel && panel.style.display === 'block') {
          await showDistributorDetails(distributorId);
        }

      } catch (err) {
        console.error('Error recalculando distribuidor:', err);
        alert('Error recalculando distribuidor:\n' + err.message);
        
        // Restaurar bot√≥n en caso de error
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }
    };

    // ============================================
    // CALCULADORA DE PUNTOS Y COMISIONES
    // ============================================

    const POINT_VALUE = 2800;
    const COMMISSION_RATE = 0.10;
    const RESTAURANT_COMMISSION_RATE = 0.05;
    const MAX_LEVELS = 5;
    const QUICK_START_THRESHOLD = 50;
    const QUICK_START_DIRECT_POINTS = 21;
    const QUICK_START_UPPER_LEVELS_POINTS = 1;
    const MAX_LEVELS_QUICK_START = 4;

    let calcUsers = [];
    let calcProducts = [];

    async function loadCalculatorData() {
      try {
        const [usersSnap, productsSnap] = await Promise.all([
          getDocs(collection(db, 'usuarios')),
          getDocs(collection(db, 'productos'))
        ]);

        calcUsers = usersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        calcProducts = productsSnap.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(p => !p.deleted && !p.hidden);

        const buyerSelect = document.getElementById('calcBuyer');
        const productSelect = document.getElementById('calcProduct');

        buyerSelect.innerHTML = '<option value="">Seleccionar usuario...</option>';
        calcUsers.forEach(user => {
          const option = document.createElement('option');
          option.value = user.id;
          option.textContent = `${user.nombre} (@${user.usuario}) - ${user.tipoRegistro || 'usuario'}`;
          buyerSelect.appendChild(option);
        });

        productSelect.innerHTML = '<option value="">Seleccionar producto...</option>';
        calcProducts.forEach(prod => {
          const option = document.createElement('option');
          option.value = prod.id;
          option.textContent = `${prod.nombre} - $${(prod.precioDistribuidor || prod.precio || 0).toLocaleString()}`;
          productSelect.appendChild(option);
        });

      } catch (err) {
        console.error('Error loading calculator data:', err);
        alert('Error cargando datos para la calculadora');
      }
    }

    async function findUserByUsername(username) {
      if (!username) return null;
      const user = calcUsers.find(u => u.usuario === username);
      return user ? { id: user.id, data: user } : null;
    }

    function getProductPrice(product, userType) {
      if (userType === 'distribuidor') {
        return product.precioDistribuidor || product.precio || 0;
      } else if (userType === 'cliente') {
        return product.precioCliente || product.precio || 0;
      } else if (userType === 'restaurante') {
        return product.precioRestaurante || product.precio || 0;
      }
      return product.precio || 0;
    }

    function getProductPoints(product, userType) {
      if (userType === 'distribuidor') {
        return product.puntosDistribuidor || product.puntos || 0;
      } else if (userType === 'restaurante') {
        return product.puntosRestaurante || product.puntos || 0;
      }
      return product.puntosDistribuidor || product.puntos || 0;
    }

    document.getElementById('calcCalculateBtn').addEventListener('click', async () => {
      const buyerId = document.getElementById('calcBuyer').value;
      const productId = document.getElementById('calcProduct').value;
      const quantity = parseInt(document.getElementById('calcQuantity').value) || 1;
      const isFirstPurchase = document.getElementById('calcIsFirstPurchase').checked;

      if (!buyerId || !productId) {
        alert('Por favor selecciona un comprador y un producto');
        return;
      }

      const buyer = calcUsers.find(u => u.id === buyerId);
      const product = calcProducts.find(p => p.id === productId);

      if (!buyer || !product) {
        alert('Error: comprador o producto no encontrado');
        return;
      }

      const buyerType = buyer.tipoRegistro || 'distribuidor';
      const unitPrice = getProductPrice(product, buyerType);
      const unitPoints = getProductPoints(product, buyerType);
      const totalPrice = unitPrice * quantity;
      const totalPoints = unitPoints * quantity;

      // Build upline chain
      const uplineChain = [];
      let currentSponsor = buyer.patrocinador;

      while (currentSponsor && uplineChain.length < MAX_LEVELS) {
        const sponsorObj = await findUserByUsername(currentSponsor);
        if (!sponsorObj) break;

        uplineChain.push({
          username: sponsorObj.data.usuario,
          name: sponsorObj.data.nombre,
          level: uplineChain.length + 1,
          type: sponsorObj.data.tipoRegistro || 'distribuidor'
        });

        currentSponsor = sponsorObj.data.patrocinador;
      }

      // Calculate commissions based on buyer type
      let commissions = [];
      let quickStartBonus = null;

      if (buyerType === 'cliente') {
        // Cliente: solo al patrocinador directo
        if (uplineChain.length > 0) {
          const distPrice = product.precioDistribuidor || product.precio || 0;
          const priceDiff = (unitPrice - distPrice) * quantity;
          const diffPoints = priceDiff / POINT_VALUE;

          commissions.push({
            recipient: uplineChain[0],
            amountCOP: priceDiff,
            points: diffPoints,
            type: 'Comisi√≥n por diferencia de precio'
          });
        }
      } else if (buyerType === 'distribuidor') {
        // Check Quick Start Bonus
        if (isFirstPurchase && totalPoints >= QUICK_START_THRESHOLD) {
          const numPackages = Math.floor(totalPoints / QUICK_START_THRESHOLD);

          if (uplineChain.length > 0) {
            const directPoints = numPackages * QUICK_START_DIRECT_POINTS;
            quickStartBonus = {
              recipient: uplineChain[0],
              points: directPoints,
              amountCOP: directPoints * POINT_VALUE,
              type: 'Quick Start Bonus (Patrocinador Directo)'
            };
          }

          for (let i = 1; i < Math.min(uplineChain.length, MAX_LEVELS_QUICK_START + 1); i++) {
            const upperPoints = numPackages * QUICK_START_UPPER_LEVELS_POINTS;
            commissions.push({
              recipient: uplineChain[i],
              amountCOP: upperPoints * POINT_VALUE,
              points: upperPoints,
              type: `Quick Start Bonus (Nivel ${i + 1})`
            });
          }
        } else {
          // Normal commission: 10% to each upline
          const totalValue = totalPoints * POINT_VALUE;
          const commissionPerUpline = totalValue * COMMISSION_RATE;
          const pointsPerUpline = commissionPerUpline / POINT_VALUE;

          uplineChain.forEach(upline => {
            commissions.push({
              recipient: upline,
              amountCOP: commissionPerUpline,
              points: pointsPerUpline,
              type: `Comisi√≥n 10% (Nivel ${upline.level})`
            });
          });
        }
      } else if (buyerType === 'restaurante') {
        // Restaurant: 5% of total points to each upline
        const pointsPerUpline = totalPoints * RESTAURANT_COMMISSION_RATE;
        const amountPerUpline = pointsPerUpline * POINT_VALUE;

        uplineChain.forEach(upline => {
          commissions.push({
            recipient: upline,
            amountCOP: amountPerUpline,
            points: pointsPerUpline,
            type: `Comisi√≥n 5% Restaurante (Nivel ${upline.level})`
          });
        });
      }

      // Display results
      const summaryDiv = document.getElementById('calcSummary');
      summaryDiv.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:16px;">
          <div style="background:#f8f9fa;padding:16px;border-radius:6px;">
            <div style="font-size:12px;color:#666;margin-bottom:4px;">Comprador</div>
            <div style="font-weight:600;font-size:16px;">${buyer.nombre}</div>
            <div style="font-size:13px;color:#666;">@${buyer.usuario}</div>
            <div style="margin-top:4px;">
              <span style="background:#007bff;color:white;padding:2px 8px;border-radius:10px;font-size:11px;text-transform:uppercase;">${buyerType}</span>
            </div>
          </div>
          <div style="background:#f8f9fa;padding:16px;border-radius:6px;">
            <div style="font-size:12px;color:#666;margin-bottom:4px;">Producto</div>
            <div style="font-weight:600;font-size:16px;">${product.nombre}</div>
            <div style="font-size:13px;color:#666;">Cantidad: ${quantity}</div>
          </div>
          <div style="background:#e7f5ff;padding:16px;border-radius:6px;">
            <div style="font-size:12px;color:#666;margin-bottom:4px;">Precio Total</div>
            <div style="font-weight:700;font-size:20px;color:#007bff;">$${totalPrice.toLocaleString()}</div>
            <div style="font-size:13px;color:#666;">$${unitPrice.toLocaleString()} √ó ${quantity}</div>
          </div>
          <div style="background:#e6f9f0;padding:16px;border-radius:6px;">
            <div style="font-size:12px;color:#666;margin-bottom:4px;">Puntos Totales</div>
            <div style="font-weight:700;font-size:20px;color:#28a745;">${totalPoints} pts</div>
            <div style="font-size:13px;color:#666;">${unitPoints} pts √ó ${quantity}</div>
          </div>
        </div>
      `;

      const distributionDiv = document.getElementById('calcDistribution');

      if (commissions.length === 0 && !quickStartBonus) {
        distributionDiv.innerHTML = `
          <div style="text-align:center;padding:40px;color:#6c757d;">
            <span style="font-size:48px;">‚ÑπÔ∏è</span>
            <h3 style="margin:16px 0 8px 0;">Sin comisiones</h3>
            <p>Este comprador no tiene patrocinador o no genera comisiones.</p>
          </div>
        `;
      } else {
        let totalCommissionCOP = commissions.reduce((sum, c) => sum + c.amountCOP, 0);
        let totalCommissionPoints = commissions.reduce((sum, c) => sum + c.points, 0);

        if (quickStartBonus) {
          totalCommissionCOP += quickStartBonus.amountCOP;
          totalCommissionPoints += quickStartBonus.points;
        }

        let distributionHTML = '';

        if (quickStartBonus) {
          distributionHTML += `
            <div style="background:#fff3cd;border-left:4px solid #ffc107;padding:16px;margin-bottom:16px;border-radius:4px;">
              <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
                <div>
                  <div style="font-weight:600;color:#856404;margin-bottom:4px;">‚≠ê ${quickStartBonus.type}</div>
                  <div style="font-size:14px;color:#856404;">${quickStartBonus.recipient.name} (@${quickStartBonus.recipient.username})</div>
                </div>
                <div style="text-align:right;">
                  <div style="font-size:18px;font-weight:700;color:#856404;">$${quickStartBonus.amountCOP.toLocaleString()}</div>
                  <div style="font-size:14px;color:#856404;">${quickStartBonus.points.toFixed(2)} puntos</div>
                </div>
              </div>
            </div>
          `;
        }

        commissions.forEach((comm, idx) => {
          const bgColor = idx % 2 === 0 ? '#f8f9fa' : '#ffffff';
          distributionHTML += `
            <div style="background:${bgColor};padding:16px;margin-bottom:8px;border-radius:4px;border-left:4px solid #764ba2;">
              <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
                <div style="flex:1;">
                  <div style="font-weight:600;margin-bottom:4px;">${comm.recipient.name}</div>
                  <div style="font-size:13px;color:#666;">@${comm.recipient.username}</div>
                  <div style="font-size:12px;color:#764ba2;margin-top:4px;">${comm.type}</div>
                </div>
                <div style="text-align:right;">
                  <div style="font-size:18px;font-weight:700;color:#333;">$${comm.amountCOP.toLocaleString()}</div>
                  <div style="font-size:14px;color:#28a745;">${comm.points.toFixed(2)} puntos</div>
                </div>
              </div>
            </div>
          `;
        });

        distributionHTML += `
          <div style="background:#e9ecef;padding:20px;margin-top:16px;border-radius:6px;">
            <div style="display:flex;justify-content:space-between;align-items:center;font-weight:700;font-size:18px;">
              <div>TOTAL A DISTRIBUIR:</div>
              <div>
                <div style="color:#333;">$${totalCommissionCOP.toLocaleString()}</div>
                <div style="color:#28a745;font-size:16px;">${totalCommissionPoints.toFixed(2)} puntos</div>
              </div>
            </div>
          </div>
        `;

        distributionDiv.innerHTML = distributionHTML;
      }

      document.getElementById('calcResults').style.display = 'block';
    });

    // ============================================
    // QUICK CALCULATOR: Pesos ‚Üí Puntos ‚Üí Comisiones
    // ============================================

    const QUICK_CALC_POINT_VALUE = 2800; // 1 punto = $2,800 pesos
    const QUICK_CALC_DISTRIBUTOR_RATE = 0.10; // 10% para distribuidores
    const QUICK_CALC_RESTAURANT_RATE = 0.05; // 5% para restaurantes

    // Funci√≥n para formatear n√∫meros con separadores de miles
    function formatPesos(amount) {
      return '$' + Math.round(amount).toLocaleString('es-CO');
    }

    // Funci√≥n para calcular y mostrar resultados
    function calculateQuickResults() {
      const benefitInput = document.getElementById('quickCalcBenefit');
      const benefit = Number(benefitInput?.value) || 0;

      if (benefit <= 0) {
        document.getElementById('quickCalcResults').style.display = 'none';
        return;
      }

      // 1. Conversi√≥n de pesos a puntos (1 punto = $2,800)
      const totalPoints = benefit / QUICK_CALC_POINT_VALUE;

      // 2. Comisi√≥n para distribuidores (10% de los puntos)
      const distributorPoints = totalPoints * QUICK_CALC_DISTRIBUTOR_RATE;
      const distributorPesos = distributorPoints * QUICK_CALC_POINT_VALUE;

      // 3. Comisi√≥n para restaurantes (5% de los puntos)
      const restaurantPoints = totalPoints * QUICK_CALC_RESTAURANT_RATE;
      const restaurantPesos = restaurantPoints * QUICK_CALC_POINT_VALUE;

      // Actualizar resultados en la UI
      // Resultado 1: Puntos totales
      document.getElementById('quickResultPoints').textContent = totalPoints.toFixed(2);
      document.getElementById('quickResultBenefitDisplay').textContent = formatPesos(benefit);
      document.getElementById('quickResultPointsSmall').textContent = totalPoints.toFixed(2);

      // Resultado 2: Distribuidores
      document.getElementById('quickResultDistributor').textContent = distributorPoints.toFixed(2);
      document.getElementById('quickResultPointsForDist').textContent = totalPoints.toFixed(2);
      document.getElementById('quickResultDistributorSmall').textContent = distributorPoints.toFixed(2);
      document.getElementById('quickResultDistributorPesos').textContent = formatPesos(distributorPesos);

      // Resultado 3: Restaurantes
      document.getElementById('quickResultRestaurant').textContent = restaurantPoints.toFixed(2);
      document.getElementById('quickResultPointsForRest').textContent = totalPoints.toFixed(2);
      document.getElementById('quickResultRestaurantSmall').textContent = restaurantPoints.toFixed(2);
      document.getElementById('quickResultRestaurantPesos').textContent = formatPesos(restaurantPesos);

      // Resumen
      document.getElementById('summaryBenefit').textContent = formatPesos(benefit);
      document.getElementById('summaryPoints').textContent = totalPoints.toFixed(2);
      document.getElementById('summaryDist').textContent = distributorPoints.toFixed(2) + ' pts';
      document.getElementById('summaryRest').textContent = restaurantPoints.toFixed(2) + ' pts';

      // Mostrar resultados
      document.getElementById('quickCalcResults').style.display = 'block';
    }

    // Event listener para el bot√≥n de calcular
    document.getElementById('quickCalcBtn')?.addEventListener('click', calculateQuickResults);

    // Tambi√©n calcular al presionar Enter en el campo de beneficio
    document.getElementById('quickCalcBenefit')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        calculateQuickResults();
      }
    });

    // Calcular autom√°ticamente mientras se escribe (con debounce)
    let quickCalcTimeout = null;
    document.getElementById('quickCalcBenefit')?.addEventListener('input', () => {
      if (quickCalcTimeout) clearTimeout(quickCalcTimeout);
      quickCalcTimeout = setTimeout(() => {
        const value = Number(document.getElementById('quickCalcBenefit')?.value) || 0;
        if (value > 0) {
          calculateQuickResults();
        }
      }, 300);
    });

    // Load calculator data when the calculator tab is activated
    const originalTabListener = document.querySelectorAll('.tab-button');
    originalTabListener.forEach(btn => {
      if (btn.dataset.tab === 'calculator') {
        btn.addEventListener('click', () => {
          if (calcUsers.length === 0 || calcProducts.length === 0) {
            loadCalculatorData();
          }
        });
      }
      // Load profits data when profits tab is activated
      if (btn.dataset.tab === 'profits') {
        btn.addEventListener('click', () => {
          loadProfitsData();
        });
      }
    });

    // ============================================
    // GANANCIAS (PROFITS) SECTION
    // ============================================

    // Product Costs Accordion State - persists while user stays on Ganancias tab
    let productCostsAccordionExpanded = false;

    // Toggle accordion for product costs configuration
    // Note: Exposed to window because it's called via inline onclick and this is a module script
    window.toggleProductCostsAccordion = function() {
      const content = document.getElementById('productCostsAccordionContent');
      const icon = document.getElementById('productCostsAccordionIcon');
      const header = document.getElementById('productCostsAccordionHeader');

      productCostsAccordionExpanded = !productCostsAccordionExpanded;

      if (productCostsAccordionExpanded) {
        // Expand: set max-height to scrollHeight for smooth animation
        content.style.maxHeight = content.scrollHeight + 'px';
        icon.style.transform = 'rotate(180deg)';
        header.style.background = 'linear-gradient(135deg,#20c997,#17a2b8)';
      } else {
        // Collapse: set max-height to 0
        content.style.maxHeight = '0';
        icon.style.transform = 'rotate(0deg)';
        header.style.background = 'linear-gradient(135deg,#28a745,#20c997)';
      }
    }

    // Update accordion max-height after content is rendered (for dynamic content)
    function updateProductCostsAccordionHeight() {
      if (productCostsAccordionExpanded) {
        const content = document.getElementById('productCostsAccordionContent');
        if (content) {
          // Temporarily remove transition for instant resize
          content.style.transition = 'none';
          content.style.maxHeight = content.scrollHeight + 'px';
          // Re-enable transition after a tick
          setTimeout(() => {
            content.style.transition = 'max-height 0.4s ease-out';
          }, 10);
        }
      }
    }

    let profitsOrders = []; // All confirmed orders
    let profitsProducts = []; // All products
    let monthlyEarningsClosures = []; // Historical monthly closures from Firestore

    // Load profits data
    async function loadProfitsData() {
      try {
        // Load products, orders, and monthly closures
        const [productsSnap, ordersSnap, closuresSnap] = await Promise.all([
          getDocs(collection(db, 'productos')),
          getDocs(collection(db, 'orders')),
          getDocs(collection(db, 'monthlyEarningsClosures'))
        ]);

        // Map products with docId (Firestore document ID) and id (product field)
        profitsProducts = productsSnap.docs
          .map(d => {
            const data = d.data();
            return {
              docId: d.id,         // Firestore document ID
              id: data.id || d.id, // Product ID field (or fallback to doc ID)
              ...data
            };
          })
          .filter(p => !p.deleted);

        profitsOrders = ordersSnap.docs
          .map(d => {
            const data = d.data();
            // Normalize createdAt: use confirmedAt as fallback if createdAt is missing
            const orderData = {
              id: d.id,
              ...data,
              // Ensure createdAt exists - prefer createdAt, fall back to confirmedAt
              createdAt: data.createdAt || data.confirmedAt || null
            };
            return orderData;
          })
          .filter(o => {
            const status = (o.status || '').toLowerCase();
            return status === 'confirmed' || status === 'confirmado';
          });

        // Load monthly closures and sort client-side (avoids composite index requirement)
        monthlyEarningsClosures = closuresSnap.docs.map(d => ({
          id: d.id,
          ...d.data()
        })).sort((a, b) => {
          // Sort by year descending, then by month descending
          if (b.year !== a.year) return b.year - a.year;
          return b.month - a.month;
        });

        // Debug logging
        console.log('üìä Profits Data Loaded:');
        console.log(`   - Productos: ${profitsProducts.length}`);
        console.log(`   - √ìrdenes confirmadas: ${profitsOrders.length}`);
        console.log(`   - Cierres mensuales guardados: ${monthlyEarningsClosures.length}`);

        // Log date parsing info for orders
        if (profitsOrders.length > 0) {
          console.log('üìÖ Muestra de √≥rdenes y sus fechas:');
          profitsOrders.slice(0, 5).forEach((o, i) => {
            const parsedDate = parseOrderDate(o.createdAt);
            console.log(`   ${i + 1}. Orden ${o.id.substring(0, 8)}... - createdAt type: ${typeof o.createdAt}, parsed: ${parsedDate ? parsedDate.toISOString() : 'NULL'}, status: ${o.status}`);
          });
        } else {
          console.warn('‚ö†Ô∏è No hay √≥rdenes confirmadas para mostrar');
        }

        // Log all products with their cost configuration
        console.log('üì¶ Lista de productos con costos:');
        profitsProducts.forEach(p => {
          console.log(`   - "${p.nombre}" (id: ${p.id}) - Costo: $${p.costo || 0}, Platform: ${p.platformPercent || 50}%`);
        });

        renderProfitsCostsList();
        updateProfitsReport();
        loadPurgeReports();
      } catch (err) {
        console.error('Error loading profits data:', err);
        alert('Error cargando datos de ganancias');
      }
    }

    // Render the costs configuration list
    function renderProfitsCostsList() {
      const container = document.getElementById('profitsCostsList');

      if (profitsProducts.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">No hay productos</div>';
        return;
      }

      let html = `
        <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr;gap:8px;padding:12px;background:#f8f9fa;border-radius:4px;font-weight:600;font-size:12px;margin-bottom:8px;">
          <div>Producto</div>
          <div style="text-align:center;">Precio Venta</div>
          <div style="text-align:center;">Costo Compra</div>
          <div style="text-align:center;">Beneficio</div>
          <div style="text-align:center;">% Plataforma</div>
          <div style="text-align:center;">Resumen</div>
        </div>
      `;

      profitsProducts.forEach(product => {
        // Use costo and platformPercent directly from product document
        const salePrice = product.precioDistribuidor || product.precio || 0;
        const cost = product.costo || 0;
        const platformPercent = product.platformPercent || 50; // Default 50% for platform
        const benefit = salePrice - cost;
        const platformProfit = benefit > 0 ? Math.round(benefit * (platformPercent / 100)) : 0;
        const networkPayment = benefit > 0 ? benefit - platformProfit : 0;

        const benefitColor = benefit > 0 ? '#28a745' : (benefit < 0 ? '#dc3545' : '#666');
        const hasConfig = cost > 0;

        html += `
          <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr;gap:8px;padding:14px 12px;border-bottom:1px solid #eee;align-items:center;${hasConfig ? '' : 'background:#fffbe6;'}">
            <div>
              <div style="font-weight:600;font-size:14px;">${product.nombre}</div>
              <div style="font-size:11px;color:#999;">${product.id}</div>
            </div>
            <div style="text-align:center;">
              <span style="color:#28a745;font-weight:700;font-size:15px;">$${salePrice.toLocaleString()}</span>
            </div>
            <div style="text-align:center;">
              <input type="number"
                id="cost-${product.docId}"
                data-product-doc-id="${product.docId}"
                value="${cost || ''}"
                min="0"
                style="width:100%;max-width:110px;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:14px;text-align:center;"
                placeholder="Ej: 2980"
                onchange="updateProfitsBenefitPreview('${product.docId}', ${salePrice})">
            </div>
            <div style="text-align:center;">
              <span id="benefit-${product.docId}" style="font-weight:700;font-size:15px;color:${benefitColor};">
                ${cost > 0 ? '$' + benefit.toLocaleString() : '‚Äî'}
              </span>
            </div>
            <div style="text-align:center;">
              <select id="platform-${product.docId}"
                data-product-doc-id="${product.docId}"
                style="padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px;width:100%;max-width:100px;"
                onchange="updateProfitsBenefitPreview('${product.docId}', ${salePrice})">
                <option value="40" ${platformPercent === 40 ? 'selected' : ''}>40% / 60%</option>
                <option value="45" ${platformPercent === 45 ? 'selected' : ''}>45% / 55%</option>
                <option value="50" ${platformPercent === 50 ? 'selected' : ''}>50% / 50%</option>
                <option value="55" ${platformPercent === 55 ? 'selected' : ''}>55% / 45%</option>
                <option value="60" ${platformPercent === 60 ? 'selected' : ''}>60% / 40%</option>
              </select>
            </div>
            <div id="summary-${product.docId}" style="text-align:center;font-size:11px;line-height:1.5;">
              ${cost > 0 ? `
                <div style="color:#007bff;"><strong>Plataforma:</strong> $${platformProfit.toLocaleString()}</div>
                <div style="color:#fd7e14;"><strong>Red:</strong> $${networkPayment.toLocaleString()}</div>
              ` : '<span style="color:#999;">Configurar en Productos</span>'}
            </div>
          </div>
        `;
      });

      // Add note about configuration
      html += `
        <div style="margin-top:16px;padding:12px;background:#e7f5ff;border-radius:6px;border-left:4px solid #007bff;">
          <p style="margin:0;font-size:13px;color:#0056b3;">
            <strong>Nota:</strong> Los costos y margenes ahora se configuran directamente en cada producto desde la pestana de <strong>Productos</strong>.
            Los cambios realizados aqui se guardan automaticamente en el documento del producto.
          </p>
        </div>
      `;

      container.innerHTML = html;

      // Update accordion height after rendering content
      updateProductCostsAccordionHeight();
    }

    // Update benefit preview when cost or platform percent changes (in profits tab)
    window.updateProfitsBenefitPreview = function(productDocId, salePrice) {
      const costInput = document.getElementById(`cost-${productDocId}`);
      const platformSelect = document.getElementById(`platform-${productDocId}`);
      const benefitSpan = document.getElementById(`benefit-${productDocId}`);
      const summaryDiv = document.getElementById(`summary-${productDocId}`);

      const cost = Number(costInput?.value) || 0;
      const platformPercent = Number(platformSelect?.value) || 50;
      const benefit = salePrice - cost;
      const platformProfit = benefit > 0 ? Math.round(benefit * (platformPercent / 100)) : 0;
      const networkPayment = benefit > 0 ? benefit - platformProfit : 0;

      const benefitColor = benefit > 0 ? '#28a745' : (benefit < 0 ? '#dc3545' : '#666');

      if (benefitSpan) {
        benefitSpan.style.color = benefitColor;
        benefitSpan.textContent = cost > 0 ? '$' + benefit.toLocaleString() : '‚Äî';
      }

      if (summaryDiv) {
        if (cost > 0) {
          summaryDiv.innerHTML = `
            <div style="color:#007bff;"><strong>Plataforma:</strong> $${platformProfit.toLocaleString()}</div>
            <div style="color:#fd7e14;"><strong>Red:</strong> $${networkPayment.toLocaleString()}</div>
          `;
        } else {
          summaryDiv.innerHTML = '<span style="color:#999;">Configurar en Productos</span>';
        }
      }
    };

    // Save costs to Firestore product documents
    document.getElementById('saveProfitsCostsBtn')?.addEventListener('click', async () => {
      const updates = [];
      const saveBtn = document.getElementById('saveProfitsCostsBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Guardando...';

      try {
        for (const product of profitsProducts) {
          const costInput = document.getElementById(`cost-${product.docId}`);
          const platformSelect = document.getElementById(`platform-${product.docId}`);

          if (costInput && platformSelect) {
            const newCost = Number(costInput.value) || 0;
            const newPlatformPercent = Number(platformSelect.value) || 50;

            // Only update if values changed
            if (newCost !== (product.costo || 0) || newPlatformPercent !== (product.platformPercent || 50)) {
              updates.push(
                updateDoc(doc(db, 'productos', product.docId), {
                  costo: newCost,
                  platformPercent: newPlatformPercent
                })
              );
              // Update local data as well
              product.costo = newCost;
              product.platformPercent = newPlatformPercent;
            }
          }
        }

        if (updates.length > 0) {
          await Promise.all(updates);
          console.log(`‚úÖ Actualizados ${updates.length} productos con nuevos costos`);
        }

        alert('Configuracion guardada correctamente en Firestore');
        updateProfitsReport();
      } catch (err) {
        console.error('Error guardando costos:', err);
        alert('Error al guardar configuracion: ' + err.message);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Guardar Configuracion';
      }
    });

    // Helper function to parse dates from Firestore timestamps or ISO strings
    function parseOrderDate(createdAt) {
      if (!createdAt) return null;
      // Handle Firestore Timestamp (has .seconds property)
      if (createdAt.seconds !== undefined) {
        return new Date(createdAt.seconds * 1000);
      }
      // Handle ISO string or other date formats
      if (typeof createdAt === 'string') {
        const parsed = new Date(createdAt);
        return isNaN(parsed.getTime()) ? null : parsed;
      }
      // Handle Date object
      if (createdAt instanceof Date) {
        return createdAt;
      }
      // Handle numeric timestamp (milliseconds)
      if (typeof createdAt === 'number') {
        return new Date(createdAt);
      }
      return null;
    }

    // Filter orders by period
    function filterOrdersByPeriod(orders, period) {
      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth();

      return orders.filter(order => {
        if (!order.createdAt) return false;
        const orderDate = parseOrderDate(order.createdAt);
        if (!orderDate) return false;

        switch (period) {
          case 'current':
            return orderDate.getMonth() === currentMonth && orderDate.getFullYear() === currentYear;
          case 'last':
            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            return orderDate.getMonth() === lastMonth && orderDate.getFullYear() === lastMonthYear;
          case 'last3':
            const threeMonthsAgo = new Date(currentYear, currentMonth - 3, 1);
            return orderDate >= threeMonthsAgo;
          case 'last6':
            const sixMonthsAgo = new Date(currentYear, currentMonth - 6, 1);
            return orderDate >= sixMonthsAgo;
          case 'year':
            return orderDate.getFullYear() === currentYear;
          case 'all':
          default:
            return true;
        }
      });
    }

    // Normalize product name for better matching
    function normalizeProductName(name) {
      if (!name) return '';
      return name
        .toLowerCase()
        .trim()
        .normalize('NFD').replace(/[ÃÄ-ÕØ]/g, '') // Remove accents
        .replace(/[-‚Äì‚Äî_]/g, ' ')    // Replace dashes with spaces
        .replace(/\s+/g, ' ')       // Normalize multiple spaces
        .replace(/\bkg\b/gi, 'kilo')
        .replace(/\bkilos?\b/gi, 'kilo')
        .replace(/\bunid\.?\b/gi, 'unidad')
        .replace(/\bunidades?\b/gi, 'unidad')
        .replace(/\bpaq\.?\b/gi, 'paquete')
        .replace(/\bpaquetes?\b/gi, 'paquete')
        .replace(/[^\w\s]/g, '')    // Remove punctuation
        .trim();
    }

    // Extract core product words (main identifying words)
    function extractCoreWords(name) {
      const normalized = normalizeProductName(name);
      // Common words to ignore for matching
      const stopWords = ['de', 'la', 'el', 'los', 'las', 'un', 'una', 'unos', 'unas', 'con', 'sin', 'para', 'por', 'en', 'y', 'o', 'kilo', 'unidad', 'paquete', 'caja', 'bolsa', 'lata', 'botella', 'litro', 'ml', 'gr', 'g'];
      return normalized.split(' ').filter(word => word.length > 1 && !stopWords.includes(word) && !/^\d+$/.test(word));
    }

    // Calculate similarity score between two product names
    function calculateSimilarity(name1, name2) {
      const words1 = extractCoreWords(name1);
      const words2 = extractCoreWords(name2);

      if (words1.length === 0 || words2.length === 0) return 0;

      let matchedWords = 0;
      words1.forEach(word1 => {
        if (words2.some(word2 =>
          word2 === word1 ||
          word2.includes(word1) ||
          word1.includes(word2)
        )) {
          matchedWords++;
        }
      });

      // Return a score between 0 and 1
      return matchedWords / Math.max(words1.length, words2.length);
    }

    // Helper function to find product by ID or name
    function findProductMatch(order, products) {
      // Try to find by productId first (matches both 'id' field and document ID)
      const productId = order.productId || order.product?.id || null;
      if (productId) {
        // Try matching product.id field
        let product = products.find(p => p.id === productId);
        if (product) return product;

        // Try matching document ID (docId)
        product = products.find(p => p.docId === productId);
        if (product) return product;

        // Try case-insensitive and normalized ID match
        const normalizedId = productId.toLowerCase().trim();
        product = products.find(p =>
          (p.id && p.id.toLowerCase().trim() === normalizedId) ||
          (p.docId && p.docId.toLowerCase().trim() === normalizedId)
        );
        if (product) return product;
      }

      // Try to find by product name
      const productName = order.productName || order.product || order.nombre || '';
      if (!productName) return null;

      const normalizedOrderName = normalizeProductName(productName);

      // 1. Try exact normalized match first
      let exactMatch = products.find(p =>
        p.nombre && normalizeProductName(p.nombre) === normalizedOrderName
      );
      if (exactMatch) return exactMatch;

      // 1.5 Try if the order name is contained in product name or vice versa (case insensitive)
      const lowerOrderName = productName.toLowerCase().trim();
      exactMatch = products.find(p => {
        if (!p.nombre) return false;
        const lowerProductName = p.nombre.toLowerCase().trim();
        return lowerProductName.includes(lowerOrderName) || lowerOrderName.includes(lowerProductName);
      });
      if (exactMatch) {
        console.log(`   üìù Match por contenido: "${productName}" ‚Üí "${exactMatch.nombre}"`);
        return exactMatch;
      }

      // 2. Try to match core words with high similarity
      const orderCoreWords = extractCoreWords(productName);
      if (orderCoreWords.length > 0) {
        // Find best match by similarity score
        let bestMatch = null;
        let bestScore = 0;

        products.forEach(p => {
          if (!p.nombre) return;
          const score = calculateSimilarity(productName, p.nombre);
          if (score > bestScore) {
            bestScore = score;
            bestMatch = p;
          }
        });

        // Lower threshold to 30% for better matching of single-word products like "Mantecaria"
        if (bestMatch && bestScore >= 0.3) {
          console.log(`   üìù Match encontrado: "${productName}" ‚Üí "${bestMatch.nombre}" (score: ${(bestScore * 100).toFixed(0)}%)`);
          return bestMatch;
        }
      }

      // 3. Partial match as fallback (at least one main word in common)
      // For single-word product names, be more flexible
      const partialMatch = products.find(p => {
        if (!p.nombre) return false;
        const productWords = extractCoreWords(p.nombre);

        // If order has only one core word, match if product contains it
        if (orderCoreWords.length === 1) {
          const orderWord = orderCoreWords[0];
          return productWords.some(prodWord =>
            prodWord === orderWord ||
            (prodWord.length >= 3 && orderWord.length >= 3 &&
             (prodWord.includes(orderWord) || orderWord.includes(prodWord)))
          ) || normalizeProductName(p.nombre).includes(orderWord);
        }

        return orderCoreWords.some(orderWord =>
          productWords.some(prodWord =>
            prodWord === orderWord ||
            (prodWord.length >= 4 && orderWord.length >= 4 &&
             (prodWord.includes(orderWord) || orderWord.includes(prodWord)))
          )
        );
      });

      if (partialMatch) {
        console.log(`   üìù Match parcial: "${productName}" ‚Üí "${partialMatch.nombre}"`);
        return partialMatch;
      }

      // 4. Last resort: try matching the first significant characters of the name
      if (normalizedOrderName.length >= 4) {
        const firstChars = normalizedOrderName.substring(0, Math.min(6, normalizedOrderName.length));
        const charMatch = products.find(p => {
          if (!p.nombre) return false;
          const normalizedProductName = normalizeProductName(p.nombre);
          return normalizedProductName.startsWith(firstChars) || firstChars.startsWith(normalizedProductName.substring(0, firstChars.length));
        });
        if (charMatch) {
          console.log(`   üìù Match por prefijo: "${productName}" ‚Üí "${charMatch.nombre}"`);
          return charMatch;
        }
      }

      console.log(`   ‚ö†Ô∏è Sin match para: "${productName}" (ID: ${productId || 'N/A'})`);
      return null;
    }

    // Extract items from an order (handles single product or multi-item orders)
    function extractOrderItems(order) {
      const items = [];

      // Check for items array (multi-item orders)
      if (Array.isArray(order.items) && order.items.length > 0) {
        order.items.forEach(item => {
          items.push({
            productId: item.productId || item.id || null,
            productName: item.title || item.productName || item.nombre || '',
            quantity: Number(item.quantity) || 1,
            price: Number(item.unit_price || item.price || item.precio || 0),
            totalPrice: Number(item.unit_price || item.price || item.precio || 0) * (Number(item.quantity) || 1)
          });
        });
        return items;
      }

      // Check for productos array (alternate format)
      if (Array.isArray(order.productos) && order.productos.length > 0) {
        order.productos.forEach(item => {
          items.push({
            productId: item.productId || item.id || null,
            productName: item.title || item.productName || item.nombre || '',
            quantity: Number(item.quantity || item.cantidad) || 1,
            price: Number(item.precio || item.price || 0),
            totalPrice: Number(item.precio || item.price || 0) * (Number(item.quantity || item.cantidad) || 1)
          });
        });
        return items;
      }

      // Single product order
      const quantity = Number(order.quantity || order.cantidad) || 1;
      const unitPrice = Number(order.price || order.precio) || 0;
      const totalPrice = Number(order.totalPrice || order.priceTotal || order.amount || order.total) || (unitPrice * quantity);

      items.push({
        productId: order.productId || order.product?.id || null,
        productName: order.productName || order.product || order.nombre || '',
        quantity: quantity,
        price: unitPrice || (totalPrice / quantity),
        totalPrice: totalPrice
      });

      return items;
    }

    // Update profits report
    function updateProfitsReport() {
      const period = document.getElementById('profitsPeriodFilter')?.value || 'current';
      const filteredOrders = filterOrdersByPeriod(profitsOrders, period);

      console.log(`\nüìä ========= ACTUALIZANDO REPORTE DE GANANCIAS =========`);
      console.log(`   Per√≠odo seleccionado: ${period}`);
      console.log(`   Total √≥rdenes confirmadas: ${profitsOrders.length}`);
      console.log(`   √ìrdenes en per√≠odo: ${filteredOrders.length}`);
      console.log(`   Total productos activos: ${profitsProducts.length}`);

      // Debug: if we have orders but none pass the filter, log the dates
      if (profitsOrders.length > 0 && filteredOrders.length === 0) {
        console.warn('‚ö†Ô∏è DIAGN√ìSTICO: Hay √≥rdenes confirmadas pero ninguna pasa el filtro de per√≠odo');
        const now = new Date();
        console.log(`   Fecha actual: ${now.toISOString()}`);
        console.log(`   Mes actual: ${now.getMonth() + 1}/${now.getFullYear()}`);
        console.log('   Primeras 5 √≥rdenes con sus fechas:');
        profitsOrders.slice(0, 5).forEach((o, i) => {
          const parsedDate = parseOrderDate(o.createdAt);
          console.log(`   ${i + 1}. ${parsedDate ? parsedDate.toISOString() : 'FECHA INV√ÅLIDA'} - createdAt raw:`, o.createdAt);
        });
      }

      // Calculate stats per product - use costo and platformPercent from product document
      const productStats = {};

      profitsProducts.forEach(product => {
        productStats[product.id] = {
          product: product,
          unitsSold: 0,
          grossRevenue: 0,
          salePrice: product.precioDistribuidor || product.precio || 0,
          cost: product.costo || 0,
          platformPercent: product.platformPercent || 50
        };
      });

      // Also track unmatched products from orders
      const unmatchedProducts = {};
      let matchedOrdersCount = 0;
      let unmatchedOrdersCount = 0;

      // Aggregate order data - extract items from each order
      filteredOrders.forEach((order, orderIndex) => {
        const orderItems = extractOrderItems(order);

        orderItems.forEach(item => {
          // Try to find matching product
          const matchedProduct = findProductMatch({
            productId: item.productId,
            productName: item.productName
          }, profitsProducts);

          if (matchedProduct && productStats[matchedProduct.id]) {
            // Found matching product in our products list
            productStats[matchedProduct.id].unitsSold += item.quantity;
            productStats[matchedProduct.id].grossRevenue += item.totalPrice;
            matchedOrdersCount++;

            // Log first 5 successful matches for debugging
            if (matchedOrdersCount <= 5) {
              console.log(`   ‚úÖ Match #${matchedOrdersCount}: "${item.productName}" (ID: ${item.productId || 'N/A'}) ‚Üí "${matchedProduct.nombre}" (qty: ${item.quantity})`);
            }
          } else if (item.productName) {
            // Track unmatched product by name for reporting
            const key = (item.productName || '').toLowerCase().trim();
            if (!unmatchedProducts[key]) {
              unmatchedProducts[key] = {
                product: {
                  nombre: item.productName,
                  id: item.productId || 'desconocido'
                },
                unitsSold: 0,
                grossRevenue: 0,
                salePrice: item.price,
                cost: 0,
                platformPercent: 50,
                orders: []
              };
            }
            unmatchedProducts[key].unitsSold += item.quantity;
            unmatchedProducts[key].grossRevenue += item.totalPrice;
            unmatchedProducts[key].orders.push(order.id);
            unmatchedOrdersCount++;

            // Update price if we have a better one
            if (item.price > 0 && unmatchedProducts[key].salePrice === 0) {
              unmatchedProducts[key].salePrice = item.price;
            }

            // Log all unmatched for debugging
            console.log(`   ‚ö†Ô∏è Sin vincular: "${item.productName}" (ID: ${item.productId || 'N/A'}) - Orden: ${order.id.substring(0, 8)}...`);
          }
        });
      });

      // Debug logging for matching results
      const matchedCount = Object.values(productStats).filter(s => s.unitsSold > 0).length;
      const unmatchedCount = Object.keys(unmatchedProducts).length;
      console.log(`\nüìä RESUMEN DE VINCULACI√ìN:`);
      console.log(`   - Items vinculados correctamente: ${matchedOrdersCount}`);
      console.log(`   - Items sin vincular: ${unmatchedOrdersCount}`);
      console.log(`   - Productos con ventas: ${matchedCount}`);

      if (unmatchedCount > 0) {
        console.log(`   - Productos diferentes sin vincular: ${unmatchedCount}`);
        Object.entries(unmatchedProducts).forEach(([key, data]) => {
          console.log(`      ‚Ä¢ "${data.product.nombre}" (ID: ${data.product.id}) - ${data.unitsSold} unidades, ${data.orders.length} √≥rdenes`);
        });
      }
      console.log(`========= FIN REPORTE =========\n`);

      // Merge unmatched products into stats for display
      Object.values(unmatchedProducts).forEach(unmatched => {
        const key = `unmatched_${unmatched.product.nombre}`;
        productStats[key] = unmatched;
      });

      // Calculate totals
      let totalPlatformProfit = 0;
      let totalNetworkPayment = 0;
      let totalSales = 0;
      let productsWithSales = 0;

      // Render table
      const tableBody = document.getElementById('profitsTable');
      let tableHTML = '';

      // Separate matched products from unmatched for better display
      const matchedStats = [];
      const unmatchedStats = [];

      Object.entries(productStats).forEach(([key, stats]) => {
        if (stats.unitsSold === 0) return;
        if (key.startsWith('unmatched_')) {
          unmatchedStats.push({ key, ...stats });
        } else {
          matchedStats.push({ key, ...stats });
        }
      });

      // Render matched products first
      matchedStats.forEach(stats => {
        // Calculate benefit per unit (sale price - cost)
        const benefitPerUnit = stats.salePrice - stats.cost;
        const totalBenefit = benefitPerUnit * stats.unitsSold;

        // Split the benefit between platform and network
        const platformProfitPerUnit = benefitPerUnit > 0 ? Math.round(benefitPerUnit * (stats.platformPercent / 100)) : 0;
        const networkPaymentPerUnit = benefitPerUnit > 0 ? benefitPerUnit - platformProfitPerUnit : 0;

        const totalPlatformProfitProduct = platformProfitPerUnit * stats.unitsSold;
        const totalNetworkPaymentProduct = networkPaymentPerUnit * stats.unitsSold;

        totalSales += stats.grossRevenue;
        totalPlatformProfit += totalPlatformProfitProduct;
        totalNetworkPayment += totalNetworkPaymentProduct;
        productsWithSales++;

        const benefitColor = benefitPerUnit > 0 ? '#28a745' : (benefitPerUnit < 0 ? '#dc3545' : '#666');
        const platformColor = totalPlatformProfitProduct > 0 ? '#007bff' : '#666';

        tableHTML += `
          <tr>
            <td>
              <strong>${stats.product.nombre}</strong>
              <div style="font-size:11px;color:#999;">${stats.product.id}</div>
            </td>
            <td style="text-align:center;"><strong>${stats.unitsSold}</strong></td>
            <td style="color:#28a745;">$${stats.salePrice.toLocaleString()}</td>
            <td>${stats.cost > 0 ? '$' + stats.cost.toLocaleString() : '<span style="color:#999;">Sin configurar</span>'}</td>
            <td style="color:${benefitColor};font-weight:600;">
              ${stats.cost > 0 ? '$' + benefitPerUnit.toLocaleString() : '‚Äî'}
              ${stats.cost > 0 ? '<div style="font-size:10px;color:#999;">' + stats.platformPercent + '% / ' + (100 - stats.platformPercent) + '%</div>' : ''}
            </td>
            <td style="color:${platformColor};font-weight:700;">
              ${stats.cost > 0 ? '$' + totalPlatformProfitProduct.toLocaleString() : '‚Äî'}
              ${stats.cost > 0 ? '<div style="font-size:10px;color:#999;">$' + platformProfitPerUnit.toLocaleString() + ' x ' + stats.unitsSold + '</div>' : ''}
            </td>
            <td style="color:#fd7e14;">
              ${stats.cost > 0 ? '$' + totalNetworkPaymentProduct.toLocaleString() : '‚Äî'}
              ${stats.cost > 0 ? '<div style="font-size:10px;color:#999;">$' + networkPaymentPerUnit.toLocaleString() + ' x ' + stats.unitsSold + '</div>' : ''}
            </td>
            <td>$${stats.grossRevenue.toLocaleString()}</td>
            <td style="color:${platformColor};font-weight:700;font-size:16px;">
              ${stats.cost > 0 ? '$' + totalPlatformProfitProduct.toLocaleString() : '‚Äî'}
            </td>
          </tr>
        `;
      });

      // Render unmatched products with warning styling
      if (unmatchedStats.length > 0) {
        tableHTML += `
          <tr>
            <td colspan="9" style="background:#fff3cd;padding:12px;border-left:4px solid #ffc107;">
              <strong style="color:#856404;">‚ö†Ô∏è Productos sin Vincular (${unmatchedStats.length})</strong>
              <p style="margin:4px 0 0 0;font-size:12px;color:#856404;">
                Estos productos en √≥rdenes confirmadas no coinciden con ning√∫n producto actual.
                Posibles causas: nombre diferente, producto eliminado, o faltan datos.
              </p>
            </td>
          </tr>
        `;

        unmatchedStats.forEach(stats => {
          totalSales += stats.grossRevenue;
          productsWithSales++;

          tableHTML += `
            <tr style="background:#fffbe6;">
              <td>
                <strong style="color:#856404;">${stats.product.nombre}</strong>
                <div style="font-size:11px;color:#999;">
                  ID original: ${stats.product.id}
                  <span style="background:#ffc107;color:#856404;padding:2px 6px;border-radius:3px;font-size:10px;margin-left:8px;">SIN VINCULAR</span>
                </div>
              </td>
              <td style="text-align:center;"><strong>${stats.unitsSold}</strong></td>
              <td style="color:#28a745;">$${stats.salePrice.toLocaleString()}</td>
              <td><span style="color:#999;">N/A</span></td>
              <td><span style="color:#999;">‚Äî</span></td>
              <td><span style="color:#999;">‚Äî</span></td>
              <td><span style="color:#999;">‚Äî</span></td>
              <td>$${stats.grossRevenue.toLocaleString()}</td>
              <td><span style="color:#999;">‚Äî</span></td>
            </tr>
          `;
        });
      }

      if (tableHTML === '') {
        tableHTML = '<tr><td colspan="9" class="empty-state">No hay ventas en este per√≠odo</td></tr>';
      }

      tableBody.innerHTML = tableHTML;

      // Update summary cards
      document.getElementById('profitsTotalProfit').textContent = `$${totalPlatformProfit.toLocaleString()}`;
      document.getElementById('profitsTotalProfit').style.color = totalPlatformProfit >= 0 ? '#28a745' : '#dc3545';
      document.getElementById('profitsTotalSales').textContent = `$${totalSales.toLocaleString()}`;
      document.getElementById('profitsTotalNetwork').textContent = `$${totalNetworkPayment.toLocaleString()}`;

      // Calculate average margin as percentage of sales
      const avgMargin = totalSales > 0 ? (totalPlatformProfit / totalSales * 100) : 0;
      document.getElementById('profitsAvgMargin').textContent = `${avgMargin.toFixed(1)}%`;

      // Update monthly report
      renderMonthlyProfitsChart();
    }

    // Render monthly profits chart - uses historical closures if available, otherwise calculates on-the-fly
    function renderMonthlyProfitsChart() {
      const container = document.getElementById('profitsMonthlyReport');

      // Group orders by month
      const monthlyData = {};
      const now = new Date();

      // Initialize last 6 months
      for (let i = 5; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        const monthName = date.toLocaleDateString('es-CO', { month: 'short', year: 'numeric' });
        monthlyData[key] = { name: monthName, revenue: 0, platformProfit: 0, networkPayment: 0, fromClosure: false };
      }

      // First, try to fill from monthly closures
      if (monthlyEarningsClosures && monthlyEarningsClosures.length > 0) {
        monthlyEarningsClosures.forEach(closure => {
          const key = `${closure.year}-${String(closure.month).padStart(2, '0')}`;
          if (monthlyData[key]) {
            monthlyData[key].revenue = closure.totalRevenue || 0;
            monthlyData[key].platformProfit = closure.totalPlatformProfit || 0;
            monthlyData[key].networkPayment = closure.totalNetworkPayment || 0;
            monthlyData[key].fromClosure = true;
          }
        });
      }

      // For months without closures, calculate from orders
      profitsOrders.forEach(order => {
        if (!order.createdAt) return;
        const orderDate = parseOrderDate(order.createdAt);
        if (!orderDate) return;
        const key = `${orderDate.getFullYear()}-${String(orderDate.getMonth() + 1).padStart(2, '0')}`;

        // Only calculate if this month doesn't have a closure already
        if (monthlyData[key] && !monthlyData[key].fromClosure) {
          // Extract items from order using the helper function
          const orderItems = extractOrderItems(order);

          orderItems.forEach(item => {
            // Find matching product
            const matchedProduct = findProductMatch({
              productId: item.productId,
              productName: item.productName
            }, profitsProducts);

            // Get cost config from product document
            const productCost = matchedProduct ? (matchedProduct.costo || 0) : 0;
            const platformPercent = matchedProduct ? (matchedProduct.platformPercent || 50) : 50;

            // Get sale price from matched product or from order item
            const salePrice = matchedProduct
              ? (matchedProduct.precioDistribuidor || matchedProduct.precio || item.price || 0)
              : item.price || 0;

            // Calculate benefit and split
            const benefitPerUnit = salePrice - productCost;
            const platformProfitPerUnit = benefitPerUnit > 0 ? Math.round(benefitPerUnit * (platformPercent / 100)) : 0;
            const networkPaymentPerUnit = benefitPerUnit > 0 ? benefitPerUnit - platformProfitPerUnit : 0;

            monthlyData[key].revenue += item.totalPrice;
            monthlyData[key].platformProfit += platformProfitPerUnit * item.quantity;
            monthlyData[key].networkPayment += networkPaymentPerUnit * item.quantity;
          });
        }
      });

      // Find max for scaling
      const maxProfit = Math.max(...Object.values(monthlyData).map(d => Math.abs(d.platformProfit)), 1);

      let html = '<div style="display:flex;gap:12px;align-items:flex-end;justify-content:space-around;min-height:200px;padding:20px 0;">';

      Object.values(monthlyData).forEach(data => {
        const height = Math.abs(data.platformProfit) / maxProfit * 150;
        const color = data.platformProfit >= 0 ? '#007bff' : '#dc3545';
        const closureIcon = data.fromClosure ? 'üìÅ' : '';

        html += `
          <div style="display:flex;flex-direction:column;align-items:center;flex:1;">
            <div style="font-weight:700;margin-bottom:8px;color:${color};">$${data.platformProfit.toLocaleString()} ${closureIcon}</div>
            <div style="width:100%;max-width:60px;height:${Math.max(height, 10)}px;background:${color};border-radius:4px 4px 0 0;"></div>
            <div style="font-size:12px;color:#666;margin-top:8px;text-align:center;">${data.name}</div>
            <div style="font-size:11px;color:#999;">Ventas: $${data.revenue.toLocaleString()}</div>
            <div style="font-size:10px;color:#fd7e14;">Red: $${data.networkPayment.toLocaleString()}</div>
          </div>
        `;
      });

      html += '</div>';

      // Add legend and generate closure button
      html += `
        <div style="margin-top:16px;padding:12px;background:#f8f9fa;border-radius:6px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
          <div style="font-size:12px;color:#666;">
            <span style="margin-right:16px;">üìÅ = Datos de cierre mensual guardado</span>
          </div>
          <button id="generateMonthlyClosureBtn" onclick="generateMonthlyEarningsClosure()" style="background:linear-gradient(135deg,#28a745,#218838);color:white;border:none;padding:10px 20px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;">
            Generar Cierre del Mes Anterior
          </button>
        </div>
      `;

      container.innerHTML = html;
    }

    // Generate monthly earnings closure for the previous month
    window.generateMonthlyEarningsClosure = async function() {
      const now = new Date();
      const prevMonth = now.getMonth() === 0 ? 11 : now.getMonth() - 1;
      const prevYear = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
      const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

      // Check if closure already exists
      const existingClosure = monthlyEarningsClosures.find(c => c.month === prevMonth + 1 && c.year === prevYear);
      if (existingClosure) {
        if (!confirm(`Ya existe un cierre para ${monthNames[prevMonth]} ${prevYear}. ¬øDesea regenerarlo?`)) {
          return;
        }
      }

      // Filter orders for the previous month
      const startOfMonth = new Date(prevYear, prevMonth, 1, 0, 0, 0, 0);
      const endOfMonth = new Date(prevYear, prevMonth + 1, 1, 0, 0, 0, 0);

      const monthOrders = profitsOrders.filter(order => {
        if (!order.createdAt) return false;
        const orderDate = parseOrderDate(order.createdAt);
        if (!orderDate) return false;
        return orderDate >= startOfMonth && orderDate < endOfMonth;
      });

      // Calculate totals and per-product breakdown
      let totalRevenue = 0;
      let totalPlatformProfit = 0;
      let totalNetworkPayment = 0;
      const productBreakdown = {};

      monthOrders.forEach(order => {
        const orderItems = extractOrderItems(order);
        orderItems.forEach(item => {
          const matchedProduct = findProductMatch({
            productId: item.productId,
            productName: item.productName
          }, profitsProducts);

          const productCost = matchedProduct ? (matchedProduct.costo || 0) : 0;
          const platformPercent = matchedProduct ? (matchedProduct.platformPercent || 50) : 50;
          const salePrice = matchedProduct
            ? (matchedProduct.precioDistribuidor || matchedProduct.precio || item.price || 0)
            : item.price || 0;

          const benefitPerUnit = salePrice - productCost;
          const platformProfitPerUnit = benefitPerUnit > 0 ? Math.round(benefitPerUnit * (platformPercent / 100)) : 0;
          const networkPaymentPerUnit = benefitPerUnit > 0 ? benefitPerUnit - platformProfitPerUnit : 0;

          totalRevenue += item.totalPrice;
          totalPlatformProfit += platformProfitPerUnit * item.quantity;
          totalNetworkPayment += networkPaymentPerUnit * item.quantity;

          // Track per-product
          const productKey = matchedProduct ? matchedProduct.id : (item.productName || 'unknown');
          if (!productBreakdown[productKey]) {
            productBreakdown[productKey] = {
              productId: productKey,
              productName: matchedProduct ? matchedProduct.nombre : item.productName,
              unitsSold: 0,
              revenue: 0,
              platformProfit: 0,
              networkPayment: 0,
              cost: productCost,
              platformPercent: platformPercent
            };
          }
          productBreakdown[productKey].unitsSold += item.quantity;
          productBreakdown[productKey].revenue += item.totalPrice;
          productBreakdown[productKey].platformProfit += platformProfitPerUnit * item.quantity;
          productBreakdown[productKey].networkPayment += networkPaymentPerUnit * item.quantity;
        });
      });

      // Create closure document
      const closureData = {
        month: prevMonth + 1,
        monthName: monthNames[prevMonth],
        year: prevYear,
        createdAt: serverTimestamp(),
        createdAtIso: new Date().toISOString(),
        totalOrders: monthOrders.length,
        totalRevenue: totalRevenue,
        totalPlatformProfit: totalPlatformProfit,
        totalNetworkPayment: totalNetworkPayment,
        averageMargin: totalRevenue > 0 ? (totalPlatformProfit / totalRevenue * 100) : 0,
        productBreakdown: Object.values(productBreakdown),
        createdBy: currentUser?.uid || 'system'
      };

      try {
        // Use the compound key for the document ID
        const closureId = `${prevYear}-${String(prevMonth + 1).padStart(2, '0')}`;

        if (existingClosure) {
          await updateDoc(doc(db, 'monthlyEarningsClosures', existingClosure.id), closureData);
        } else {
          await setDoc(doc(db, 'monthlyEarningsClosures', closureId), closureData);
        }

        alert(`Cierre de ${monthNames[prevMonth]} ${prevYear} generado correctamente.\n\nResumen:\n- Ordenes: ${monthOrders.length}\n- Ventas: $${totalRevenue.toLocaleString()}\n- Ganancia Plataforma: $${totalPlatformProfit.toLocaleString()}\n- Pago Red: $${totalNetworkPayment.toLocaleString()}`);

        // Reload data
        await loadProfitsData();
      } catch (err) {
        console.error('Error generando cierre mensual:', err);
        alert('Error al generar cierre mensual: ' + err.message);
      }
    };

    // Listen for period filter changes
    document.getElementById('profitsPeriodFilter')?.addEventListener('change', updateProfitsReport);

    // ============================================
    // PURGE REPORTS SECTION (Commissions Deleted by Inactivity)
    // ============================================

    let purgeReportsData = [];

    // Load purge reports from Firestore
    async function loadPurgeReports() {
      const container = document.getElementById('purgeReportsList');
      try {
        const purgeSnap = await getDocs(query(
          collection(db, 'commissionsPurged'),
          orderBy('executedAt', 'desc')
        ));

        purgeReportsData = purgeSnap.docs.map(d => ({
          id: d.id,
          ...d.data()
        }));

        console.log(`üìä Loaded ${purgeReportsData.length} purge reports`);
        renderPurgeReports();
      } catch (err) {
        console.error('Error loading purge reports:', err);
        container.innerHTML = '<div style="text-align:center;color:#dc3545;padding:20px;">Error al cargar informes de purga</div>';
      }
    }

    // Filter purge reports based on selection
    function filterPurgeReports() {
      const filter = document.getElementById('purgeReportFilter')?.value || 'all';
      const now = new Date();
      const currentYear = now.getFullYear();

      return purgeReportsData.filter(report => {
        if (filter === 'all') return true;
        if (filter === 'current_year') return report.year === currentYear;
        if (filter === 'last_3') {
          // Last 3 months
          const reportDate = new Date(report.year, report.month - 1, 1);
          const threeMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 3, 1);
          return reportDate >= threeMonthsAgo;
        }
        return true;
      });
    }

    // Render purge reports
    function renderPurgeReports() {
      const container = document.getElementById('purgeReportsList');
      const filtered = filterPurgeReports();

      // Update summary stats
      let totalAmount = 0;
      let totalPoints = 0;
      let totalUsers = 0;

      filtered.forEach(report => {
        totalAmount += report.totalPurgedAmount || 0;
        totalPoints += report.totalPurgedPoints || 0;
        totalUsers += (report.purgedUsers || []).length;
      });

      document.getElementById('purgeReportCount').textContent = filtered.length;
      document.getElementById('purgeTotalAmount').textContent = `$${totalAmount.toLocaleString()}`;
      document.getElementById('purgeTotalPoints').textContent = totalPoints.toFixed(2);
      document.getElementById('purgeTotalUsers').textContent = totalUsers;

      if (filtered.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#666;padding:40px;">No hay informes de comisiones eliminadas. Estos se generan autom√°ticamente el d√≠a 1 de cada mes para distribuidores que no se activaron el mes anterior.</div>';
        return;
      }

      let html = '';

      filtered.forEach(report => {
        const executedDate = report.executedAt?.seconds
          ? new Date(report.executedAt.seconds * 1000).toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })
          : 'Fecha desconocida';

        html += `
          <div style="border:1px solid #e0e0e0;border-radius:8px;margin-bottom:16px;overflow:hidden;">
            <div style="background:linear-gradient(135deg,#f8f9fa,#e9ecef);padding:16px;border-bottom:1px solid #e0e0e0;">
              <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;">
                <div>
                  <h4 style="margin:0;color:#333;">${report.monthName} ${report.year}</h4>
                  <small style="color:#666;">Ejecutado: ${executedDate}</small>
                </div>
                <div style="display:flex;gap:16px;flex-wrap:wrap;">
                  <div style="text-align:center;">
                    <div style="font-size:11px;color:#666;text-transform:uppercase;">Distribuidores</div>
                    <div style="font-weight:700;color:#333;">${report.totalDistributors || 0}</div>
                  </div>
                  <div style="text-align:center;">
                    <div style="font-size:11px;color:#28a745;text-transform:uppercase;">Activos</div>
                    <div style="font-weight:700;color:#28a745;">${report.activeDistributors || 0}</div>
                  </div>
                  <div style="text-align:center;">
                    <div style="font-size:11px;color:#dc3545;text-transform:uppercase;">Inactivos</div>
                    <div style="font-weight:700;color:#dc3545;">${report.inactiveDistributors || 0}</div>
                  </div>
                  <div style="text-align:center;">
                    <div style="font-size:11px;color:#6c757d;text-transform:uppercase;">Purgados</div>
                    <div style="font-weight:700;color:#c62828;">${(report.purgedUsers || []).length}</div>
                  </div>
                  <div style="text-align:center;">
                    <div style="font-size:11px;color:#6c757d;text-transform:uppercase;">Total Eliminado</div>
                    <div style="font-weight:700;color:#c62828;">$${(report.totalPurgedAmount || 0).toLocaleString()}</div>
                  </div>
                </div>
              </div>
            </div>

            ${(report.purgedUsers || []).length > 0 ? `
              <div style="padding:0;">
                <button onclick="togglePurgeDetails('${report.id}')"
                        style="width:100%;padding:12px;background:#fff;border:none;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-size:14px;color:#333;border-bottom:1px solid #e0e0e0;">
                  <span>Ver detalles de ${(report.purgedUsers || []).length} usuarios afectados</span>
                  <span id="purge-toggle-${report.id}">‚ñº</span>
                </button>
                <div id="purge-details-${report.id}" style="display:none;">
                  <table style="width:100%;border-collapse:collapse;font-size:13px;">
                    <thead>
                      <tr style="background:#fafafa;">
                        <th style="padding:10px;text-align:left;border-bottom:1px solid #e0e0e0;">Usuario</th>
                        <th style="padding:10px;text-align:left;border-bottom:1px solid #e0e0e0;">Email</th>
                        <th style="padding:10px;text-align:right;border-bottom:1px solid #e0e0e0;">Monto Eliminado</th>
                        <th style="padding:10px;text-align:right;border-bottom:1px solid #e0e0e0;">Puntos Eliminados</th>
                        <th style="padding:10px;text-align:center;border-bottom:1px solid #e0e0e0;">Comisiones</th>
                        <th style="padding:10px;text-align:center;border-bottom:1px solid #e0e0e0;">Detalles</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${(report.purgedUsers || []).map(user => `
                        <tr style="border-bottom:1px solid #f0f0f0;">
                          <td style="padding:10px;">
                            <div style="font-weight:500;">${user.username || 'Sin nombre'}</div>
                            <div style="font-size:11px;color:#666;">${user.userId ? user.userId.substring(0, 10) + '...' : ''}</div>
                          </td>
                          <td style="padding:10px;color:#666;">${user.email || '-'}</td>
                          <td style="padding:10px;text-align:right;color:#c62828;font-weight:500;">$${(user.purgedAmount || 0).toLocaleString()}</td>
                          <td style="padding:10px;text-align:right;color:#ef6c00;">${(user.purgedPoints || 0).toFixed(2)}</td>
                          <td style="padding:10px;text-align:center;">${user.commissionsCount || 0}</td>
                          <td style="padding:10px;text-align:center;">
                            <button onclick="showPurgedCommissions('${report.id}', '${user.userId}')"
                                    style="padding:4px 8px;font-size:11px;background:#6c757d;color:#fff;border:none;border-radius:4px;cursor:pointer;">
                              Ver
                            </button>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            ` : '<div style="padding:16px;text-align:center;color:#666;">No hubo usuarios purgados en este per√≠odo</div>'}
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Toggle purge report details
    window.togglePurgeDetails = function(reportId) {
      const details = document.getElementById(`purge-details-${reportId}`);
      const toggle = document.getElementById(`purge-toggle-${reportId}`);
      if (details.style.display === 'none') {
        details.style.display = 'block';
        toggle.textContent = '‚ñ≤';
      } else {
        details.style.display = 'none';
        toggle.textContent = '‚ñº';
      }
    };

    // Show purged commissions details for a specific user
    window.showPurgedCommissions = function(reportId, userId) {
      const report = purgeReportsData.find(r => r.id === reportId);
      if (!report) return;

      const user = (report.purgedUsers || []).find(u => u.userId === userId);
      if (!user) return;

      const commissions = user.purgedCommissions || [];

      let tableRows = commissions.map(c => `
        <tr>
          <td style="padding:8px;border:1px solid #ddd;">${c.type || '-'}</td>
          <td style="padding:8px;border:1px solid #ddd;">${c.action || '-'}</td>
          <td style="padding:8px;border:1px solid #ddd;text-align:right;">$${(c.amount || 0).toLocaleString()}</td>
          <td style="padding:8px;border:1px solid #ddd;text-align:right;">${(c.points || 0).toFixed(2)}</td>
          <td style="padding:8px;border:1px solid #ddd;">${c.date ? new Date(c.date).toLocaleDateString('es-CO') : '-'}</td>
          <td style="padding:8px;border:1px solid #ddd;">${c.fromUser || '-'}</td>
        </tr>
      `).join('');

      if (commissions.length === 0) {
        tableRows = '<tr><td colspan="6" style="padding:20px;text-align:center;color:#666;">No hay detalles disponibles</td></tr>';
      }

      Swal.fire({
        title: `Comisiones Eliminadas - ${user.username || 'Usuario'}`,
        html: `
          <div style="text-align:left;margin-bottom:16px;">
            <p><strong>Balance anterior:</strong> $${(user.previousBalance || 0).toLocaleString()}</p>
            <p><strong>Balance nuevo:</strong> $${(user.newBalance || 0).toLocaleString()}</p>
            <p><strong>Puntos grupales anteriores:</strong> ${(user.previousGroupPoints || 0).toFixed(2)}</p>
            <p><strong>Puntos grupales nuevos:</strong> ${(user.newGroupPoints || 0).toFixed(2)}</p>
          </div>
          <div style="max-height:300px;overflow-y:auto;">
            <table style="width:100%;border-collapse:collapse;font-size:12px;">
              <thead>
                <tr style="background:#f5f5f5;">
                  <th style="padding:8px;border:1px solid #ddd;text-align:left;">Tipo</th>
                  <th style="padding:8px;border:1px solid #ddd;text-align:left;">Descripci√≥n</th>
                  <th style="padding:8px;border:1px solid #ddd;text-align:right;">Monto</th>
                  <th style="padding:8px;border:1px solid #ddd;text-align:right;">Puntos</th>
                  <th style="padding:8px;border:1px solid #ddd;">Fecha</th>
                  <th style="padding:8px;border:1px solid #ddd;">De Usuario</th>
                </tr>
              </thead>
              <tbody>
                ${tableRows}
              </tbody>
            </table>
          </div>
        `,
        width: '800px',
        confirmButtonText: 'Cerrar'
      });
    };

    // Listen for purge report filter changes
    document.getElementById('purgeReportFilter')?.addEventListener('change', renderPurgeReports);

    // Initialize purge month/year selectors with current previous month as default
    function initPurgeMonthYearSelectors() {
      const monthSelect = document.getElementById('purgeMonthSelect');
      const yearSelect = document.getElementById('purgeYearSelect');

      if (!monthSelect || !yearSelect) return;

      const now = new Date();
      const currentYear = now.getFullYear();

      // Populate year dropdown (current year and 2 previous years)
      yearSelect.innerHTML = '';
      for (let y = currentYear; y >= currentYear - 2; y--) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        yearSelect.appendChild(opt);
      }

      // Set default to previous month
      const prevMonth = now.getMonth() === 0 ? 11 : now.getMonth() - 1;
      const prevYear = now.getMonth() === 0 ? currentYear - 1 : currentYear;

      monthSelect.value = prevMonth;
      yearSelect.value = prevYear;
    }

    // Initialize selectors when DOM is ready
    initPurgeMonthYearSelectors();

    // Load purge reports when profits tab is activated (add to existing load)
    const profitsTabBtn = document.querySelector('[data-tab="profits"]');
    if (profitsTabBtn) {
      profitsTabBtn.addEventListener('click', () => {
        loadPurgeReports();
      });
    }

    // Execute manual purge of inactive commissions - now with preview/confirmation flow
    let purgePreviewData = null; // Store preview data for confirmation
    let selectedPurgeMonth = null; // Store selected month for confirmation step
    let selectedPurgeYear = null; // Store selected year for confirmation step

    async function executeManualPurge() {
      // Get selected month and year from the dropdowns
      const monthSelect = document.getElementById('purgeMonthSelect');
      const yearSelect = document.getElementById('purgeYearSelect');

      const selectedMonth = parseInt(monthSelect.value, 10); // 0-11
      const selectedYear = parseInt(yearSelect.value, 10);

      const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      const monthName = monthNames[selectedMonth];

      // Store selected values for confirmation step
      selectedPurgeMonth = selectedMonth;
      selectedPurgeYear = selectedYear;

      // First, show loading and fetch preview
      const btn = document.getElementById('manualPurgeBtn');
      const originalContent = btn.innerHTML;
      btn.innerHTML = '<span style="font-size:16px;">‚è≥</span> Generando vista previa...';
      btn.disabled = true;
      btn.style.opacity = '0.7';

      try {
        // Get current admin user info for audit
        const currentUser = auth.currentUser;
        const adminUserId = currentUser ? currentUser.uid : null;
        const adminEmail = currentUser ? currentUser.email : null;

        // Fetch preview first (no changes are made) - pass selected month/year
        const previewResponse = await fetch('/.netlify/functions/purge-inactive-commissions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'preview',
            month: selectedMonth,
            year: selectedYear,
            adminUserId: adminUserId,
            adminEmail: adminEmail
          })
        });

        const previewData = await previewResponse.json();

        if (!previewData.success) {
          throw new Error(previewData.error || 'Error al generar vista previa');
        }

        // Store preview data for confirmation step
        purgePreviewData = previewData;

        // Build the preview report HTML
        const usersToAffect = previewData.preview?.usersToAffect || [];
        const summary = previewData.summary;
        const period = previewData.period;

        let usersTableHtml = '';
        if (usersToAffect.length > 0) {
          usersTableHtml = `
            <div style="max-height:250px;overflow-y:auto;margin-top:15px;border:1px solid #ddd;border-radius:6px;">
              <table style="width:100%;border-collapse:collapse;font-size:12px;">
                <thead style="position:sticky;top:0;background:#f5f5f5;">
                  <tr>
                    <th style="padding:8px;text-align:left;border-bottom:2px solid #ddd;">Usuario</th>
                    <th style="padding:8px;text-align:center;border-bottom:2px solid #ddd;">Estado</th>
                    <th style="padding:8px;text-align:center;border-bottom:2px solid #ddd;">Pts. Mes</th>
                    <th style="padding:8px;text-align:right;border-bottom:2px solid #ddd;">Balance Actual</th>
                    <th style="padding:8px;text-align:right;border-bottom:2px solid #ddd;">A Eliminar</th>
                    <th style="padding:8px;text-align:center;border-bottom:2px solid #ddd;">Comisiones</th>
                  </tr>
                </thead>
                <tbody>
                  ${usersToAffect.map(u => `
                    <tr style="border-bottom:1px solid #eee;">
                      <td style="padding:8px;">
                        <div style="font-weight:600;">${u.username}</div>
                        <div style="font-size:10px;color:#666;">${u.email}</div>
                      </td>
                      <td style="padding:8px;text-align:center;">
                        <span style="background:#ffebee;color:#c62828;padding:2px 8px;border-radius:10px;font-size:11px;">
                          Inactivo
                        </span>
                      </td>
                      <td style="padding:8px;text-align:center;font-weight:600;color:#ef6c00;">
                        ${u.monthlyPoints || 0}/10
                      </td>
                      <td style="padding:8px;text-align:right;">$${u.previousBalance?.toLocaleString() || 0}</td>
                      <td style="padding:8px;text-align:right;color:#c62828;font-weight:600;">
                        -$${u.purgedAmount?.toLocaleString() || 0}
                      </td>
                      <td style="padding:8px;text-align:center;">${u.commissionsCount || 0}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        } else {
          usersTableHtml = `
            <div style="background:#e8f5e9;padding:15px;border-radius:6px;text-align:center;margin-top:15px;">
              <span style="font-size:20px;">‚úÖ</span>
              <p style="margin:10px 0 0;color:#2e7d32;font-weight:500;">
                No hay usuarios que cumplan las condiciones de purga para ${period.monthName} ${period.year}.
              </p>
            </div>
          `;
        }

        // Show the preview modal
        const result = await Swal.fire({
          title: 'üìã Vista Previa de Purga',
          html: `
            <div style="text-align:left;font-size:14px;">
              <div style="background:#fff3e0;padding:12px;border-radius:8px;margin-bottom:15px;border-left:4px solid #ef6c00;">
                <strong>‚ö†Ô∏è IMPORTANTE:</strong> Este es solo un reporte informativo. No se han realizado cambios todav√≠a.
              </div>

              <div style="background:#f5f5f5;padding:12px;border-radius:8px;margin-bottom:15px;">
                <strong>üìÖ Periodo a purgar:</strong> ${period.monthName} ${period.year}<br>
                <span style="font-size:12px;color:#666;">
                  (${new Date(period.startDate).toLocaleDateString()} - ${new Date(period.endDate).toLocaleDateString()})
                </span>
              </div>

              <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:15px;">
                <div style="background:#e3f2fd;padding:10px;border-radius:6px;text-align:center;">
                  <div style="font-size:11px;color:#1565c0;">Total Distribuidores</div>
                  <div style="font-size:18px;font-weight:700;color:#1565c0;">${summary.totalDistributors}</div>
                </div>
                <div style="background:#e8f5e9;padding:10px;border-radius:6px;text-align:center;">
                  <div style="font-size:11px;color:#2e7d32;">Activos (10+ pts)</div>
                  <div style="font-size:18px;font-weight:700;color:#2e7d32;">${summary.activeDistributors}</div>
                </div>
                <div style="background:#ffebee;padding:10px;border-radius:6px;text-align:center;">
                  <div style="font-size:11px;color:#c62828;">A Purgar</div>
                  <div style="font-size:18px;font-weight:700;color:#c62828;">${summary.purgedUsers}</div>
                </div>
              </div>

              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;">
                <div style="background:#fff3e0;padding:10px;border-radius:6px;text-align:center;">
                  <div style="font-size:11px;color:#ef6c00;">COP a Eliminar</div>
                  <div style="font-size:16px;font-weight:700;color:#ef6c00;">$${summary.totalPurgedAmount?.toLocaleString() || 0}</div>
                </div>
                <div style="background:#fce4ec;padding:10px;border-radius:6px;text-align:center;">
                  <div style="font-size:11px;color:#ad1457;">Puntos a Eliminar</div>
                  <div style="font-size:16px;font-weight:700;color:#ad1457;">${summary.totalPurgedPoints?.toFixed(2) || 0}</div>
                </div>
              </div>

              <h4 style="margin:15px 0 10px;border-bottom:1px solid #ddd;padding-bottom:5px;">
                üë• Usuarios Afectados (${usersToAffect.length})
              </h4>
              ${usersTableHtml}

              ${usersToAffect.length > 0 ? `
                <div style="background:#ffebee;padding:12px;border-radius:8px;margin-top:15px;border-left:4px solid #c62828;">
                  <strong style="color:#c62828;">üö® Esta accion NO se puede deshacer.</strong><br>
                  <span style="font-size:12px;">Para confirmar la purga, presione el boton "Confirmar Purga".</span>
                </div>
              ` : ''}
            </div>
          `,
          icon: 'info',
          width: '700px',
          showCancelButton: true,
          showConfirmButton: usersToAffect.length > 0,
          confirmButtonColor: '#c62828',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'üóëÔ∏è Confirmar Purga',
          cancelButtonText: usersToAffect.length > 0 ? 'Cancelar' : 'Cerrar'
        });

        // If confirmed, execute the actual purge
        if (result.isConfirmed && usersToAffect.length > 0) {
          await executeConfirmedPurge(adminUserId, adminEmail);
        }

      } catch (err) {
        console.error('Error generating purge preview:', err);
        Swal.fire({
          title: 'Error',
          text: `No se pudo generar la vista previa: ${err.message}`,
          icon: 'error',
          confirmButtonText: 'Cerrar'
        });
      } finally {
        btn.innerHTML = originalContent;
        btn.disabled = false;
        btn.style.opacity = '1';
      }
    }

    // Execute the confirmed purge (called after preview confirmation)
    async function executeConfirmedPurge(adminUserId, adminEmail) {
      const btn = document.getElementById('manualPurgeBtn');
      const originalContent = btn.innerHTML;
      btn.innerHTML = '<span style="font-size:16px;">üîÑ</span> Ejecutando purga...';
      btn.disabled = true;
      btn.style.opacity = '0.7';

      try {
        const response = await fetch('/.netlify/functions/purge-inactive-commissions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'execute',
            month: selectedPurgeMonth,
            year: selectedPurgeYear,
            adminUserId: adminUserId,
            adminEmail: adminEmail
          })
        });

        const data = await response.json();

        if (data.success) {
          const period = data.period;
          const summary = data.summary;

          await Swal.fire({
            title: '‚úÖ Purga Completada',
            html: `
              <div style="text-align:left;font-size:14px;">
                <div style="background:#e8f5e9;padding:12px;border-radius:8px;margin-bottom:15px;border-left:4px solid #4caf50;">
                  <strong>La purga se ha ejecutado correctamente.</strong>
                </div>

                <p><strong>üìÖ Mes procesado:</strong> ${period.monthName} ${period.year}</p>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:15px;">
                  <div style="background:#e8f5e9;padding:10px;border-radius:6px;text-align:center;">
                    <div style="font-size:12px;color:#2e7d32;">Distribuidores Activos</div>
                    <div style="font-size:20px;font-weight:700;color:#2e7d32;">${summary.activeDistributors}</div>
                  </div>
                  <div style="background:#ffebee;padding:10px;border-radius:6px;text-align:center;">
                    <div style="font-size:12px;color:#c62828;">Usuarios Purgados</div>
                    <div style="font-size:20px;font-weight:700;color:#c62828;">${summary.purgedUsers}</div>
                  </div>
                  <div style="background:#fff3e0;padding:10px;border-radius:6px;text-align:center;">
                    <div style="font-size:12px;color:#ef6c00;">Total COP Eliminado</div>
                    <div style="font-size:20px;font-weight:700;color:#ef6c00;">$${summary.totalPurgedAmount?.toLocaleString() || 0}</div>
                  </div>
                  <div style="background:#fce4ec;padding:10px;border-radius:6px;text-align:center;">
                    <div style="font-size:12px;color:#ad1457;">Puntos Eliminados</div>
                    <div style="font-size:20px;font-weight:700;color:#ad1457;">${summary.totalPurgedPoints?.toFixed(2) || 0}</div>
                  </div>
                </div>

                <div style="background:#e3f2fd;padding:10px;border-radius:6px;margin-top:15px;font-size:12px;">
                  <strong>üìù Registro de Auditoria:</strong><br>
                  <span style="color:#666;">Esta accion ha sido registrada con fecha, hora y administrador para auditoria interna.</span>
                </div>
              </div>
            `,
            icon: 'success',
            confirmButtonText: 'Cerrar'
          });

          // Reload purge reports to show the new entry
          await loadPurgeReports();
        } else {
          throw new Error(data.error || 'Error desconocido');
        }
      } catch (err) {
        console.error('Error executing manual purge:', err);
        Swal.fire({
          title: 'Error',
          text: `No se pudo ejecutar la purga: ${err.message}`,
          icon: 'error',
          confirmButtonText: 'Cerrar'
        });
      } finally {
        btn.innerHTML = originalContent;
        btn.disabled = false;
        btn.style.opacity = '1';
        purgePreviewData = null; // Clear preview data
      }
    }

    // Make the function globally accessible
    window.executeManualPurge = executeManualPurge;

    // ========== EDUCACI√ìN MANAGEMENT ==========
    let educationData = [];
    let currentEducationFilter = 'all';

    // Load education content
    async function loadEducationContent() {
      const container = document.getElementById('educationList');
      if (!container) return;

      try {
        const q = query(
          collection(db, 'educacion'),
          orderBy('fecha', 'desc')
        );
        const snapshot = await getDocs(q);

        educationData = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        renderEducationList();
      } catch (error) {
        console.error('Error loading education content:', error);
        container.innerHTML = '<div style="text-align:center;color:#dc3545;padding:40px;">Error al cargar contenido educativo</div>';
      }
    }

    // Render education list based on filter
    function renderEducationList() {
      const container = document.getElementById('educationList');
      if (!container) return;

      const filteredData = currentEducationFilter === 'all'
        ? educationData
        : educationData.filter(item => item.tipo === currentEducationFilter);

      if (filteredData.length === 0) {
        container.innerHTML = `
          <div style="text-align:center;color:#666;padding:60px;background:white;border-radius:12px;">
            <div style="font-size:48px;margin-bottom:12px;">üì≠</div>
            <p style="margin:0;font-size:16px;">No hay contenido educativo${currentEducationFilter !== 'all' ? ' en esta categor√≠a' : ''}.</p>
            <p style="margin:8px 0 0 0;font-size:14px;color:#999;">Usa el bot√≥n "Agregar Enlace" para crear el primer recurso.</p>
          </div>
        `;
        return;
      }

      const typeIcons = {
        video: 'üé¨',
        libro: 'üìö',
        documento: 'üìÑ',
        pec: 'üìã',
        link: 'üîó'
      };

      const typeLabels = {
        video: 'Video',
        libro: 'Libro',
        documento: 'Documento',
        pec: 'PEC',
        link: 'Enlace'
      };

      container.innerHTML = filteredData.map(item => {
        const icon = typeIcons[item.tipo] || 'üìù';
        const label = typeLabels[item.tipo] || item.tipo;
        const isActive = item.activo !== false;
        const fecha = item.fecha?.toDate ? item.fecha.toDate().toLocaleDateString('es-ES') : 'Sin fecha';

        return `
          <div class="education-item" data-id="${item.id}" style="background:white;border-radius:12px;padding:20px;display:flex;align-items:center;gap:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);${!isActive ? 'opacity:0.6;' : ''}">
            <div style="font-size:32px;width:56px;height:56px;display:flex;align-items:center;justify-content:center;background:#f8fafc;border-radius:12px;">${icon}</div>
            <div style="flex:1;min-width:0;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                <h4 style="margin:0;font-size:16px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(item.titulo || 'Sin t√≠tulo')}</h4>
                <span style="background:${isActive ? '#dcfce7' : '#fef2f2'};color:${isActive ? '#166534' : '#dc2626'};padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;">${isActive ? 'Activo' : 'Inactivo'}</span>
              </div>
              <p style="margin:0 0 4px 0;font-size:13px;color:#666;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(item.descripcion || 'Sin descripci√≥n')}</p>
              <div style="display:flex;gap:12px;font-size:12px;color:#999;">
                <span style="background:#f1f5f9;padding:2px 8px;border-radius:4px;">${label}</span>
                <span>${fecha}</span>
                <a href="${escapeHtml(item.url || '#')}" target="_blank" rel="noopener" style="color:#667eea;text-decoration:none;overflow:hidden;text-overflow:ellipsis;max-width:200px;display:inline-block;white-space:nowrap;">Ver enlace ‚Üí</a>
              </div>
            </div>
            <div style="display:flex;gap:8px;">
              <button onclick="editEducation('${item.id}')" class="btn-primary" style="padding:8px 16px;font-size:13px;border-radius:6px;">Editar</button>
              <button onclick="deleteEducation('${item.id}')" class="btn-danger" style="padding:8px 16px;font-size:13px;border-radius:6px;">Eliminar</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Education filter buttons
    document.querySelectorAll('.edu-filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.edu-filter-btn').forEach(b => {
          b.classList.remove('active');
          b.style.background = '#f8f9fa';
          b.style.color = '#333';
        });
        btn.classList.add('active');
        btn.style.background = '#667eea';
        btn.style.color = 'white';
        currentEducationFilter = btn.dataset.filter;
        renderEducationList();
      });
    });

    // Education modal handling
    const educationModal = document.getElementById('educationModal');
    const educationForm = document.getElementById('educationForm');
    const btnAddEducation = document.getElementById('btnAddEducation');
    const educationModalCancel = document.getElementById('educationModalCancel');

    if (btnAddEducation) {
      btnAddEducation.addEventListener('click', () => {
        document.getElementById('educationModalTitle').textContent = 'Agregar Enlace Educativo';
        document.getElementById('educationId').value = '';
        document.getElementById('educationType').value = '';
        document.getElementById('educationTitle').value = '';
        document.getElementById('educationUrl').value = '';
        document.getElementById('educationDescription').value = '';
        document.getElementById('educationImage').value = '';
        document.getElementById('educationProductId').value = '';
        document.getElementById('educationActive').checked = true;
        document.getElementById('pecFieldsContainer').style.display = 'none';
        document.getElementById('educationUrlField').style.display = 'block';
        document.getElementById('pecImagePreview').style.display = 'none';
        // Load products for PEC selector
        loadProductsForPECSelector();
        educationModal.style.display = 'flex';
      });
    }

    // Load products into PEC product selector
    async function loadProductsForPECSelector() {
      const selector = document.getElementById('educationProductId');
      if (!selector) return;

      try {
        const productosCol = collection(db, 'productos');
        const snapshot = await getDocs(productosCol);

        selector.innerHTML = '<option value="">Seleccionar producto...</option>';

        snapshot.docs.forEach(doc => {
          const prod = doc.data();
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = prod.nombre || prod.name || doc.id;
          selector.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading products for PEC selector:', error);
      }
    }

    // Toggle PEC fields based on content type
    const educationType = document.getElementById('educationType');
    if (educationType) {
      educationType.addEventListener('change', (e) => {
        const pecFieldsContainer = document.getElementById('pecFieldsContainer');
        const educationUrlField = document.getElementById('educationUrlField');
        const educationUrl = document.getElementById('educationUrl');

        if (e.target.value === 'pec') {
          // Show PEC fields, hide URL field
          pecFieldsContainer.style.display = 'block';
          educationUrlField.style.display = 'none';
          educationUrl.removeAttribute('required');
          // Load products if not already loaded
          loadProductsForPECSelector();
        } else {
          // Hide PEC fields, show URL field
          pecFieldsContainer.style.display = 'none';
          educationUrlField.style.display = 'block';
          educationUrl.setAttribute('required', 'required');
        }
      });
    }

    // Preview PEC image when filename is entered
    const educationImageInput = document.getElementById('educationImage');
    if (educationImageInput) {
      educationImageInput.addEventListener('input', (e) => {
        const filename = e.target.value.trim();
        const previewContainer = document.getElementById('pecImagePreview');
        const previewImg = document.getElementById('pecImagePreviewImg');
        if (filename) {
          previewImg.src = '/images/pec/' + filename;
          previewImg.onerror = () => { previewContainer.style.display = 'none'; };
          previewImg.onload = () => { previewContainer.style.display = 'block'; };
        } else {
          previewContainer.style.display = 'none';
        }
      });
    }

    if (educationModalCancel) {
      educationModalCancel.addEventListener('click', () => {
        educationModal.style.display = 'none';
      });
    }

    // Close modal on outside click
    if (educationModal) {
      educationModal.addEventListener('click', (e) => {
        if (e.target === educationModal) {
          educationModal.style.display = 'none';
        }
      });
    }

    // Save education content
    if (educationForm) {
      educationForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const id = document.getElementById('educationId').value;
        const tipo = document.getElementById('educationType').value;
        const titulo = document.getElementById('educationTitle').value.trim();
        const url = document.getElementById('educationUrl').value.trim();
        const descripcion = document.getElementById('educationDescription').value.trim();
        const imagen = document.getElementById('educationImage').value.trim();
        const productoId = document.getElementById('educationProductId').value;
        const activo = document.getElementById('educationActive').checked;

        // Validation based on content type
        if (!tipo || !titulo) {
          alert('Por favor complete todos los campos obligatorios');
          return;
        }

        // For PEC: require product ID and image; for others: require URL
        if (tipo === 'pec') {
          if (!productoId) {
            alert('Por favor seleccione un producto asociado para el recurso PEC');
            return;
          }
          if (!imagen) {
            alert('Por favor ingrese el nombre del archivo de imagen de portada');
            return;
          }
        } else {
          if (!url) {
            alert('Por favor ingrese la URL del recurso');
            return;
          }
        }

        try {
          const data = {
            tipo,
            titulo,
            descripcion,
            activo,
            fecha: new Date()
          };

          // For PEC content: add imagen and productoId, no URL
          if (tipo === 'pec') {
            data.imagen = imagen;
            data.productoId = productoId;
            // Remove url field for PEC if it exists
            data.url = '';
          } else {
            // For non-PEC content: add URL
            data.url = url;
          }

          if (id) {
            // Update existing
            await updateDoc(doc(db, 'educacion', id), data);
          } else {
            // Create new
            await addDoc(collection(db, 'educacion'), data);
          }

          educationModal.style.display = 'none';
          await loadEducationContent();
          alert(id ? 'Contenido actualizado correctamente' : 'Contenido agregado correctamente');
        } catch (error) {
          console.error('Error saving education content:', error);
          alert('Error al guardar: ' + error.message);
        }
      });
    }

    // Edit education
    window.editEducation = async function(id) {
      const item = educationData.find(e => e.id === id);
      if (!item) return;

      // Load products for selector first
      await loadProductsForPECSelector();

      document.getElementById('educationModalTitle').textContent = 'Editar Enlace Educativo';
      document.getElementById('educationId').value = id;
      document.getElementById('educationType').value = item.tipo || '';
      document.getElementById('educationTitle').value = item.titulo || '';
      document.getElementById('educationUrl').value = item.url || '';
      document.getElementById('educationDescription').value = item.descripcion || '';
      document.getElementById('educationImage').value = item.imagen || '';
      document.getElementById('educationProductId').value = item.productoId || '';
      document.getElementById('educationActive').checked = item.activo !== false;

      // Show/hide fields based on content type
      const pecFieldsContainer = document.getElementById('pecFieldsContainer');
      const educationUrlField = document.getElementById('educationUrlField');
      const pecImagePreview = document.getElementById('pecImagePreview');
      const pecImagePreviewImg = document.getElementById('pecImagePreviewImg');

      if (item.tipo === 'pec') {
        pecFieldsContainer.style.display = 'block';
        educationUrlField.style.display = 'none';
        if (item.imagen) {
          pecImagePreviewImg.src = '/images/pec/' + item.imagen;
          pecImagePreviewImg.onerror = () => { pecImagePreview.style.display = 'none'; };
          pecImagePreviewImg.onload = () => { pecImagePreview.style.display = 'block'; };
        } else {
          pecImagePreview.style.display = 'none';
        }
      } else {
        pecFieldsContainer.style.display = 'none';
        educationUrlField.style.display = 'block';
        pecImagePreview.style.display = 'none';
      }

      educationModal.style.display = 'flex';
    };

    // Delete education
    window.deleteEducation = async function(id) {
      if (!confirm('¬øEst√°s seguro de que deseas eliminar este contenido educativo?')) return;

      try {
        await deleteDoc(doc(db, 'educacion', id));
        await loadEducationContent();
        alert('Contenido eliminado correctamente');
      } catch (error) {
        console.error('Error deleting education content:', error);
        alert('Error al eliminar: ' + error.message);
      }
    };

    // ===== BRANDING / IDENTIDAD VISUAL SECTION =====

    // Default brand settings
    const defaultBrandSettings = {
      branding: {
        platformName: 'PorKCasare',
        tagline: 'Carne empacada al vac√≠o',
        logoUrl: '/images/logo.webp'
      },
      colors: {
        primary: '#667eea',
        secondary: '#764ba2',
        accent: '#0052cc',
        success: '#00875a',
        danger: '#de350b',
        warning: '#ff8b00',
        textPrimary: '#172b4d',
        textSecondary: '#5e6c84',
        background: '#f4f5f7',
        cardBackground: '#ffffff'
      },
      fonts: {
        headings: "'Inter', sans-serif",
        body: "'Inter', sans-serif"
      },
      homeTexts: {
        heroTitle: 'Carne empacada al vac√≠o ‚Äî PorKCasare',
        heroSubtitle: 'Seleccionamos, empacamos y distribuimos cortes de cerdo con trazabilidad y la mejor calidad.',
        missionTitle: 'Misi√≥n',
        missionText: 'En PorkCasare trabajamos d√≠a a d√≠a en la crianza y ceba de porcinos con los m√°s altos est√°ndares de nutrici√≥n, bioseguridad y bienestar animal, utilizando procesos responsables que impulsan el crecimiento econ√≥mico local y fortalecen el sector agropecuario.',
        visionTitle: 'Visi√≥n',
        visionText: 'Convertirnos en una granja porc√≠cola l√≠der en la regi√≥n, reconocida por la innovaci√≥n, calidad gen√©tica y sostenibilidad ambiental, aportando al desarrollo del campo colombiano y garantizando un producto de confianza para nuestros clientes.',
        footerText: '¬© PorKCasare by F&F Asociados'
      },
      accessSelectionTexts: {
        title: 'Bienvenido a PorkCasare',
        clientRegisterButton: 'Registro de Cliente',
        distributorRegisterButton: 'Registro nuevo Distribuidor',
        distributorAccessButton: 'Acceso del Distribuidor'
      },
      loginTexts: {
        proveedorTitle: 'Portal de Proveedores',
        proveedorSubtitle: 'Ingresa tus credenciales para acceder',
        loginButton: 'Iniciar Sesi√≥n',
        forgotPassword: 'Recuperar contrase√±a'
      },
      virtualOfficeTexts: {
        navTitle: 'PorkCasare',
        logoutButton: 'Cerrar sesi√≥n',
        activationAlert: 'Debes realizar una compra m√≠nima de 50 puntos para activar tu c√≥digo y comenzar a recibir bonos y pagos.',
        progressTitle: '¬°Tu camino a Corona!',
        progressSubtitle: 'Contin√∫a acumulando puntos para alcanzar mayores beneficios'
      },
      virtualOfficeColors: {
        primary: '#4a90e2',
        secondary: '#667eea',
        accent: '#007bff',
        navBackground: '#4a90e2',
        btnNormal: '#007bff',
        btnHover: '#0056b3',
        btnText: '#ffffff',
        btnLogout: '#667eea'
      },
      productButtons: {
        buyNormal: '#2563a0',
        buyHover: '#3573b0',
        add: '#007bff',
        viewMore: '#6c757d',
        text: '#ffffff',
        qtyBorder: '#1e88e5'
      },
      productCards: {
        background: '#ffffff',
        border: '#e8e8e8',
        titleColor: '#1e293b',
        priceColor: '#007bff',
        descColor: '#64748b',
        shadowColor: '#000000'
      }
    };

    // Palettes definition
    const colorPalettes = {
      profesional: {
        primary: '#667eea',
        secondary: '#764ba2',
        accent: '#0052cc',
        success: '#00875a',
        danger: '#de350b',
        warning: '#ff8b00'
      },
      natural: {
        primary: '#2d6a4f',
        secondary: '#40916c',
        accent: '#52b788',
        success: '#2d6a4f',
        danger: '#c1121f',
        warning: '#fb8500'
      },
      moderno: {
        primary: '#7c3aed',
        secondary: '#a78bfa',
        accent: '#c4b5fd',
        success: '#10b981',
        danger: '#ef4444',
        warning: '#f59e0b'
      },
      calido: {
        primary: '#ea580c',
        secondary: '#fb923c',
        accent: '#fdba74',
        success: '#65a30d',
        danger: '#dc2626',
        warning: '#eab308'
      },
      corporativo: {
        primary: '#1e293b',
        secondary: '#475569',
        accent: '#64748b',
        success: '#059669',
        danger: '#dc2626',
        warning: '#d97706'
      }
    };

    let currentBrandSettings = null;
    let hasUnsavedBrandingChanges = false;
    let brandingFormInitialized = false;
    const LOCAL_BACKUP_KEY = 'brand-settings-local-backup';
    const PENDING_SAVE_KEY = 'brand-settings-pending-save';

    // Save to local backup (localStorage)
    function saveToLocalBackup(settings) {
      try {
        localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify({
          settings: settings,
          timestamp: new Date().toISOString()
        }));
        console.log('‚úÖ Backup local guardado');
        return true;
      } catch (error) {
        console.error('Error guardando backup local:', error);
        return false;
      }
    }

    // Get local backup
    function getLocalBackup() {
      try {
        const backup = localStorage.getItem(LOCAL_BACKUP_KEY);
        return backup ? JSON.parse(backup) : null;
      } catch (error) {
        return null;
      }
    }

    // Clear local backup
    function clearLocalBackup() {
      localStorage.removeItem(LOCAL_BACKUP_KEY);
      localStorage.removeItem(PENDING_SAVE_KEY);
    }

    // Mark pending save for later sync
    function markPendingSave(settings) {
      try {
        localStorage.setItem(PENDING_SAVE_KEY, JSON.stringify({
          settings: settings,
          timestamp: new Date().toISOString()
        }));
      } catch (error) {
        console.error('Error marcando guardado pendiente:', error);
      }
    }

    // Check for pending saves on load
    function checkPendingSave() {
      try {
        const pending = localStorage.getItem(PENDING_SAVE_KEY);
        if (pending) {
          const data = JSON.parse(pending);
          return data;
        }
      } catch (error) {
        return null;
      }
      return null;
    }

    // Export settings to JSON file
    function exportBrandSettings() {
      const settings = collectBrandSettings();
      settings.exportDate = new Date().toISOString();
      const dataStr = JSON.stringify(settings, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
      const filename = `identidad-visual-${new Date().toISOString().split('T')[0]}.json`;

      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', filename);
      linkElement.click();

      Swal.fire({
        icon: 'success',
        title: 'Exportado',
        text: `Configuraci√≥n exportada como ${filename}`,
        confirmButtonColor: '#667eea'
      });
    }

    // Import settings from JSON file
    function importBrandSettings() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';

      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
          const text = await file.text();
          const settings = JSON.parse(text);

          // Validate structure
          if (!settings.branding && !settings.colors && !settings.fonts) {
            throw new Error('Archivo de configuraci√≥n inv√°lido');
          }

          populateBrandingForm(settings);
          markBrandingAsChanged();

          Swal.fire({
            icon: 'success',
            title: 'Importado',
            text: 'Configuraci√≥n importada. Recuerda guardar los cambios para aplicarlos.',
            confirmButtonColor: '#667eea'
          });
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se pudo importar el archivo: ' + error.message,
            confirmButtonColor: '#de350b'
          });
        }
      };

      input.click();
    }

    // Restore from local backup
    async function restoreFromLocalBackup() {
      const backup = getLocalBackup();
      if (!backup) {
        Swal.fire({
          icon: 'info',
          title: 'Sin backup',
          text: 'No hay backup local disponible.',
          confirmButtonColor: '#667eea'
        });
        return;
      }

      const result = await Swal.fire({
        icon: 'question',
        title: 'Restaurar backup',
        text: `¬øRestaurar la configuraci√≥n del ${new Date(backup.timestamp).toLocaleString('es-CO')}?`,
        showCancelButton: true,
        confirmButtonText: 'S√≠, restaurar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#667eea'
      });

      if (result.isConfirmed) {
        populateBrandingForm(backup.settings);
        markBrandingAsChanged();
        Swal.fire({
          icon: 'success',
          title: 'Restaurado',
          text: 'Configuraci√≥n restaurada desde backup local. Recuerda guardar los cambios.',
          confirmButtonColor: '#667eea'
        });
      }
    }

    // Mark branding as having unsaved changes
    function markBrandingAsChanged() {
      if (!brandingFormInitialized) return;
      hasUnsavedBrandingChanges = true;
      updateUnsavedChangesIndicator();
    }

    // Update visual indicator for unsaved changes
    function updateUnsavedChangesIndicator() {
      const saveBtn = document.getElementById('saveBrandingBtn');
      const indicator = document.getElementById('brandingUnsavedIndicator');

      if (hasUnsavedBrandingChanges) {
        if (saveBtn) {
          saveBtn.classList.add('btn-pulse');
          saveBtn.innerHTML = '<span>üíæ</span> Guardar cambios *';
        }
        if (indicator) {
          indicator.style.display = 'inline';
        }
      } else {
        if (saveBtn) {
          saveBtn.classList.remove('btn-pulse');
          saveBtn.innerHTML = '<span>üíæ</span> Guardar cambios';
        }
        if (indicator) {
          indicator.style.display = 'none';
        }
      }
    }

    // Load brand settings on page load (with protection against overwriting unsaved changes)
    async function loadBrandSettings(forceReload = false) {
      // Protect against overwriting unsaved changes
      if (hasUnsavedBrandingChanges && !forceReload) {
        console.log('‚ö†Ô∏è Skipping brand settings reload - unsaved changes exist');
        return;
      }

      try {
        const response = await fetch('/.netlify/functions/get-brand-settings');
        if (!response.ok) throw new Error('Failed to load settings');
        currentBrandSettings = await response.json();
        populateBrandingForm(currentBrandSettings);
        hasUnsavedBrandingChanges = false;
        updateUnsavedChangesIndicator();
      } catch (error) {
        console.warn('Using default brand settings:', error);
        currentBrandSettings = defaultBrandSettings;
        populateBrandingForm(defaultBrandSettings);
        hasUnsavedBrandingChanges = false;
        updateUnsavedChangesIndicator();
      }
    }

    // Populate branding form with settings
    function populateBrandingForm(settings) {
      // Branding section
      if (settings.branding) {
        document.getElementById('brandPlatformName').value = settings.branding.platformName || '';
        document.getElementById('brandTagline').value = settings.branding.tagline || '';
        document.getElementById('brandLogoUrl').value = settings.branding.logoUrl || '/images/logo.webp';
        document.getElementById('brandLogoPreview').src = settings.branding.logoUrl || '/images/logo.webp';
      }

      // Colors section
      if (settings.colors) {
        const colorFields = ['primary', 'secondary', 'accent', 'success', 'danger', 'warning', 'textPrimary', 'textSecondary', 'background', 'cardBackground'];
        colorFields.forEach(field => {
          const colorInput = document.getElementById(`brandColor${field.charAt(0).toUpperCase() + field.slice(1)}`);
          const hexInput = document.getElementById(`brandColor${field.charAt(0).toUpperCase() + field.slice(1)}Hex`);
          if (colorInput && settings.colors[field]) {
            colorInput.value = settings.colors[field];
            if (hexInput) hexInput.value = settings.colors[field];
          }
        });
        updateGradientPreview();
      }

      // Fonts section
      if (settings.fonts) {
        if (settings.fonts.headings) {
          document.getElementById('brandFontHeadings').value = settings.fonts.headings;
          document.getElementById('brandFontPreviewHeading').style.fontFamily = settings.fonts.headings;
        }
        if (settings.fonts.body) {
          document.getElementById('brandFontBody').value = settings.fonts.body;
          document.getElementById('brandFontPreviewBody').style.fontFamily = settings.fonts.body;
        }
      }

      // Home texts section
      if (settings.homeTexts) {
        document.getElementById('brandHomeHeroTitle').value = settings.homeTexts.heroTitle || '';
        document.getElementById('brandHomeHeroSubtitle').value = settings.homeTexts.heroSubtitle || '';
        document.getElementById('brandHomeMissionTitle').value = settings.homeTexts.missionTitle || '';
        document.getElementById('brandHomeMissionText').value = settings.homeTexts.missionText || '';
        document.getElementById('brandHomeVisionTitle').value = settings.homeTexts.visionTitle || '';
        document.getElementById('brandHomeVisionText').value = settings.homeTexts.visionText || '';
        document.getElementById('brandHomeFooterText').value = settings.homeTexts.footerText || '';
      }

      // Access selection texts
      if (settings.accessSelectionTexts) {
        document.getElementById('brandAccessTitle').value = settings.accessSelectionTexts.title || '';
        document.getElementById('brandAccessClientBtn').value = settings.accessSelectionTexts.clientRegisterButton || '';
        document.getElementById('brandAccessDistributorBtn').value = settings.accessSelectionTexts.distributorRegisterButton || '';
        document.getElementById('brandAccessDistributorAccessBtn').value = settings.accessSelectionTexts.distributorAccessButton || '';
      }

      // Login texts
      if (settings.loginTexts) {
        document.getElementById('brandLoginProveedorTitle').value = settings.loginTexts.proveedorTitle || '';
        document.getElementById('brandLoginProveedorSubtitle').value = settings.loginTexts.proveedorSubtitle || '';
        document.getElementById('brandLoginButton').value = settings.loginTexts.loginButton || '';
        document.getElementById('brandLoginForgotPassword').value = settings.loginTexts.forgotPassword || '';
      }

      // Virtual office texts
      if (settings.virtualOfficeTexts) {
        document.getElementById('brandVirtualOfficeNavTitle').value = settings.virtualOfficeTexts.navTitle || '';
        document.getElementById('brandVirtualOfficeLogoutBtn').value = settings.virtualOfficeTexts.logoutButton || '';
        document.getElementById('brandVirtualOfficeActivationAlert').value = settings.virtualOfficeTexts.activationAlert || '';
        document.getElementById('brandVirtualOfficeProgressTitle').value = settings.virtualOfficeTexts.progressTitle || '';
        document.getElementById('brandVirtualOfficeProgressSubtitle').value = settings.virtualOfficeTexts.progressSubtitle || '';
      }

      // Virtual office colors
      if (settings.virtualOfficeColors) {
        const voColorFields = {
          'VOColorPrimary': 'primary',
          'VOColorSecondary': 'secondary',
          'VOColorAccent': 'accent',
          'VONavBackground': 'navBackground',
          'VOBtnNormal': 'btnNormal',
          'VOBtnHover': 'btnHover',
          'VOBtnText': 'btnText',
          'VOBtnLogout': 'btnLogout'
        };
        Object.entries(voColorFields).forEach(([inputId, settingKey]) => {
          const colorInput = document.getElementById(`brand${inputId}`);
          const hexInput = document.getElementById(`brand${inputId}Hex`);
          if (colorInput && settings.virtualOfficeColors[settingKey]) {
            colorInput.value = settings.virtualOfficeColors[settingKey];
            if (hexInput) hexInput.value = settings.virtualOfficeColors[settingKey];
          }
        });
        updateVOPreview();
      }

      // Product buttons
      if (settings.productButtons) {
        const productBtnFields = {
          'ProductBtnBuy': 'buyNormal',
          'ProductBtnBuyHover': 'buyHover',
          'ProductBtnAdd': 'add',
          'ProductBtnViewMore': 'viewMore',
          'ProductBtnText': 'text',
          'ProductQtyBorder': 'qtyBorder'
        };
        Object.entries(productBtnFields).forEach(([inputId, settingKey]) => {
          const colorInput = document.getElementById(`brand${inputId}`);
          const hexInput = document.getElementById(`brand${inputId}Hex`);
          if (colorInput && settings.productButtons[settingKey]) {
            colorInput.value = settings.productButtons[settingKey];
            if (hexInput) hexInput.value = settings.productButtons[settingKey];
          }
        });
        updateProductBtnPreview();
      }

      // Product cards
      if (settings.productCards) {
        const productCardFields = {
          'ProductCardBg': 'background',
          'ProductCardBorder': 'border',
          'ProductCardTitle': 'titleColor',
          'ProductCardPrice': 'priceColor',
          'ProductCardDesc': 'descColor',
          'ProductCardShadow': 'shadowColor'
        };
        Object.entries(productCardFields).forEach(([inputId, settingKey]) => {
          const colorInput = document.getElementById(`brand${inputId}`);
          const hexInput = document.getElementById(`brand${inputId}Hex`);
          if (colorInput && settings.productCards[settingKey]) {
            colorInput.value = settings.productCards[settingKey];
            if (hexInput) hexInput.value = settings.productCards[settingKey];
          }
        });
        updateProductCardPreview();
      }

      // Last updated
      if (settings.metadata && settings.metadata.lastUpdated) {
        const lastUpdatedEl = document.getElementById('brandingLastUpdated');
        document.getElementById('brandingLastUpdatedDate').textContent = new Date(settings.metadata.lastUpdated).toLocaleString('es-CO');
        document.getElementById('brandingLastUpdatedBy').textContent = settings.metadata.updatedBy || 'admin';
        lastUpdatedEl.style.display = 'block';
      }
    }

    // Collect brand settings from form
    function collectBrandSettings() {
      return {
        branding: {
          platformName: document.getElementById('brandPlatformName').value.trim(),
          tagline: document.getElementById('brandTagline').value.trim(),
          logoUrl: document.getElementById('brandLogoUrl').value.trim()
        },
        colors: {
          primary: document.getElementById('brandColorPrimaryHex').value,
          secondary: document.getElementById('brandColorSecondaryHex').value,
          accent: document.getElementById('brandColorAccentHex').value,
          success: document.getElementById('brandColorSuccessHex').value,
          danger: document.getElementById('brandColorDangerHex').value,
          warning: document.getElementById('brandColorWarningHex').value,
          textPrimary: document.getElementById('brandColorTextPrimaryHex').value,
          textSecondary: document.getElementById('brandColorTextSecondaryHex').value,
          background: document.getElementById('brandColorBackgroundHex').value,
          cardBackground: document.getElementById('brandColorCardBackgroundHex').value,
          gradientStart: document.getElementById('brandColorPrimaryHex').value,
          gradientEnd: document.getElementById('brandColorSecondaryHex').value
        },
        fonts: {
          headings: document.getElementById('brandFontHeadings').value,
          body: document.getElementById('brandFontBody').value
        },
        homeTexts: {
          heroTitle: document.getElementById('brandHomeHeroTitle').value.trim(),
          heroSubtitle: document.getElementById('brandHomeHeroSubtitle').value.trim(),
          missionTitle: document.getElementById('brandHomeMissionTitle').value.trim(),
          missionText: document.getElementById('brandHomeMissionText').value.trim(),
          visionTitle: document.getElementById('brandHomeVisionTitle').value.trim(),
          visionText: document.getElementById('brandHomeVisionText').value.trim(),
          footerText: document.getElementById('brandHomeFooterText').value.trim()
        },
        accessSelectionTexts: {
          title: document.getElementById('brandAccessTitle').value.trim(),
          clientRegisterButton: document.getElementById('brandAccessClientBtn').value.trim(),
          distributorRegisterButton: document.getElementById('brandAccessDistributorBtn').value.trim(),
          distributorAccessButton: document.getElementById('brandAccessDistributorAccessBtn').value.trim()
        },
        loginTexts: {
          proveedorTitle: document.getElementById('brandLoginProveedorTitle').value.trim(),
          proveedorSubtitle: document.getElementById('brandLoginProveedorSubtitle').value.trim(),
          loginButton: document.getElementById('brandLoginButton').value.trim(),
          forgotPassword: document.getElementById('brandLoginForgotPassword').value.trim()
        },
        virtualOfficeTexts: {
          navTitle: document.getElementById('brandVirtualOfficeNavTitle').value.trim(),
          logoutButton: document.getElementById('brandVirtualOfficeLogoutBtn').value.trim(),
          activationAlert: document.getElementById('brandVirtualOfficeActivationAlert').value.trim(),
          progressTitle: document.getElementById('brandVirtualOfficeProgressTitle').value.trim(),
          progressSubtitle: document.getElementById('brandVirtualOfficeProgressSubtitle').value.trim()
        },
        // Configuraci√≥n visual de la Oficina Virtual
        virtualOfficeColors: {
          primary: document.getElementById('brandVOColorPrimaryHex')?.value || '#4a90e2',
          secondary: document.getElementById('brandVOColorSecondaryHex')?.value || '#667eea',
          accent: document.getElementById('brandVOColorAccentHex')?.value || '#007bff',
          navBackground: document.getElementById('brandVONavBackgroundHex')?.value || '#4a90e2',
          btnNormal: document.getElementById('brandVOBtnNormalHex')?.value || '#007bff',
          btnHover: document.getElementById('brandVOBtnHoverHex')?.value || '#0056b3',
          btnText: document.getElementById('brandVOBtnTextHex')?.value || '#ffffff',
          btnLogout: document.getElementById('brandVOBtnLogoutHex')?.value || '#667eea'
        },
        // Configuraci√≥n de botones de productos
        productButtons: {
          buyNormal: document.getElementById('brandProductBtnBuyHex')?.value || '#2563a0',
          buyHover: document.getElementById('brandProductBtnBuyHoverHex')?.value || '#3573b0',
          add: document.getElementById('brandProductBtnAddHex')?.value || '#007bff',
          viewMore: document.getElementById('brandProductBtnViewMoreHex')?.value || '#6c757d',
          text: document.getElementById('brandProductBtnTextHex')?.value || '#ffffff',
          qtyBorder: document.getElementById('brandProductQtyBorderHex')?.value || '#1e88e5'
        },
        // Configuraci√≥n de tarjetas de productos
        productCards: {
          background: document.getElementById('brandProductCardBgHex')?.value || '#ffffff',
          border: document.getElementById('brandProductCardBorderHex')?.value || '#e8e8e8',
          titleColor: document.getElementById('brandProductCardTitleHex')?.value || '#1e293b',
          priceColor: document.getElementById('brandProductCardPriceHex')?.value || '#007bff',
          descColor: document.getElementById('brandProductCardDescHex')?.value || '#64748b',
          shadowColor: document.getElementById('brandProductCardShadowHex')?.value || '#000000'
        }
      };
    }

    // Save brand settings with retry logic and local backup
    async function saveBrandSettings(retryCount = 0) {
      const maxRetries = 3;
      const saveBtn = document.getElementById('saveBrandingBtn');
      const originalText = saveBtn.innerHTML;

      try {
        saveBtn.disabled = true;
        saveBtn.innerHTML = retryCount > 0
          ? `<span>üîÑ</span> Reintentando (${retryCount}/${maxRetries})...`
          : '<span>‚è≥</span> Guardando...';

        const settings = collectBrandSettings();

        // Always save local backup first
        saveToLocalBackup(settings);

        // Get Firebase auth token if user is logged in
        let adminToken = null;
        if (auth.currentUser) {
          try {
            adminToken = await auth.currentUser.getIdToken(true); // Force refresh token
          } catch (tokenError) {
            console.warn('Error obteniendo token, intentando sin autenticaci√≥n:', tokenError);
          }
        }

        const response = await fetch('/.netlify/functions/save-brand-settings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            settings: settings,
            adminToken: adminToken
          })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Failed to save settings');
        }

        // Update last updated info
        const lastUpdatedEl = document.getElementById('brandingLastUpdated');
        document.getElementById('brandingLastUpdatedDate').textContent = new Date().toLocaleString('es-CO');
        document.getElementById('brandingLastUpdatedBy').textContent = auth.currentUser?.email || 'admin';
        lastUpdatedEl.style.display = 'block';

        // Reset unsaved changes flag after successful save
        hasUnsavedBrandingChanges = false;
        updateUnsavedChangesIndicator();

        // Clear pending save marker on success
        localStorage.removeItem(PENDING_SAVE_KEY);

        Swal.fire({
          icon: 'success',
          title: '¬°Guardado!',
          text: 'Los cambios de identidad visual se han guardado correctamente. Los cambios se aplicar√°n en todas las p√°ginas.',
          confirmButtonColor: '#667eea'
        });

      } catch (error) {
        console.error('Error saving brand settings:', error);

        // Mark as pending for later sync
        markPendingSave(collectBrandSettings());

        // Retry logic for network errors
        if (retryCount < maxRetries && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError'))) {
          const waitTime = Math.pow(2, retryCount) * 1000; // Exponential backoff
          console.log(`Reintentando en ${waitTime/1000}s...`);
          setTimeout(() => saveBrandSettings(retryCount + 1), waitTime);
          return;
        }

        // Show options to user when save fails
        const result = await Swal.fire({
          icon: 'warning',
          title: 'Error al guardar en servidor',
          html: `
            <p>No se pudieron guardar los cambios en el servidor: <strong>${error.message}</strong></p>
            <p style="margin-top: 10px;">Tu configuraci√≥n se ha guardado <strong>localmente</strong> como respaldo.</p>
            <p style="margin-top: 10px; font-size: 0.9em; color: #666;">Opciones disponibles:</p>
          `,
          showCancelButton: true,
          showDenyButton: true,
          confirmButtonText: 'üì• Exportar como archivo',
          denyButtonText: 'üîÑ Reintentar',
          cancelButtonText: 'Cerrar',
          confirmButtonColor: '#667eea',
          denyButtonColor: '#f59e0b'
        });

        if (result.isConfirmed) {
          exportBrandSettings();
        } else if (result.isDenied) {
          saveBrandSettings(0); // Retry from start
        }
      } finally {
        saveBtn.disabled = false;
        if (!hasUnsavedBrandingChanges) {
          saveBtn.innerHTML = '<span>üíæ</span> Guardar cambios';
        } else {
          saveBtn.innerHTML = '<span>üíæ</span> Guardar cambios *';
        }
      }
    }

    // Update gradient preview
    function updateGradientPreview() {
      const primary = document.getElementById('brandColorPrimaryHex').value;
      const secondary = document.getElementById('brandColorSecondaryHex').value;
      const preview = document.getElementById('brandGradientPreview');
      if (preview) {
        preview.style.background = `linear-gradient(135deg, ${primary} 0%, ${secondary} 100%)`;
      }
    }

    // Update Virtual Office navigation preview
    function updateVOPreview() {
      const navBg = document.getElementById('brandVONavBackgroundHex')?.value || '#4a90e2';
      const navPreview = document.getElementById('brandVONavPreview');
      if (navPreview) {
        navPreview.style.background = navBg;
      }

      const btnNormal = document.getElementById('brandVOBtnNormalHex')?.value || '#007bff';
      const btnText = document.getElementById('brandVOBtnTextHex')?.value || '#ffffff';
      const btnLogout = document.getElementById('brandVOBtnLogoutHex')?.value || '#667eea';
      const btnSecondary = document.getElementById('brandVOColorSecondaryHex')?.value || '#764ba2';

      const normalPreview = document.getElementById('brandVOBtnPreviewNormal');
      if (normalPreview) {
        normalPreview.style.background = btnNormal;
        normalPreview.style.color = btnText;
      }

      const logoutPreview = document.getElementById('brandVOBtnPreviewLogout');
      if (logoutPreview) {
        logoutPreview.style.background = `linear-gradient(135deg, ${btnLogout} 0%, ${btnSecondary} 100%)`;
      }
    }

    // Update Product buttons preview
    function updateProductBtnPreview() {
      const buyNormal = document.getElementById('brandProductBtnBuyHex')?.value || '#2563a0';
      const addBtn = document.getElementById('brandProductBtnAddHex')?.value || '#007bff';
      const viewMore = document.getElementById('brandProductBtnViewMoreHex')?.value || '#6c757d';
      const btnText = document.getElementById('brandProductBtnTextHex')?.value || '#ffffff';
      const qtyBorder = document.getElementById('brandProductQtyBorderHex')?.value || '#1e88e5';

      const buyPreview = document.getElementById('brandProductBtnPreviewBuy');
      if (buyPreview) {
        buyPreview.style.background = buyNormal;
        buyPreview.style.color = btnText;
      }

      const addPreview = document.getElementById('brandProductBtnPreviewAdd');
      if (addPreview) {
        addPreview.style.background = addBtn;
        addPreview.style.color = btnText;
      }

      const viewPreview = document.getElementById('brandProductBtnPreviewViewMore');
      if (viewPreview) {
        viewPreview.style.background = viewMore;
        viewPreview.style.color = btnText;
      }

      const qtyMinus = document.getElementById('brandProductQtyPreviewMinus');
      const qtyPlus = document.getElementById('brandProductQtyPreviewPlus');
      if (qtyMinus) {
        qtyMinus.style.borderColor = qtyBorder;
        qtyMinus.style.color = qtyBorder;
      }
      if (qtyPlus) {
        qtyPlus.style.borderColor = qtyBorder;
        qtyPlus.style.color = qtyBorder;
      }
    }

    // Update Product card preview
    function updateProductCardPreview() {
      const cardBg = document.getElementById('brandProductCardBgHex')?.value || '#ffffff';
      const cardBorder = document.getElementById('brandProductCardBorderHex')?.value || '#e8e8e8';
      const titleColor = document.getElementById('brandProductCardTitleHex')?.value || '#1e293b';
      const priceColor = document.getElementById('brandProductCardPriceHex')?.value || '#007bff';
      const descColor = document.getElementById('brandProductCardDescHex')?.value || '#64748b';

      const cardPreview = document.getElementById('brandProductCardPreview');
      if (cardPreview) {
        cardPreview.style.background = cardBg;
        cardPreview.style.borderColor = cardBorder;
      }

      const titlePreview = document.getElementById('brandProductCardPreviewTitle');
      if (titlePreview) {
        titlePreview.style.color = titleColor;
      }

      const descPreview = document.getElementById('brandProductCardPreviewDesc');
      if (descPreview) {
        descPreview.style.color = descColor;
      }

      const pricePreview = document.getElementById('brandProductCardPreviewPrice');
      if (pricePreview) {
        pricePreview.style.color = priceColor;
      }
    }

    // Sync color input with hex input
    function syncColorInputs(colorId, hexId) {
      const colorInput = document.getElementById(colorId);
      const hexInput = document.getElementById(hexId);

      if (colorInput && hexInput) {
        colorInput.addEventListener('input', () => {
          hexInput.value = colorInput.value;
          updateGradientPreview();
        });

        hexInput.addEventListener('input', () => {
          if (/^#[0-9A-Fa-f]{6}$/.test(hexInput.value)) {
            colorInput.value = hexInput.value;
            updateGradientPreview();
          }
        });
      }
    }

    // Apply palette (also marks as changed)
    function applyPalette(paletteName) {
      const palette = colorPalettes[paletteName];
      if (!palette) return;

      Object.entries(palette).forEach(([key, value]) => {
        const colorInput = document.getElementById(`brandColor${key.charAt(0).toUpperCase() + key.slice(1)}`);
        const hexInput = document.getElementById(`brandColor${key.charAt(0).toUpperCase() + key.slice(1)}Hex`);
        if (colorInput) colorInput.value = value;
        if (hexInput) hexInput.value = value;
      });

      updateGradientPreview();

      // Update palette button styles
      document.querySelectorAll('.brand-palette-btn').forEach(btn => {
        btn.style.borderColor = btn.dataset.palette === paletteName ? palette.primary : '#e9ecef';
      });

      // Mark as changed since user selected a palette
      markBrandingAsChanged();
    }

    // Initialize branding section
    function initBrandingSection() {
      // Sync color inputs
      const colorFields = ['Primary', 'Secondary', 'Accent', 'Success', 'Danger', 'Warning', 'TextPrimary', 'TextSecondary', 'Background', 'CardBackground'];
      colorFields.forEach(field => {
        syncColorInputs(`brandColor${field}`, `brandColor${field}Hex`);
      });

      // Font preview updates
      document.getElementById('brandFontHeadings')?.addEventListener('change', function() {
        document.getElementById('brandFontPreviewHeading').style.fontFamily = this.value;
        markBrandingAsChanged();
      });

      document.getElementById('brandFontBody')?.addEventListener('change', function() {
        document.getElementById('brandFontPreviewBody').style.fontFamily = this.value;
        markBrandingAsChanged();
      });

      // Logo preview update
      document.getElementById('brandLogoUrl')?.addEventListener('input', function() {
        document.getElementById('brandLogoPreview').src = this.value || '/images/logo.webp';
        markBrandingAsChanged();
      });

      // Sync color inputs for new Visual Configuration sections
      // Virtual Office colors
      const voColorFields = ['VOColorPrimary', 'VOColorSecondary', 'VOColorAccent', 'VONavBackground', 'VOBtnNormal', 'VOBtnHover', 'VOBtnText', 'VOBtnLogout'];
      voColorFields.forEach(field => {
        const colorInput = document.getElementById(`brand${field}`);
        const hexInput = document.getElementById(`brand${field}Hex`);
        if (colorInput && hexInput) {
          colorInput.addEventListener('input', () => {
            hexInput.value = colorInput.value;
            updateVOPreview();
          });
          hexInput.addEventListener('input', () => {
            if (/^#[0-9A-Fa-f]{6}$/.test(hexInput.value)) {
              colorInput.value = hexInput.value;
              updateVOPreview();
            }
          });
        }
      });

      // Product button colors
      const productBtnFields = ['ProductBtnBuy', 'ProductBtnBuyHover', 'ProductBtnAdd', 'ProductBtnViewMore', 'ProductBtnText', 'ProductQtyBorder'];
      productBtnFields.forEach(field => {
        const colorInput = document.getElementById(`brand${field}`);
        const hexInput = document.getElementById(`brand${field}Hex`);
        if (colorInput && hexInput) {
          colorInput.addEventListener('input', () => {
            hexInput.value = colorInput.value;
            updateProductBtnPreview();
          });
          hexInput.addEventListener('input', () => {
            if (/^#[0-9A-Fa-f]{6}$/.test(hexInput.value)) {
              colorInput.value = hexInput.value;
              updateProductBtnPreview();
            }
          });
        }
      });

      // Product card colors
      const productCardFields = ['ProductCardBg', 'ProductCardBorder', 'ProductCardTitle', 'ProductCardPrice', 'ProductCardDesc', 'ProductCardShadow'];
      productCardFields.forEach(field => {
        const colorInput = document.getElementById(`brand${field}`);
        const hexInput = document.getElementById(`brand${field}Hex`);
        if (colorInput && hexInput) {
          colorInput.addEventListener('input', () => {
            hexInput.value = colorInput.value;
            updateProductCardPreview();
          });
          hexInput.addEventListener('input', () => {
            if (/^#[0-9A-Fa-f]{6}$/.test(hexInput.value)) {
              colorInput.value = hexInput.value;
              updateProductCardPreview();
            }
          });
        }
      });

      // Palette buttons
      document.querySelectorAll('.brand-palette-btn').forEach(btn => {
        btn.addEventListener('click', () => applyPalette(btn.dataset.palette));
      });

      // Save button
      document.getElementById('saveBrandingBtn')?.addEventListener('click', saveBrandSettings);

      // Export button
      document.getElementById('exportBrandingBtn')?.addEventListener('click', exportBrandSettings);

      // Import button
      document.getElementById('importBrandingBtn')?.addEventListener('click', importBrandSettings);

      // Restore from local backup button
      document.getElementById('restoreBackupBtn')?.addEventListener('click', restoreFromLocalBackup);

      // Reset button
      document.getElementById('resetBrandingBtn')?.addEventListener('click', () => {
        if (confirm('¬øEst√°s seguro de restaurar los valores predeterminados? Esto no guardar√° los cambios autom√°ticamente.')) {
          hasUnsavedBrandingChanges = false;
          populateBrandingForm(defaultBrandSettings);
          markBrandingAsChanged();
        }
      });

      // Add change detection to all branding form inputs
      const brandingTabContent = document.getElementById('tab-branding');
      if (brandingTabContent) {
        brandingTabContent.querySelectorAll('input, select, textarea').forEach(input => {
          input.addEventListener('input', markBrandingAsChanged);
          input.addEventListener('change', markBrandingAsChanged);
        });
      }

      // Warn user before leaving page with unsaved changes
      window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedBrandingChanges) {
          e.preventDefault();
          e.returnValue = 'Tienes cambios sin guardar en Identidad Visual. ¬øEst√°s seguro de que deseas salir?';
          return e.returnValue;
        }
      });

      // Load current settings
      loadBrandSettings();

      // Check for pending saves and notify user
      const pendingSave = checkPendingSave();
      if (pendingSave) {
        setTimeout(async () => {
          const result = await Swal.fire({
            icon: 'info',
            title: 'Guardado pendiente encontrado',
            html: `
              <p>Hay una configuraci√≥n que no se pudo guardar el ${new Date(pendingSave.timestamp).toLocaleString('es-CO')}.</p>
              <p style="margin-top: 10px;">¬øQu√© deseas hacer?</p>
            `,
            showCancelButton: true,
            showDenyButton: true,
            confirmButtonText: 'üîÑ Reintentar guardar',
            denyButtonText: 'üìã Cargar en formulario',
            cancelButtonText: 'Ignorar',
            confirmButtonColor: '#667eea',
            denyButtonColor: '#f59e0b'
          });

          if (result.isConfirmed) {
            // Populate form with pending data and save
            populateBrandingForm(pendingSave.settings);
            saveBrandSettings();
          } else if (result.isDenied) {
            // Just populate form, let user review
            populateBrandingForm(pendingSave.settings);
            markBrandingAsChanged();
          }
        }, 1000);
      }

      // Mark as initialized (prevents marking changes during initial population)
      setTimeout(() => {
        brandingFormInitialized = true;
      }, 500);
    }

    // Initialize branding when tab is clicked
    document.querySelector('[data-tab="branding"]')?.addEventListener('click', initBrandingSection, { once: true });

  </script>
  <script type="module" src="/js/session-timeout.js"></script>
</body>
</html>
