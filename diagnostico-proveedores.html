<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagn√≥stico de Usuarios Proveedores - PorkCasare</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f5f9ff;
      padding: 20px;
    }
    .diagnostic-container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0px 4px 12px rgba(0,0,0,0.1);
    }
    .user-card {
      border: 2px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: #f8f9fa;
    }
    .user-card.error {
      border-color: #dc3545;
      background: #f8d7da;
    }
    .user-card.warning {
      border-color: #ffc107;
      background: #fff3cd;
    }
    .user-card.success {
      border-color: #28a745;
      background: #d4edda;
    }
    .field-display {
      font-family: monospace;
      background: white;
      padding: 8px;
      border-radius: 4px;
      margin: 5px 0;
      border: 1px solid #dee2e6;
    }
    .btn-fix {
      margin-top: 10px;
    }
    .loading {
      text-align: center;
      padding: 40px;
    }
  </style>
</head>
<body>

  <div class="diagnostic-container">
    <h2 class="text-center mb-4">üîç Diagn√≥stico de Usuarios Proveedores</h2>

    <div class="alert alert-info">
      <strong>Informaci√≥n:</strong> Esta herramienta revisa todos los usuarios del sistema y encuentra problemas con los roles de proveedor.
    </div>

    <div class="mb-3">
      <button id="btnDiagnosticar" class="btn btn-primary">Ejecutar Diagn√≥stico</button>
      <button id="btnFixAll" class="btn btn-success" style="display:none;">Corregir Todos los Problemas</button>
    </div>

    <div id="results"></div>
  </div>

  <script type="module">
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js';
    import { getFirestore, collection, getDocs, doc, updateDoc, query, where } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js';

    // Import Firebase auth and db from existing config
    import { auth, db } from '/src/firebase-config.js';

    const resultsDiv = document.getElementById('results');
    const btnDiagnosticar = document.getElementById('btnDiagnosticar');
    const btnFixAll = document.getElementById('btnFixAll');

    let problemUsers = [];

    // Check if user is admin
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        resultsDiv.innerHTML = '<div class="alert alert-danger">Debes iniciar sesi√≥n como administrador para usar esta herramienta.</div>';
        btnDiagnosticar.disabled = true;
        return;
      }

      try {
        const userDoc = await getDocs(query(collection(db, "usuarios"), where("email", "==", user.email)));
        if (userDoc.empty) {
          resultsDiv.innerHTML = '<div class="alert alert-danger">Usuario no encontrado en la base de datos.</div>';
          btnDiagnosticar.disabled = true;
          return;
        }

        const userData = userDoc.docs[0].data();
        if (userData.role !== 'admin' && userData.rol !== 'admin') {
          resultsDiv.innerHTML = '<div class="alert alert-danger">Solo administradores pueden usar esta herramienta.</div>';
          btnDiagnosticar.disabled = true;
          return;
        }
      } catch (error) {
        console.error('Error checking user permissions:', error);
      }
    });

    btnDiagnosticar.addEventListener('click', async () => {
      resultsDiv.innerHTML = '<div class="loading"><div class="spinner-border text-primary" role="status"></div><p>Analizando usuarios...</p></div>';
      problemUsers = [];

      try {
        const usersSnap = await getDocs(collection(db, "usuarios"));
        let htmlOutput = '<h4 class="mt-4">Resultados del Diagn√≥stico</h4>';

        let totalUsers = 0;
        let proveedorUsers = 0;
        let problemCount = 0;

        usersSnap.docs.forEach(userDoc => {
          const userData = userDoc.data();
          const userId = userDoc.id;
          totalUsers++;

          // Check for supplier-related issues
          const hasRoleProveedor = userData.role === 'proveedor';
          const hasRolProveedor = userData.rol === 'proveedor';
          const tipoRegistro = userData.tipoRegistro;
          const username = userData.usuario || 'N/A';
          const nombre = userData.nombre || 'N/A';
          const apellido = userData.apellido || '';
          const email = userData.email || 'N/A';

          // Identify if this should be a supplier
          const shouldBeSupplier = hasRoleProveedor || hasRolProveedor || tipoRegistro === 'proveedor';

          if (shouldBeSupplier) {
            proveedorUsers++;

            // Check for problems
            let problems = [];
            let cardClass = 'success';

            if (!hasRoleProveedor) {
              problems.push('Falta campo <code>role: "proveedor"</code>');
              cardClass = 'warning';
            }

            if (!hasRolProveedor) {
              problems.push('Falta campo <code>rol: "proveedor"</code>');
              cardClass = 'warning';
            }

            if (tipoRegistro && tipoRegistro !== 'proveedor') {
              problems.push(`Campo <code>tipoRegistro</code> tiene valor incorrecto: "${tipoRegistro}"`);
              cardClass = 'error';
            }

            // Check for typos in role values
            if (userData.role && userData.role !== 'proveedor' && userData.role.toLowerCase().includes('prove')) {
              problems.push(`Posible error tipogr√°fico en <code>role</code>: "${userData.role}"`);
              cardClass = 'error';
            }

            if (userData.rol && userData.rol !== 'proveedor' && userData.rol.toLowerCase().includes('prove')) {
              problems.push(`Posible error tipogr√°fico en <code>rol</code>: "${userData.rol}"`);
              cardClass = 'error';
            }

            if (problems.length > 0) {
              problemCount++;
              problemUsers.push({ userId, userData, problems });

              htmlOutput += `
                <div class="user-card ${cardClass}">
                  <h5>${nombre} ${apellido} (@${username})</h5>
                  <div class="field-display"><strong>ID:</strong> ${userId}</div>
                  <div class="field-display"><strong>Email:</strong> ${email}</div>
                  <div class="field-display"><strong>role:</strong> ${userData.role || '<em>no definido</em>'}</div>
                  <div class="field-display"><strong>rol:</strong> ${userData.rol || '<em>no definido</em>'}</div>
                  <div class="field-display"><strong>tipoRegistro:</strong> ${userData.tipoRegistro || '<em>no definido</em>'}</div>
                  <div class="alert alert-warning mt-2 mb-2">
                    <strong>Problemas encontrados:</strong>
                    <ul class="mb-0">
                      ${problems.map(p => `<li>${p}</li>`).join('')}
                    </ul>
                  </div>
                  <button class="btn btn-sm btn-success btn-fix" onclick="fixUser('${userId}')">Corregir Este Usuario</button>
                </div>
              `;
            } else {
              htmlOutput += `
                <div class="user-card success">
                  <h5>‚úÖ ${nombre} ${apellido} (@${username})</h5>
                  <div class="field-display"><strong>Email:</strong> ${email}</div>
                  <div class="field-display"><strong>role:</strong> ${userData.role}</div>
                  <div class="field-display"><strong>rol:</strong> ${userData.rol}</div>
                  <p class="text-success mb-0 mt-2"><strong>Este usuario est√° configurado correctamente.</strong></p>
                </div>
              `;
            }
          }
        });

        // Summary
        const summary = `
          <div class="alert ${problemCount > 0 ? 'alert-warning' : 'alert-success'}">
            <h5>Resumen</h5>
            <ul>
              <li><strong>Total de usuarios en el sistema:</strong> ${totalUsers}</li>
              <li><strong>Usuarios proveedores encontrados:</strong> ${proveedorUsers}</li>
              <li><strong>Usuarios con problemas:</strong> ${problemCount}</li>
            </ul>
          </div>
        `;

        resultsDiv.innerHTML = summary + htmlOutput;

        if (problemCount > 0) {
          btnFixAll.style.display = 'inline-block';
        }

      } catch (error) {
        console.error('Error during diagnostic:', error);
        resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
      }
    });

    // Fix single user
    window.fixUser = async function(userId) {
      try {
        const userRef = doc(db, "usuarios", userId);
        await updateDoc(userRef, {
          role: 'proveedor',
          rol: 'proveedor'
        });
        alert(`‚úÖ Usuario corregido exitosamente. Los campos role y rol ahora son "proveedor".`);
        btnDiagnosticar.click(); // Refresh
      } catch (error) {
        console.error('Error fixing user:', error);
        alert(`‚ùå Error al corregir usuario: ${error.message}`);
      }
    };

    // Fix all problem users
    btnFixAll.addEventListener('click', async () => {
      if (!confirm(`¬øEst√°s seguro de que deseas corregir ${problemUsers.length} usuarios?`)) {
        return;
      }

      btnFixAll.disabled = true;
      btnFixAll.textContent = 'Corrigiendo...';

      try {
        const promises = problemUsers.map(({ userId }) => {
          const userRef = doc(db, "usuarios", userId);
          return updateDoc(userRef, {
            role: 'proveedor',
            rol: 'proveedor'
          });
        });

        await Promise.all(promises);
        alert(`‚úÖ ${problemUsers.length} usuarios corregidos exitosamente.`);
        btnDiagnosticar.click(); // Refresh
      } catch (error) {
        console.error('Error fixing users:', error);
        alert(`‚ùå Error: ${error.message}`);
      } finally {
        btnFixAll.disabled = false;
        btnFixAll.textContent = 'Corregir Todos los Problemas';
      }
    });
  </script>

</body>
</html>
