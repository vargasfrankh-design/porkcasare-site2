<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Oficina Virtual - PorkCasare</title>
  <link rel="stylesheet" href="css/style.css" />
<style>
/* Loading overlay styles */
#page-loading-overlay {
  position: fixed;
  inset: 0;
  background: linear-gradient(180deg, rgba(10,11,13,0.65), rgba(20,22,23,0.65));
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 99999;
  opacity: 1;
  transition: opacity 300ms ease, visibility 300ms ease;
  visibility: visible;
  backdrop-filter: blur(4px) saturate(120%);
  -webkit-backdrop-filter: blur(4px) saturate(120%);
}

/* Hidden state */
#page-loading-overlay.hidden {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
}

/* Card */
#page-loading-overlay .loader-card {
  background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
  border-radius: 14px;
  padding: 22px 28px;
  display: flex;
  gap: 16px;
  align-items: center;
  box-shadow: 0 6px 30px rgba(2,6,23,0.6);
  border: 1px solid rgba(255,255,255,0.06);
  color: #fff;
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}

/* Spinner */
.loader-spinner {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  display: grid;
  place-items: center;
  background: conic-gradient(from 0deg, rgba(255,255,255,0.12), rgba(255,255,255,0.02));
  padding: 6px;
  box-shadow: inset 0 -6px 12px rgba(0,0,0,0.25);
}
.loader-spinner .dot {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 4px solid transparent;
  border-top-color: #7be495;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Text */
.loader-text {
  display: flex;
  flex-direction: column;
}
.loader-text .title {
  font-weight: 700;
  font-size: 16px;
  letter-spacing: 0.1px;
}
.loader-text .subtitle {
  margin-top: 4px;
  font-size: 13px;
  color: rgba(255,255,255,0.85);
}

/* subtle pulse under the card */
#page-loading-overlay::after {
  content: "";
  position: absolute;
  width: 220px;
  height: 220px;
  border-radius: 50%;
  background: radial-gradient(circle at center, rgba(123,228,149,0.12), transparent 40%);
  filter: blur(12px);
  z-index: 99998;
  transform: translateY(40px);
}
</style>
</head>
<body>
<!-- Page Loading Overlay (inserted by assistant) -->
<div id="page-loading-overlay" aria-hidden="false" role="status" aria-live="polite">
  <div class="loader-card" role="presentation">
    <div class="loader-spinner" aria-hidden="true">
      <div class="dot"></div>
    </div>
    <div class="loader-text">
      <div class="title">Cargando Oficina Virtual‚Ä¶</div>
      <div class="subtitle">Estamos preparando tu espacio. Esto no deber√≠a tardar mucho.</div>
    </div>
  </div>
</div>
<!-- end loading overlay -->

  <!-- Barra de navegaci√≥n -->
  <nav class="nav">
    <div class="brand">
      <img src="/images/logo.webp" alt="PorkCasare" class="logo" />
      <h2>PorkCasare</h2>
    </div>
    <div class="nav-actions">
      <button id="logoutBtn" class="btn btn-logout">Cerrar sesi√≥n</button>
    </div>
  </nav>

  <!-- Banner informativo de env√≠os (ticker animado) -->
  <div class="shipping-ticker" role="marquee" aria-label="Informaci√≥n de env√≠os">
    <div class="shipping-ticker-track">
      <div class="shipping-ticker-content" id="tickerContent">
        <span class="ticker-item"><span class="ticker-icon">üöö</span> Env√≠os a nivel nacional <span class="ticker-icon">üá®üá¥</span></span>
        <span class="ticker-separator">‚Ä¢</span>
        <span class="ticker-item"><span class="ticker-icon">üì¶</span> No aplica contra entrega</span>
        <span class="ticker-separator">‚Ä¢</span>
        <span class="ticker-item"><span class="ticker-icon">‚ùÑÔ∏è</span> No aplica para productos en fr√≠o</span>
        <span class="ticker-separator">‚Ä¢</span>
        <span class="ticker-item ticker-link" onclick="window.open('https://wa.me/573125929316?text=Hola,%20quiero%20conocer%20los%20t√©rminos%20y%20condiciones', '_blank')"><span class="ticker-icon">üìÑ</span> Aplica t√©rminos y condiciones</span>
        <span class="ticker-separator">‚Ä¢</span>
      </div>
    </div>
  </div>
  <script>
  /* Ticker seamless infinite loop - ensures content is always visible */
  (function() {
    function initTicker() {
      var content = document.getElementById('tickerContent');
      if (!content) return;

      var track = content.parentElement;

      // Clone the content multiple times to ensure seamless loop
      var originalHTML = content.innerHTML;
      // Add enough copies to fill at least 3x the viewport width
      content.innerHTML = originalHTML + originalHTML + originalHTML + originalHTML;

      // Get the width of one set of content
      var tempDiv = document.createElement('div');
      tempDiv.style.cssText = 'display:inline-flex;visibility:hidden;position:absolute;white-space:nowrap;';
      tempDiv.innerHTML = originalHTML;
      document.body.appendChild(tempDiv);
      var singleSetWidth = tempDiv.offsetWidth;
      document.body.removeChild(tempDiv);

      // Calculate animation duration based on content width for consistent speed
      var speed = 50; // pixels per second
      var duration = singleSetWidth / speed;

      // Apply custom animation with calculated duration
      content.style.animationDuration = duration + 's';

      // Create dynamic keyframes for perfect loop
      var styleSheet = document.createElement('style');
      styleSheet.textContent = '@keyframes ticker-scroll-dynamic { 0% { transform: translateX(0); } 100% { transform: translateX(-' + singleSetWidth + 'px); } }';
      document.head.appendChild(styleSheet);

      content.style.animationName = 'ticker-scroll-dynamic';
      content.style.animationTimingFunction = 'linear';
      content.style.animationIterationCount = 'infinite';
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTicker);
    } else {
      initTicker();
    }
  })();
  </script>

  <!-- Alerta de activaci√≥n -->
  <div id="activationAlert" class="activation-alert" style="display:none;">
    ‚ö†Ô∏è Debes realizar una compra m√≠nima de 50 puntos para activar tu c√≥digo y comenzar a recibir bonos y pagos.
  </div>

  <!-- Barra de progreso de metas -->
  <div id="progressBarContainer" class="progress-bar-container" style="display:none;">
    <div class="progress-bar-header">
      <h3>¬°Tu camino a Corona!</h3>
      <p class="progress-subtitle">Contin√∫a acumulando puntos para alcanzar mayores beneficios</p>
    </div>
    <div class="progress-bar-wrapper">
      <div class="progress-bar-track">
        <div id="progressBarFill" class="progress-bar-fill" data-tier="plata">
          <span class="fire-emoji">üî•</span>
          <span class="progress-percentage" id="progressPercentage">0%</span>
        </div>
      </div>
      <div class="progress-tiers">
        <div class="tier-marker" data-tier="plata" data-commission="1400000">
          <div class="tier-icon">ü•à</div>
          <div class="tier-points">$1.4M</div>
          <div class="tier-pts">500 pts</div>
        </div>
        <div class="tier-marker" data-tier="oro" data-commission="4200000">
          <div class="tier-icon">ü•á</div>
          <div class="tier-points">$4.2M</div>
          <div class="tier-pts">1500 pts</div>
        </div>
        <div class="tier-marker" data-tier="stars" data-commission="8400000">
          <div class="tier-icon">‚≠ê</div>
          <div class="tier-points">$8.4M</div>
          <div class="tier-pts">3000 pts</div>
        </div>
        <div class="tier-marker" data-tier="diamante" data-commission="14000000">
          <div class="tier-icon">üíé</div>
          <div class="tier-points">$14M</div>
          <div class="tier-pts">5000 pts</div>
        </div>
        <div class="tier-marker" data-tier="corona" data-commission="28000000">
          <div class="tier-icon">üëë</div>
          <div class="tier-points">$28M</div>
          <div class="tier-pts">10000 pts</div>
        </div>
      </div>
      <div class="current-tier-info">
        <span id="currentTierLabel">Rango Actual: <strong id="currentTierName">Master</strong></span>
        <span id="pointsToNext">Faltan <strong id="pointsToNextValue">$1.400.000</strong> en comisiones para la siguiente meta</span>
      </div>
    </div>
  </div>
  
  <!-- Contenido principal -->
  <div class="container">
    <div class="card">
      <div class="foto-perfil">
        <div class="avatar-wrapper">
          <img id="profileImg" src="../images/avatars/avatar1.png" alt="Avatar actual">
          <a href="https://wa.me/573125929316" target="_blank" rel="noopener noreferrer" class="whatsapp-docs-btn" title="Enviar documentos por WhatsApp">
            üìÑ
          </a>
        </div>
        <div class="avatar-options" id="avatarOptions">
          <p>Selecciona tu avatar:</p>
          <div class="avatar-grid">
            <img src="../images/avatars/avatar1.png" data-avatar="avatar1.png" alt="Avatar 1" />
            <img src="../images/avatars/avatar2.png" data-avatar="avatar2.png" alt="Avatar 2" />
            <img src="../images/avatars/avatar3.png" data-avatar="avatar3.png" alt="Avatar 3" />
            <img src="../images/avatars/avatar4.png" data-avatar="avatar4.png" alt="Avatar 4" />
            <img src="../images/avatars/avatar5.png" data-avatar="avatar5.png" alt="Avatar 5" />
            <img src="../images/avatars/avatar6.png" data-avatar="avatar6.png" alt="Avatar 6" />
            <img src="../images/avatars/avatar7.png" data-avatar="avatar7.png" alt="Avatar 7" />
            <img src="../images/avatars/avatar8.png" data-avatar="avatar8.png" alt="Avatar 8" />
            <img src="../images/avatars/avatar9.png" data-avatar="avatar9.png" alt="Avatar 9" />
          </div>
        </div>
        <button id="changeAvatarBtn" class="btn small" style="display:none; margin-top:10px;">
          Cambiar avatar
        </button>
      </div>

      <h1>Bienvenido a tu oficina virtual</h1>
      <div class="user-info">
        <p><strong>Nombre:</strong> <span id="name">Cargando...</span> <span class="label"></span></p>
        <p><strong>Email:</strong> <span id="email">Cargando...</span></p>
        <p><strong>C√≥digo:</strong> <span id="code">Cargando...</span></p>
        <p><strong>Puntos personales:</strong> <span id="points">0</span></p>
        <p><strong>Puntos grupales:</strong> <span id="teamPoints">0</span></p>

        <!-- Bloque de comisiones -->
<div class="comisiones">
  <div class="comision-item cobradas">
    <div class="comision-label">Comisiones totales cobradas</div>
    <div class="comision-value">
      <span id="totalComisionesCobradas">$ 0</span>
    </div>
  </div>

  <div class="comision-item por-cobrar">
    <div class="comision-label">Comisiones por cobrar</div>
    <div class="comision-value">
      <span id="pendingCommissions">Cargando...</span>
    </div>
  </div>

        <!-- Bloque wallet y cobrar (a√±adido para compatibilidad con js/comisiones.js) -->
<div class="wallet-section" style="margin-top:12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
  <div style="display:flex; flex-direction:column;">
    <div style="font-size:0.9rem; color:#555">Saldo en wallet</div>
    <div id="walletBalance" style="font-weight:700; font-size:1rem;">$0</div>
  </div>

  <div style="display:flex; gap:8px; align-items:center;">
    <button id="btnCobrar" class="btn" disabled style="padding:8px 12px; border-radius:8px; cursor:pointer;">Cobrar</button>
    <div id="lastTxInfo" style="color:#666; font-size:0.9rem;">√öltima transacci√≥n: -</div>
  </div>
</div>
<!-- Fin bloque wallet y cobrar -->

        <!-- Link de referido -->
        <div class="history-section">
          <h2>Tu link de referido</h2>
          <div class="ref-container" style="display:flex;gap:8px;align-items:center;">
            <input type="text" id="refCode" readonly style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd" />
            <button id="copyRef" class="btn small">Copiar</button>
          </div>
          <small style="color:#666">Comparte este enlace para que el campo "Patrocinador" se autocomplete al registrar.</small>
        </div>

        <!-- Navegaci√≥n de secciones: Educaci√≥n, Consumo, Duplicaci√≥n -->
        <div class="section-tabs-container">
          <div class="section-tabs">
            <button class="section-tab" data-tab="educacion">
              <span class="tab-icon">üìö</span>
              <span class="tab-label">Educaci√≥n</span>
            </button>
            <button class="section-tab active" data-tab="consumo">
              <span class="tab-icon">üõí</span>
              <span class="tab-label">Consumo</span>
            </button>
            <button class="section-tab" data-tab="duplicacion">
              <span class="tab-icon">üåê</span>
              <span class="tab-label">Duplicaci√≥n</span>
            </button>
          </div>
        </div>

        <!-- ========== TAB: EDUCACI√ìN ========== -->
        <div id="tab-educacion" class="tab-content" style="display:none;">
          <div class="education-section-expanded">
            <div class="education-header">
              <h2>üìö Centro de Recursos Educativos</h2>
              <p>Accede a todo el material educativo para tu desarrollo profesional y crecimiento en el negocio.</p>
            </div>

            <!-- Recursos organizados por categor√≠a - Solo enlaces -->
            <div class="education-resources-grid">

              <!-- Videos YouTube -->
              <div class="resource-category" id="category-videos">
                <div class="category-header">
                  <span class="category-icon-large">üé¨</span>
                  <div class="category-title-wrap">
                    <h3>Videos Educativos</h3>
                    <span class="category-subtitle">YouTube, TikTok y m√°s</span>
                  </div>
                </div>
                <div class="resource-links-list" id="videosEducativos">
                  <div class="education-placeholder-compact">
                    <span class="placeholder-icon">‚ñ∂Ô∏è</span>
                    <p>Los videos se cargar√°n desde administraci√≥n.</p>
                  </div>
                </div>
              </div>

              <!-- Libros y Documentos -->
              <div class="resource-category" id="category-libros">
                <div class="category-header">
                  <span class="category-icon-large">üìñ</span>
                  <div class="category-title-wrap">
                    <h3>Libros y Documentos</h3>
                    <span class="category-subtitle">Material de lectura</span>
                  </div>
                </div>
                <div class="resource-links-list" id="librosDocumentos">
                  <div class="education-placeholder-compact">
                    <span class="placeholder-icon">üìÑ</span>
                    <p>Los libros y documentos se cargar√°n desde administraci√≥n.</p>
                  </div>
                </div>
              </div>

              <!-- PEC del Mes -->
              <div class="resource-category" id="category-pec">
                <div class="category-header">
                  <span class="category-icon-large">üìù</span>
                  <div class="category-title-wrap">
                    <h3>PEC del Mes</h3>
                    <span class="category-subtitle">Paquete de Educaci√≥n Continua</span>
                  </div>
                </div>
                <div class="resource-links-list" id="pecDelMes">
                  <div class="education-placeholder-compact">
                    <span class="placeholder-icon">üìã</span>
                    <p>El PEC del mes se cargar√° desde administraci√≥n.</p>
                  </div>
                </div>
              </div>

              <!-- Enlaces √ötiles -->
              <div class="resource-category" id="category-enlaces">
                <div class="category-header">
                  <span class="category-icon-large">üîó</span>
                  <div class="category-title-wrap">
                    <h3>Enlaces √ötiles</h3>
                    <span class="category-subtitle">Recursos adicionales</span>
                  </div>
                </div>
                <div class="resource-links-list" id="enlacesUtiles">
                  <div class="education-placeholder-compact">
                    <span class="placeholder-icon">üåê</span>
                    <p>Los enlaces se cargar√°n desde administraci√≥n.</p>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- ========== TAB: CONSUMO ========== -->
        <div id="tab-consumo" class="tab-content" style="display:block;">
          <!-- Productos -->
          <div class="history-section consumo-section">
            <h2>Productos disponibles</h2>

            <!-- Horizontal Category Filters -->
            <div class="category-filters-container">
              <div class="category-filters" id="categoryFilters">
                <button class="category-filter-btn active" data-category="todas">
                  <span class="category-emoji">üè™</span>
                  <span class="category-name">Todas</span>
                </button>
                <button class="category-filter-btn" data-category="carnes">
                  <span class="category-emoji">ü•©</span>
                  <span class="category-name">Carnes</span>
                </button>
                <button class="category-filter-btn" data-category="bebidas">
                  <span class="category-emoji">üç∑</span>
                  <span class="category-name">Bebidas</span>
                </button>
                <button class="category-filter-btn" data-category="alimentos">
                  <span class="category-emoji">üçö</span>
                  <span class="category-name">Alimentos</span>
                </button>
                <button class="category-filter-btn" data-category="aseo">
                  <span class="category-emoji">üß¥</span>
                  <span class="category-name">Aseo</span>
                </button>
                <button class="category-filter-btn" data-category="higiene-personal">
                  <span class="category-emoji">üßº</span>
                  <span class="category-name">Higiene</span>
                </button>
                <button class="category-filter-btn" data-category="abarrotes">
                  <span class="category-emoji">üõí</span>
                  <span class="category-name">Abarrotes</span>
                </button>
              </div>
            </div>

            <!-- Hidden select for JavaScript compatibility -->
            <select id="categorySelector" style="display:none;">
              <option value="todas">Todas las categor√≠as</option>
              <option value="carnes">Carnes</option>
              <option value="bebidas">Bebidas</option>
              <option value="alimentos">Alimentos</option>
              <option value="aseo">Aseo</option>
              <option value="higiene-personal">Higiene Personal</option>
              <option value="abarrotes">Abarrotes</option>
            </select>

            <div id="productGrid" class="product-grid"></div>
          </div>

          <!-- Historial -->
          <div class="history-section">
            <h2>Historial</h2>
            <div id="history" class="history-list"></div>
          </div>
        </div>

        <!-- ========== TAB: DUPLICACI√ìN ========== -->
        <div id="tab-duplicacion" class="tab-content" style="display:none;">
          <!-- Red - Vista expandida -->
          <div class="history-section duplicacion-expanded">
            <h2>Mi Red</h2>

            <!-- Estad√≠sticas ampliadas de la red -->
            <div class="network-stats-grid" id="networkStatsGrid">
              <div class="network-stat-card primary">
                <div class="stat-icon">üë•</div>
                <div class="stat-content">
                  <div class="stat-label">Afiliados Directos</div>
                  <div class="stat-value" id="statDirectAffiliates">0</div>
                </div>
              </div>
              <div class="network-stat-card secondary">
                <div class="stat-icon">üåê</div>
                <div class="stat-content">
                  <div class="stat-label">Afiliados Indirectos</div>
                  <div class="stat-value" id="statIndirectAffiliates">0</div>
                </div>
              </div>
              <div class="network-stat-card success">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-content">
                  <div class="stat-label">Activos Este Mes</div>
                  <div class="stat-value" id="statActiveThisMonth">0</div>
                </div>
              </div>
              <div class="network-stat-card warning">
                <div class="stat-icon">üìä</div>
                <div class="stat-content">
                  <div class="stat-label">Total en Red</div>
                  <div class="stat-value" id="statTotalNetwork">0</div>
                </div>
              </div>
            </div>

            <!-- Puntos por nivel -->
            <div class="network-levels-section">
              <h3>üìà Puntos por Nivel <span style="font-size: 0.75em; font-weight: normal; color: #666;">(Acumulado total)</span></h3>
              <div class="levels-grid" id="levelsPointsGrid">
                <div class="level-card level-1">
                  <span class="level-badge">Nivel 1</span>
                  <span class="level-points" id="pointsLevel1">0 pts</span>
                </div>
                <div class="level-card level-2">
                  <span class="level-badge">Nivel 2</span>
                  <span class="level-points" id="pointsLevel2">0 pts</span>
                </div>
                <div class="level-card level-3">
                  <span class="level-badge">Nivel 3</span>
                  <span class="level-points" id="pointsLevel3">0 pts</span>
                </div>
                <div class="level-card level-4">
                  <span class="level-badge">Nivel 4</span>
                  <span class="level-points" id="pointsLevel4">0 pts</span>
                </div>
                <div class="level-card level-5">
                  <span class="level-badge">Nivel 5</span>
                  <span class="level-points" id="pointsLevel5">0 pts</span>
                </div>
              </div>
            </div>

            <!-- Bonos obtenidos -->
            <div class="network-bonuses-section">
              <h3>üéÅ Resumen de Bonos <span style="font-size: 0.75em; font-weight: normal; color: #666;">(Mes en curso)</span></h3>
              <div class="bonuses-grid" id="bonusesGrid">
                <div class="bonus-card">
                  <div class="bonus-icon">üöÄ</div>
                  <div class="bonus-info">
                    <div class="bonus-label">Bono de Inicio R√°pido</div>
                    <div class="bonus-sublabel" style="font-size: 0.7em; color: #888;">M√°ster ingresados este mes</div>
                    <div class="bonus-value" id="bonusReferidos">$0</div>
                  </div>
                </div>
                <div class="bonus-card">
                  <div class="bonus-icon">üîÑ</div>
                  <div class="bonus-info">
                    <div class="bonus-label">Bono de Recompra</div>
                    <div class="bonus-sublabel" style="font-size: 0.7em; color: #888;">Comisiones por cobrar del mes</div>
                    <div class="bonus-value" id="bonusRecompra">$0</div>
                  </div>
                </div>
                <div class="bonus-card">
                  <div class="bonus-icon">‚≠ê</div>
                  <div class="bonus-info">
                    <div class="bonus-label">Bono de Equipo</div>
                    <div class="bonus-value" id="bonusEquipo" style="color: #888; font-style: italic;">Pr√≥ximamente</div>
                  </div>
                </div>
                <div class="bonus-card">
                  <div class="bonus-icon">üèÜ</div>
                  <div class="bonus-info">
                    <div class="bonus-label">Bono de Liderazgo</div>
                    <div class="bonus-value" id="bonusLiderazgo" style="color: #888; font-style: italic;">Pr√≥ximamente</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Controles del √°rbol -->
            <div id="network-controls" class="network-controls-expanded">
              <div class="controls-row">
                <div class="stat-mini">
                  <span class="stat-mini-label">Total frontales</span>
                  <span class="stat-mini-value" id="statFrontalesTotal">0</span>
                  <span class="stat-mini-sub">Del grupo: <strong id="statFrontalesGrupo">0</strong></span>
                </div>
                <div class="stat-mini">
                  <span class="stat-mini-label">Total en Red</span>
                  <span class="stat-mini-value" id="statTotal">0</span>
                  <span class="stat-mini-sub">Del grupo: <strong id="statTotalGrupo">0</strong></span>
                </div>
                <div class="stat-mini">
                  <span class="stat-mini-label">Activos este mes</span>
                  <span class="stat-mini-value" id="statRecompra">0</span>
                  <span class="stat-mini-sub">Del grupo: <strong id="statRecompraGrupo">0</strong></span>
                </div>
                <div class="controls-actions">
                  <label for="pageSize">Frontales por grupo:</label>
                  <select id="pageSize">
                    <option value="5" selected>5</option>
                  </select>
                  <button id="btnRefreshMap" class="btn small">üîÑ Actualizar</button>
                </div>
              </div>
            </div>

            <div id="network-group-info" class="network-group-info-expanded">
              <strong>üìç Visualizando:</strong> <span id="currentGroupInfo">Todos los frontales</span>
            </div>

            <!-- Contenedor del √°rbol expandido -->
            <div id="mapContainer" class="map-container-expanded">
              <div id="treeWrap" class="tree-wrap-expanded"></div>
              <div id="treePager"></div>
              <div id="statsInfo"></div>
            </div>
          </div>
        </div>

      </div> <!-- /.user-info -->
    </div> <!-- /.card -->
  </div> <!-- /.container -->

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script type="module" src="js/progress-bar.js"></script>
  <script type="module" src="js/distribuidor-lite.js"></script>
  <script type="module" src="js/red-unilevel.js"></script>
  <script type="module" src="js/productos.js"></script>
  <script type="module" src="js/educacion.js"></script>
  <script type="module" src="/js/comisiones.js"></script>
  <script type="module" src="/js/session-timeout.js"></script>
  <script>
(function(){
  function setup(){
    const btn = document.getElementById('btnCobrar');
    if (!btn) return;
    // envolver el bot√≥n para posicionar tooltip
    let wrapBtn = btn.parentElement;
    if (!wrapBtn.classList.contains('wallet-tooltip-wrap')) {
      const wrapper = document.createElement('span');
      wrapper.className = 'wallet-tooltip-wrap';
      wrapBtn.replaceChild(wrapper, btn);
      wrapper.appendChild(btn);
      wrapBtn = wrapper;
    } else {
      wrapBtn = btn.parentElement;
    }
    // crear tooltip
    let tip = wrapBtn.querySelector('.wallet-tooltip');
    if (!tip) {
      tip = document.createElement('div');
      tip.className = 'wallet-tooltip hidden';
      tip.textContent = 'No tienes comisiones por cobrar';
      wrapBtn.appendChild(tip);
    }

    function updateTooltip(){
      if (btn.disabled) {
        tip.classList.remove('hidden');
      } else {
        tip.classList.add('hidden');
      }
    }

    updateTooltip();
    const obs = new MutationObserver(() => updateTooltip());
    obs.observe(btn, { attributes: true, attributeFilter: ['disabled'] });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setup);
  } else {
    setup();
  }
})();
</script>

<!-- Category Filter Buttons Navigation -->
<script>
(function() {
  function initCategoryFilters() {
    const filterBtns = document.querySelectorAll('.category-filter-btn');
    const categorySelector = document.getElementById('categorySelector');

    if (!filterBtns.length || !categorySelector) return;

    filterBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        // Remove active class from all buttons
        filterBtns.forEach(b => b.classList.remove('active'));
        // Add active to clicked button
        this.classList.add('active');

        // Get the category value
        const category = this.getAttribute('data-category');

        // Update the hidden select to trigger existing JS logic
        categorySelector.value = category;

        // Set window variable for filtering
        window.selectedCategory = category;

        // Reset to page 1 when changing category
        window.currentProductPage = 1;

        // Dispatch change event to trigger product filtering
        const event = new Event('change', { bubbles: true });
        categorySelector.dispatchEvent(event);

        // Also call renderProductos directly if available (for module timing)
        if (typeof window.renderProductos === 'function') {
          window.renderProductos();
        }
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCategoryFilters);
  } else {
    initCategoryFilters();
  }
})();
</script>

<!-- Section Tabs Navigation (Educaci√≥n, Consumo, Duplicaci√≥n) -->
<script>
(function() {
  function initSectionTabs() {
    const tabs = document.querySelectorAll('.section-tab');
    const tabContents = document.querySelectorAll('.tab-content');

    if (!tabs.length || !tabContents.length) return;

    function switchTab(tabName) {
      // Remove active class from all tabs
      tabs.forEach(tab => tab.classList.remove('active'));

      // Hide all tab contents
      tabContents.forEach(content => {
        content.style.display = 'none';
      });

      // Add active class to clicked tab
      const activeTab = document.querySelector(`.section-tab[data-tab="${tabName}"]`);
      if (activeTab) {
        activeTab.classList.add('active');
      }

      // Show corresponding content
      const activeContent = document.getElementById(`tab-${tabName}`);
      if (activeContent) {
        activeContent.style.display = 'block';
        // Re-trigger animation
        activeContent.style.animation = 'none';
        activeContent.offsetHeight; // Force reflow
        activeContent.style.animation = '';
      }

      // Dispatch custom event for tabs that need it
      if (tabName === 'duplicacion') {
        // Dispatch a custom event that the tree can listen to
        window.dispatchEvent(new CustomEvent('tab-duplicacion-shown'));

        // Also trigger resize to ensure D3 tree renders correctly
        setTimeout(() => {
          window.dispatchEvent(new Event('resize'));
        }, 100);
      } else if (tabName === 'educacion') {
        // Dispatch event so education module can refresh content
        window.dispatchEvent(new CustomEvent('tab-educacion-shown'));
      }

      // Store active tab in sessionStorage for persistence during session
      try {
        sessionStorage.setItem('activeOfficeTab', tabName);
      } catch(e) {}
    }

    // Add click handlers to tabs
    tabs.forEach(tab => {
      tab.addEventListener('click', function() {
        const tabName = this.getAttribute('data-tab');
        if (tabName) {
          switchTab(tabName);
        }
      });
    });

    // Check for stored tab preference (but default to consumo on page load)
    // We intentionally default to 'consumo' as per requirements
    const storedTab = sessionStorage.getItem('activeOfficeTab');

    // On initial load, always show Consumo (as per requirements)
    // But if user has navigated within the session, respect their choice
    if (storedTab && document.referrer && document.referrer.includes(window.location.hostname)) {
      switchTab(storedTab);
    } else {
      // Default to Consumo on fresh page load
      switchTab('consumo');
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSectionTabs);
  } else {
    initSectionTabs();
  }
})();
</script>

<script>

<!-- Loading overlay control ‚Äî enhanced: waits for avatar-grid or hides quickly for default avatars -->
<script>
/* Loading overlay control ‚Äî version improved to wait for avatar-grid hiding */
(function () {
  const overlayId = 'page-loading-overlay';
  const overlay = document.getElementById(overlayId);

  window.showPageLoading = function(message) {
    if (!overlay) return;
    overlay.classList.remove('hidden');
    overlay.setAttribute('aria-hidden', 'false');
    if (message) {
      const sub = overlay.querySelector('.loader-text .subtitle');
      if (sub) sub.textContent = message;
    }
  };

  window.hidePageLoading = function() {
    if (!overlay) return;
    overlay.classList.add('hidden');
    overlay.setAttribute('aria-hidden', 'true');
    setTimeout(() => {
      if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
    }, 400);
  };

  function isProfileUsingDefault(imgEl) {
    try {
      if (!imgEl) return true;
      const raw = imgEl.getAttribute && imgEl.getAttribute('src') ? imgEl.getAttribute('src') : (imgEl.src || '');
      const src = String(raw).split('?')[0].toLowerCase();
      if (!src) return true;
      if (src.includes('default-avatar.png')) return true;
      if (/avatar[_-]?\d+\.png$/.test(src)) return true;
      if (src.indexOf('/images/avatars/') !== -1 && /avatar\d+\.png$/.test(src)) return true;
      return false;
    } catch (e) {
      return true;
    }
  }

  function waitForAvatarGridThenHide() {
    const avatarGrid = document.querySelector('.avatar-grid') || document.getElementById('avatarGrid');
    const profileImg = document.getElementById('profileImg');
    const changeAvatarBtn = document.getElementById('changeAvatarBtn');

    if (!avatarGrid) {
      setTimeout(() => window.hidePageLoading(), 120);
      return;
    }

    if (isProfileUsingDefault(profileImg)) {
      setTimeout(() => window.hidePageLoading(), 120);
      return;
    }

    let observer;
    let finished = false;
    const finish = () => {
      if (finished) return;
      finished = true;
      try { if (observer) observer.disconnect(); } catch(e){}
      window.hidePageLoading();
    };

    try {
      observer = new MutationObserver(() => {
        try {
          const inDom = document.body.contains(avatarGrid);
          const style = window.getComputedStyle(avatarGrid);
          const isHidden = !inDom || (style && (style.display === 'none' || style.visibility === 'hidden' || avatarGrid.hidden));
          if (isHidden) finish();
        } catch (err) {}
      });
      observer.observe(avatarGrid, { attributes: true, attributeFilter: ['style','class','hidden'], childList: true });
    } catch (e) {
      observer = null;
    }

    let attempts = 0;
    const poll = setInterval(() => {
      attempts++;
      try {
        const inDom = document.body.contains(avatarGrid);
        const style = window.getComputedStyle(avatarGrid);
        const isHidden = !inDom || (style && (style.display === 'none' || style.visibility === 'hidden' || avatarGrid.hidden));
        if (isHidden) {
          clearInterval(poll);
          finish();
        } else if (attempts > 50) {
          clearInterval(poll);
          finish();
        }
      } catch (e) {}
    }, 250);

    if (changeAvatarBtn) {
      changeAvatarBtn.addEventListener('click', () => {
        setTimeout(() => {
          try {
            const style = window.getComputedStyle(avatarGrid);
            if (style.display === 'none' || avatarGrid.hidden) finish();
          } catch (e) {}
        }, 220);
      });
    }

    setTimeout(() => {
      try {
        const style = window.getComputedStyle(avatarGrid);
        const isHiddenNow = !document.body.contains(avatarGrid) || (style && (style.display === 'none' || style.visibility === 'hidden' || avatarGrid.hidden));
        if (!isHiddenNow) {
          finish();
        }
      } catch (e) {
        finish();
      }
    }, 12000);
  }

  window.addEventListener('load', function () {
    try {
      const avatarGrid = document.querySelector('.avatar-grid') || document.getElementById('avatarGrid');
      const profileImg = document.getElementById('profileImg');

      if (!avatarGrid || isProfileUsingDefault(profileImg)) {
        setTimeout(() => window.hidePageLoading(), 260);
      } else {
        waitForAvatarGridThenHide();
      }
    } catch (e) {
      setTimeout(() => window.hidePageLoading(), 800);
    }
  });

  window.onMapReady = function() {
    try { window.hidePageLoading(); } catch(e) { 
      const ov = document.getElementById('page-loading-overlay'); if (ov) ov.classList.add('hidden');
    }
  };

  setTimeout(() => {
    const ov = document.getElementById(overlayId);
    if (ov && !ov.classList.contains('hidden')) {
      try { window.hidePageLoading(); } catch(e) { ov.classList.add('hidden'); }
    }
  }, 18000);
})();
</script>


<script>
/* Loading overlay control ‚Äî versi√≥n robusta: busca el elemento din√°micamente + fallback forzoso */
(function () {
  const overlayId = 'page-loading-overlay';

  function getOverlay() {
    return document.getElementById(overlayId);
  }

  function forceRemoveOverlay(ov) {
    try {
      if (!ov) return;
      // Quitar transiciones para evitar parpadeo y forzar ocultado
      ov.style.transition = 'none';
      ov.style.opacity = '0';
      ov.style.visibility = 'hidden';
      ov.style.pointerEvents = 'none';
      // Forzar display none despu√©s de 80ms
      setTimeout(() => {
        try { if (ov && ov.parentNode) ov.parentNode.removeChild(ov); } catch(e){}
      }, 80);
    } catch(e) { console.debug('[page-loading] forceRemoveOverlay failed', e); }
  }

  window.showPageLoading = function(message) {
    const overlay = getOverlay();
    if (!overlay) {
      console.debug('[page-loading] showPageLoading: overlay no encontrado');
      return;
    }
    overlay.classList.remove('hidden');
    overlay.setAttribute('aria-hidden', 'false');
    overlay.style.display = ''; // revert any forced display:none
    if (message) {
      const sub = overlay.querySelector('.loader-text .subtitle');
      if (sub) sub.textContent = message;
    }
  };

  window.hidePageLoading = function() {
    const overlay = getOverlay();
    if (!overlay) {
      console.debug('[page-loading] hidePageLoading: overlay no encontrado (buscar fallback)');
      const ov = document.getElementById(overlayId);
      if (ov) forceRemoveOverlay(ov);
      return;
    }
    try {
      // A√±adir clase para animaci√≥n si existe CSS
      overlay.classList.add('hidden');
      overlay.setAttribute('aria-hidden', 'true');
      // Despu√©s de la transici√≥n, remover; pero tambi√©n forzar como fallback
      setTimeout(() => {
        const ov = getOverlay();
        if (ov && ov.parentNode) ov.parentNode.removeChild(ov);
      }, 400);
      // Fallback r√°pido
      setTimeout(() => forceRemoveOverlay(overlay), 500);
    } catch(e) {
      console.warn('[page-loading] hidePageLoading error', e);
      forceRemoveOverlay(overlay);
    }
  };

  // Fallback final: si la p√°gina termina de cargar y a√∫n se ve el overlay, forzarlo
  window.addEventListener('load', function () {
    try {
      const ov = getOverlay();
      if (ov && !ov.classList.contains('hidden')) {
        console.debug('[page-loading] load event: overlay still visible ‚Äî forcing removal');
        forceRemoveOverlay(ov);
      }
    } catch(e) { console.debug('[page-loading] load handler failed', e); }
  }, { once: true });

  // Mantener el timeout de seguridad existente (ejemplo: 18s)
  setTimeout(() => {
    const ov = getOverlay();
    if (ov && !ov.classList.contains('hidden')) {
      try { window.hidePageLoading(); } catch(e) { forceRemoveOverlay(ov); }
    }
  }, 18000);

})();
</script>
</body>
</html>
